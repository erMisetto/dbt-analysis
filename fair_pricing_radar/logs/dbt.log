[0m22:20:06.838629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A4F1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A661E320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A661E140>]}


============================== 22:20:06.858576 | 9dc1bece-5157-40df-a412-664da04e1b33 ==============================
[0m22:20:06.858576 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:20:06.859574 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:20:06.863562 [error] [MainThread]: Encountered an error:
Runtime Error
  Could not find profile named 'fair_pricing_radar'
[0m22:20:06.865558 [debug] [MainThread]: Command `dbt run` failed at 22:20:06.865558 after 0.12 seconds
[0m22:20:06.866555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A4F1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A661F0A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137A661E3B0>]}
[0m22:20:06.867553 [debug] [MainThread]: Flushing usage events
[0m22:20:07.250548 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:21:00.307492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B43F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B45659CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B45659EA0>]}


============================== 22:21:00.311482 | 064b7ce8-34ed-4462-8432-ab14bb99aa2e ==============================
[0m22:21:00.311482 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:21:00.312479 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:21:00.316469 [error] [MainThread]: Encountered an error:
Runtime Error
  Could not find profile named 'fair_pricing_radar'
[0m22:21:00.318463 [debug] [MainThread]: Command `dbt run` failed at 22:21:00.318463 after 0.10 seconds
[0m22:21:00.319461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B43F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B45658F40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B45659C30>]}
[0m22:21:00.320459 [debug] [MainThread]: Flushing usage events
[0m22:21:00.686996 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:24:22.141572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422EA1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230159C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230159E40>]}


============================== 22:24:22.145561 | dd04c5b4-56d7-4736-bf6d-38713cae65e9 ==============================
[0m22:24:22.145561 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:24:22.146559 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:24:28.471249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd04c5b4-56d7-4736-bf6d-38713cae65e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230127E20>]}
[0m22:24:28.530092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd04c5b4-56d7-4736-bf6d-38713cae65e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001423875F400>]}
[0m22:24:28.538071 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:24:29.242691 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:24:29.243689 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:24:29.244686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'dd04c5b4-56d7-4736-bf6d-38713cae65e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422FA1BBB0>]}
[0m22:24:29.273609 [error] [MainThread]: Encountered an error:
Parsing Error
  Error reading fair_pricing_radar: sources.yml - Runtime Error
    Syntax error near line 2
    ------------------------------
    1  | -- models/sources.yml
    2  | tversion: 2
    3  | sources:
    4  |   - name: raw_airfares
    5  |     database: FLIGHT_PRICES      
    
    Raw Error:
    ------------------------------
    mapping values are not allowed in this context
      in "<unicode string>", line 2, column 9
[0m22:24:29.275604 [debug] [MainThread]: Command `dbt run` failed at 22:24:29.275604 after 7.22 seconds
[0m22:24:29.276601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422EA1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014238B134C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014238B11840>]}
[0m22:24:29.276601 [debug] [MainThread]: Flushing usage events
[0m22:24:29.625678 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:26:46.658057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D5A01D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D5B71E320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D5B71E140>]}


============================== 22:26:46.662046 | 05329d08-eff3-4d1b-ba4a-2d0983917181 ==============================
[0m22:26:46.662046 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:26:46.663044 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:26:47.555656 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '05329d08-eff3-4d1b-ba4a-2d0983917181', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D58197010>]}
[0m22:26:47.614499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '05329d08-eff3-4d1b-ba4a-2d0983917181', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D63D5C460>]}
[0m22:26:47.615496 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:26:48.163032 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:26:48.164030 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:26:48.166024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '05329d08-eff3-4d1b-ba4a-2d0983917181', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D640732E0>]}
[0m22:26:50.699249 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_fare_searches' (models\staging\stg_fare_searches.sql) depends on a source named 'raw_airfares.FLIGHT_FARES' which was not found
[0m22:26:50.701244 [debug] [MainThread]: Command `dbt run` failed at 22:26:50.701244 after 4.12 seconds
[0m22:26:50.702241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D5A01D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D64B28190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014D6477AE60>]}
[0m22:26:50.702241 [debug] [MainThread]: Flushing usage events
[0m22:26:51.048315 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:30:04.594696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002519381D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025194F59C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025194F59E10>]}


============================== 22:30:04.598685 | 2a18ca48-ec68-40a7-bb3a-e03128f9cd59 ==============================
[0m22:30:04.598685 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:30:04.599683 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_fare_searches', 'send_anonymous_usage_stats': 'True'}
[0m22:30:05.495287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a18ca48-ec68-40a7-bb3a-e03128f9cd59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025194F2FDF0>]}
[0m22:30:05.554129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a18ca48-ec68-40a7-bb3a-e03128f9cd59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025194D92D70>]}
[0m22:30:05.556125 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:30:06.111638 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:30:06.112636 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:30:06.113634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '2a18ca48-ec68-40a7-bb3a-e03128f9cd59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002519D9E6E90>]}
[0m22:30:07.672465 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_fare_searches' (models\staging\stg_fare_searches.sql) depends on a source named 'raw_airfares.FLIGHT_FARES' which was not found
[0m22:30:07.674459 [debug] [MainThread]: Command `dbt run` failed at 22:30:07.674459 after 3.16 seconds
[0m22:30:07.675456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002519381D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002519E7F5870>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002519E683070>]}
[0m22:30:07.675456 [debug] [MainThread]: Flushing usage events
[0m22:30:08.015547 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:32:30.298569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D071D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D1E59C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D1E59E10>]}


============================== 22:32:30.302558 | fb20eb51-61b8-4784-ae64-88238b78928e ==============================
[0m22:32:30.302558 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:32:30.303555 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:32:31.225090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb20eb51-61b8-4784-ae64-88238b78928e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D1E2BDF0>]}
[0m22:32:31.283933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb20eb51-61b8-4784-ae64-88238b78928e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D1C92D70>]}
[0m22:32:31.284930 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:32:31.850418 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:32:31.852412 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:32:31.853411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'fb20eb51-61b8-4784-ae64-88238b78928e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9DA7E6E90>]}
[0m22:32:33.413238 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_fare_searches' (models\staging\stg_fare_searches.sql) depends on a source named 'raw_airfares.FLIGHT_FARES' which was not found
[0m22:32:33.415233 [debug] [MainThread]: Command `dbt run` failed at 22:32:33.415233 after 3.20 seconds
[0m22:32:33.416230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9D071D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9DAFB7010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9DAFB4EB0>]}
[0m22:32:33.416230 [debug] [MainThread]: Flushing usage events
[0m22:32:33.763302 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:34:53.743939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE211D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE3859D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE3859F30>]}


============================== 22:34:53.747928 | 13169354-bb11-43d8-b360-f886c5f08a98 ==============================
[0m22:34:53.747928 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:34:53.747928 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_fare_searches', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:34:54.640541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '13169354-bb11-43d8-b360-f886c5f08a98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE382DCC0>]}
[0m22:34:54.700380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '13169354-bb11-43d8-b360-f886c5f08a98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BEBF5F820>]}
[0m22:34:54.701378 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:34:55.263874 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:34:55.264871 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:34:55.265869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '13169354-bb11-43d8-b360-f886c5f08a98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BEC245750>]}
[0m22:34:57.021174 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_fare_searches' (models\staging\stg_fare_searches.sql) depends on a source named 'raw_airfares.FLIGHT_FARES' which was not found
[0m22:34:57.023169 [debug] [MainThread]: Command `dbt run` failed at 22:34:57.023169 after 3.36 seconds
[0m22:34:57.024166 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE211D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BECD79C90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BECD79BA0>]}
[0m22:34:57.025163 [debug] [MainThread]: Flushing usage events
[0m22:34:57.367249 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:36:27.829317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DE21D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DF959CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DF959ED0>]}


============================== 22:36:27.833306 | 511699c5-df0a-4f41-84f6-ee27356cfc01 ==============================
[0m22:36:27.833306 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:36:27.833306 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:36:28.731902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DC397010>]}
[0m22:36:28.789748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E7F5C460>]}
[0m22:36:28.791743 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:36:29.362217 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:36:29.364212 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:36:29.365209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E82732E0>]}
[0m22:36:31.081619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E942C130>]}
[0m22:36:31.258146 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:36:31.380818 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:36:31.637134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E942CA30>]}
[0m22:36:31.637134 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m22:36:31.638131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E942EE90>]}
[0m22:36:31.640125 [info ] [MainThread]: 
[0m22:36:31.641123 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:36:31.641123 [info ] [MainThread]: 
[0m22:36:31.642120 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:36:31.643117 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:36:34.325942 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:36:34.325942 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:36:34.326940 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:40.911330 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 6.585 seconds
[0m22:36:40.918311 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_PUBLIC'
[0m22:36:40.928285 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_PUBLIC"
[0m22:36:40.929282 [debug] [ThreadPool]: On list_FLIGHT_PRICES_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_PUBLIC"} */
show objects in FLIGHT_PRICES.PUBLIC limit 10000;
[0m22:36:40.930280 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:44.633376 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 3.703 seconds
[0m22:36:44.635371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E91946A0>]}
[0m22:36:44.642352 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m22:36:44.643349 [info ] [Thread-1 (]: 1 of 1 START sql incremental model PUBLIC.stg_fare_searches .................... [RUN]
[0m22:36:44.644347 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m22:36:44.645344 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m22:36:44.654320 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:36:44.657313 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m22:36:44.723136 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:36:44.729120 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m22:36:44.730117 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')[-1]             as destination
  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered;
[0m22:36:44.731115 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:36:48.947838 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbde11-0305-0c98-0006-8fdb0016e8ae
[0m22:36:48.947838 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 79 at position 22 unexpected ';'.
[0m22:36:48.950829 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001003 (42000): SQL compilation error:
  syntax error line 79 at position 22 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:36:48.958808 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '511699c5-df0a-4f41-84f6-ee27356cfc01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E8C3C5B0>]}
[0m22:36:48.959806 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model PUBLIC.stg_fare_searches ........... [[31mERROR[0m in 4.31s]
[0m22:36:48.961801 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m22:36:48.961801 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001003 (42000): SQL compilation error:
  syntax error line 79 at position 22 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m22:36:48.963795 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:36:48.964792 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:36:48.964792 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:36:49.323832 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_PUBLIC' was left open.
[0m22:36:49.324829 [debug] [MainThread]: On list_FLIGHT_PRICES_PUBLIC: Close
[0m22:36:49.666914 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m22:36:49.667911 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m22:36:50.030941 [info ] [MainThread]: 
[0m22:36:50.031938 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 18.39 seconds (18.39s).
[0m22:36:50.032941 [debug] [MainThread]: Command end result
[0m22:36:50.059863 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:36:50.062856 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:36:50.070834 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:36:50.070834 [info ] [MainThread]: 
[0m22:36:50.071832 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:36:50.072829 [info ] [MainThread]: 
[0m22:36:50.072829 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001003 (42000): SQL compilation error:
  syntax error line 79 at position 22 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:36:50.073826 [info ] [MainThread]: 
[0m22:36:50.074824 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:36:50.076818 [debug] [MainThread]: Command `dbt run` failed at 22:36:50.076818 after 22.33 seconds
[0m22:36:50.077815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DE21D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237DE2BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E897FA00>]}
[0m22:36:50.077815 [debug] [MainThread]: Flushing usage events
[0m22:36:50.423890 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:39:31.492130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027369E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002736B556560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002736B556740>]}


============================== 22:39:31.496119 | 11cc986f-2a08-45b4-9309-acb40b789f22 ==============================
[0m22:39:31.496119 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:39:31.497117 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:39:32.390726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027366F97040>]}
[0m22:39:32.449569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002736ABFDE10>]}
[0m22:39:32.451564 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:39:33.023035 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:39:33.291318 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:39:33.291318 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m22:39:33.642379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027373BEC880>]}
[0m22:39:33.761062 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:39:33.763056 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:39:33.784998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273746F39D0>]}
[0m22:39:33.785995 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m22:39:33.786993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273746F0790>]}
[0m22:39:33.787990 [info ] [MainThread]: 
[0m22:39:33.788987 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:39:33.789985 [info ] [MainThread]: 
[0m22:39:33.790982 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:39:33.791979 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:39:33.904678 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:39:33.905675 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:39:33.905675 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:39:38.540281 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 4.635 seconds
[0m22:39:38.548259 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_PUBLIC'
[0m22:39:38.558232 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_PUBLIC"
[0m22:39:38.559229 [debug] [ThreadPool]: On list_FLIGHT_PRICES_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_PUBLIC"} */
show objects in FLIGHT_PRICES.PUBLIC limit 10000;
[0m22:39:38.559229 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:39:42.618373 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 4.059 seconds
[0m22:39:42.621365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273746F2080>]}
[0m22:39:42.625355 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m22:39:42.626352 [info ] [Thread-1 (]: 1 of 1 START sql incremental model PUBLIC.stg_fare_searches .................... [RUN]
[0m22:39:42.627350 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m22:39:42.628347 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m22:39:42.636326 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:39:42.638321 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m22:39:42.699157 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:39:42.703146 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m22:39:42.704145 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')[-1]             as destination
  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m22:39:42.704145 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:39:46.658569 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbde14-0305-0c96-0006-8fdb0016d826
[0m22:39:46.659566 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'PUBLIC'
[0m22:39:46.661560 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:39:46.663555 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '11cc986f-2a08-45b4-9309-acb40b789f22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027369A11D50>]}
[0m22:39:46.664552 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model PUBLIC.stg_fare_searches ........... [[31mERROR[0m in 4.04s]
[0m22:39:46.665550 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m22:39:46.666547 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m22:39:46.668542 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:39:46.668542 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:39:46.669539 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:39:47.020600 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_PUBLIC' was left open.
[0m22:39:47.020600 [debug] [MainThread]: On list_FLIGHT_PRICES_PUBLIC: Close
[0m22:39:47.374653 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m22:39:47.374653 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m22:39:47.727709 [info ] [MainThread]: 
[0m22:39:47.728706 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 13.94 seconds (13.94s).
[0m22:39:47.729705 [debug] [MainThread]: Command end result
[0m22:39:47.755634 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:39:47.758626 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:39:47.766605 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:39:47.767603 [info ] [MainThread]: 
[0m22:39:47.768601 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:39:47.769598 [info ] [MainThread]: 
[0m22:39:47.770595 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:39:47.771592 [info ] [MainThread]: 
[0m22:39:47.771592 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:39:47.773586 [debug] [MainThread]: Command `dbt run` failed at 22:39:47.773586 after 16.36 seconds
[0m22:39:47.774585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027369E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027366DCF4F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027369ED44C0>]}
[0m22:39:47.774585 [debug] [MainThread]: Flushing usage events
[0m22:39:48.134621 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:12:30.823143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF0651D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF07C59D80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF07C59F60>]}


============================== 15:12:30.826135 | 016d24f0-f39e-4cc6-932a-0d6ddeb1a113 ==============================
[0m15:12:30.826135 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:12:30.827133 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:12:35.853690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF074F8FA0>]}
[0m15:12:35.914527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF074FAB90>]}
[0m15:12:35.922508 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:12:36.608671 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:12:37.854340 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:12:37.855338 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\sources.yml
[0m15:12:37.856335 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m15:12:38.325081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF114500A0>]}
[0m15:12:38.449747 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:12:38.452741 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:12:38.679135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF114517B0>]}
[0m15:12:38.680132 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:12:38.680132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF10FD9B70>]}
[0m15:12:38.682126 [info ] [MainThread]: 
[0m15:12:38.683124 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:12:38.683124 [info ] [MainThread]: 
[0m15:12:38.684121 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:12:38.686116 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:12:41.118610 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:12:41.118610 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:12:41.119608 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:51.847917 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 10.728 seconds
[0m15:12:51.855896 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_PUBLIC'
[0m15:12:51.866866 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_PUBLIC"
[0m15:12:51.866866 [debug] [ThreadPool]: On list_FLIGHT_PRICES_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_PUBLIC"} */
show objects in FLIGHT_PRICES.PUBLIC limit 10000;
[0m15:12:51.867864 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:55.499152 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 3.631 seconds
[0m15:12:55.501147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF11451570>]}
[0m15:12:55.509126 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:12:55.510124 [info ] [Thread-1 (]: 1 of 1 START sql incremental model PUBLIC.stg_fare_searches .................... [RUN]
[0m15:12:55.511121 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:12:55.511121 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:12:55.521094 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:12:55.522091 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:12:55.590907 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:12:55.594897 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:12:55.595894 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')[-1]             as destination
  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:12:55.596891 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:12:59.078581 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe1f5-0305-0c96-0006-8fdb001780b2
[0m15:12:59.079578 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'PUBLIC'
[0m15:12:59.082570 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:12:59.090548 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '016d24f0-f39e-4cc6-932a-0d6ddeb1a113', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF11485060>]}
[0m15:12:59.091546 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model PUBLIC.stg_fare_searches ........... [[31mERROR[0m in 3.57s]
[0m15:12:59.092544 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:12:59.093541 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m15:12:59.095535 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:12:59.095535 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:12:59.096532 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:12:59.437620 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_PUBLIC' was left open.
[0m15:12:59.438617 [debug] [MainThread]: On list_FLIGHT_PRICES_PUBLIC: Close
[0m15:12:59.774719 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:12:59.774719 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:13:00.119796 [info ] [MainThread]: 
[0m15:13:00.120794 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 21.44 seconds (21.44s).
[0m15:13:00.121791 [debug] [MainThread]: Command end result
[0m15:13:00.150713 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:13:00.153705 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:13:00.162682 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:13:00.162682 [info ] [MainThread]: 
[0m15:13:00.164677 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:13:00.165674 [info ] [MainThread]: 
[0m15:13:00.165674 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:13:00.167669 [info ] [MainThread]: 
[0m15:13:00.168666 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:13:00.170660 [debug] [MainThread]: Command `dbt run` failed at 15:13:00.170660 after 29.43 seconds
[0m15:13:00.171657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF0651D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF074FAB90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DF11D5AC20>]}
[0m15:13:00.171657 [debug] [MainThread]: Flushing usage events
[0m15:13:00.514740 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:13:19.337403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472301D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024724756590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024724756770>]}


============================== 15:13:19.341392 | 88179b07-3376-4503-a5fd-3525ff7eca2e ==============================
[0m15:13:19.341392 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:13:19.342389 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_fare_searches', 'send_anonymous_usage_stats': 'True'}
[0m15:13:20.266917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024721497010>]}
[0m15:13:20.327755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472D05C460>]}
[0m15:13:20.329749 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:13:20.916181 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:13:21.073759 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:13:21.074756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024723DFEB60>]}
[0m15:13:22.731326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472E138130>]}
[0m15:13:22.911843 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:13:22.914836 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:13:22.936777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472DD86F50>]}
[0m15:13:22.937774 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:13:22.938773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472DD87370>]}
[0m15:13:22.940766 [info ] [MainThread]: 
[0m15:13:22.941764 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:13:22.941764 [info ] [MainThread]: 
[0m15:13:22.942761 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:13:22.944756 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:13:23.057454 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:13:23.058451 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:13:23.058451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:13:27.180428 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.122 seconds
[0m15:13:27.188407 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:13:27.199377 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:13:27.200374 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:13:27.200374 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:13:31.048084 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 3.847 seconds
[0m15:13:31.050080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472DD86D70>]}
[0m15:13:31.055066 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:13:31.056063 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m15:13:31.057062 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:13:31.057062 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:13:31.067034 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:13:31.068031 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:13:31.130863 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:13:31.134853 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:13:31.135851 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')[-1]             as destination
  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:13:31.135851 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:13:34.852909 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe1f6-0305-0c96-0006-8fdb001780ba
[0m15:13:34.852909 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
[0m15:13:34.855902 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:13:34.857896 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88179b07-3376-4503-a5fd-3525ff7eca2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247229DCD90>]}
[0m15:13:34.858894 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 3.80s]
[0m15:13:34.859891 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:13:34.860889 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m15:13:34.862883 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:13:34.863880 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:13:34.863880 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:13:35.205966 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:13:35.205966 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:13:35.558024 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:13:35.558024 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:13:35.895122 [info ] [MainThread]: 
[0m15:13:35.896120 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 12.95 seconds (12.95s).
[0m15:13:35.897118 [debug] [MainThread]: Command end result
[0m15:13:35.925042 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:13:35.929032 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:13:35.937010 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:13:35.938008 [info ] [MainThread]: 
[0m15:13:35.939006 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:13:35.940003 [info ] [MainThread]: 
[0m15:13:35.941000 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:13:35.941000 [info ] [MainThread]: 
[0m15:13:35.941997 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:13:35.943992 [debug] [MainThread]: Command `dbt run` failed at 15:13:35.943992 after 16.69 seconds
[0m15:13:35.944989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472301D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472472A530>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002472472BAC0>]}
[0m15:13:35.945987 [debug] [MainThread]: Flushing usage events
[0m15:13:36.281090 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:16:36.398912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DE11D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF856620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF856800>]}


============================== 15:16:36.402901 | d1d0af36-f7e8-42a1-92db-70a8c85e32f3 ==============================
[0m15:16:36.402901 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:16:36.403898 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_fare_searches', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:16:37.392255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF0FF040>]}
[0m15:16:37.453092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF0FCE50>]}
[0m15:16:37.455091 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:16:38.041519 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:16:38.313791 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:16:38.314788 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:16:38.389588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E89F6410>]}
[0m15:16:38.567114 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:16:38.570106 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:16:38.599029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF7F1F30>]}
[0m15:16:38.600027 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:16:38.602021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DF7F1E40>]}
[0m15:16:38.604015 [info ] [MainThread]: 
[0m15:16:38.605013 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:16:38.605013 [info ] [MainThread]: 
[0m15:16:38.607007 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:16:38.609999 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:16:38.751621 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:16:38.752618 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:16:38.752618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:16:42.825725 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.072 seconds
[0m15:16:42.833703 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:16:42.845671 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:16:42.846669 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:16:42.847666 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:16:46.682411 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 3.835 seconds
[0m15:16:46.684405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E8A07D00>]}
[0m15:16:46.689392 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:16:46.690390 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m15:16:46.691387 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:16:46.691387 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:16:46.704353 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:16:46.706348 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:16:46.769179 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:16:46.773168 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:16:46.774166 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')[-1]             as destination
  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:16:46.774166 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:16:50.815358 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe1f9-0305-0ebd-0006-8fdb001770de
[0m15:16:50.816356 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
[0m15:16:50.818350 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:16:50.821342 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd1d0af36-f7e8-42a1-92db-70a8c85e32f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E9488490>]}
[0m15:16:50.822340 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 4.13s]
[0m15:16:50.823337 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:16:50.823337 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m15:16:50.825332 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:16:50.826329 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:16:50.826329 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:16:51.166419 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:16:51.166419 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:16:51.531443 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:16:51.532441 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:16:51.882504 [info ] [MainThread]: 
[0m15:16:51.882504 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 13.27 seconds (13.27s).
[0m15:16:51.883502 [debug] [MainThread]: Command end result
[0m15:16:51.911427 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:16:51.914419 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:16:51.922398 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:16:51.923395 [info ] [MainThread]: 
[0m15:16:51.924393 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:16:51.924393 [info ] [MainThread]: 
[0m15:16:51.925390 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001852 (22023): Invalid extraction path '-1': array index -1 is off limits; must be between 0 and 2,147,483,647.
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m15:16:51.926388 [info ] [MainThread]: 
[0m15:16:51.926388 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:16:51.929379 [debug] [MainThread]: Command `dbt run` failed at 15:16:51.928382 after 15.61 seconds
[0m15:16:51.929379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DE11D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197DE1B2860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197E8273B50>]}
[0m15:16:51.930376 [debug] [MainThread]: Flushing usage events
[0m15:16:52.269469 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:17:51.375404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8951D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8AC56590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8AC56770>]}


============================== 15:17:51.379393 | 0466b346-ae25-45b6-a1a2-050501a4d28c ==============================
[0m15:17:51.379393 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:17:51.380390 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:17:52.297936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE87797010>]}
[0m15:17:52.357776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE9335C460>]}
[0m15:17:52.359771 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:17:52.939221 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:17:53.200522 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:17:53.201520 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m15:17:53.567541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE93EEF1F0>]}
[0m15:17:53.689216 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:17:53.692207 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:17:53.714149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE93DAD240>]}
[0m15:17:53.715146 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:17:53.716144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE93D88B50>]}
[0m15:17:53.718138 [info ] [MainThread]: 
[0m15:17:53.718138 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:17:53.719136 [info ] [MainThread]: 
[0m15:17:53.720134 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:17:53.721130 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:17:53.834826 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:17:53.834826 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:17:53.835824 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:57.862056 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.026 seconds
[0m15:17:57.870035 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:17:57.880009 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:17:57.881006 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:17:57.882003 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:18:01.707771 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 3.826 seconds
[0m15:18:01.709767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE93DAEF50>]}
[0m15:18:01.713756 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:18:01.714753 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m15:18:01.715751 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:18:01.716748 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:18:01.725724 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:18:01.727719 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:18:01.789553 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:18:01.792545 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:18:01.793542 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0]               as origin,
    split(SEGMENTSARRIVALAIRPORTCODE, '||')[
  array_size(split(SEGMENTSARRIVALAIRPORTCODE, '||')) - 1
] AS destination

  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:18:01.794540 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:20:47.569211 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 165.775 seconds
[0m15:20:47.577190 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m15:20:47.583173 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:20:47.584171 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m15:20:47.788624 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.204 seconds
[0m15:20:47.810566 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0466b346-ae25-45b6-a1a2-050501a4d28c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE875CD5D0>]}
[0m15:20:47.811563 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 1[0m in 166.09s]
[0m15:20:47.812560 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:20:47.813557 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:20:47.814555 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:20:47.814555 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:20:48.189552 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:20:48.190550 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:20:48.539616 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:20:48.540613 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:20:48.894666 [info ] [MainThread]: 
[0m15:20:48.895664 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 2 minutes and 55.17 seconds (175.17s).
[0m15:20:48.896662 [debug] [MainThread]: Command end result
[0m15:20:48.929574 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:20:48.932565 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:20:48.941542 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:20:48.942539 [info ] [MainThread]: 
[0m15:20:48.943536 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:20:48.943536 [info ] [MainThread]: 
[0m15:20:48.944533 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:20:48.946527 [debug] [MainThread]: Command `dbt run` succeeded at 15:20:48.945531 after 177.65 seconds
[0m15:20:48.947525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8951D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE895BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE93E5BF70>]}
[0m15:20:48.948523 [debug] [MainThread]: Flushing usage events
[0m15:20:49.304570 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:40:08.228782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE2CC1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE2E356500>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE2E3566E0>]}


============================== 15:40:08.232771 | 325ca42a-2fa5-4994-9211-efa3e884899f ==============================
[0m15:40:08.232771 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:40:08.233769 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:40:09.176248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE2E327E20>]}
[0m15:40:09.238082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE3695F400>]}
[0m15:40:09.240077 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:40:09.816536 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:40:10.089804 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:40:10.090803 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m15:40:10.455825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE37453FA0>]}
[0m15:40:10.579495 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:40:10.582488 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:40:10.604429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE373FEF80>]}
[0m15:40:10.606424 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:40:10.607421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE373FEE60>]}
[0m15:40:10.609415 [info ] [MainThread]: 
[0m15:40:10.609415 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:40:10.610413 [info ] [MainThread]: 
[0m15:40:10.611410 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:40:10.612407 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:40:10.731090 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:40:10.731090 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:40:10.732087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:40:14.914901 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.183 seconds
[0m15:40:14.922879 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:40:14.933850 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:40:14.933850 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:40:14.934848 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:40:18.457427 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 3.523 seconds
[0m15:40:18.459422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE3748E110>]}
[0m15:40:18.464409 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:40:18.465406 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m15:40:18.465406 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:40:18.466404 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:40:18.477374 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:40:18.478371 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:40:18.540206 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:40:18.543197 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:40:18.544195 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    trim(replace(
        split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0] , '\"','')
    )                                                             as origin,

-- destination (last element = length - 1)
trim(replace(
        split(
          SEGMENTSARRIVALAIRPORTCODE,'||'
        )[ array_size(split(SEGMENTSARRIVALAIRPORTCODE,'||')) - 1 ] , '\"','')
    )                                                             as destination,

  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:40:18.545192 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:43:04.841468 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 166.296 seconds
[0m15:43:04.850445 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m15:43:04.856428 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:43:04.857426 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m15:43:05.079831 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.222 seconds
[0m15:43:05.102770 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '325ca42a-2fa5-4994-9211-efa3e884899f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE372EBC40>]}
[0m15:43:05.103768 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 1[0m in 166.64s]
[0m15:43:05.104765 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:43:05.106759 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:43:05.107757 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:43:05.107757 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:43:05.496717 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:43:05.497714 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:43:05.856754 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:43:05.857752 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:43:06.205820 [info ] [MainThread]: 
[0m15:43:06.206818 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 2 minutes and 55.59 seconds (175.59s).
[0m15:43:06.207815 [debug] [MainThread]: Command end result
[0m15:43:06.235741 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:43:06.237735 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:43:06.247708 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:43:06.248706 [info ] [MainThread]: 
[0m15:43:06.248706 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:43:06.249704 [info ] [MainThread]: 
[0m15:43:06.250700 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:43:06.252696 [debug] [MainThread]: Command `dbt run` succeeded at 15:43:06.252696 after 178.11 seconds
[0m15:43:06.253692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE2CC1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE369787C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002EE3740A170>]}
[0m15:43:06.253692 [debug] [MainThread]: Flushing usage events
[0m15:43:06.609740 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:45:51.201575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EDD1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EF456560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EF456740>]}


============================== 15:45:51.205564 | 954e3633-0eb7-4468-95ae-d31a89e8c8fb ==============================
[0m15:45:51.205564 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:45:51.206562 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m15:45:52.164998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EAF97040>]}
[0m15:45:52.225835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EECFDE10>]}
[0m15:45:52.226833 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:45:52.801296 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:45:53.069579 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:45:53.070577 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:45:53.143382 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F85F64A0>]}
[0m15:45:53.314923 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:45:53.317915 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:45:53.340854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F83D32E0>]}
[0m15:45:53.341851 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:45:53.342849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F84E9210>]}
[0m15:45:53.344843 [info ] [MainThread]: 
[0m15:45:53.344843 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:45:53.345840 [info ] [MainThread]: 
[0m15:45:53.346838 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:45:53.347835 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:45:53.475493 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:45:53.476491 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:45:53.477488 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:45:58.226787 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.749 seconds
[0m15:45:58.233769 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:45:58.244740 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:45:58.244740 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:45:58.245737 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:01.887996 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 3.643 seconds
[0m15:46:01.890988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F85CF2B0>]}
[0m15:46:01.894977 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m15:46:01.895974 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m15:46:01.896972 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m15:46:01.897970 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m15:46:01.911932 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:46:01.913926 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m15:46:01.972769 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m15:46:01.976759 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:46:01.977756 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    trim(replace(
        split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0] , '\"','')
    )                                                             as origin,

-- destination (last element = length - 1)
trim(replace(
        split(
          SEGMENTSARRIVALAIRPORTCODE,'||'
        )[ array_size(split(SEGMENTSARRIVALAIRPORTCODE,'||')) - 1 ] , '\"','')
    )                                                             as destination,

  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m15:46:01.977756 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:48:45.360823 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 163.383 seconds
[0m15:48:45.369799 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m15:48:45.375783 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m15:48:45.376780 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m15:48:45.658028 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.280 seconds
[0m15:48:45.681965 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '954e3633-0eb7-4468-95ae-d31a89e8c8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EADCD600>]}
[0m15:48:45.681965 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 1[0m in 163.78s]
[0m15:48:45.683959 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m15:48:45.684956 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:45.684956 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:48:45.685954 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:48:46.178636 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:48:46.178636 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:48:46.540668 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m15:48:46.542664 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m15:48:46.888737 [info ] [MainThread]: 
[0m15:48:46.889734 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 2 minutes and 53.54 seconds (173.54s).
[0m15:48:46.890732 [debug] [MainThread]: Command end result
[0m15:48:46.918658 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:48:46.921649 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:48:46.930625 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:48:46.931622 [info ] [MainThread]: 
[0m15:48:46.932620 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:48:46.932620 [info ] [MainThread]: 
[0m15:48:46.933617 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:48:46.935612 [debug] [MainThread]: Command `dbt run` succeeded at 15:48:46.935612 after 175.81 seconds
[0m15:48:46.936610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206EDD1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F8571960>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000206F8570550>]}
[0m15:48:46.937606 [debug] [MainThread]: Flushing usage events
[0m15:48:47.279691 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:52:26.497441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F71971D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F71AE56560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F71AE56740>]}


============================== 15:52:26.500433 | ec9fdf1f-90e9-43ad-9fb1-b8b21e5b88c2 ==============================
[0m15:52:26.500433 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:52:26.501430 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select int_fare_legs', 'send_anonymous_usage_stats': 'True'}
[0m15:52:27.433936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ec9fdf1f-90e9-43ad-9fb1-b8b21e5b88c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F71AE31CC0>]}
[0m15:52:27.494773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ec9fdf1f-90e9-43ad-9fb1-b8b21e5b88c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F72365D240>]}
[0m15:52:27.496768 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:52:28.067242 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:52:28.332533 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:52:28.333531 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m15:52:28.589845 [error] [MainThread]: Encountered an error:
Compilation Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  expected token ',', got 'table'
    line 3
      materialized='table'         -- full table, rebuildable
[0m15:52:28.591840 [debug] [MainThread]: Command `dbt run` failed at 15:52:28.591840 after 2.18 seconds
[0m15:52:28.592837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F71971D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F723F0DD80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F723F0DD50>]}
[0m15:52:28.592837 [debug] [MainThread]: Flushing usage events
[0m15:52:28.937914 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:53:53.636406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F68D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F6A4565C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F6A4567A0>]}


============================== 15:53:53.640397 | d0654552-316f-4363-992b-7e19e666d062 ==============================
[0m15:53:53.640397 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:53:53.641393 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_fare_legs', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:53:54.586865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F67097040>]}
[0m15:53:54.649696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F72C5F1F0>]}
[0m15:53:54.651691 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:53:55.225158 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:53:55.486459 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:53:55.487457 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m15:53:55.841509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F735EE320>]}
[0m15:53:55.963184 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:53:55.966176 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:53:55.989115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F735FBAC0>]}
[0m15:53:55.990112 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:53:55.991110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F735FA380>]}
[0m15:53:55.993104 [info ] [MainThread]: 
[0m15:53:55.993104 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:53:55.994102 [info ] [MainThread]: 
[0m15:53:55.995100 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:53:55.996097 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:53:56.108794 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:53:56.109791 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:53:56.109791 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:00.604771 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.494 seconds
[0m15:54:00.611752 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:54:00.622723 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:54:00.623720 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:54:00.623720 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:04.698822 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 4.075 seconds
[0m15:54:04.700817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F735FB5B0>]}
[0m15:54:04.705803 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m15:54:04.706802 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m15:54:04.707799 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m15:54:04.707799 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m15:54:04.716774 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m15:54:04.718769 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m15:54:04.751681 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m15:54:04.755670 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m15:54:04.756668 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Bring in the arrays we need */
    select
        LEGID,
        dep_airport_arr,
        arr_airport_arr,
        seg_airline_arr,
        seg_dist_arr,
        seg_dur_arr
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * Use FLATTEN to explode index positions.
     * For each index, pull the matching element from every array.
     */
    select
        b.LEGID,
        f.index + 1                                                 as leg_number,

        trim(replace(b.dep_airport_arr[f.index] , '\"',''))        as departure_airport,
        trim(replace(b.arr_airport_arr[f.index] , '\"',''))        as arrival_airport,

        trim(replace(b.seg_airline_arr[f.index] ,  '\"',''))       as operating_carrier,

        /* distance & duration arrays may contain blanks—try_to_number keeps nulls */
        try_to_number( trim(replace(b.seg_dist_arr[f.index],'\"','')) ) as leg_distance,
        try_to_number( trim(replace(b.seg_dur_arr[f.index] ,'\"','')) ) as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f

)

select
    LEGID,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened;
[0m15:54:04.757666 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:54:08.798858 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe21e-0305-0bb1-0006-8fdb001790fe
[0m15:54:08.798858 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 49 at position 14 unexpected ';'.
[0m15:54:08.801849 [debug] [Thread-1 (]: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 49 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m15:54:08.803844 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0654552-316f-4363-992b-7e19e666d062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F742FC100>]}
[0m15:54:08.804842 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_fare_legs .............. [[31mERROR[0m in 4.10s]
[0m15:54:08.805839 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m15:54:08.806836 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_fare_legs' to be skipped because of status 'error'.  Reason: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 49 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql.
[0m15:54:08.807834 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:08.808831 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:54:08.808831 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:54:09.164878 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:54:09.165876 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:54:09.501977 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m15:54:09.501977 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m15:54:09.842068 [info ] [MainThread]: 
[0m15:54:09.842068 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.85 seconds (13.85s).
[0m15:54:09.843065 [debug] [MainThread]: Command end result
[0m15:54:09.869994 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:54:09.871988 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:54:09.880964 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:54:09.881962 [info ] [MainThread]: 
[0m15:54:09.882959 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:54:09.883957 [info ] [MainThread]: 
[0m15:54:09.884953 [error] [MainThread]:   Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 49 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m15:54:09.885951 [info ] [MainThread]: 
[0m15:54:09.885951 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:54:09.887946 [debug] [MainThread]: Command `dbt run` failed at 15:54:09.887946 after 16.33 seconds
[0m15:54:09.888943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F68D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F735E3BB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F68DD44C0>]}
[0m15:54:09.888943 [debug] [MainThread]: Flushing usage events
[0m15:54:10.231027 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:54:55.542851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4E61D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4FD56560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4FD56740>]}


============================== 15:54:55.546840 | b19e6b62-8293-45bc-bc0b-5bcf56376821 ==============================
[0m15:54:55.546840 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:54:55.547838 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select int_fare_legs', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:54:56.443442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4CA97070>]}
[0m15:54:56.502285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4F3FDBD0>]}
[0m15:54:56.504280 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m15:54:57.074754 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m15:54:57.343036 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:54:57.343036 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m15:54:57.691105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED58FEE320>]}
[0m15:54:57.808791 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:54:57.811783 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:54:57.834722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED58FFB430>]}
[0m15:54:57.834722 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m15:54:57.835720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED58FFA3B0>]}
[0m15:54:57.837714 [info ] [MainThread]: 
[0m15:54:57.838711 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:54:57.838711 [info ] [MainThread]: 
[0m15:54:57.839709 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m15:54:57.840706 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m15:54:57.950412 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m15:54:57.951409 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m15:54:57.952408 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:55:02.407493 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.456 seconds
[0m15:55:02.415471 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m15:55:02.428438 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m15:55:02.430432 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m15:55:02.430432 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:55:06.188383 [debug] [ThreadPool]: SQL status: SUCCESS 2 in 3.758 seconds
[0m15:55:06.191375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED58FF8460>]}
[0m15:55:06.198355 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m15:55:06.199352 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m15:55:06.200350 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m15:55:06.200350 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m15:55:06.209326 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m15:55:06.210323 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m15:55:06.242237 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m15:55:06.245230 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m15:55:06.245230 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Bring in the arrays we need */
    select
        LEGID,
        dep_airport_arr,
        arr_airport_arr,
        seg_airline_arr,
        seg_dist_arr,
        seg_dur_arr
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * Use FLATTEN to explode index positions.
     * For each index, pull the matching element from every array.
     */
    select
        b.LEGID,
        f.index + 1                                                 as leg_number,

        trim(replace(b.dep_airport_arr[f.index] , '\"',''))        as departure_airport,
        trim(replace(b.arr_airport_arr[f.index] , '\"',''))        as arrival_airport,

        trim(replace(b.seg_airline_arr[f.index] ,  '\"',''))       as operating_carrier,

        /* distance & duration arrays may contain blanks—try_to_number keeps nulls */
        try_to_number( trim(replace(b.seg_dist_arr[f.index],'\"','')) ) as leg_distance,
        try_to_number( trim(replace(b.seg_dur_arr[f.index] ,'\"','')) ) as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f

)

select
    LEGID,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened
        );
[0m15:55:06.246227 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m15:56:41.080141 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 94.834 seconds
[0m15:56:41.105075 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b19e6b62-8293-45bc-bc0b-5bcf56376821', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4C6CD630>]}
[0m15:56:41.106072 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_fare_legs .................. [[32mSUCCESS 1[0m in 94.90s]
[0m15:56:41.107069 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m15:56:41.109066 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:56:41.109066 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m15:56:41.110061 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m15:56:41.464114 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m15:56:41.464114 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m15:56:41.813181 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m15:56:41.814178 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m15:56:42.160252 [info ] [MainThread]: 
[0m15:56:42.161251 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 44.32 seconds (104.32s).
[0m15:56:42.162248 [debug] [MainThread]: Command end result
[0m15:56:42.191169 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m15:56:42.195159 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m15:56:42.203138 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m15:56:42.204135 [info ] [MainThread]: 
[0m15:56:42.206130 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:56:42.206130 [info ] [MainThread]: 
[0m15:56:42.207127 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:56:42.209121 [debug] [MainThread]: Command `dbt run` succeeded at 15:56:42.209121 after 106.74 seconds
[0m15:56:42.209121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4E61D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4D1A0C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED4E6B1030>]}
[0m15:56:42.211117 [debug] [MainThread]: Flushing usage events
[0m15:56:42.575142 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:41:46.881589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E971D1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E973459C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E973459E40>]}


============================== 16:41:46.886576 | 4845e3dc-d2da-4249-ac54-362ae3af71b0 ==============================
[0m16:41:46.886576 [info ] [MainThread]: Running with dbt=1.9.4
[0m16:41:46.887574 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_daily_prices', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:41:47.987631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E973433E20>]}
[0m16:41:48.069412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97BB5F400>]}
[0m16:41:48.070409 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m16:41:48.730655 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m16:41:49.089694 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:41:49.091690 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m16:41:49.516061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97C6EE410>]}
[0m16:41:49.648706 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:41:49.651698 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:41:49.679624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97C5870D0>]}
[0m16:41:49.680621 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m16:41:49.681618 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97C587130>]}
[0m16:41:49.683612 [info ] [MainThread]: 
[0m16:41:49.684610 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:41:49.684610 [info ] [MainThread]: 
[0m16:41:49.686605 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:41:49.689598 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m16:41:49.845198 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m16:41:49.846196 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m16:41:49.846196 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:41:57.371704 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 7.525 seconds
[0m16:41:57.379682 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m16:41:57.391651 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m16:41:57.392648 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m16:41:57.392648 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:42:01.576022 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.183 seconds
[0m16:42:01.579006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97C585AB0>]}
[0m16:42:01.583992 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m16:42:01.584990 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m16:42:01.585988 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m16:42:01.586985 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m16:42:01.595960 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:42:01.596958 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m16:42:01.634856 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:42:01.638846 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m16:42:01.638846 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

    select
        origin,
        destination,
        -- Define a route key in lexicographic order so JFK-LAX and LAX-JFK stay distinct
        origin || '-' || destination                   as route,

        /* bucket days_to_flight */
        case
            when days_to_flight between  0 and  3 then '00-03'
            when days_to_flight between  4 and  7 then '04-07'
            when days_to_flight between  8 and 29 then '08-29'
            else                                         '30+'
        end                                            as dtf_bucket,

        flight_date,
        search_date,
        marketing_carrier,        --  add if you have a dedicated carrier field; otherwise use FAREBASIS or SEG_AIRLINE_ARR[0]
        total_fare,
        base_fare,
        total_fare / nullif(base_fare,0)               as total_base_ratio

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

    select
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date,                    -- keep flight_date so we can compare like-for-like departures
        count(*)                        as obs,
        median(total_fare)              as median_fare,
        percentile_cont(0.95) within group (order by total_fare) as p95_fare,
        median(total_base_ratio)        as median_ratio,
        percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio
    from base
    group by
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date
)

select * from agg;
[0m16:42:01.639843 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:42:05.870108 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe24e-0305-0bb1-0006-8fdb0017917a
[0m16:42:05.871106 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 52 at position 17 unexpected ';'.
[0m16:42:05.874098 [debug] [Thread-1 (]: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 52 at position 17 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:42:05.876092 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4845e3dc-d2da-4249-ac54-362ae3af71b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97D4018D0>]}
[0m16:42:05.877090 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_daily_prices ..... [[31mERROR[0m in 4.29s]
[0m16:42:05.878088 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m16:42:05.879085 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_daily_prices' to be skipped because of status 'error'.  Reason: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 52 at position 17 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql.
[0m16:42:05.881080 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:42:05.882077 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m16:42:05.882077 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m16:42:06.219175 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m16:42:06.219175 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m16:42:06.552284 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m16:42:06.552284 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m16:42:06.886403 [info ] [MainThread]: 
[0m16:42:06.887400 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 17.20 seconds (17.20s).
[0m16:42:06.889396 [debug] [MainThread]: Command end result
[0m16:42:06.918317 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:42:06.922307 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:42:06.932281 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m16:42:06.933278 [info ] [MainThread]: 
[0m16:42:06.934275 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:42:06.934275 [info ] [MainThread]: 
[0m16:42:06.935272 [error] [MainThread]:   Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 52 at position 17 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:42:06.936270 [info ] [MainThread]: 
[0m16:42:06.937267 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:42:06.940259 [debug] [MainThread]: Command `dbt run` failed at 16:42:06.940259 after 20.18 seconds
[0m16:42:06.941256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E971D1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E97C6B7070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E971DD43D0>]}
[0m16:42:06.942254 [debug] [MainThread]: Flushing usage events
[0m16:42:07.278354 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:44:01.367139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C694E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6965562C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6965560E0>]}


============================== 16:44:01.371129 | 319c13cf-2453-4753-a34d-cabbc5ee1555 ==============================
[0m16:44:01.371129 [info ] [MainThread]: Running with dbt=1.9.4
[0m16:44:01.372126 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_route_daily_prices', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:44:02.329579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C696525CC0>]}
[0m16:44:02.393409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69EB5F820>]}
[0m16:44:02.394406 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m16:44:02.991821 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m16:44:03.271592 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:44:03.271592 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m16:44:03.638610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69F7EE320>]}
[0m16:44:03.767267 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:44:03.769261 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:44:03.792201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69F7F9F30>]}
[0m16:44:03.793197 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m16:44:03.794195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69F7F9F90>]}
[0m16:44:03.796189 [info ] [MainThread]: 
[0m16:44:03.797188 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:44:03.798184 [info ] [MainThread]: 
[0m16:44:03.798184 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:44:03.800179 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m16:44:03.915870 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m16:44:03.916867 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m16:44:03.917864 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:07.293407 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.376 seconds
[0m16:44:07.301386 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m16:44:07.313354 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m16:44:07.313354 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m16:44:07.314351 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:11.270806 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.956 seconds
[0m16:44:11.272801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69F7F88E0>]}
[0m16:44:11.277788 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m16:44:11.278785 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m16:44:11.279783 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m16:44:11.279783 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m16:44:11.289757 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:44:11.291752 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m16:44:11.323172 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:44:11.326164 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m16:44:11.327161 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

    select
        origin,
        destination,
        -- Define a route key in lexicographic order so JFK-LAX and LAX-JFK stay distinct
        origin || '-' || destination                   as route,

        /* bucket days_to_flight */
        case
            when days_to_flight between  0 and  3 then '00-03'
            when days_to_flight between  4 and  7 then '04-07'
            when days_to_flight between  8 and 29 then '08-29'
            else                                         '30+'
        end                                            as dtf_bucket,

        flight_date,
        search_date,
        marketing_carrier,        --  add if you have a dedicated carrier field; otherwise use FAREBASIS or SEG_AIRLINE_ARR[0]
        total_fare,
        base_fare,
        total_fare / nullif(base_fare,0)               as total_base_ratio

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

    select
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date,                    -- keep flight_date so we can compare like-for-like departures
        count(*)                        as obs,
        median(total_fare)              as median_fare,
        percentile_cont(0.95) within group (order by total_fare) as p95_fare,
        median(total_base_ratio)        as median_ratio,
        percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio
    from base
    group by
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date
)

select * from agg
        );
[0m16:44:11.328159 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:44:15.299621 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe250-0305-0c98-0006-8fdb001762fe
[0m16:44:15.300619 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 23 at position 8
invalid identifier 'MARKETING_CARRIER'
[0m16:44:15.303610 [debug] [Thread-1 (]: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 23 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:44:15.306603 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '319c13cf-2453-4753-a34d-cabbc5ee1555', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A04FCF70>]}
[0m16:44:15.307600 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_daily_prices ..... [[31mERROR[0m in 4.02s]
[0m16:44:15.308598 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m16:44:15.309594 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_daily_prices' to be skipped because of status 'error'.  Reason: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 23 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql.
[0m16:44:15.311589 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:44:15.311589 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m16:44:15.312586 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m16:44:15.650682 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m16:44:15.651680 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m16:44:16.006239 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m16:44:16.006239 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m16:44:16.337858 [info ] [MainThread]: 
[0m16:44:16.337858 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.54 seconds (12.54s).
[0m16:44:16.339853 [debug] [MainThread]: Command end result
[0m16:44:16.366780 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:44:16.369773 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:44:16.377751 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m16:44:16.378749 [info ] [MainThread]: 
[0m16:44:16.380744 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:44:16.381741 [info ] [MainThread]: 
[0m16:44:16.381741 [error] [MainThread]:   Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 23 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:44:16.382738 [info ] [MainThread]: 
[0m16:44:16.383735 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:44:16.385730 [debug] [MainThread]: Command `dbt run` failed at 16:44:16.385730 after 15.10 seconds
[0m16:44:16.386727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C694E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69EB5F820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C694ED77F0>]}
[0m16:44:16.387725 [debug] [MainThread]: Flushing usage events
[0m16:44:16.725339 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:48:19.356898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB8F91D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB91056320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB91056140>]}


============================== 16:48:19.361886 | d98734c9-9a18-455d-b34f-83d92f350d50 ==============================
[0m16:48:19.361886 [info ] [MainThread]: Running with dbt=1.9.4
[0m16:48:19.363880 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_route_daily_prices', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:48:20.493874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB8DB97010>]}
[0m16:48:20.585628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9975C460>]}
[0m16:48:20.587623 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m16:48:21.240384 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m16:48:21.695675 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:48:21.696672 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m16:48:22.155968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9A2EE380>]}
[0m16:48:22.282629 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:48:22.285622 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:48:22.317537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9A2F9F60>]}
[0m16:48:22.317537 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m16:48:22.318534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9A2F9FF0>]}
[0m16:48:22.320529 [info ] [MainThread]: 
[0m16:48:22.321526 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:48:22.322524 [info ] [MainThread]: 
[0m16:48:22.324519 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:48:22.326513 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m16:48:22.482097 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m16:48:22.482097 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m16:48:22.483094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:48:27.371127 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.888 seconds
[0m16:48:27.379105 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m16:48:27.391073 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m16:48:27.392070 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m16:48:27.392070 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:48:31.203408 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.811 seconds
[0m16:48:31.206400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9A2F8700>]}
[0m16:48:31.211386 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m16:48:31.211386 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m16:48:31.212384 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m16:48:31.213381 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m16:48:31.224351 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:48:31.226346 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m16:48:31.262249 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:48:31.266239 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m16:48:31.267237 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

    select
        origin,
        destination,
        -- Define a route key in lexicographic order so JFK-LAX and LAX-JFK stay distinct
        origin || '-' || destination                   as route,

        /* bucket days_to_flight */
        case
            when days_to_flight between  0 and  3 then '00-03'
            when days_to_flight between  4 and  7 then '04-07'
            when days_to_flight between  8 and 29 then '08-29'
            else                                         '30+'
        end                                            as dtf_bucket,

        flight_date,
        search_date,
        trim(both '"' from seg_airline_name_arr[0]) AS marketing_carrier,
        total_fare,
        base_fare,
        total_fare / nullif(base_fare,0)               as total_base_ratio

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

    select
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date,                    -- keep flight_date so we can compare like-for-like departures
        count(*)                        as obs,
        median(total_fare)              as median_fare,
        percentile_cont(0.95) within group (order by total_fare) as p95_fare,
        median(total_base_ratio)        as median_ratio,
        percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio
    from base
    group by
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date
)

select * from agg
        );
[0m16:48:31.268234 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:48:34.870665 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe255-0305-0bd9-0006-8fdb00175d4e
[0m16:48:34.871662 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 23 at position 18 unexpected ''"''.
syntax error line 23 at position 18 unexpected ''"''.
syntax error line 23 at position 52 unexpected 'AS'.
[0m16:48:34.874655 [debug] [Thread-1 (]: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 52 unexpected 'AS'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:48:34.877646 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd98734c9-9a18-455d-b34f-83d92f350d50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9ADFD630>]}
[0m16:48:34.878643 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_daily_prices ..... [[31mERROR[0m in 3.66s]
[0m16:48:34.879641 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m16:48:34.882633 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_daily_prices' to be skipped because of status 'error'.  Reason: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 52 unexpected 'AS'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql.
[0m16:48:34.884627 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:48:34.884627 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m16:48:34.885625 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m16:48:35.247178 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m16:48:35.248175 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m16:48:35.608718 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m16:48:35.609716 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m16:48:35.944818 [info ] [MainThread]: 
[0m16:48:35.945816 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.62 seconds (13.62s).
[0m16:48:35.949805 [debug] [MainThread]: Command end result
[0m16:48:35.986707 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:48:35.991694 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:48:36.004659 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m16:48:36.005656 [info ] [MainThread]: 
[0m16:48:36.006653 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:48:36.009646 [info ] [MainThread]: 
[0m16:48:36.010643 [error] [MainThread]:   Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  001003 (42000): SQL compilation error:
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 18 unexpected ''"''.
  syntax error line 23 at position 52 unexpected 'AS'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m16:48:36.011640 [info ] [MainThread]: 
[0m16:48:36.012637 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:48:36.016627 [debug] [MainThread]: Command `dbt run` failed at 16:48:36.016627 after 16.81 seconds
[0m16:48:36.017624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB8F91D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB8F12F790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB9975FE80>]}
[0m16:48:36.018621 [debug] [MainThread]: Flushing usage events
[0m16:48:36.362207 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:52:57.202152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E44C1D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E46156650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E46156830>]}


============================== 16:52:57.207138 | 1567d5b4-c4f2-42c1-824f-ff1fb656573e ==============================
[0m16:52:57.207138 [info ] [MainThread]: Running with dbt=1.9.4
[0m16:52:57.207138 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_route_daily_prices', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:52:58.326179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4EA5C640>]}
[0m16:52:58.390004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4EA5E3B0>]}
[0m16:52:58.391001 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m16:52:59.120557 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m16:52:59.433225 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:52:59.434223 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m16:52:59.853609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4F3EE2F0>]}
[0m16:52:59.991747 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:52:59.995736 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:53:00.024659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4F285000>]}
[0m16:53:00.025656 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m16:53:00.026654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4F286E60>]}
[0m16:53:00.028648 [info ] [MainThread]: 
[0m16:53:00.029645 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m16:53:00.029645 [info ] [MainThread]: 
[0m16:53:00.030643 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m16:53:00.032637 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m16:53:00.152336 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m16:53:00.153333 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m16:53:00.153333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:53:05.809785 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.656 seconds
[0m16:53:05.817763 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m16:53:05.829731 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m16:53:05.830729 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m16:53:05.831726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:53:09.527890 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.696 seconds
[0m16:53:09.530882 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4F285C30>]}
[0m16:53:09.534872 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m16:53:09.535869 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m16:53:09.536867 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m16:53:09.537864 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m16:53:09.546839 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:53:09.547838 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m16:53:09.580749 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m16:53:09.583741 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m16:53:09.583741 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

    select
        origin,
        destination,
        -- Define a route key in lexicographic order so JFK-LAX and LAX-JFK stay distinct
        origin || '-' || destination                   as route,

        /* bucket days_to_flight */
        case
            when days_to_flight between  0 and  3 then '00-03'
            when days_to_flight between  4 and  7 then '04-07'
            when days_to_flight between  8 and 29 then '08-29'
            else                                         '30+'
        end                                            as dtf_bucket,

        flight_date,
        search_date,
        replace(seg_airline_arr[0], '"', '') AS marketing_carrier,
        total_fare,
        base_fare,
        total_fare / nullif(base_fare,0)               as total_base_ratio

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

    select
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date,                    -- keep flight_date so we can compare like-for-like departures
        count(*)                        as obs,
        median(total_fare)              as median_fare,
        percentile_cont(0.95) within group (order by total_fare) as p95_fare,
        median(total_base_ratio)        as median_ratio,
        percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio
    from base
    group by
        route,
        marketing_carrier,
        dtf_bucket,
        flight_date
)

select * from agg
        );
[0m16:53:09.584738 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m16:53:46.732506 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 37.148 seconds
[0m16:53:46.768410 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1567d5b4-c4f2-42c1-824f-ff1fb656573e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E42ACD540>]}
[0m16:53:46.769407 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_daily_prices ......... [[32mSUCCESS 1[0m in 37.23s]
[0m16:53:46.772401 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m16:53:46.774394 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:53:46.775392 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m16:53:46.775392 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m16:53:47.146399 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m16:53:47.147397 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m16:53:47.505944 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m16:53:47.506941 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m16:53:47.877461 [info ] [MainThread]: 
[0m16:53:47.878458 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 47.85 seconds (47.85s).
[0m16:53:47.881450 [debug] [MainThread]: Command end result
[0m16:53:47.932821 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m16:53:47.943792 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m16:53:47.999643 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m16:53:48.002635 [info ] [MainThread]: 
[0m16:53:48.052013 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:53:48.094898 [info ] [MainThread]: 
[0m16:53:48.102876 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:53:48.150749 [debug] [MainThread]: Command `dbt run` succeeded at 16:53:48.150749 after 51.03 seconds
[0m16:53:48.156733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E44C1D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E4F3B8D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012E42F7BF40>]}
[0m16:53:48.163714 [debug] [MainThread]: Flushing usage events
[0m16:53:48.525761 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:05:32.787908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2421D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C259564D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C259566B0>]}


============================== 17:05:32.791897 | 51ace858-7d3c-446d-aa89-44a94da0eca7 ==============================
[0m17:05:32.791897 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:05:32.792896 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:05:33.737381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2592BDF0>]}
[0m17:05:33.801212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C25792D70>]}
[0m17:05:33.803205 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:05:34.390140 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:05:34.660418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:05:34.661417 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:05:35.046400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2EA7D4E0>]}
[0m17:05:35.171571 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:05:35.174563 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:05:35.198007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2EBE24D0>]}
[0m17:05:35.199005 [info ] [MainThread]: Found 9 models, 1 analysis, 3 seeds, 1 source, 474 macros
[0m17:05:35.199005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2EBE3190>]}
[0m17:05:35.200999 [info ] [MainThread]: 
[0m17:05:35.201996 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:05:35.202994 [info ] [MainThread]: 
[0m17:05:35.203991 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:05:35.204989 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:05:35.319682 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:05:35.320679 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:05:35.321677 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:05:43.493437 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 8.172 seconds
[0m17:05:43.502413 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:05:43.513383 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:05:43.513383 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:05:43.514381 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:05:47.063943 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.550 seconds
[0m17:05:47.066935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2EBE1E70>]}
[0m17:05:47.070925 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:05:47.071922 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:05:47.072920 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:05:47.073917 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:05:47.084887 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:05:47.086883 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:05:47.157693 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:05:47.162679 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:05:47.163677 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (

-- 1. Pull from the raw source
with raw as (
  select
    LEGID,
    SEARCHDATE,
    FLIGHTDATE,
    TOTALFARE,
    BASEFARE,
    ISNONSTOP,
    ISBASICECONOMY,
    ISREFUNDABLE,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,
    -- keep all segment columns
    SEGMENTSDEPARTUREAIRPORTCODE,
    SEGMENTSARRIVALAIRPORTCODE,
    SEGMENTSAIRLINECODE,
    SEGMENTSEQUIPMENTDESCRIPTION,
    SEGMENTSDISTANCE,
    SEGMENTSDURATIONINSECONDS,
    SEGMENTSCABINCODE
  from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
),

-- 2. Parse + derive
transformed as (
  select
    LEGID,
    to_date(SEARCHDATE)                           as search_date,
    to_date(FLIGHTDATE)                           as flight_date,
    datediff('day', 
      to_date(SEARCHDATE),
      to_date(FLIGHTDATE)
    )                                             as days_to_flight,
    cast(TOTALFARE  as numeric)                   as total_fare,
    cast(BASEFARE   as numeric)                   as base_fare,
    ISNONSTOP                                      as is_nonstop_flag,
    ISBASICECONOMY                                 as is_basic_economy,
    ISREFUNDABLE                                   as is_refundable,
    FAREBASISCODE,
    TOTALTRAVELDISTANCE,
    TRAVELDURATION,

    -- split pipe-delimited legs into arrays
    split(SEGMENTSDEPARTUREAIRPORTCODE, '||')      as dep_airport_arr,
    split(SEGMENTSARRIVALAIRPORTCODE,   '||')      as arr_airport_arr,
    split(SEGMENTSAIRLINECODE,          '||')      as seg_airline_arr,
    split(SEGMENTSDISTANCE,             '||')      as seg_dist_arr,
    split(SEGMENTSDURATIONINSECONDS,    '||')      as seg_dur_arr,
    split(SEGMENTSEQUIPMENTDESCRIPTION, '||')      as seg_equip_arr,
    split(SEGMENTSCABINCODE,            '||')      as seg_cabin_arr,

    -- derive stops, origin & destination
    array_size(split(SEGMENTSDEPARTUREAIRPORTCODE,'||')) - 1   as segment_count,
    trim(replace(
        split(SEGMENTSDEPARTUREAIRPORTCODE,'||')[0] , '\"','')
    )                                                             as origin,

    -- destination (last element = length - 1)
    trim(replace(
            split(
              SEGMENTSARRIVALAIRPORTCODE,'||'
            )[ array_size(split(SEGMENTSARRIVALAIRPORTCODE,'||')) - 1 ] , '\"','')
        )                                                             as destination,
    trim(replace(seg_airline_arr[0], '"', ''))      as marketing_carrier,

  from raw
  where 
    -- only keep sensible bookings
    TOTALFARE  is not null
    and BASEFARE is not null
    and try_to_date(SEARCHDATE) is not null
    and try_to_date(FLIGHTDATE) is not null
    and datediff('day', to_date(SEARCHDATE), to_date(FLIGHTDATE)) >= 0
),

-- 3. Incremental filter: only new search_dates
filtered as (
  select * from transformed
  
)

-- 4. Emit final staging rows
select * from filtered
        );
[0m17:05:47.164674 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:09:18.984934 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 211.820 seconds
[0m17:09:18.992912 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m17:09:18.999894 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:09:18.999894 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m17:09:19.218310 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.218 seconds
[0m17:09:19.243243 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '51ace858-7d3c-446d-aa89-44a94da0eca7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C222CD630>]}
[0m17:09:19.244241 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 1[0m in 212.17s]
[0m17:09:19.245750 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:09:19.246742 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:09:19.247739 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:09:19.247739 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:09:20.365759 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:09:20.366756 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:09:21.460852 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:09:21.461851 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:09:21.816900 [info ] [MainThread]: 
[0m17:09:21.817899 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 3 minutes and 46.61 seconds (226.61s).
[0m17:09:21.818896 [debug] [MainThread]: Command end result
[0m17:09:21.845823 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:09:21.849814 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:09:21.858790 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:09:21.858790 [info ] [MainThread]: 
[0m17:09:21.859786 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:09:21.861782 [info ] [MainThread]: 
[0m17:09:21.861782 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:09:21.863776 [debug] [MainThread]: Command `dbt run` succeeded at 17:09:21.863776 after 229.16 seconds
[0m17:09:21.864773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2421D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C258F0FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C2E60CA60>]}
[0m17:09:21.865770 [debug] [MainThread]: Flushing usage events
[0m17:09:22.211353 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:22:44.971920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8E11D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8F859CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8F859EA0>]}


============================== 17:22:44.975909 | a110bdbd-379c-4021-9462-d3d95e3a4099 ==============================
[0m17:22:44.975909 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:22:44.976907 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt seed --select carrier_mapping', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:22:45.983719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a110bdbd-379c-4021-9462-d3d95e3a4099', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8F832EF0>]}
[0m17:22:46.045553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a110bdbd-379c-4021-9462-d3d95e3a4099', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE97F59240>]}
[0m17:22:46.046551 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:22:46.665920 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:22:46.846438 [error] [MainThread]: Encountered an error:
Parsing Error
  The schema file at models\schema.yml is invalid because the value of 'seeds' is not a list
[0m17:22:46.849430 [debug] [MainThread]: Command `dbt seed` failed at 17:22:46.848433 after 1.96 seconds
[0m17:22:46.849430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE8E11D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE9897E2F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CE9897E440>]}
[0m17:22:46.850428 [debug] [MainThread]: Flushing usage events
[0m17:22:47.217445 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:29:42.224701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A3591D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A37059D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A37059F00>]}


============================== 17:29:42.227693 | e82ad886-6386-4eb4-ae97-54dc7f2996c0 ==============================
[0m17:29:42.227693 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:29:42.228691 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt seed --select carrier_mapping', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:29:43.160215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e82ad886-6386-4eb4-ae97-54dc7f2996c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A37029CF0>]}
[0m17:29:43.225042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e82ad886-6386-4eb4-ae97-54dc7f2996c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A36E93550>]}
[0m17:29:43.227036 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:29:43.822457 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:29:43.988518 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:29:43.989516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'e82ad886-6386-4eb4-ae97-54dc7f2996c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A368FD540>]}
[0m17:29:44.005982 [error] [MainThread]: Encountered an error:
Parsing Error
  The schema file at models\schema.yml is invalid because the value of 'seeds' is not a list
[0m17:29:44.009971 [debug] [MainThread]: Command `dbt seed` failed at 17:29:44.009971 after 1.87 seconds
[0m17:29:44.010969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A3591D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A40070C10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A40070BE0>]}
[0m17:29:44.011966 [debug] [MainThread]: Flushing usage events
[0m17:29:44.360046 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:29:57.378925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232ECC1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232EE159D80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232EE159F60>]}


============================== 17:29:57.382914 | c8b26fb7-ccb6-41c0-b94a-54265c586830 ==============================
[0m17:29:57.382914 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:29:57.383911 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt seed --select carrier_mapping', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:29:58.292989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c8b26fb7-ccb6-41c0-b94a-54265c586830', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232ED7FCDC0>]}
[0m17:29:58.353826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c8b26fb7-ccb6-41c0-b94a-54265c586830', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232F6A5FB50>]}
[0m17:29:58.354824 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:29:58.937277 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:29:59.086877 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:29:59.087875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'c8b26fb7-ccb6-41c0-b94a-54265c586830', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232ED7FD4E0>]}
[0m17:29:59.103831 [error] [MainThread]: Encountered an error:
Parsing Error
  The schema file at models\schema.yml is invalid because the value of 'seeds' is not a list
[0m17:29:59.105827 [debug] [MainThread]: Command `dbt seed` failed at 17:29:59.105827 after 1.81 seconds
[0m17:29:59.106824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232ECC1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232F7270AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232F7270B80>]}
[0m17:29:59.107821 [debug] [MainThread]: Flushing usage events
[0m17:29:59.481821 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:31:42.335811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE691D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE805A530>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE805A350>]}


============================== 17:31:42.339800 | 607b2332-4d28-4815-b687-ef878d063534 ==============================
[0m17:31:42.339800 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:31:42.340799 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt ls --resource-type seed', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:31:43.249878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '607b2332-4d28-4815-b687-ef878d063534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFF0861060>]}
[0m17:31:43.309225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '607b2332-4d28-4815-b687-ef878d063534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE7EBCDF0>]}
[0m17:31:43.310223 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:31:43.887690 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:31:44.031810 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:31:44.032808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '607b2332-4d28-4815-b687-ef878d063534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE78FD4E0>]}
[0m17:31:44.046770 [error] [MainThread]: Encountered an error:
Parsing Error
  The schema file at models\schema.yml is invalid because the value of 'seeds' is not a list
[0m17:31:44.048766 [debug] [MainThread]: Command `dbt ls` failed at 17:31:44.048766 after 1.80 seconds
[0m17:31:44.049763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFE691D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFF106CFA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CFF106CF70>]}
[0m17:31:44.049763 [debug] [MainThread]: Flushing usage events
[0m17:31:44.406315 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:33:05.077904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E495A1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4971564A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E497156680>]}


============================== 17:33:05.080896 | a911ee8b-363e-4c54-a0f9-f352e2bbc8a3 ==============================
[0m17:33:05.080896 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:33:05.081893 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt ls --resource-type seed', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:33:05.996954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E49F7AD210>]}
[0m17:33:06.059786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E49F760FA0>]}
[0m17:33:06.061781 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:33:06.637253 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:33:06.782876 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:33:06.783873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4967FEB60>]}
[0m17:33:08.645919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4A08AEBC0>]}
[0m17:33:08.788537 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:33:08.791528 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:33:08.820452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4A08B2350>]}
[0m17:33:08.821449 [info ] [MainThread]: Found 10 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:33:08.822447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a911ee8b-363e-4c54-a0f9-f352e2bbc8a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4A08B22F0>]}
[0m17:33:08.823443 [info ] [MainThread]: fair_pricing_radar.carrier_mapping
[0m17:33:08.825438 [debug] [MainThread]: Command `dbt ls` succeeded at 17:33:08.825438 after 3.83 seconds
[0m17:33:08.825438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E495A1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4A016FEE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E4A08AE500>]}
[0m17:33:08.826435 [debug] [MainThread]: Flushing usage events
[0m17:33:09.167523 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:33:35.344948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F631D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7A5A2F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7A5A110>]}


============================== 17:33:35.349935 | 22579abf-9a05-4611-902b-e288b393aed9 ==============================
[0m17:33:35.349935 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:33:35.350933 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt seed --select carrier_mapping', 'send_anonymous_usage_stats': 'True'}
[0m17:33:36.284448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7A25CF0>]}
[0m17:33:36.345285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7893550>]}
[0m17:33:36.346282 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:33:36.916276 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:33:37.204505 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:33:37.204505 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:33:37.340142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002518015F0D0>]}
[0m17:33:37.485259 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:33:37.487254 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:33:37.518171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251804CE500>]}
[0m17:33:37.519169 [info ] [MainThread]: Found 10 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:33:37.520166 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025180BCD270>]}
[0m17:33:37.521163 [info ] [MainThread]: 
[0m17:33:37.522161 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:33:37.523158 [info ] [MainThread]: 
[0m17:33:37.524155 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:33:37.525153 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:33:37.665776 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:33:37.666774 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:33:37.667771 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:33:42.443581 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.777 seconds
[0m17:33:42.451559 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:33:42.461533 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:33:42.462530 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:33:42.463528 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:33:46.258904 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.795 seconds
[0m17:33:46.260899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251801A7F40>]}
[0m17:33:46.265886 [debug] [Thread-1 (]: Began running node seed.fair_pricing_radar.carrier_mapping
[0m17:33:46.266883 [info ] [Thread-1 (]: 1 of 1 START seed file WALRUS_PUBLIC.carrier_mapping ........................... [RUN]
[0m17:33:46.267881 [debug] [Thread-1 (]: Acquiring new snowflake connection 'seed.fair_pricing_radar.carrier_mapping'
[0m17:33:46.267881 [debug] [Thread-1 (]: Began compiling node seed.fair_pricing_radar.carrier_mapping
[0m17:33:46.268878 [debug] [Thread-1 (]: Began executing node seed.fair_pricing_radar.carrier_mapping
[0m17:33:46.303784 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.carrier_mapping"
[0m17:33:46.304782 [debug] [Thread-1 (]: On seed.fair_pricing_radar.carrier_mapping: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.carrier_mapping"} */
create table FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping (code text,name text)
[0m17:33:46.305779 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:33:50.147064 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.842 seconds
[0m17:33:50.161026 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.carrier_mapping"
[0m17:33:50.162024 [debug] [Thread-1 (]: On seed.fair_pricing_radar.carrier_mapping: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.carrier_mapping"} */
BEGIN
[0m17:33:50.376451 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.214 seconds
[0m17:33:50.377449 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.carrier_mapping"
[0m17:33:50.378446 [debug] [Thread-1 (]: On seed.fair_pricing_radar.carrier_mapping: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.carrier_mapping"} */
insert into FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping (code, name) values
            (%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s)...
[0m17:33:51.020234 [debug] [Thread-1 (]: SQL status: SUCCESS 14 in 0.641 seconds
[0m17:33:51.021231 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.carrier_mapping"
[0m17:33:51.022229 [debug] [Thread-1 (]: On seed.fair_pricing_radar.carrier_mapping: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.carrier_mapping"} */
COMMIT
[0m17:33:51.398738 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.376 seconds
[0m17:33:51.405719 [debug] [Thread-1 (]: Writing runtime SQL for node "seed.fair_pricing_radar.carrier_mapping"
[0m17:33:51.431650 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22579abf-9a05-4611-902b-e288b393aed9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002518167F6A0>]}
[0m17:33:51.431650 [info ] [Thread-1 (]: 1 of 1 OK loaded seed file WALRUS_PUBLIC.carrier_mapping ....................... [[32mINSERT 14[0m in 5.16s]
[0m17:33:51.432647 [debug] [Thread-1 (]: Finished running node seed.fair_pricing_radar.carrier_mapping
[0m17:33:51.434644 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:33:51.434644 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:33:51.435640 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:33:51.773242 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:33:51.773242 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:33:52.122309 [debug] [MainThread]: Connection 'seed.fair_pricing_radar.carrier_mapping' was left open.
[0m17:33:52.123306 [debug] [MainThread]: On seed.fair_pricing_radar.carrier_mapping: Close
[0m17:33:52.452929 [info ] [MainThread]: 
[0m17:33:52.453928 [info ] [MainThread]: Finished running 1 seed in 0 hours 0 minutes and 14.93 seconds (14.93s).
[0m17:33:52.454926 [debug] [MainThread]: Command end result
[0m17:33:52.482850 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:33:52.486839 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:33:52.495815 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:33:52.496813 [info ] [MainThread]: 
[0m17:33:52.497810 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:33:52.498809 [info ] [MainThread]: 
[0m17:33:52.499805 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:33:52.501799 [debug] [MainThread]: Command `dbt seed` succeeded at 17:33:52.501799 after 17.24 seconds
[0m17:33:52.502797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F631D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F63D44C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025181669C60>]}
[0m17:33:52.502797 [debug] [MainThread]: Flushing usage events
[0m17:33:52.846876 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:36:13.161784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A05E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A0735DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A0735E1A0>]}


============================== 17:36:13.165773 | 58c15910-29ec-4ff9-a146-4f0cdc2f04f7 ==============================
[0m17:36:13.165773 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:36:13.166770 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_route_daily_prices --full-refresh', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:36:14.074874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A0732DCF0>]}
[0m17:36:14.134222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A0FC5F820>]}
[0m17:36:14.135220 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:36:14.704697 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:36:14.984947 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:36:14.985945 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m17:36:15.345982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A1084C130>]}
[0m17:36:15.483614 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:36:15.485608 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:36:15.508547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A105FE800>]}
[0m17:36:15.509544 [info ] [MainThread]: Found 10 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:36:15.510542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A104B2860>]}
[0m17:36:15.512536 [info ] [MainThread]: 
[0m17:36:15.512536 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:36:15.513534 [info ] [MainThread]: 
[0m17:36:15.514531 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:36:15.515529 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:36:15.629237 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:36:15.629237 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:36:15.630234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:36:20.463854 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.834 seconds
[0m17:36:20.471832 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:36:20.481806 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:36:20.481806 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:36:20.482803 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:36:24.276708 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 3.794 seconds
[0m17:36:24.279701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A105FE6B0>]}
[0m17:36:24.284687 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m17:36:24.285685 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m17:36:24.286682 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m17:36:24.286682 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m17:36:24.295657 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m17:36:24.296655 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m17:36:24.328570 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m17:36:24.331562 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m17:36:24.332559 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

  select
    origin,
    destination,
    -- Define a route key so JFK-LAX and LAX-JFK stay distinct
    origin || '-' || destination        as route,

    /* bucket days_to_flight */
    case
      when days_to_flight between  0 and  3 then '00-03'
      when days_to_flight between  4 and  7 then '04-07'
      when days_to_flight between  8 and 29 then '08-29'
      else                                  '30+'
    end                                  as dtf_bucket,

    flight_date,
    search_date,

    -- cleaned two-letter carrier code
    replace(seg_airline_arr[0], '"', '') as marketing_carrier_code,

    total_fare,
    base_fare,
    total_fare / nullif(base_fare, 0)     as total_base_ratio

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

  select
    route,
    marketing_carrier_code           as marketing_carrier,  -- still code here
    dtf_bucket,
    flight_date,                      -- keep flight_date for like-for-like comparisons
    count(*)                          as obs,
    median(total_fare)                as median_fare,
    percentile_cont(0.95) within group (order by total_fare) as p95_fare,
    median(total_base_ratio)          as median_ratio,
    percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio

  from base
  group by
    route,
    marketing_carrier_code,
    dtf_bucket,
    flight_date

),

with_named as (

  select
    a.*,
    m.name as marketing_carrier_name
  from agg as a
  left join FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping as m
    on a.marketing_carrier = m.code

)

select
  route,
  marketing_carrier        as carrier_code,
  marketing_carrier_name   as carrier_name,
  dtf_bucket,
  flight_date,
  obs,
  median_fare,
  p95_fare,
  median_ratio,
  p95_ratio
from with_named
        );
[0m17:36:24.332559 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:37:01.666236 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 37.333 seconds
[0m17:37:01.690172 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58c15910-29ec-4ff9-a146-4f0cdc2f04f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A1088A710>]}
[0m17:37:01.691170 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_daily_prices ......... [[32mSUCCESS 1[0m in 37.40s]
[0m17:37:01.692167 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m17:37:01.693165 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:37:01.694162 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:37:01.694162 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:37:02.030780 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:37:02.031778 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:37:02.364887 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m17:37:02.365884 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m17:37:02.711959 [info ] [MainThread]: 
[0m17:37:02.712957 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 47.20 seconds (47.20s).
[0m17:37:02.714951 [debug] [MainThread]: Command end result
[0m17:37:02.742878 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:37:02.745868 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:37:02.754845 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:37:02.755843 [info ] [MainThread]: 
[0m17:37:02.756839 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:37:02.757837 [info ] [MainThread]: 
[0m17:37:02.758834 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:37:02.760829 [debug] [MainThread]: Command `dbt run` succeeded at 17:37:02.759831 after 49.68 seconds
[0m17:37:02.761826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A05E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A05EBF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A05E4E950>]}
[0m17:37:02.761826 [debug] [MainThread]: Flushing usage events
[0m17:37:03.117379 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:40:58.485578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82C01D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82D75A260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82D75A080>]}


============================== 17:40:58.489568 | 748d1eac-172b-410a-8289-b50d5012bf24 ==============================
[0m17:40:58.489568 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:40:58.490566 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select dim_carrier', 'send_anonymous_usage_stats': 'True'}
[0m17:40:59.397151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82CDFDB10>]}
[0m17:40:59.457989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82D593460>]}
[0m17:40:59.458987 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:41:00.029964 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:41:00.319191 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m17:41:00.320189 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\dim_carrier.sql
[0m17:41:00.689718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F836944130>]}
[0m17:41:00.829850 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:41:00.832842 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:41:00.854784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F836799AB0>]}
[0m17:41:00.855781 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:41:00.856779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F83679ADA0>]}
[0m17:41:00.858773 [info ] [MainThread]: 
[0m17:41:00.858773 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:41:00.859771 [info ] [MainThread]: 
[0m17:41:00.860768 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:41:00.861765 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:41:00.972469 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:41:00.973466 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:41:00.974464 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:07.964868 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 6.991 seconds
[0m17:41:07.971848 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:41:07.982820 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:41:07.982820 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:41:07.983817 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:11.724340 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 3.741 seconds
[0m17:41:11.728329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F836929DB0>]}
[0m17:41:11.733316 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.dim_carrier
[0m17:41:11.733316 [info ] [Thread-1 (]: 1 of 1 START sql view model WALRUS_PUBLIC.dim_carrier .......................... [RUN]
[0m17:41:11.735310 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.dim_carrier'
[0m17:41:11.735310 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.dim_carrier
[0m17:41:11.744287 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.dim_carrier"
[0m17:41:11.747278 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.dim_carrier
[0m17:41:11.778196 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.dim_carrier"
[0m17:41:11.780190 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.dim_carrier"
[0m17:41:11.780190 [debug] [Thread-1 (]: On model.fair_pricing_radar.dim_carrier: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.dim_carrier"} */
create or replace   view FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier
  
   as (
    

select
  code   as carrier_code,
  name   as carrier_name
from FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping
  );
[0m17:41:11.781187 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:41:15.436970 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe289-0305-0ebd-0006-8fdb00177312
[0m17:41:15.436970 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
[0m17:41:15.439962 [debug] [Thread-1 (]: Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql
[0m17:41:15.441956 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '748d1eac-172b-410a-8289-b50d5012bf24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F836929F30>]}
[0m17:41:15.442954 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model WALRUS_PUBLIC.dim_carrier ................. [[31mERROR[0m in 3.71s]
[0m17:41:15.443951 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.dim_carrier
[0m17:41:15.444948 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.dim_carrier' to be skipped because of status 'error'.  Reason: Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql.
[0m17:41:15.446943 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:41:15.446943 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:41:15.447940 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:41:15.784558 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:41:15.785556 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:41:16.129635 [debug] [MainThread]: Connection 'model.fair_pricing_radar.dim_carrier' was left open.
[0m17:41:16.130633 [debug] [MainThread]: On model.fair_pricing_radar.dim_carrier: Close
[0m17:41:16.476707 [info ] [MainThread]: 
[0m17:41:16.477705 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 15.62 seconds (15.62s).
[0m17:41:16.478703 [debug] [MainThread]: Command end result
[0m17:41:16.505630 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:41:16.507625 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:41:16.514606 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:41:16.515603 [info ] [MainThread]: 
[0m17:41:16.516602 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:41:16.518597 [info ] [MainThread]: 
[0m17:41:16.519594 [error] [MainThread]:   Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql
[0m17:41:16.520591 [info ] [MainThread]: 
[0m17:41:16.521588 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:41:16.523583 [debug] [MainThread]: Command `dbt run` failed at 17:41:16.523583 after 18.12 seconds
[0m17:41:16.524580 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82C01D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82D593460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F82C0D7E50>]}
[0m17:41:16.525577 [debug] [MainThread]: Flushing usage events
[0m17:41:16.863179 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:41:52.136340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191E9C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191EB359CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191EB359EA0>]}


============================== 17:41:52.140330 | 833e2764-04b8-43f4-aa72-7b8ff3f6af85 ==============================
[0m17:41:52.140330 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:41:52.141328 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select dim_carrier', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:41:53.065362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191EB32E0B0>]}
[0m17:41:53.126199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191F3C5D240>]}
[0m17:41:53.127197 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:41:53.710661 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:41:53.998890 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:41:53.999887 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:41:54.141509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191E6D2FA60>]}
[0m17:41:54.286122 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:41:54.289114 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:41:54.312053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191F44E57E0>]}
[0m17:41:54.314047 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:41:54.315046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191F452B4C0>]}
[0m17:41:54.316042 [info ] [MainThread]: 
[0m17:41:54.317039 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:41:54.318037 [info ] [MainThread]: 
[0m17:41:54.318037 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:41:54.320032 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:41:54.432730 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:41:54.433727 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:41:54.433727 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:58.226145 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.792 seconds
[0m17:41:58.234123 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:41:58.244096 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:41:58.245093 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:41:58.245093 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:42:02.302790 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 4.057 seconds
[0m17:42:02.305782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191F44E6710>]}
[0m17:42:02.309772 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.dim_carrier
[0m17:42:02.310769 [info ] [Thread-1 (]: 1 of 1 START sql view model WALRUS_PUBLIC.dim_carrier .......................... [RUN]
[0m17:42:02.311767 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.dim_carrier'
[0m17:42:02.311767 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.dim_carrier
[0m17:42:02.320742 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.dim_carrier"
[0m17:42:02.321740 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.dim_carrier
[0m17:42:02.351660 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.dim_carrier"
[0m17:42:02.353655 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.dim_carrier"
[0m17:42:02.353655 [debug] [Thread-1 (]: On model.fair_pricing_radar.dim_carrier: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.dim_carrier"} */
create or replace   view FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier
  
   as (
    

select
  code   as carrier_code,
  name   as carrier_name
from FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping
  );
[0m17:42:02.354652 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:42:06.310630 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe28a-0305-0c96-0006-8fdb0017835a
[0m17:42:06.310630 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
[0m17:42:06.313622 [debug] [Thread-1 (]: Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql
[0m17:42:06.315617 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '833e2764-04b8-43f4-aa72-7b8ff3f6af85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191E97DCD90>]}
[0m17:42:06.316614 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model WALRUS_PUBLIC.dim_carrier ................. [[31mERROR[0m in 4.00s]
[0m17:42:06.317611 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.dim_carrier
[0m17:42:06.318609 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.dim_carrier' to be skipped because of status 'error'.  Reason: Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql.
[0m17:42:06.320604 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:42:06.321601 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:42:06.321601 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:42:06.658699 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:42:06.659696 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:42:07.003798 [debug] [MainThread]: Connection 'model.fair_pricing_radar.dim_carrier' was left open.
[0m17:42:07.004795 [debug] [MainThread]: On model.fair_pricing_radar.dim_carrier: Close
[0m17:42:07.331920 [info ] [MainThread]: 
[0m17:42:07.332918 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.01 seconds (13.01s).
[0m17:42:07.333915 [debug] [MainThread]: Command end result
[0m17:42:07.360842 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:42:07.363835 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:42:07.372810 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:42:07.373808 [info ] [MainThread]: 
[0m17:42:07.374806 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:42:07.375804 [info ] [MainThread]: 
[0m17:42:07.376800 [error] [MainThread]:   Database Error in model dim_carrier (models\intermediate\dim_carrier.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\intermediate\dim_carrier.sql
[0m17:42:07.376800 [info ] [MainThread]: 
[0m17:42:07.377798 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:42:07.379792 [debug] [MainThread]: Command `dbt run` failed at 17:42:07.378795 after 15.32 seconds
[0m17:42:07.379792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191E9C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191E80961D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191F4F7BD90>]}
[0m17:42:07.380789 [debug] [MainThread]: Flushing usage events
[0m17:42:07.746810 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:43:02.873779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9A91D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9C059DB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9C059F90>]}


============================== 17:43:02.877768 | c9887b9e-6784-4f1a-9d95-73699b564dc1 ==============================
[0m17:43:02.877768 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:43:02.878766 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_competition', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:43:03.818280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017BA485C640>]}
[0m17:43:03.878120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017BA485E3B0>]}
[0m17:43:03.880114 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:43:04.568778 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:43:04.891439 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:43:04.892436 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:43:05.042542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B98C68FA0>]}
[0m17:43:05.200120 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:43:05.203112 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:43:05.228046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9C031060>]}
[0m17:43:05.229044 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:43:05.230041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017BA512B520>]}
[0m17:43:05.231038 [info ] [MainThread]: 
[0m17:43:05.232035 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:43:05.233033 [info ] [MainThread]: 
[0m17:43:05.233033 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:43:05.235028 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:43:05.355704 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:43:05.356702 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:43:05.356702 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:43:10.605751 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.249 seconds
[0m17:43:10.613730 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:43:10.623703 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:43:10.624704 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:43:10.625698 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:43:14.631018 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 4.005 seconds
[0m17:43:14.634010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017BA48E2AD0>]}
[0m17:43:14.637999 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m17:43:14.638996 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m17:43:14.639994 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m17:43:14.639994 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m17:43:14.648970 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m17:43:14.649968 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m17:43:14.684382 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m17:43:14.687374 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m17:43:14.688371 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with base as (

    select
        origin || '-' || destination               as route,
        marketing_carrier,
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    -- how many bookings each carrier operates on each route
    select
        route,
        marketing_carrier,
        count(*)                as flight_bookings
    from base
    group by 1,2

), concentration as (

    /*  HHI = Σ(s_i^2) where s_i = share of bookings per carrier  */
    select
        route,
        sum(flight_bookings)                            as total_bookings,
        sum( power(flight_bookings,2) ) / power(sum(flight_bookings),2)  as hhi,
        count(marketing_carrier)                        as carrier_count
    from carrier_flights
    group by route

)

select
    route,
    carrier_count,
    hhi                               -- 1.0 = pure monopoly, <0.2 highly competitive
from concentration;
[0m17:43:14.688371 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:43:18.760545 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe28c-0305-0c98-0006-8fdb0017643e
[0m17:43:18.760545 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 40 at position 18 unexpected ';'.
[0m17:43:18.763537 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 40 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m17:43:18.765532 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c9887b9e-6784-4f1a-9d95-73699b564dc1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9A40A950>]}
[0m17:43:18.766529 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 4.12s]
[0m17:43:18.767527 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m17:43:18.768525 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 40 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m17:43:18.770519 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:43:18.770519 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:43:18.771517 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:43:19.115596 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:43:19.116593 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:43:19.455193 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m17:43:19.456190 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m17:43:19.785323 [info ] [MainThread]: 
[0m17:43:19.786321 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.55 seconds (14.55s).
[0m17:43:19.788315 [debug] [MainThread]: Command end result
[0m17:43:19.815242 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:43:19.818236 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:43:19.827211 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:43:19.827211 [info ] [MainThread]: 
[0m17:43:19.828209 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:43:19.829206 [info ] [MainThread]: 
[0m17:43:19.830203 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 40 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m17:43:19.831200 [info ] [MainThread]: 
[0m17:43:19.832198 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:43:19.833195 [debug] [MainThread]: Command `dbt run` failed at 17:43:19.833195 after 17.04 seconds
[0m17:43:19.834192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9A91D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B98908670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017B9A9D7E50>]}
[0m17:43:19.835190 [debug] [MainThread]: Flushing usage events
[0m17:43:20.200728 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:49:42.333369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC75E1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC7755DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC7755E1A0>]}


============================== 17:49:42.337359 | 27080682-7e48-45b8-b0bb-fdc3d6115001 ==============================
[0m17:49:42.337359 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:49:42.338356 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select dim_carrier', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:49:43.284851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC74297070>]}
[0m17:49:43.343694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC76BFDBD0>]}
[0m17:49:43.344691 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:49:43.908689 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:49:44.191931 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:49:44.191931 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\dim_carrier.sql
[0m17:49:44.550983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC00A44130>]}
[0m17:49:44.688626 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:49:44.691619 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:49:44.716552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC007C9E70>]}
[0m17:49:44.717549 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:49:44.717549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC007C8A00>]}
[0m17:49:44.719544 [info ] [MainThread]: 
[0m17:49:44.720541 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:49:44.720541 [info ] [MainThread]: 
[0m17:49:44.721539 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:49:44.722536 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:49:44.847709 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:49:44.848705 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:49:44.848705 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:49.393583 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.544 seconds
[0m17:49:49.400564 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:49:49.411535 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:49:49.412532 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:49:49.412532 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:49:53.154577 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 3.742 seconds
[0m17:49:53.157569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC00A47AC0>]}
[0m17:49:53.162555 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.dim_carrier
[0m17:49:53.163553 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.dim_carrier ......................... [RUN]
[0m17:49:53.163553 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.dim_carrier'
[0m17:49:53.164550 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.dim_carrier
[0m17:49:53.173526 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.dim_carrier"
[0m17:49:53.175522 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.dim_carrier
[0m17:49:53.205441 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.dim_carrier"
[0m17:49:53.207436 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.dim_carrier"
[0m17:49:53.208433 [debug] [Thread-1 (]: On model.fair_pricing_radar.dim_carrier: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.dim_carrier"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier
         as
        (

select
  code   as carrier_code,
  name   as carrier_name
from FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping
        );
[0m17:49:53.208433 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:49:57.800721 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.592 seconds
[0m17:49:57.821666 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '27080682-7e48-45b8-b0bb-fdc3d6115001', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC72ECD630>]}
[0m17:49:57.822663 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.dim_carrier .................... [[32mSUCCESS 1[0m in 4.66s]
[0m17:49:57.823660 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.dim_carrier
[0m17:49:57.825655 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:49:57.825655 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:49:57.826652 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:49:58.154774 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:49:58.155772 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:49:58.490876 [debug] [MainThread]: Connection 'model.fair_pricing_radar.dim_carrier' was left open.
[0m17:49:58.490876 [debug] [MainThread]: On model.fair_pricing_radar.dim_carrier: Close
[0m17:49:58.827974 [info ] [MainThread]: 
[0m17:49:58.828972 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.11 seconds (14.11s).
[0m17:49:58.829969 [debug] [MainThread]: Command end result
[0m17:49:58.855899 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:49:58.858892 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:49:58.867868 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:49:58.868865 [info ] [MainThread]: 
[0m17:49:58.868865 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:49:58.870860 [info ] [MainThread]: 
[0m17:49:58.871858 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:49:58.872855 [debug] [MainThread]: Command `dbt run` succeeded at 17:49:58.872855 after 16.62 seconds
[0m17:49:58.873852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC75E1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC749A0C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC01577AF0>]}
[0m17:49:58.874849 [debug] [MainThread]: Flushing usage events
[0m17:49:59.211454 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:52:17.848800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E7581D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E76F59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E76F59EA0>]}


============================== 17:52:17.852789 | 4406169f-1b34-4515-9fc7-2e716efa8b66 ==============================
[0m17:52:17.852789 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:52:17.853787 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select int_route_competition', 'send_anonymous_usage_stats': 'True'}
[0m17:52:18.776342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E73C97040>]}
[0m17:52:18.837180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E765FE2C0>]}
[0m17:52:18.838177 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:52:19.412147 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:52:19.705868 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:52:19.706867 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m17:52:20.072407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E0044C130>]}
[0m17:52:20.217021 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:52:20.220013 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:52:20.245943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E0042D3F0>]}
[0m17:52:20.245943 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m17:52:20.246941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E0042CA60>]}
[0m17:52:20.248935 [info ] [MainThread]: 
[0m17:52:20.249933 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:52:20.250930 [info ] [MainThread]: 
[0m17:52:20.250930 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:52:20.252925 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:52:20.363628 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:52:20.364626 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:52:20.364626 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:52:26.245468 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.881 seconds
[0m17:52:26.253446 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:52:26.263420 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:52:26.264417 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:52:26.264417 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:52:30.372496 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 4.108 seconds
[0m17:52:30.375488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E0042FAF0>]}
[0m17:52:30.380475 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m17:52:30.381472 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m17:52:30.381472 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m17:52:30.382470 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m17:52:30.391446 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m17:52:30.393441 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m17:52:30.424357 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m17:52:30.426352 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m17:52:30.427349 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with base as (

    select
        origin || '-' || destination                as route,
        marketing_carrier,
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    -- how many bookings each carrier operates on each route
    select
        route,
        marketing_carrier,
        count(*)                                  as flight_bookings
    from base
    group by
        route,
        marketing_carrier

), concentration as (

    /* HHI = Σ(s_i^2) where s_i = share of bookings per carrier */
    select
        route,
        sum(flight_bookings)                      as total_bookings,
        sum(power(flight_bookings, 2)) 
          / power(sum(flight_bookings), 2)        as hhi,
        count(marketing_carrier)                  as carrier_count
    from carrier_flights
    group by
        route

)

select
    route,
    carrier_count,
    hhi                                         -- 1.0 = pure monopoly, <0.2 highly competitive
from concentration
        );
[0m17:52:30.428347 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:52:36.479243 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.051 seconds
[0m17:52:36.500692 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4406169f-1b34-4515-9fc7-2e716efa8b66', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E738CD600>]}
[0m17:52:36.501690 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_competition .......... [[32mSUCCESS 1[0m in 6.12s]
[0m17:52:36.502687 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m17:52:36.503684 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:52:36.504681 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:52:36.504681 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:52:36.856740 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:52:36.857737 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:52:37.196830 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m17:52:37.197827 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m17:52:37.539418 [info ] [MainThread]: 
[0m17:52:37.540417 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 17.29 seconds (17.29s).
[0m17:52:37.541414 [debug] [MainThread]: Command end result
[0m17:52:37.569338 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:52:37.572331 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:52:37.580310 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:52:37.580310 [info ] [MainThread]: 
[0m17:52:37.581307 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:52:37.582305 [info ] [MainThread]: 
[0m17:52:37.583302 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:52:37.585297 [debug] [MainThread]: Command `dbt run` succeeded at 17:52:37.585297 after 19.82 seconds
[0m17:52:37.586293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E7581D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E7588F880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019E7F9BCF10>]}
[0m17:52:37.586293 [debug] [MainThread]: Flushing usage events
[0m17:52:37.926887 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:59:55.151942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCA01D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCB75A2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCB75A0E0>]}


============================== 18:59:55.155932 | 1abb1f92-025e-4521-b09c-95cfb9a269e6 ==============================
[0m18:59:55.155932 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:59:55.155932 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_route_competition', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:59:56.149795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCB7260B0>]}
[0m18:59:56.213625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CD3D5D240>]}
[0m18:59:56.215620 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:59:56.789590 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:59:57.084320 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:59:57.084320 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m18:59:57.444863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CD494C130>]}
[0m18:59:57.582495 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:59:57.585487 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:59:57.610421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CD493A350>]}
[0m18:59:57.611418 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m18:59:57.612416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CD493B4F0>]}
[0m18:59:57.613413 [info ] [MainThread]: 
[0m18:59:57.614410 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:59:57.615408 [info ] [MainThread]: 
[0m18:59:57.615408 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:59:57.616405 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:59:57.753040 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:59:57.754037 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:59:57.755034 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:02.866934 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.113 seconds
[0m19:00:02.874913 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:00:02.884886 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:00:02.885884 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:00:02.885884 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:06.528666 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.643 seconds
[0m19:00:06.531659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CD4939360>]}
[0m19:00:06.536645 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m19:00:06.537643 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m19:00:06.538640 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m19:00:06.538640 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m19:00:06.547616 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m19:00:06.548613 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m19:00:06.581525 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m19:00:06.583520 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m19:00:06.584517 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with base as (

    select
        origin || '-' || destination                as route,
        marketing_carrier,
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    -- how many bookings each carrier operates on each route
    select
        route,
        marketing_carrier,
        count(*)                                  as flight_bookings
    from base
    group by
        route,
        marketing_carrier

), concentration as (

    /* HHI = Σ(s_i^2) where s_i = share of bookings per carrier */
    select
        route,
        sum(flight_bookings)                      as total_bookings,
        sum(power(flight_bookings, 2)) 
          / power(sum(flight_bookings), 2)        as hhi,
        count(marketing_carrier)                  as carrier_count
    from carrier_flights
    group by
        route

)

select
    route,
    carrier_count,
    hhi                                         -- 1.0 = pure monopoly, <0.2 highly competitive
from concentration
        );
[0m19:00:06.585515 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:00:12.943615 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.358 seconds
[0m19:00:12.966554 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1abb1f92-025e-4521-b09c-95cfb9a269e6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CC6FCD5A0>]}
[0m19:00:12.967551 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_competition .......... [[32mSUCCESS 1[0m in 6.43s]
[0m19:00:12.968549 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m19:00:12.970543 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:12.970543 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:00:12.971540 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:00:13.332575 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:00:13.333572 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:00:13.674672 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m19:00:13.675669 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m19:00:14.013765 [info ] [MainThread]: 
[0m19:00:14.014762 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 16.40 seconds (16.40s).
[0m19:00:14.015761 [debug] [MainThread]: Command end result
[0m19:00:14.041690 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:00:14.044683 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:00:14.053659 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:00:14.053659 [info ] [MainThread]: 
[0m19:00:14.054657 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:14.055654 [info ] [MainThread]: 
[0m19:00:14.056745 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:00:14.058645 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:14.058645 after 18.99 seconds
[0m19:00:14.058645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCA01D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCA0D77F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CCA0B2110>]}
[0m19:00:14.059642 [debug] [MainThread]: Flushing usage events
[0m19:00:14.416687 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:04:58.845390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021450F1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021452659C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021452659E10>]}


============================== 19:04:58.850376 | 86c5846f-e4a4-4b51-af8a-17bf4fe193df ==============================
[0m19:04:58.850376 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:04:58.851373 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m19:05:00.194793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021452626890>]}
[0m19:05:00.254633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021452492D70>]}
[0m19:05:00.255630 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:05:00.826608 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:05:01.154251 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:05:01.154251 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:05:01.288397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002145AE79E10>]}
[0m19:05:01.430019 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:05:01.434009 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:05:01.464926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002145AEF1390>]}
[0m19:05:01.464926 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:05:01.465923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002145AE5F160>]}
[0m19:05:01.467918 [info ] [MainThread]: 
[0m19:05:01.468915 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:05:01.468915 [info ] [MainThread]: 
[0m19:05:01.469913 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:05:01.470910 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:05:01.585603 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:05:01.586600 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:05:01.587598 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:05:06.734916 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.148 seconds
[0m19:05:06.742894 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:05:06.752868 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:05:06.752868 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:05:06.753865 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:05:10.474934 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.721 seconds
[0m19:05:10.478924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002145AEF3610>]}
[0m19:05:10.484908 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:05:10.485905 [info ] [Thread-1 (]: 1 of 1 START sql view model WALRUS_PUBLIC.mart_pricing_features ................ [RUN]
[0m19:05:10.486903 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:05:10.487900 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:05:10.496876 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:05:10.497873 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:05:10.527793 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:05:10.531783 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:05:10.532780 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace   view FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
  
   as (
    

with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination           as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,
        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                    '30+'
        end                                         as dtf_bucket,
        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)        as total_base_ratio,
        s.segment_count,
        s.marketing_carrier                         as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s

), trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID

), enriched as (

    select
        b.*,
        d.trip_dist,
        c.carrier_count,
        c.hhi,
        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,
        dc.carrier_name        as carrier_name   -- bring in the full name

    from booking b

    left join trip_distance                d using (LEGID)
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition     c
      on c.route = b.route

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices     p
      on  p.route             = b.route
      and p.marketing_carrier = b.carrier_code
      and p.dtf_bucket        = b.dtf_bucket
      and p.flight_date       = b.flight_date

    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
      on dc.carrier_code = b.carrier_code

), flags as (

    select
        *,
        -- rule 1: last-minute spike
        case
          when dtf_bucket = '00-03'
               and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1
        end as r1_last_minute_spike,

        -- rule 2: opacity / ancillary markup
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1
        end as r2_opacity_markup,

        -- rule 3: monopoly premium
        case
          when hhi > 0.80
               and (total_fare / nullif(trip_dist,1)) > 1.0
          then 1
        end as r3_monopoly_premium,

        -- rule 4: potential collusion placeholder
        0 as r4_parallel_move

    from enriched

)

select * from flags
  );
[0m19:05:10.532780 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:05:14.236926 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe2dd-0305-0bd9-0006-8fdb0017a0ea
[0m19:05:14.237925 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
[0m19:05:14.240915 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:05:14.242910 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '86c5846f-e4a4-4b51-af8a-17bf4fe193df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021450B11750>]}
[0m19:05:14.243908 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model WALRUS_PUBLIC.mart_pricing_features ....... [[31mERROR[0m in 3.75s]
[0m19:05:14.244905 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:05:14.245903 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:05:14.247897 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:05:14.247897 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:05:14.248894 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:05:14.599966 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:05:14.600963 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:05:14.934072 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:05:14.935069 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:05:15.274162 [info ] [MainThread]: 
[0m19:05:15.275160 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 13.80 seconds (13.80s).
[0m19:05:15.276158 [debug] [MainThread]: Command end result
[0m19:05:15.304083 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:05:15.306077 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:05:15.314560 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:05:15.315558 [info ] [MainThread]: 
[0m19:05:15.316555 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:05:15.316555 [info ] [MainThread]: 
[0m19:05:15.317552 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:05:15.318550 [info ] [MainThread]: 
[0m19:05:15.318550 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:05:15.320545 [debug] [MainThread]: Command `dbt run` failed at 19:05:15.320545 after 16.63 seconds
[0m19:05:15.321541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021450F1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002144FCA0C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021450FB1030>]}
[0m19:05:15.322538 [debug] [MainThread]: Flushing usage events
[0m19:05:15.682575 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:11:55.133846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF82E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF84559D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF84559F30>]}


============================== 19:11:55.137836 | ec9eb24a-2d20-480e-8520-7d0b5245861b ==============================
[0m19:11:55.137836 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:11:55.137836 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m19:11:56.036457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF845320B0>]}
[0m19:11:56.095299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8CB5D240>]}
[0m19:11:56.096297 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:11:56.662288 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:11:56.949520 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:11:56.950517 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:11:57.313559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8D74C130>]}
[0m19:11:57.450205 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:11:57.453197 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:11:57.475138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8D6795A0>]}
[0m19:11:57.476136 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:11:57.477133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8D67B640>]}
[0m19:11:57.479128 [info ] [MainThread]: 
[0m19:11:57.479128 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:11:57.480125 [info ] [MainThread]: 
[0m19:11:57.481122 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:11:57.482120 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:11:57.592823 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:11:57.592823 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:11:57.593821 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:12:00.694066 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.100 seconds
[0m19:12:00.701047 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:12:00.711020 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:12:00.712018 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:12:00.712018 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:12:04.609639 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.898 seconds
[0m19:12:04.613629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8D74F370>]}
[0m19:12:04.618615 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:12:04.618615 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:12:04.619613 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:12:04.620610 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:12:04.630583 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:12:04.632578 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:12:04.663495 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:12:04.666487 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:12:04.667484 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination           as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,
        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                    '30+'
        end                                         as dtf_bucket,
        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)        as total_base_ratio,
        s.segment_count,
        s.marketing_carrier                         as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s

), trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID

), enriched as (

    select
        b.*,
        d.trip_dist,
        c.carrier_count,
        c.hhi,
        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,
        dc.carrier_name        as carrier_name   -- bring in the full name

    from booking b

    left join trip_distance                d using (LEGID)
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition     c
      on c.route = b.route

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices     p
      on  p.route             = b.route
      and p.marketing_carrier = b.carrier_code
      and p.dtf_bucket        = b.dtf_bucket
      and p.flight_date       = b.flight_date

    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
      on dc.carrier_code = b.carrier_code

), flags as (

    select
        *,
        -- rule 1: last-minute spike
        case
          when dtf_bucket = '00-03'
               and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1
        end as r1_last_minute_spike,

        -- rule 2: opacity / ancillary markup
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1
        end as r2_opacity_markup,

        -- rule 3: monopoly premium
        case
          when hhi > 0.80
               and (total_fare / nullif(trip_dist,1)) > 1.0
          then 1
        end as r3_monopoly_premium,

        -- rule 4: potential collusion placeholder
        0 as r4_parallel_move

    from enriched

)

select * from flags
        );
[0m19:12:04.668482 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:12:08.432970 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe2e4-0305-0c96-0006-8fdb001785e6
[0m19:12:08.433967 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 58 at position 10
invalid identifier 'P.MARKETING_CARRIER'
[0m19:12:08.435962 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 58 at position 10
  invalid identifier 'P.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:12:08.438954 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ec9eb24a-2d20-480e-8520-7d0b5245861b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF829DC460>]}
[0m19:12:08.438954 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.82s]
[0m19:12:08.439951 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:12:08.440949 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 58 at position 10
  invalid identifier 'P.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:12:08.442944 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:12:08.443941 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:12:08.443941 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:12:08.808471 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:12:08.808471 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:12:09.137108 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:12:09.138105 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:12:09.476705 [info ] [MainThread]: 
[0m19:12:09.477702 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.00 seconds (12.00s).
[0m19:12:09.478700 [debug] [MainThread]: Command end result
[0m19:12:09.506625 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:12:09.508619 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:12:09.516598 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:12:09.517596 [info ] [MainThread]: 
[0m19:12:09.518594 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:12:09.519591 [info ] [MainThread]: 
[0m19:12:09.520589 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 58 at position 10
  invalid identifier 'P.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:12:09.521585 [info ] [MainThread]: 
[0m19:12:09.522582 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:12:09.524577 [debug] [MainThread]: Command `dbt run` failed at 19:12:09.524577 after 14.47 seconds
[0m19:12:09.525575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF82E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF844B7310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF8E489E70>]}
[0m19:12:09.526572 [debug] [MainThread]: Flushing usage events
[0m19:12:09.876635 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:21:43.949500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542ED1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543045DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543045E1A0>]}


============================== 19:21:43.953490 | e95eee12-c0d1-438e-937a-7e4ec6001bef ==============================
[0m19:21:43.953490 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:21:43.954487 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:21:44.959827 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025430431CF0>]}
[0m19:21:45.023655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025438B5F820>]}
[0m19:21:45.024653 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:21:45.603612 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:21:45.900325 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:21:45.901322 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:21:46.265867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543974C130>]}
[0m19:21:46.402501 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:21:46.405494 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:21:46.429430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543973A620>]}
[0m19:21:46.430428 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:21:46.430428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543973B790>]}
[0m19:21:46.432422 [info ] [MainThread]: 
[0m19:21:46.433419 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:21:46.433419 [info ] [MainThread]: 
[0m19:21:46.434417 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:21:46.435414 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:21:46.573046 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:21:46.574043 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:21:46.574043 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:21:52.009593 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.435 seconds
[0m19:21:52.016574 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:21:52.026548 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:21:52.027545 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:21:52.028543 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:21:55.681300 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.653 seconds
[0m19:21:55.684291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254397395A0>]}
[0m19:21:55.689278 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:21:55.690276 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:21:55.691273 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:21:55.691273 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:21:55.700249 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:21:55.702244 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:21:55.734158 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:21:55.738147 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:21:55.738147 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination           as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,
        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                    '30+'
        end                                         as dtf_bucket,
        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)        as total_base_ratio,
        s.segment_count,
        s.marketing_carrier                         as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s

), trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID

), enriched as (

  select
    b.*,
    d.trip_dist,
    c.carrier_count,
    c.hhi,
    p.median_fare,
    p.p95_fare,
    p.median_ratio,
    p.p95_ratio,
    dc.carrier_name

  from booking b

  left join trip_distance d
    using (LEGID)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
    on c.route = b.route

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
    on  p.route        = b.route
    and p.carrier_code = b.marketing_carrier   -- use carrier_code here
    and p.dtf_bucket   = b.dtf_bucket
    and p.flight_date  = b.flight_date

  left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
    on dc.carrier_code = b.marketing_carrier

), flags as (

    select
        *,
        -- rule 1: last-minute spike
        case
          when dtf_bucket = '00-03'
               and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1
        end as r1_last_minute_spike,

        -- rule 2: opacity / ancillary markup
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1
        end as r2_opacity_markup,

        -- rule 3: monopoly premium
        case
          when hhi > 0.80
               and (total_fare / nullif(trip_dist,1)) > 1.0
          then 1
        end as r3_monopoly_premium,

        -- rule 4: potential collusion placeholder
        0 as r4_parallel_move

    from enriched

)

select * from flags
        );
[0m19:21:55.739145 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:21:59.418368 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe2ee-0305-0bb1-0006-8fdb0017955a
[0m19:21:59.418368 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 60 at position 25
invalid identifier 'B.MARKETING_CARRIER'
[0m19:21:59.421360 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 60 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:21:59.423355 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e95eee12-c0d1-438e-937a-7e4ec6001bef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542E8DCD90>]}
[0m19:21:59.424352 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.73s]
[0m19:21:59.425349 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:21:59.426347 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 60 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:21:59.428341 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:21:59.428341 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:21:59.429339 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:21:59.771434 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:21:59.772431 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:22:00.111524 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:22:00.111524 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:22:00.454607 [info ] [MainThread]: 
[0m19:22:00.455604 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.02 seconds (14.02s).
[0m19:22:00.456602 [debug] [MainThread]: Command end result
[0m19:22:00.484034 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:22:00.487027 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:22:00.496003 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:22:00.497000 [info ] [MainThread]: 
[0m19:22:00.497000 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:22:00.497998 [info ] [MainThread]: 
[0m19:22:00.498995 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 60 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:22:00.498995 [info ] [MainThread]: 
[0m19:22:00.500990 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:22:00.501987 [debug] [MainThread]: Command `dbt run` failed at 19:22:00.501987 after 16.64 seconds
[0m19:22:00.502983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542ED1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542EDBF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002543A187370>]}
[0m19:22:00.503981 [debug] [MainThread]: Flushing usage events
[0m19:22:00.873991 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:29:57.675518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275A71D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275BE5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275BE5E1A0>]}


============================== 19:29:57.679507 | c41b9995-b098-4efb-a976-fc839693f11b ==============================
[0m19:29:57.679507 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:29:57.680505 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m19:29:58.592572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275BE2DCF0>]}
[0m19:29:58.651920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002276465F820>]}
[0m19:29:58.652918 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:29:59.222418 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:29:59.502669 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:29:59.503666 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:29:59.865698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022765248130>]}
[0m19:30:00.005324 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:30:00.008317 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:30:00.031255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002276522E620>]}
[0m19:30:00.032253 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:30:00.033250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002276522F790>]}
[0m19:30:00.035244 [info ] [MainThread]: 
[0m19:30:00.035244 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:30:00.036242 [info ] [MainThread]: 
[0m19:30:00.037240 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:30:00.038237 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:30:00.147943 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:30:00.148941 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:30:00.149938 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:37.417263 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 37.268 seconds
[0m19:30:37.425241 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:30:37.435214 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:30:37.435214 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:30:37.436212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:41.103961 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.668 seconds
[0m19:30:41.107951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002276522D5A0>]}
[0m19:30:41.112937 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:30:41.113934 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:30:41.113934 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:30:41.114932 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:30:41.124906 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:30:41.125903 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:30:41.159812 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:30:41.163801 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:30:41.163801 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination           as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,
        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                    '30+'
        end                                         as dtf_bucket,
        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)        as total_base_ratio,
        s.segment_count,
        s.marketing_carrier                         as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s

), trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID

), enriched as (

  select
    b.*,
    d.trip_dist,
    c.carrier_count,
    c.hhi,
    p.median_fare,
    p.p95_fare,
    p.median_ratio,
    p.p95_ratio,
    dc.carrier_name

  from booking b

  left join trip_distance d
    using (LEGID)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
    on c.route = b.route

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
    on  p.route        = b.route
    and p.carrier_code = b.carrier_code   
    and p.dtf_bucket   = b.dtf_bucket
    and p.flight_date  = b.flight_date

  left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
    on dc.carrier_code = b.marketing_carrier

), flags as (

    select
        *,
        -- rule 1: last-minute spike
        case
          when dtf_bucket = '00-03'
               and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1
        end as r1_last_minute_spike,

        -- rule 2: opacity / ancillary markup
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1
        end as r2_opacity_markup,

        -- rule 3: monopoly premium
        case
          when hhi > 0.80
               and (total_fare / nullif(trip_dist,1)) > 1.0
          then 1
        end as r3_monopoly_premium,

        -- rule 4: potential collusion placeholder
        0 as r4_parallel_move

    from enriched

)

select * from flags
        );
[0m19:30:41.164798 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:30:44.788130 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe2f7-0305-0c98-0006-8fdb001767ba
[0m19:30:44.789127 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 65 at position 25
invalid identifier 'B.MARKETING_CARRIER'
[0m19:30:44.792120 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 65 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:30:44.794114 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c41b9995-b098-4efb-a976-fc839693f11b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275A20CD90>]}
[0m19:30:44.795112 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.68s]
[0m19:30:44.796109 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:30:44.797106 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 65 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:30:44.799101 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:30:44.800098 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:30:44.800098 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:30:45.151171 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:30:45.152169 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:30:45.500238 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:30:45.501235 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:30:45.840832 [info ] [MainThread]: 
[0m19:30:45.841829 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 45.80 seconds (45.80s).
[0m19:30:45.842827 [debug] [MainThread]: Command end result
[0m19:30:45.870752 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:30:45.872747 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:30:45.880726 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:30:45.881723 [info ] [MainThread]: 
[0m19:30:45.882720 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:30:45.883718 [info ] [MainThread]: 
[0m19:30:45.884715 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 65 at position 25
  invalid identifier 'B.MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:30:45.884715 [info ] [MainThread]: 
[0m19:30:45.885712 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:30:45.888704 [debug] [MainThread]: Command `dbt run` failed at 19:30:45.887707 after 48.32 seconds
[0m19:30:45.888704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275A71D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275A7BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022765C5B370>]}
[0m19:30:45.889702 [debug] [MainThread]: Flushing usage events
[0m19:30:46.247743 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:31:39.119634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273AFE1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B155DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B155E140>]}


============================== 19:31:39.123624 | 55b32638-17fa-4e4d-a77f-1132dd47ae7f ==============================
[0m19:31:39.123624 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:31:39.123624 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m19:31:40.019254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B1536890>]}
[0m19:31:40.078098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B1392D70>]}
[0m19:31:40.079094 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:31:40.640593 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:31:40.920350 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:31:40.921348 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:31:41.281890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273BAA4C130>]}
[0m19:31:41.420027 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:31:41.423019 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:31:41.444469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273BAA4D420>]}
[0m19:31:41.445466 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:31:41.446463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273BAA4CE80>]}
[0m19:31:41.448457 [info ] [MainThread]: 
[0m19:31:41.448457 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:31:41.449455 [info ] [MainThread]: 
[0m19:31:41.450453 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:31:41.451450 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:31:41.560664 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:31:41.560664 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:31:41.561662 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:47.027619 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.466 seconds
[0m19:31:47.035598 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:31:47.045571 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:31:47.046568 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:31:47.046568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:31:50.735743 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 3.689 seconds
[0m19:31:50.739732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273BAA4EB60>]}
[0m19:31:50.743722 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:31:50.744719 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:31:50.745717 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:31:50.745717 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:31:50.755690 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:31:50.756687 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:31:50.789599 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:31:50.793588 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:31:50.793588 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination           as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,
        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                    '30+'
        end                                         as dtf_bucket,
        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)        as total_base_ratio,
        s.segment_count,
        s.marketing_carrier                         as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s

), trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID

), enriched as (

  select
    b.*,
    d.trip_dist,
    c.carrier_count,
    c.hhi,
    p.median_fare,
    p.p95_fare,
    p.median_ratio,
    p.p95_ratio,
    dc.carrier_name

  from booking b

  left join trip_distance d
    using (LEGID)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
    on c.route = b.route

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
    on  p.route        = b.route
    and p.carrier_code = b.carrier_code   
    and p.dtf_bucket   = b.dtf_bucket
    and p.flight_date  = b.flight_date

  left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
    on dc.carrier_code = b.carrier_code

), flags as (

    select
        *,
        -- rule 1: last-minute spike
        case
          when dtf_bucket = '00-03'
               and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1
        end as r1_last_minute_spike,

        -- rule 2: opacity / ancillary markup
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1
        end as r2_opacity_markup,

        -- rule 3: monopoly premium
        case
          when hhi > 0.80
               and (total_fare / nullif(trip_dist,1)) > 1.0
          then 1
        end as r3_monopoly_premium,

        -- rule 4: potential collusion placeholder
        0 as r4_parallel_move

    from enriched

)

select * from flags
        );
[0m19:31:50.794586 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:32:46.188194 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 55.393 seconds
[0m19:32:46.210134 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '55b32638-17fa-4e4d-a77f-1132dd47ae7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273ACECD630>]}
[0m19:32:46.211132 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 55.46s]
[0m19:32:46.212129 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:32:46.213126 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:32:46.214123 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:32:46.214123 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:32:46.551233 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:32:46.552230 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:32:46.882347 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:32:46.882347 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:32:47.225430 [info ] [MainThread]: 
[0m19:32:47.226427 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 5.78 seconds (65.78s).
[0m19:32:47.227425 [debug] [MainThread]: Command end result
[0m19:32:47.255350 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:32:47.258342 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:32:47.265323 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:32:47.266322 [info ] [MainThread]: 
[0m19:32:47.267319 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:32:47.268317 [info ] [MainThread]: 
[0m19:32:47.268317 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:32:47.270310 [debug] [MainThread]: Command `dbt run` succeeded at 19:32:47.270310 after 68.30 seconds
[0m19:32:47.271308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273AFE1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273B1392D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000273AFEB0A60>]}
[0m19:32:47.272306 [debug] [MainThread]: Flushing usage events
[0m19:32:47.635334 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:53:24.978751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E60A1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6215DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6215E1D0>]}


============================== 19:53:24.983737 | 0610729a-bc68-425e-9ae2-1b357b7642fb ==============================
[0m19:53:24.983737 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:53:24.983737 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:53:25.929714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E621320B0>]}
[0m19:53:25.991549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6AA5D240>]}
[0m19:53:25.993544 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:53:26.560040 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:53:26.871207 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m19:53:26.872205 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_alerts.sql
[0m19:53:26.872205 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:53:27.238226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6B644130>]}
[0m19:53:27.377852 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:53:27.380845 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:53:27.403784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6B3CB310>]}
[0m19:53:27.404781 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:53:27.405779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6B1E5C90>]}
[0m19:53:27.406775 [info ] [MainThread]: 
[0m19:53:27.407773 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:53:27.408770 [info ] [MainThread]: 
[0m19:53:27.409280 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:53:27.410273 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:53:27.533942 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:53:27.533942 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:53:27.534940 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:53:32.516695 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.982 seconds
[0m19:53:32.524673 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:53:32.534647 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:53:32.535644 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:53:32.536642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:53:36.183451 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.647 seconds
[0m19:53:36.186443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6B647310>]}
[0m19:53:36.191430 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:53:36.192427 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:53:36.193425 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:53:36.193425 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:53:36.203398 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:53:36.204395 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:53:36.235313 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:53:36.240300 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:53:36.241297 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ──────────────────────────────────────────────────────────
-- 1.  Booking-level facts
-- ──────────────────────────────────────────────────────────
with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ──────────────────────────────────────────────────────────
-- 2.  Trip distance per LEGID
-- ──────────────────────────────────────────────────────────
trip_distance as (

    select
        LEGID,
        sum(leg_distance)        as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID
),

-- ──────────────────────────────────────────────────────────
-- 3.  Join booking with distances & reference tables
--     Use window median to back-fill missing trip_dist
-- ──────────────────────────────────────────────────────────
enriched as (

    select
        b.*,

        /* distance gap patch — use median trip_dist for the route if null */
        coalesce(
            d.trip_dist,
            median(d.trip_dist) over (partition by b.route)
        )                                                    as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name

    from booking b

    left join trip_distance d
      using (LEGID)

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
      on  c.route = b.route

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
      on  p.route         = b.route
      and p.carrier_code  = b.carrier_code
      and p.dtf_bucket    = b.dtf_bucket
      and p.flight_date   = b.flight_date

    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
      on dc.carrier_code = b.carrier_code
),

-- ──────────────────────────────────────────────────────────
-- 4.  Flag logic
-- ──────────────────────────────────────────────────────────
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- Rule 1  Last-minute spike
        ------------------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                             as r1_last_minute_spike,

        ------------------------------------------------------------------
        -- Rule 2  Opacity / ancillary markup
        ------------------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                             as r2_opacity_markup,

        ------------------------------------------------------------------
        -- Rule 3  Monopoly premium  (fare-per-mile > $1 when HHI > 0.8)
        ------------------------------------------------------------------
        case
          when hhi > 0.80
           and ( total_fare / nullif(trip_dist,1) ) > 1.0
          then 1 end                                             as r3_monopoly_premium,

        ------------------------------------------------------------------
        -- Rule 4  Parallel-move / collusion placeholder
        ------------------------------------------------------------------
        0                                                        as r4_parallel_move

    from enriched
)

select * from flags;
[0m19:53:36.242294 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:53:40.034710 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe30e-0305-0ebd-0006-8fdb001776f2
[0m19:53:40.035708 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 130 at position 19 unexpected ';'.
[0m19:53:40.037703 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 130 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:53:40.040695 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0610729a-bc68-425e-9ae2-1b357b7642fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6B647250>]}
[0m19:53:40.041692 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.85s]
[0m19:53:40.042689 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:53:40.042689 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 130 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:53:40.044684 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:53:40.045681 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:53:40.045681 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:53:40.388270 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:53:40.388270 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:53:40.725369 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:53:40.726367 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:53:41.075937 [info ] [MainThread]: 
[0m19:53:41.076934 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.67 seconds (13.67s).
[0m19:53:41.077932 [debug] [MainThread]: Command end result
[0m19:53:41.105856 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:53:41.108849 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:53:41.116827 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:53:41.117825 [info ] [MainThread]: 
[0m19:53:41.117825 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:53:41.118822 [info ] [MainThread]: 
[0m19:53:41.119819 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 130 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:53:41.121814 [info ] [MainThread]: 
[0m19:53:41.121814 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:53:41.123809 [debug] [MainThread]: Command `dbt run` failed at 19:53:41.123809 after 16.23 seconds
[0m19:53:41.124805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E60A1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E6AA5D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014E60AD77F0>]}
[0m19:53:41.125804 [debug] [MainThread]: Flushing usage events
[0m19:53:41.468885 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:53:56.241666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB4B1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB6259C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB6259E10>]}


============================== 19:53:56.244657 | e791c94f-0d03-450e-91c0-7aea2a260c2c ==============================
[0m19:53:56.244657 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:53:56.245655 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:53:57.191140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB622E890>]}
[0m19:53:57.250980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB6092D70>]}
[0m19:53:57.251977 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:53:57.815470 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:53:58.103699 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:53:58.104697 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:53:58.465742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBF64C130>]}
[0m19:53:58.604372 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:53:58.606367 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:53:58.629306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBF64EC20>]}
[0m19:53:58.630303 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m19:53:58.631301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBF64D870>]}
[0m19:53:58.633295 [info ] [MainThread]: 
[0m19:53:58.634292 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:53:58.634292 [info ] [MainThread]: 
[0m19:53:58.635290 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:53:58.637285 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:53:58.748985 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:53:58.749983 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:53:58.750980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:02.006295 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 3.255 seconds
[0m19:54:02.013276 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:54:02.023249 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:54:02.024247 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:54:02.024247 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:05.705961 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.681 seconds
[0m19:54:05.709951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBF64F2E0>]}
[0m19:54:05.713939 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:54:05.714937 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:54:05.715935 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:54:05.715935 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:54:05.725907 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:54:05.726905 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:54:05.758819 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:54:05.763806 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:54:05.764804 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ──────────────────────────────────────────────────────────
-- 1.  Booking-level facts
-- ──────────────────────────────────────────────────────────
with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ──────────────────────────────────────────────────────────
-- 2.  Trip distance per LEGID
-- ──────────────────────────────────────────────────────────
trip_distance as (

    select
        LEGID,
        sum(leg_distance)        as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID
),

-- ──────────────────────────────────────────────────────────
-- 3.  Join booking with distances & reference tables
--     Use window median to back-fill missing trip_dist
-- ──────────────────────────────────────────────────────────
enriched as (

    select
        b.*,

        /* distance gap patch — use median trip_dist for the route if null */
        coalesce(
            d.trip_dist,
            median(d.trip_dist) over (partition by b.route)
        )                                                    as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name

    from booking b

    left join trip_distance d
      using (LEGID)

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
      on  c.route = b.route

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
      on  p.route         = b.route
      and p.carrier_code  = b.carrier_code
      and p.dtf_bucket    = b.dtf_bucket
      and p.flight_date   = b.flight_date

    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
      on dc.carrier_code = b.carrier_code
),

-- ──────────────────────────────────────────────────────────
-- 4.  Flag logic
-- ──────────────────────────────────────────────────────────
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- Rule 1  Last-minute spike
        ------------------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                             as r1_last_minute_spike,

        ------------------------------------------------------------------
        -- Rule 2  Opacity / ancillary markup
        ------------------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                             as r2_opacity_markup,

        ------------------------------------------------------------------
        -- Rule 3  Monopoly premium  (fare-per-mile > $1 when HHI > 0.8)
        ------------------------------------------------------------------
        case
          when hhi > 0.80
           and ( total_fare / nullif(trip_dist,1) ) > 1.0
          then 1 end                                             as r3_monopoly_premium,

        ------------------------------------------------------------------
        -- Rule 4  Parallel-move / collusion placeholder
        ------------------------------------------------------------------
        0                                                        as r4_parallel_move

    from enriched
)

select * from flags
        );
[0m19:54:05.764804 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:55:15.376084 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 69.611 seconds
[0m19:55:15.400021 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e791c94f-0d03-450e-91c0-7aea2a260c2c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB2ACD630>]}
[0m19:55:15.401018 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 69.68s]
[0m19:55:15.402015 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:55:15.403013 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:55:15.404010 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:55:15.404010 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:55:15.810922 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:55:15.810922 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:55:16.162006 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:55:16.162006 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:55:16.516060 [info ] [MainThread]: 
[0m19:55:16.517057 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 17.88 seconds (77.88s).
[0m19:55:16.518054 [debug] [MainThread]: Command end result
[0m19:55:16.545980 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:55:16.548972 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:55:16.556950 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:55:16.558945 [info ] [MainThread]: 
[0m19:55:16.558945 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:55:16.559943 [info ] [MainThread]: 
[0m19:55:16.560940 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:55:16.562934 [debug] [MainThread]: Command `dbt run` succeeded at 19:55:16.562934 after 80.41 seconds
[0m19:55:16.562934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB4B1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBF6274F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DB42CBD90>]}
[0m19:55:16.563932 [debug] [MainThread]: Flushing usage events
[0m19:55:16.916987 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:01:28.705782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3C91D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3E05DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3E05E140>]}


============================== 20:01:28.709772 | 0e64bcf6-71ac-4de4-a3ca-3f64c9914890 ==============================
[0m20:01:28.709772 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:01:28.710769 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:01:29.635309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3E036890>]}
[0m20:01:29.694151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3DE92D70>]}
[0m20:01:29.696146 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:01:30.268615 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:01:30.555860 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:01:30.556857 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m20:01:30.926868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D47348130>]}
[0m20:01:31.068489 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:01:31.071482 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:01:31.093423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D4734AC20>]}
[0m20:01:31.094420 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m20:01:31.095417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D47349870>]}
[0m20:01:31.096415 [info ] [MainThread]: 
[0m20:01:31.097412 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:01:31.098410 [info ] [MainThread]: 
[0m20:01:31.098410 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:01:31.099407 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:01:31.210110 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:01:31.210110 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:01:31.211108 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:36.063713 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.853 seconds
[0m20:01:36.071692 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:01:36.081666 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:01:36.081666 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:01:36.082663 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:39.708009 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.625 seconds
[0m20:01:39.711999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D4734B2E0>]}
[0m20:01:39.716985 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m20:01:39.717983 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m20:01:39.718980 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m20:01:39.719977 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m20:01:39.729950 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m20:01:39.730948 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m20:01:39.764857 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m20:01:39.769844 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m20:01:39.770841 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ──────────────────────────────────────────────────────────
-- 1.  Booking-level facts
-- ──────────────────────────────────────────────────────────
with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ──────────────────────────────────────────────────────────
-- 2.  Trip distance per LEGID
-- ──────────────────────────────────────────────────────────
trip_distance as (

    select
        LEGID,
        sum(leg_distance)        as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID
),

-- ──────────────────────────────────────────────────────────
-- 3.  Join booking with distances & reference tables
--     Use window median to back-fill missing trip_dist
-- ──────────────────────────────────────────────────────────
enriched as (

    select
        b.*,

        /* distance gap patch — use median trip_dist for the route if null */
        coalesce(
        d.trip_dist,
        median(d.trip_dist) over (partition by b.route),
        s.totaltraveldistance      -- comes from stg_fare_searches
)                                              as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name

    from booking b

    left join trip_distance d
      using (LEGID)

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
      on  c.route = b.route

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
      on  p.route         = b.route
      and p.carrier_code  = b.carrier_code
      and p.dtf_bucket    = b.dtf_bucket
      and p.flight_date   = b.flight_date

    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
      on dc.carrier_code = b.carrier_code
),

-- ──────────────────────────────────────────────────────────
-- 4.  Flag logic
-- ──────────────────────────────────────────────────────────
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- Rule 1  Last-minute spike
        ------------------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                             as r1_last_minute_spike,

        ------------------------------------------------------------------
        -- Rule 2  Opacity / ancillary markup
        ------------------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                             as r2_opacity_markup,

        ------------------------------------------------------------------
        -- Rule 3  Monopoly premium  (fare-per-mile > $1 when HHI > 0.8)
        ------------------------------------------------------------------
        case
          when hhi > 0.80
           and ( total_fare / nullif(trip_dist,1) ) > 1.0
          then 1 end                                             as r3_monopoly_premium,

        ------------------------------------------------------------------
        -- Rule 4  Parallel-move / collusion placeholder
        ------------------------------------------------------------------
        0                                                        as r4_parallel_move

    from enriched
)

select * from flags
        );
[0m20:01:39.771839 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:01:43.405166 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe316-0305-0c96-0006-8fdb00178722
[0m20:01:43.406163 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 62 at position 8
invalid identifier 'S.TOTALTRAVELDISTANCE'
[0m20:01:43.408158 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 8
  invalid identifier 'S.TOTALTRAVELDISTANCE'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m20:01:43.411150 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e64bcf6-71ac-4de4-a3ca-3f64c9914890', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D48077BB0>]}
[0m20:01:43.412147 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.69s]
[0m20:01:43.413145 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m20:01:43.413145 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 8
  invalid identifier 'S.TOTALTRAVELDISTANCE'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m20:01:43.415140 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:43.416137 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:01:43.416137 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:01:43.748258 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:01:43.749256 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:01:44.108306 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m20:01:44.109304 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m20:01:44.458370 [info ] [MainThread]: 
[0m20:01:44.459368 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.36 seconds (13.36s).
[0m20:01:44.460366 [debug] [MainThread]: Command end result
[0m20:01:44.487294 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:01:44.490286 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:01:44.498264 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:01:44.499262 [info ] [MainThread]: 
[0m20:01:44.500259 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:01:44.500259 [info ] [MainThread]: 
[0m20:01:44.501256 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 8
  invalid identifier 'S.TOTALTRAVELDISTANCE'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m20:01:44.502254 [info ] [MainThread]: 
[0m20:01:44.503251 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:01:44.504248 [debug] [MainThread]: Command `dbt run` failed at 20:01:44.504248 after 15.89 seconds
[0m20:01:44.505245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3C91D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3DE92D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025D3C9AD030>]}
[0m20:01:44.505245 [debug] [MainThread]: Flushing usage events
[0m20:01:44.856809 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:03:15.089373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A211D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A3859CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A3859ED0>]}


============================== 20:03:15.093362 | cc8ce2b3-12b9-4edb-aefa-d0e138bbe454 ==============================
[0m20:03:15.093362 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:03:15.094360 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:03:16.050309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A3825CF0>]}
[0m20:03:16.114139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268AC05F820>]}
[0m20:03:16.115136 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:03:16.689624 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:03:17.009276 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:03:17.010274 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m20:03:17.377292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268ACC48130>]}
[0m20:03:17.516919 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:03:17.518913 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:03:17.542850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268ACC32710>]}
[0m20:03:17.543847 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m20:03:17.544844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268ACC304F0>]}
[0m20:03:17.546839 [info ] [MainThread]: 
[0m20:03:17.547836 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:03:17.547836 [info ] [MainThread]: 
[0m20:03:17.548834 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:03:17.549831 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:03:17.676492 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:03:17.677489 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:03:17.677489 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:03:24.687328 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 7.010 seconds
[0m20:03:24.695307 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:03:24.705785 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:03:24.705785 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:03:24.706782 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:03:28.308709 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.602 seconds
[0m20:03:28.312699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268ACC31630>]}
[0m20:03:28.317685 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m20:03:28.317685 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m20:03:28.318682 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m20:03:28.319680 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m20:03:28.329654 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m20:03:28.330651 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m20:03:28.361567 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m20:03:28.366554 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m20:03:28.367551 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ──────────────────────────────────
-- 1. Booking-level facts
-- ──────────────────────────────────
with booking as (

    select
        s.LEGID,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                      as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                  as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                 as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                  as carrier_code,

        /* bring raw itinerary distance so we can use it as fallback */
        s.totaltraveldistance                                as raw_trip_distance

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ──────────────────────────────────
-- 2. Summed leg distance
-- ──────────────────────────────────
trip_distance as (

    select
        LEGID,
        sum(leg_distance)    as trip_dist
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by LEGID
),

-- ──────────────────────────────────
-- 3. Enrich + distance gap patch
-- ──────────────────────────────────
enriched as (

    select
        b.*,

        /* BEST DISTANCE: leg sum  ▸ route median ▸ raw itinerary */
        coalesce(
            d.trip_dist,
            median(d.trip_dist) over (partition by b.route),
            b.raw_trip_distance
        )                                                   as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name

    from booking b
    left join trip_distance                     d using (LEGID)
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c on  c.route = b.route
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices p
         on  p.route         = b.route
         and p.carrier_code  = b.carrier_code
         and p.dtf_bucket    = b.dtf_bucket
         and p.flight_date   = b.flight_date
    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier dc
         on dc.carrier_code  = b.carrier_code
),

-- ──────────────────────────────────
-- 4. Flag logic
-- ──────────────────────────────────
flags as (

    select
        *,

        /* R1 – Last-minute spike */
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                               as r1_last_minute_spike,

        /* R2 – Opacity markup */
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                               as r2_opacity_markup,

        /* R3 – Monopoly premium (fare_per_mile > $1 when HHI > 0.8) */
        case
          when hhi > 0.80
           and ( total_fare / nullif(trip_dist,1) ) > 1.0
          then 1 end                               as r3_monopoly_premium,

        /* R4 – collusion placeholder */
        0                                          as r4_parallel_move

    from enriched
)

select * from flags
        );
[0m20:03:28.367551 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:04:47.910900 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 79.543 seconds
[0m20:04:47.934836 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc8ce2b3-12b9-4edb-aefa-d0e138bbe454', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A00CD5D0>]}
[0m20:04:47.935833 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 79.61s]
[0m20:04:47.936832 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m20:04:47.938826 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:04:47.939823 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:04:47.939823 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:04:48.316814 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:04:48.316814 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:04:48.677358 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m20:04:48.678356 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m20:04:49.035906 [info ] [MainThread]: 
[0m20:04:49.036904 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 31.49 seconds (91.49s).
[0m20:04:49.037901 [debug] [MainThread]: Command end result
[0m20:04:49.064829 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:04:49.066823 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:04:49.074802 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:04:49.075800 [info ] [MainThread]: 
[0m20:04:49.076797 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:04:49.077794 [info ] [MainThread]: 
[0m20:04:49.078792 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:04:49.080786 [debug] [MainThread]: Command `dbt run` succeeded at 20:04:49.080786 after 94.07 seconds
[0m20:04:49.081784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A211D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268A16CB520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000268ACC327D0>]}
[0m20:04:49.081784 [debug] [MainThread]: Flushing usage events
[0m20:04:49.472760 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:10:28.534561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017775D1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017777459D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017777459F30>]}


============================== 20:10:28.538550 | 1948bf3d-a302-4efc-8825-ebe0c457a5a9 ==============================
[0m20:10:28.538550 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:10:28.539548 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_alerts', 'send_anonymous_usage_stats': 'True'}
[0m20:10:29.461097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177774320B0>]}
[0m20:10:29.522932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001777FB5D240>]}
[0m20:10:29.523930 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:10:30.109364 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:10:30.400597 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:10:30.401594 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:10:30.546207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001777FB78580>]}
[0m20:10:30.691819 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:10:30.694810 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:10:30.717749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001777FE42260>]}
[0m20:10:30.717749 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m20:10:30.718746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177005A10F0>]}
[0m20:10:30.720741 [info ] [MainThread]: 
[0m20:10:30.721738 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:10:30.721738 [info ] [MainThread]: 
[0m20:10:30.722736 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:10:30.724730 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:10:30.837429 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:10:30.838426 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:10:30.838426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:35.527482 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.689 seconds
[0m20:10:35.535460 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:10:35.546431 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:10:35.547428 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:10:35.547428 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:39.223162 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.676 seconds
[0m20:10:39.227151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001777FE418A0>]}
[0m20:10:39.231141 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m20:10:39.232138 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_alerts ................. [RUN]
[0m20:10:39.233136 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_alerts'
[0m20:10:39.234133 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_alerts
[0m20:10:39.242111 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:10:39.243109 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_alerts
[0m20:10:39.276021 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:10:39.278016 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:10:39.279013 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_alerts: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_alerts"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_alerts
         as
        (-- models/mart/mart_pricing_alerts.sql


select
  LEGID,
  route,
  flight_date,
  marketing_carrier,
  total_fare,
  trip_dist,
  r1_last_minute_spike  as flag_last_min,
  r2_opacity_markup     as flag_opacity,
  r3_monopoly_premium   as flag_monopoly,
  /* later: r4_parallel_move */
  array_construct_compact(
      case when r1_last_minute_spike = 1 then 'last_minute' end,
      case when r2_opacity_markup    = 1 then 'opacity'     end,
      case when r3_monopoly_premium  = 1 then 'monopoly'    end
  )                                          as flag_list
from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
where r1_last_minute_spike = 1
   or r2_opacity_markup    = 1
   or r3_monopoly_premium  = 1
        );
[0m20:10:39.280011 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:10:43.359148 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe31f-0305-0bb1-0006-8fdb001796b6
[0m20:10:43.360146 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 10 at position 2
invalid identifier 'MARKETING_CARRIER'
[0m20:10:43.362140 [debug] [Thread-1 (]: Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 10 at position 2
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql
[0m20:10:43.365132 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1948bf3d-a302-4efc-8825-ebe0c457a5a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001777FE404C0>]}
[0m20:10:43.366130 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_alerts ........ [[31mERROR[0m in 4.13s]
[0m20:10:43.367127 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m20:10:43.368124 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_alerts' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 10 at position 2
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql.
[0m20:10:43.369122 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:10:43.370119 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:10:43.370119 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:10:43.728668 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:10:43.729665 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:10:44.063292 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_alerts' was left open.
[0m20:10:44.064289 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_alerts: Close
[0m20:10:44.392411 [info ] [MainThread]: 
[0m20:10:44.393408 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.67 seconds (13.67s).
[0m20:10:44.394406 [debug] [MainThread]: Command end result
[0m20:10:44.422331 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:10:44.425324 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:10:44.434300 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:10:44.435297 [info ] [MainThread]: 
[0m20:10:44.435297 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:10:44.436294 [info ] [MainThread]: 
[0m20:10:44.437292 [error] [MainThread]:   Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 10 at position 2
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql
[0m20:10:44.438289 [info ] [MainThread]: 
[0m20:10:44.439287 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:10:44.440284 [debug] [MainThread]: Command `dbt run` failed at 20:10:44.440284 after 16.00 seconds
[0m20:10:44.441281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017775D1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000177005F2530>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017774275090>]}
[0m20:10:44.442279 [debug] [MainThread]: Flushing usage events
[0m20:10:44.787355 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:13:22.582279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D711D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D885DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D885E1A0>]}


============================== 20:13:22.586268 | 330c7fe1-3b30-4506-b09f-42de2fcd1265 ==============================
[0m20:13:22.586268 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:13:22.586268 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select mart_pricing_alerts', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:13:23.499332 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D8825CF0>]}
[0m20:13:23.558681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E0F5F820>]}
[0m20:13:23.560676 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:13:24.129183 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:13:24.473264 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:13:24.474261 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_alerts.sql
[0m20:13:24.888154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E1B48130>]}
[0m20:13:25.029775 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:13:25.031769 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:13:25.053711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E1B2F4C0>]}
[0m20:13:25.054709 [info ] [MainThread]: Found 11 models, 1 analysis, 1 seed, 3 data tests, 1 source, 474 macros
[0m20:13:25.054709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E1B2F580>]}
[0m20:13:25.056703 [info ] [MainThread]: 
[0m20:13:25.057700 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:13:25.057700 [info ] [MainThread]: 
[0m20:13:25.058698 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:13:25.059695 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:13:25.177380 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:13:25.178377 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:13:25.178377 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:13:30.513667 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.335 seconds
[0m20:13:30.520649 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:13:30.531619 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:13:30.531619 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:13:30.532616 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:13:34.223799 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 3.691 seconds
[0m20:13:34.227789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E1B2D720>]}
[0m20:13:34.231778 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m20:13:34.232776 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_alerts ................. [RUN]
[0m20:13:34.233773 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_alerts'
[0m20:13:34.234771 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_alerts
[0m20:13:34.242749 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:13:34.243746 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_alerts
[0m20:13:34.275661 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:13:34.277656 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_alerts"
[0m20:13:34.278653 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_alerts: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_alerts"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_alerts
         as
        (

select
  LEGID,
  route,
  flight_date,
  carrier_code,                 -- renamed
  carrier_name,                 -- include full name too, if you like
  total_fare,
  trip_dist,
  r1_last_minute_spike  as flag_last_min,
  r2_opacity_markup     as flag_opacity,
  r3_monopoly_premium   as flag_monopoly,
  array_construct_compact(
      case when r1_last_minute_spike = 1 then 'last_minute' end,
      case when r2_opacity_markup    = 1 then 'opacity'     end,
      case when r3_monopoly_premium  = 1 then 'monopoly'    end
  ) as flag_list
from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
where r1_last_minute_spike = 1
   or r2_opacity_markup    = 1
   or r3_monopoly_premium  = 1
        );
[0m20:13:34.278653 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:13:41.869466 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 7.590 seconds
[0m20:13:41.890410 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '330c7fe1-3b30-4506-b09f-42de2fcd1265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D51CD5D0>]}
[0m20:13:41.891408 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_alerts ............ [[32mSUCCESS 1[0m in 7.66s]
[0m20:13:41.892405 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m20:13:41.894399 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:13:41.894399 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:13:41.895397 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:13:42.238479 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:13:42.239477 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:13:42.572585 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_alerts' was left open.
[0m20:13:42.572585 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_alerts: Close
[0m20:13:42.930134 [info ] [MainThread]: 
[0m20:13:42.931131 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 17.87 seconds (17.87s).
[0m20:13:42.933126 [debug] [MainThread]: Command end result
[0m20:13:42.961051 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:13:42.964043 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:13:42.972022 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:13:42.973019 [info ] [MainThread]: 
[0m20:13:42.975015 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:13:42.976012 [info ] [MainThread]: 
[0m20:13:42.977009 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:13:42.978006 [debug] [MainThread]: Command `dbt run` succeeded at 20:13:42.978006 after 20.48 seconds
[0m20:13:42.979003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D711D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210D714E950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E17D2A70>]}
[0m20:13:42.980001 [debug] [MainThread]: Flushing usage events
[0m20:13:43.337550 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:32:24.742721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A5E1D210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A7359B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A7359CF0>]}


============================== 23:32:24.748705 | 3f16980a-b598-4494-b489-bdfe2f46e8fb ==============================
[0m23:32:24.748705 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:32:24.749704 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt ls --resource-type seed', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:32:26.254691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286AF962B30>]}
[0m23:32:26.315528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A71934C0>]}
[0m23:32:26.316526 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:32:26.888502 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:32:27.060548 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:32:27.061545 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A69FC880>]}
[0m23:32:28.937540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286B0786800>]}
[0m23:32:29.092126 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:32:29.096115 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:32:29.128031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286B0A58BB0>]}
[0m23:32:29.128031 [info ] [MainThread]: Found 11 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:32:29.129028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3f16980a-b598-4494-b489-bdfe2f46e8fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286B0A5BB50>]}
[0m23:32:29.131022 [info ] [MainThread]: fair_pricing_radar.carrier_mapping
[0m23:32:29.131022 [info ] [MainThread]: fair_pricing_radar.seed_airport_geo
[0m23:32:29.133017 [debug] [MainThread]: Command `dbt ls` succeeded at 23:32:29.133017 after 4.51 seconds
[0m23:32:29.133017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286A5E1D210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286B0666440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286B0666530>]}
[0m23:32:29.134014 [debug] [MainThread]: Flushing usage events
[0m23:32:29.517494 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:33:28.564927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC4D1D1B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC645A230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC645A050>]}


============================== 23:33:28.568916 | 89d8aba5-ecaf-413d-b604-75b6c5cb5ffe ==============================
[0m23:33:28.568916 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:33:28.569914 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt seed --select seed_airport_geo', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:33:29.470505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCEC5A890>]}
[0m23:33:29.530345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC62927A0>]}
[0m23:33:29.532340 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:33:30.106817 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:33:30.419980 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:33:30.420977 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:33:30.579553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC3178FA0>]}
[0m23:33:30.731147 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:33:30.734139 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:33:30.758075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCED4D540>]}
[0m23:33:30.759073 [info ] [MainThread]: Found 11 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:33:30.759073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC60712A0>]}
[0m23:33:30.761068 [info ] [MainThread]: 
[0m23:33:30.762065 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:33:30.762065 [info ] [MainThread]: 
[0m23:33:30.763063 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:33:30.765057 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:33:30.941584 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:33:30.941584 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:33:30.942583 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:33:36.967555 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 6.025 seconds
[0m23:33:36.975533 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:33:36.985506 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:33:36.986504 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:33:36.986504 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:33:40.971407 [debug] [ThreadPool]: SQL status: SUCCESS 9 in 3.984 seconds
[0m23:33:40.974399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCF4EDEA0>]}
[0m23:33:40.982378 [debug] [Thread-1 (]: Began running node seed.fair_pricing_radar.seed_airport_geo
[0m23:33:40.983375 [info ] [Thread-1 (]: 1 of 1 START seed file WALRUS_PUBLIC.seed_airport_geo .......................... [RUN]
[0m23:33:40.985370 [debug] [Thread-1 (]: Acquiring new snowflake connection 'seed.fair_pricing_radar.seed_airport_geo'
[0m23:33:40.985370 [debug] [Thread-1 (]: Began compiling node seed.fair_pricing_radar.seed_airport_geo
[0m23:33:40.986367 [debug] [Thread-1 (]: Began executing node seed.fair_pricing_radar.seed_airport_geo
[0m23:33:41.022272 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_airport_geo"
[0m23:33:41.022272 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_airport_geo: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_airport_geo"} */
create table FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo (iata_code text,lat_deg float8,lon_deg float8)
[0m23:33:41.023269 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:33:45.101908 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.078 seconds
[0m23:33:45.115871 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_airport_geo"
[0m23:33:45.115871 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_airport_geo: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_airport_geo"} */
BEGIN
[0m23:33:45.360721 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.244 seconds
[0m23:33:45.361718 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_airport_geo"
[0m23:33:45.362716 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_airport_geo: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_airport_geo"} */
insert into FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo (iata_code, lat_deg, lon_deg) values
            (%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,...
[0m23:33:46.346108 [debug] [Thread-1 (]: SQL status: SUCCESS 24 in 0.983 seconds
[0m23:33:46.347105 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_airport_geo"
[0m23:33:46.348102 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_airport_geo: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_airport_geo"} */
COMMIT
[0m23:33:46.728086 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.379 seconds
[0m23:33:46.733073 [debug] [Thread-1 (]: Writing runtime SQL for node "seed.fair_pricing_radar.seed_airport_geo"
[0m23:33:46.759003 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89d8aba5-ecaf-413d-b604-75b6c5cb5ffe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCFFD8370>]}
[0m23:33:46.759003 [info ] [Thread-1 (]: 1 of 1 OK loaded seed file WALRUS_PUBLIC.seed_airport_geo ...................... [[32mINSERT 24[0m in 5.77s]
[0m23:33:46.760999 [debug] [Thread-1 (]: Finished running node seed.fair_pricing_radar.seed_airport_geo
[0m23:33:46.761995 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:33:46.761995 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:33:46.762993 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:33:47.099598 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:33:47.099598 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:33:47.455646 [debug] [MainThread]: Connection 'seed.fair_pricing_radar.seed_airport_geo' was left open.
[0m23:33:47.456643 [debug] [MainThread]: On seed.fair_pricing_radar.seed_airport_geo: Close
[0m23:33:47.831159 [info ] [MainThread]: 
[0m23:33:47.832157 [info ] [MainThread]: Finished running 1 seed in 0 hours 0 minutes and 17.07 seconds (17.07s).
[0m23:33:47.833155 [debug] [MainThread]: Command end result
[0m23:33:47.860588 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:33:47.863580 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:33:47.872556 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:33:47.873554 [info ] [MainThread]: 
[0m23:33:47.874551 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:33:47.875548 [info ] [MainThread]: 
[0m23:33:47.876545 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:33:47.877542 [debug] [MainThread]: Command `dbt seed` succeeded at 23:33:47.877542 after 19.40 seconds
[0m23:33:47.878540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC4D1D1B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC42CB130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC4DD6FE0>]}
[0m23:33:47.879537 [debug] [MainThread]: Flushing usage events
[0m23:33:48.235584 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:36:17.620336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D291D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D4059CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D4059ED0>]}


============================== 23:36:17.624326 | 88529e9e-c253-43d0-8e01-30718bfe90f8 ==============================
[0m23:36:17.624326 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:36:17.625322 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:36:18.605713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88529e9e-c253-43d0-8e01-30718bfe90f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D4031CF0>]}
[0m23:36:18.666059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88529e9e-c253-43d0-8e01-30718bfe90f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DC75F820>]}
[0m23:36:18.667056 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:36:19.250508 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:36:19.557685 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:36:19.558682 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:36:19.801540 [error] [MainThread]: Encountered an error:
Compilation Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  unexpected char '─' at 43
    line 3
      --  ────────────────────────────────────────────────────────────
[0m23:36:19.803534 [debug] [MainThread]: Command `dbt run` failed at 23:36:19.803534 after 2.27 seconds
[0m23:36:19.804532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D291D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DD214A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DD216800>]}
[0m23:36:19.804532 [debug] [MainThread]: Flushing usage events
[0m23:36:20.154595 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:36:40.464623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F0D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F2456560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F2456740>]}


============================== 23:36:40.468612 | 6dbdcf20-fd51-40f1-a49f-d9e05416ecbd ==============================
[0m23:36:40.468612 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:36:40.469609 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:36:41.373711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193EF097040>]}
[0m23:36:41.439536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F1CFDE10>]}
[0m23:36:41.441530 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:36:42.019490 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:36:42.301253 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:36:42.302250 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:36:42.670280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193FB861060>]}
[0m23:36:42.809906 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:36:42.812898 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:36:42.837832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193FB4D7B80>]}
[0m23:36:42.838829 [info ] [MainThread]: Found 11 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:36:42.838829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193FB3AC190>]}
[0m23:36:42.840823 [info ] [MainThread]: 
[0m23:36:42.841820 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:36:42.841820 [info ] [MainThread]: 
[0m23:36:42.842819 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:36:42.844813 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:36:42.970476 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:36:42.971474 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:36:42.971474 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:36:48.363109 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.391 seconds
[0m23:36:48.371088 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:36:48.381060 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:36:48.382058 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:36:48.382058 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:36:52.413355 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 4.031 seconds
[0m23:36:52.418342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193FB4D7D60>]}
[0m23:36:52.422331 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:36:52.423329 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:36:52.424326 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:36:52.425323 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:36:52.435296 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:36:52.438289 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:36:52.470203 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:36:52.474192 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:36:52.475190 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1. Booking-level facts
-- ╰────────────────────────────────────────────────────────────╯
with booking as (    

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code,

        /* keep raw distance for fall-back #2 */
        s.totaltraveldistance                               as raw_trip_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2. Summed distance per LEGID  (fall-back #1)
-- ╰────────────────────────────────────────────────────────────╯
trip_distance as (    
    select
        legid,
        sum(leg_distance)          as leg_sum_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by legid
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3. Airport geo lookup  (lat / lon in degrees)
-- ╰────────────────────────────────────────────────────────────╯
airport_geo as (
    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo         -- IATA, lat_deg, lon_deg
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4. Join everything & compute final trip_dist
-- ╰────────────────────────────────────────────────────────────╯
enriched as (

    select
        b.*,

        /* distance cascade:
           1) summed legs
           2) raw distance from booking
           3) great-circle distance between O&D (+2 % padding)
           4) route-level median (unlikely to be used now)
        */
        coalesce(
            d.leg_sum_distance,
            b.raw_trip_distance,
            1.02 * st_distance_sphere(
                     to_geography('POINT('||ao.lon_deg||' '||ao.lat_deg||')'),
                     to_geography('POINT('||ad.lon_deg||' '||ad.lat_deg||')')
                   ) / 1609.344,          -- convert metres → statute miles
            median(d.leg_sum_distance) over (partition by b.route)
        )                                   as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name
    from booking b
    left join trip_distance            d  using (legid)
    left join airport_geo              ao on ao.iata_code = b.origin
    left join airport_geo              ad on ad.iata_code = b.destination
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   c
           on  c.route = b.route
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices  p
           on  p.route         = b.route
           and p.carrier_code  = b.carrier_code
           and p.dtf_bucket    = b.dtf_bucket
           and p.flight_date   = b.flight_date
    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier  dc
           on dc.carrier_code  = b.carrier_code
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5. Flag logic
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        -----------------------------------------------------------
        -- R1  Last-minute spike
        -----------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                      as r1_last_minute_spike,

        -----------------------------------------------------------
        -- R2  Opacity / ancillary markup
        -----------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                      as r2_opacity_markup,

        -----------------------------------------------------------
        -- R3  Monopoly premium  (HHI > 0.8 and  > $1 / mi)
        -----------------------------------------------------------
        case
          when hhi > 0.80
           and total_fare / nullif(trip_dist,1) > 1.00
          then 1 end                                      as r3_monopoly_premium,

        -----------------------------------------------------------
        -- R4 placeholder
        -----------------------------------------------------------
        0                                                 as r4_parallel_move
    from enriched
)

select * from flags;
[0m23:36:52.476187 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:36:56.346878 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe3ed-0305-0bb1-0006-8fdb00179976
[0m23:36:56.347875 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 143 at position 19 unexpected ';'.
[0m23:36:56.349870 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 143 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:36:56.352862 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6dbdcf20-fd51-40f1-a49f-d9e05416ecbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F090DD50>]}
[0m23:36:56.353860 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.93s]
[0m23:36:56.354857 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:36:56.355854 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 143 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m23:36:56.357848 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:36:56.357848 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:36:56.358846 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:36:56.725864 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:36:56.725864 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:36:57.055981 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:36:57.055981 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:36:57.399074 [info ] [MainThread]: 
[0m23:36:57.400072 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.56 seconds (14.56s).
[0m23:36:57.401070 [debug] [MainThread]: Command end result
[0m23:36:57.428994 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:36:57.431986 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:36:57.440964 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:36:57.441961 [info ] [MainThread]: 
[0m23:36:57.442958 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:36:57.442958 [info ] [MainThread]: 
[0m23:36:57.443955 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 143 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:36:57.444952 [info ] [MainThread]: 
[0m23:36:57.444952 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:36:57.447944 [debug] [MainThread]: Command `dbt run` failed at 23:36:57.447944 after 17.06 seconds
[0m23:36:57.448941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F0D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F1CFDE10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000193F0DD44C0>]}
[0m23:36:57.449939 [debug] [MainThread]: Flushing usage events
[0m23:36:57.800999 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:37:08.924931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3151D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC32C59D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC32C59F30>]}


============================== 23:37:08.928920 | 2997dcdb-05ec-4818-8b2b-c9a75d044f76 ==============================
[0m23:37:08.928920 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:37:08.929918 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:37:09.833515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC32C320B0>]}
[0m23:37:09.893355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3B35D240>]}
[0m23:37:09.895350 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:37:10.474811 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:37:10.767546 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:37:10.768544 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:37:11.134565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3BF5D000>]}
[0m23:37:11.276187 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:37:11.278180 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:37:11.301120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3BDD65C0>]}
[0m23:37:11.302117 [info ] [MainThread]: Found 11 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:37:11.302117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3BCA9D80>]}
[0m23:37:11.304112 [info ] [MainThread]: 
[0m23:37:11.305109 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:37:11.305109 [info ] [MainThread]: 
[0m23:37:11.306107 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:37:11.308103 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:37:11.419802 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:37:11.420799 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:37:11.420799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:37:15.708400 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 4.287 seconds
[0m23:37:15.716379 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:37:15.726352 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:37:15.727349 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:37:15.727349 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:37:19.751150 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 4.023 seconds
[0m23:37:19.755139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3BDD4A90>]}
[0m23:37:19.759129 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:37:19.760126 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:37:19.761124 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:37:19.762121 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:37:19.772094 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:37:19.773091 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:37:19.805006 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:37:19.809992 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:37:19.810991 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1. Booking-level facts
-- ╰────────────────────────────────────────────────────────────╯
with booking as (    

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code,

        /* keep raw distance for fall-back #2 */
        s.totaltraveldistance                               as raw_trip_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2. Summed distance per LEGID  (fall-back #1)
-- ╰────────────────────────────────────────────────────────────╯
trip_distance as (    
    select
        legid,
        sum(leg_distance)          as leg_sum_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by legid
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3. Airport geo lookup  (lat / lon in degrees)
-- ╰────────────────────────────────────────────────────────────╯
airport_geo as (
    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo         -- IATA, lat_deg, lon_deg
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4. Join everything & compute final trip_dist
-- ╰────────────────────────────────────────────────────────────╯
enriched as (

    select
        b.*,

        /* distance cascade:
           1) summed legs
           2) raw distance from booking
           3) great-circle distance between O&D (+2 % padding)
           4) route-level median (unlikely to be used now)
        */
        coalesce(
            d.leg_sum_distance,
            b.raw_trip_distance,
            1.02 * st_distance_sphere(
                     to_geography('POINT('||ao.lon_deg||' '||ao.lat_deg||')'),
                     to_geography('POINT('||ad.lon_deg||' '||ad.lat_deg||')')
                   ) / 1609.344,          -- convert metres → statute miles
            median(d.leg_sum_distance) over (partition by b.route)
        )                                   as trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name
    from booking b
    left join trip_distance            d  using (legid)
    left join airport_geo              ao on ao.iata_code = b.origin
    left join airport_geo              ad on ad.iata_code = b.destination
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   c
           on  c.route = b.route
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices  p
           on  p.route         = b.route
           and p.carrier_code  = b.carrier_code
           and p.dtf_bucket    = b.dtf_bucket
           and p.flight_date   = b.flight_date
    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier  dc
           on dc.carrier_code  = b.carrier_code
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5. Flag logic
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        -----------------------------------------------------------
        -- R1  Last-minute spike
        -----------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                      as r1_last_minute_spike,

        -----------------------------------------------------------
        -- R2  Opacity / ancillary markup
        -----------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                      as r2_opacity_markup,

        -----------------------------------------------------------
        -- R3  Monopoly premium  (HHI > 0.8 and  > $1 / mi)
        -----------------------------------------------------------
        case
          when hhi > 0.80
           and total_fare / nullif(trip_dist,1) > 1.00
          then 1 end                                      as r3_monopoly_premium,

        -----------------------------------------------------------
        -- R4 placeholder
        -----------------------------------------------------------
        0                                                 as r4_parallel_move
    from enriched
)

select * from flags
        );
[0m23:37:19.811987 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:37:23.601412 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe3ee-0305-0c98-0006-8fdb00176b6a
[0m23:37:23.602409 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 002140 (42601): SQL compilation error:
Unknown function ST_DISTANCE_SPHERE
[0m23:37:23.604405 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002140 (42601): SQL compilation error:
  Unknown function ST_DISTANCE_SPHERE
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:37:23.606399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2997dcdb-05ec-4818-8b2b-c9a75d044f76', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC310D4460>]}
[0m23:37:23.607396 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.84s]
[0m23:37:23.608394 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:37:23.609391 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002140 (42601): SQL compilation error:
  Unknown function ST_DISTANCE_SPHERE
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m23:37:23.611385 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:37:23.612383 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:37:23.612383 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:37:23.982393 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:37:23.983390 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:37:24.425231 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:37:24.426228 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:37:24.756849 [info ] [MainThread]: 
[0m23:37:24.757846 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.45 seconds (13.45s).
[0m23:37:24.758844 [debug] [MainThread]: Command end result
[0m23:37:24.786768 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:37:24.789761 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:37:24.797740 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:37:24.797740 [info ] [MainThread]: 
[0m23:37:24.798738 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:37:24.799735 [info ] [MainThread]: 
[0m23:37:24.800732 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002140 (42601): SQL compilation error:
  Unknown function ST_DISTANCE_SPHERE
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:37:24.801729 [info ] [MainThread]: 
[0m23:37:24.801729 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:37:24.803724 [debug] [MainThread]: Command `dbt run` failed at 23:37:24.803724 after 15.96 seconds
[0m23:37:24.804721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3151D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3B35D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC315D77F0>]}
[0m23:37:24.805720 [debug] [MainThread]: Flushing usage events
[0m23:37:25.172737 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:39:20.691074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA631D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA7A5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA7A5E1A0>]}


============================== 23:39:20.695064 | 2498a5ef-d827-473b-819d-0cf385b8dc07 ==============================
[0m23:39:20.695064 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:39:20.696062 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:39:21.616615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA4697040>]}
[0m23:39:21.677452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA72FE2C0>]}
[0m23:39:21.679447 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:39:22.261397 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:39:22.558110 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:39:22.559108 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:39:22.938094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB0E5D060>]}
[0m23:39:23.086696 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:39:23.088691 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:39:23.111630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB0AD7490>]}
[0m23:39:23.112627 [info ] [MainThread]: Found 11 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:39:23.113624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB09A8A60>]}
[0m23:39:23.115619 [info ] [MainThread]: 
[0m23:39:23.115619 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:39:23.116617 [info ] [MainThread]: 
[0m23:39:23.117614 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:39:23.118611 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:39:23.262227 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:39:23.263224 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:39:23.264221 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:39:28.494794 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.231 seconds
[0m23:39:28.501774 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:39:28.511748 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:39:28.512745 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:39:28.513743 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:39:32.234362 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 3.721 seconds
[0m23:39:32.238350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB0AD4AC0>]}
[0m23:39:32.243337 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:39:32.243337 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:39:32.245332 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:39:32.245332 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:39:32.255305 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:39:32.256302 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:39:32.289215 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:39:32.294202 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:39:32.295199 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1. Booking-level facts
-- ╰────────────────────────────────────────────────────────────╯
with booking as (    

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code,

        /* keep raw distance for fall-back #2 */
        s.totaltraveldistance                               as raw_trip_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2. Summed distance per LEGID  (fall-back #1)
-- ╰────────────────────────────────────────────────────────────╯
trip_distance as (    
    select
        legid,
        sum(leg_distance)          as leg_sum_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by legid
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3. Airport geo lookup  (lat / lon in degrees)
-- ╰────────────────────────────────────────────────────────────╯
airport_geo as (
    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo         -- IATA, lat_deg, lon_deg
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4. Join everything & compute final trip_dist
-- ╰────────────────────────────────────────────────────────────╯
enriched as (

    select
        b.*,

        /* distance cascade:
           1) summed legs
           2) raw distance from booking
           3) great-circle distance between O&D (+2 % padding)
           4) route-level median (unlikely to be used now)
        */
        coalesce(
      d.leg_sum_distance,
      b.raw_trip_distance,
      -- swap ST_DISTANCE_SPHERE for ST_DISTANCE:
      1.02
      * ST_DISTANCE(
          TO_GEOGRAPHY('POINT(' || ao.lon_deg || ' ' || ao.lat_deg || ')'),
          TO_GEOGRAPHY('POINT(' || ad.lon_deg || ' ' || ad.lat_deg || ')')
        )
      / 1609.344,  -- meters → miles
      median(d.leg_sum_distance) OVER (PARTITION BY b.route)
    ) AS trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name
    from booking b
    left join trip_distance            d  using (legid)
    left join airport_geo              ao on ao.iata_code = b.origin
    left join airport_geo              ad on ad.iata_code = b.destination
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   c
           on  c.route = b.route
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices  p
           on  p.route         = b.route
           and p.carrier_code  = b.carrier_code
           and p.dtf_bucket    = b.dtf_bucket
           and p.flight_date   = b.flight_date
    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier  dc
           on dc.carrier_code  = b.carrier_code
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5. Flag logic
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        -----------------------------------------------------------
        -- R1  Last-minute spike
        -----------------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                      as r1_last_minute_spike,

        -----------------------------------------------------------
        -- R2  Opacity / ancillary markup
        -----------------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                      as r2_opacity_markup,

        -----------------------------------------------------------
        -- R3  Monopoly premium  (HHI > 0.8 and  > $1 / mi)
        -----------------------------------------------------------
        case
          when hhi > 0.80
           and total_fare / nullif(trip_dist,1) > 1.00
          then 1 end                                      as r3_monopoly_premium,

        -----------------------------------------------------------
        -- R4 placeholder
        -----------------------------------------------------------
        0                                                 as r4_parallel_move
    from enriched
)

select * from flags
        );
[0m23:39:32.296196 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:41:49.547036 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 137.252 seconds
[0m23:41:49.571970 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2498a5ef-d827-473b-819d-0cf385b8dc07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA42CD600>]}
[0m23:41:49.572968 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 137.33s]
[0m23:41:49.573965 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:41:49.574962 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:41:49.575959 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:41:49.575959 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:41:49.923041 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:41:49.923041 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:41:50.264129 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:41:50.264129 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:41:50.624167 [info ] [MainThread]: 
[0m23:41:50.625164 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 27.51 seconds (147.51s).
[0m23:41:50.627159 [debug] [MainThread]: Command end result
[0m23:41:50.655589 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:41:50.658581 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:41:50.665563 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:41:50.666560 [info ] [MainThread]: 
[0m23:41:50.667557 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:41:50.668555 [info ] [MainThread]: 
[0m23:41:50.669552 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:41:50.670549 [debug] [MainThread]: Command `dbt run` succeeded at 23:41:50.670549 after 150.06 seconds
[0m23:41:50.671547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAA631D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB03BCA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAB0B06440>]}
[0m23:41:50.672544 [debug] [MainThread]: Flushing usage events
[0m23:41:51.028593 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:53:58.543891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B711D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B885A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B885A170>]}


============================== 23:53:58.547880 | 99bb6711-1199-4fdc-981c-069731b42c28 ==============================
[0m23:53:58.547880 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:53:58.548878 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:53:59.495851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '99bb6711-1199-4fdc-981c-069731b42c28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B5497070>]}
[0m23:53:59.555691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '99bb6711-1199-4fdc-981c-069731b42c28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B80FDBD0>]}
[0m23:53:59.556688 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:54:00.131668 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:54:00.415414 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:54:00.416412 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m23:54:00.779441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '99bb6711-1199-4fdc-981c-069731b42c28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0C1C49420>]}
[0m23:54:00.923057 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:54:00.926050 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:54:00.952978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '99bb6711-1199-4fdc-981c-069731b42c28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0C18D4A30>]}
[0m23:54:00.953975 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:54:00.954973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99bb6711-1199-4fdc-981c-069731b42c28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0C19EB4F0>]}
[0m23:54:00.955969 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m23:54:00.956967 [debug] [MainThread]: Command end result
[0m23:54:00.988884 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:54:00.991873 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:54:00.996860 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:54:00.998855 [debug] [MainThread]: Command `dbt run` succeeded at 23:54:00.997858 after 2.53 seconds
[0m23:54:00.998855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B711D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0C1C19CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B5EA0C40>]}
[0m23:54:00.999852 [debug] [MainThread]: Flushing usage events
[0m23:54:01.338451 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:56:07.311488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244B4E1D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244B6559AE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244B6559CC0>]}


============================== 23:56:07.315476 | e4db534a-9ae9-4847-a860-84a44f02255e ==============================
[0m23:56:07.315476 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:56:07.316474 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt ls -s int_route_fare_per_mi_stats', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:56:08.287395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4db534a-9ae9-4847-a860-84a44f02255e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BEB60E80>]}
[0m23:56:08.347235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4db534a-9ae9-4847-a860-84a44f02255e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BEB63F40>]}
[0m23:56:08.349230 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:56:08.917228 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:56:09.205457 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:56:09.206455 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:56:09.578460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4db534a-9ae9-4847-a860-84a44f02255e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BF7616C0>]}
[0m23:56:09.717089 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:56:09.720082 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:56:09.740029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4db534a-9ae9-4847-a860-84a44f02255e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BF71CE50>]}
[0m23:56:09.741026 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:56:09.742023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4db534a-9ae9-4847-a860-84a44f02255e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BF71CC70>]}
[0m23:56:09.743020 [info ] [MainThread]: fair_pricing_radar.intermediate.int_route_fare_per_mi_stats
[0m23:56:09.744018 [debug] [MainThread]: Command `dbt ls` succeeded at 23:56:09.744018 after 2.51 seconds
[0m23:56:09.745015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244B4E1D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BEB63F40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244BF78EB90>]}
[0m23:56:09.746012 [debug] [MainThread]: Flushing usage events
[0m23:56:10.122018 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:56:23.482968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE351D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE4C5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE4C5E1A0>]}


============================== 23:56:23.486956 | 406de34d-9a7e-4978-ab87-7f21c112186a ==============================
[0m23:56:23.486956 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:56:23.487955 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:56:24.386057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '406de34d-9a7e-4978-ab87-7f21c112186a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AED45C3A0>]}
[0m23:56:24.444900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '406de34d-9a7e-4978-ab87-7f21c112186a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AED45FB50>]}
[0m23:56:24.445898 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:56:25.002434 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:56:25.281687 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:56:25.282683 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:56:25.417324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '406de34d-9a7e-4978-ab87-7f21c112186a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AEDDD9150>]}
[0m23:56:25.558945 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:56:25.560940 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:56:25.583879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '406de34d-9a7e-4978-ab87-7f21c112186a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE4BF2950>]}
[0m23:56:25.584876 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m23:56:25.585874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '406de34d-9a7e-4978-ab87-7f21c112186a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE4BF36D0>]}
[0m23:56:25.586871 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m23:56:25.589862 [debug] [MainThread]: Command end result
[0m23:56:25.619783 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:56:25.622775 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:56:25.627761 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:56:25.629757 [debug] [MainThread]: Command `dbt run` succeeded at 23:56:25.629757 after 2.23 seconds
[0m23:56:25.630753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE351D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AED5F7730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AE35D4C40>]}
[0m23:56:25.630753 [debug] [MainThread]: Flushing usage events
[0m23:56:25.977331 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:59:35.800044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B2F1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B4659D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B4659F30>]}


============================== 23:59:35.804033 | ea7e3148-16b0-4c82-b7f1-e40191a51da6 ==============================
[0m23:59:35.804033 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:59:35.805032 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'send_anonymous_usage_stats': 'True'}
[0m23:59:36.719092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea7e3148-16b0-4c82-b7f1-e40191a51da6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199BCE5C3A0>]}
[0m23:59:36.778931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea7e3148-16b0-4c82-b7f1-e40191a51da6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199BCE5FB50>]}
[0m23:59:36.779929 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:59:37.353421 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:59:37.637660 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:59:37.638657 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m23:59:38.006673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea7e3148-16b0-4c82-b7f1-e40191a51da6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199BDA63FA0>]}
[0m23:59:38.154784 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:59:38.157776 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:59:38.177723 [error] [MainThread]: Encountered an error:
Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m23:59:38.336298 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 153, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 103, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 235, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 264, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 311, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 328, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\main.py", line 578, in run
    results = task.run()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 574, in run
    self._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\compile.py", line 133, in _runtime_initialize
    super()._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 170, in _runtime_initialize
    self.compile_manifest()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\base.py", line 134, in compile_manifest
    self.graph = self.compiler.compile(self.manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 475, in compile
    linker.link_graph(manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 195, in link_graph
    raise RuntimeError("Found a cycle: {}".format(cycle))
RuntimeError: Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats

[0m23:59:38.340288 [debug] [MainThread]: Command `dbt run` failed at 23:59:38.340288 after 2.62 seconds
[0m23:59:38.341285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199B2F1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199BD6DB2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199BD6D9F60>]}
[0m23:59:38.341285 [debug] [MainThread]: Flushing usage events
[0m23:59:38.687370 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:01:35.758516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63191D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E633059D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E633059F30>]}


============================== 00:01:35.761508 | 82288416-d885-4da2-a4d2-6cb04b33f3ae ==============================
[0m00:01:35.761508 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:01:35.762506 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'send_anonymous_usage_stats': 'True'}
[0m00:01:36.679559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '82288416-d885-4da2-a4d2-6cb04b33f3ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63B75C3A0>]}
[0m00:01:36.738906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '82288416-d885-4da2-a4d2-6cb04b33f3ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63B75FB50>]}
[0m00:01:36.740901 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:01:37.318357 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:01:37.608580 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:01:37.609578 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:01:37.980586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '82288416-d885-4da2-a4d2-6cb04b33f3ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63C33D480>]}
[0m00:01:38.122711 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:01:38.125704 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:01:38.145650 [error] [MainThread]: Encountered an error:
Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:01:38.147645 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 153, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 103, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 235, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 264, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 311, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 328, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\main.py", line 578, in run
    results = task.run()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 574, in run
    self._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\compile.py", line 133, in _runtime_initialize
    super()._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 170, in _runtime_initialize
    self.compile_manifest()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\base.py", line 134, in compile_manifest
    self.graph = self.compiler.compile(self.manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 475, in compile
    linker.link_graph(manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 195, in link_graph
    raise RuntimeError("Found a cycle: {}".format(cycle))
RuntimeError: Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats

[0m00:01:38.151634 [debug] [MainThread]: Command `dbt run` failed at 00:01:38.151634 after 2.47 seconds
[0m00:01:38.151634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63191D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63C0B50F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63C0B4FA0>]}
[0m00:01:38.152632 [debug] [MainThread]: Flushing usage events
[0m00:01:38.504196 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:03:07.891456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530BF1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530D659D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530D659F00>]}


============================== 00:03:07.896442 | 421961c8-e5f3-4dab-af78-f470b81ebcd2 ==============================
[0m00:03:07.896442 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:03:07.897440 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:03:08.832445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '421961c8-e5f3-4dab-af78-f470b81ebcd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530D621CF0>]}
[0m00:03:08.891792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '421961c8-e5f3-4dab-af78-f470b81ebcd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530D493550>]}
[0m00:03:08.893788 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:03:09.476241 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:03:09.771465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:03:09.772462 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:03:10.147459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '421961c8-e5f3-4dab-af78-f470b81ebcd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001531693D4E0>]}
[0m00:03:10.290077 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:03:10.293070 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:03:10.313016 [error] [MainThread]: Encountered an error:
Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:03:10.315011 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 153, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 103, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 235, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 264, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 311, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\requires.py", line 328, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\cli\main.py", line 578, in run
    results = task.run()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 574, in run
    self._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\compile.py", line 133, in _runtime_initialize
    super()._runtime_initialize()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\runnable.py", line 170, in _runtime_initialize
    self.compile_manifest()
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\task\base.py", line 134, in compile_manifest
    self.graph = self.compiler.compile(self.manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 475, in compile
    linker.link_graph(manifest)
  File "C:\Users\Mattia\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.10_qbz5n2kfra8p0\LocalCache\local-packages\Python310\site-packages\dbt\compilation.py", line 195, in link_graph
    raise RuntimeError("Found a cycle: {}".format(cycle))
RuntimeError: Found a cycle: model.fair_pricing_radar.mart_pricing_features --> model.fair_pricing_radar.int_route_fare_per_mi_stats

[0m00:03:10.318003 [debug] [MainThread]: Command `dbt run` failed at 00:03:10.318003 after 2.51 seconds
[0m00:03:10.319000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001530BF1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153166AD360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000153166AD570>]}
[0m00:03:10.319998 [debug] [MainThread]: Flushing usage events
[0m00:03:10.678543 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:04:27.130810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2AC1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2C35DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2C35E1D0>]}


============================== 00:04:27.134800 | 232d4604-964a-4c72-aad9-7b3e7f6d0ac6 ==============================
[0m00:04:27.134800 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:04:27.135797 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m00:04:28.124169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2C321CF0>]}
[0m00:04:28.187998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2C193550>]}
[0m00:04:28.188996 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:04:28.774953 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:04:29.074153 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:04:29.075151 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:04:29.448153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA3555FFA0>]}
[0m00:04:29.593763 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:04:29.596755 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:04:29.619695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA352AD960>]}
[0m00:04:29.619695 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m00:04:29.620692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA352AD4E0>]}
[0m00:04:29.622687 [info ] [MainThread]: 
[0m00:04:29.623684 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:04:29.623684 [info ] [MainThread]: 
[0m00:04:29.624681 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:04:29.625679 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:04:29.755332 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:04:29.755332 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:04:29.756330 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:04:34.842298 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.086 seconds
[0m00:04:34.849279 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:04:34.859757 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:04:34.860754 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:04:34.860754 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:04:38.631228 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 3.771 seconds
[0m00:04:38.636215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA353E1060>]}
[0m00:04:38.640204 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:04:38.641201 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats ......... [RUN]
[0m00:04:38.642199 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m00:04:38.643196 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:04:38.651174 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:04:38.652172 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:04:38.685084 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:04:38.687079 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:04:38.688076 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
         as
        (-- models/intermediate/int_route_fare_per_mi_stats.sql


with per_leg as (

  select
    route,
    total_fare / trip_dist as usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices   -- instead of mart_pricing_features
  where hhi >= 0.90

)

select
  route,
  percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi
from per_leg
group by route
        );
[0m00:04:38.689073 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:04:42.237604 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe409-0305-0f94-0006-8fdb0017b1f2
[0m00:04:42.238602 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 10 at position 4
invalid identifier 'TOTAL_FARE'
[0m00:04:42.240596 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 10 at position 4
  invalid identifier 'TOTAL_FARE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:04:42.243589 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '232d4604-964a-4c72-aad9-7b3e7f6d0ac6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2A811D50>]}
[0m00:04:42.244586 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.60s]
[0m00:04:42.245583 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:04:42.245583 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 10 at position 4
  invalid identifier 'TOTAL_FARE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql.
[0m00:04:42.247578 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:04:42.248575 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:04:42.248575 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:04:42.620087 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:04:42.621084 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:04:43.140716 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m00:04:43.141713 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m00:04:43.485793 [info ] [MainThread]: 
[0m00:04:43.486790 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.86 seconds (13.86s).
[0m00:04:43.487789 [debug] [MainThread]: Command end result
[0m00:04:43.517709 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:04:43.520701 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:04:43.530674 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:04:43.531672 [info ] [MainThread]: 
[0m00:04:43.532669 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m00:04:43.532669 [info ] [MainThread]: 
[0m00:04:43.533666 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 10 at position 4
  invalid identifier 'TOTAL_FARE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:04:43.534664 [info ] [MainThread]: 
[0m00:04:43.535661 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m00:04:43.537655 [debug] [MainThread]: Command `dbt run` failed at 00:04:43.537655 after 16.51 seconds
[0m00:04:43.538653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2AC1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2C321CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2ACD44C0>]}
[0m00:04:43.538653 [debug] [MainThread]: Flushing usage events
[0m00:04:43.898689 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:06:40.341619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA2D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA445DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA445E1D0>]}


============================== 00:06:40.345609 | 946e65a5-cf89-4a83-886d-991886f44160 ==============================
[0m00:06:40.345609 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:06:40.346606 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:06:41.254682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA4435CF0>]}
[0m00:06:41.315519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA4293550>]}
[0m00:06:41.317514 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:06:41.883522 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:06:42.176242 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:06:42.177240 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m00:06:42.545255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAD85D510>]}
[0m00:06:42.687874 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:06:42.690866 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:06:42.712808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAD81D4E0>]}
[0m00:06:42.713805 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m00:06:42.714802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAD81D3C0>]}
[0m00:06:42.716797 [info ] [MainThread]: 
[0m00:06:42.717794 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:06:42.717794 [info ] [MainThread]: 
[0m00:06:42.718791 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:06:42.719789 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:06:42.830492 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:06:42.830492 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:06:42.831491 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:06:48.142372 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.311 seconds
[0m00:06:48.150351 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:06:48.160324 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:06:48.161322 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:06:48.161322 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:06:52.183119 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 4.021 seconds
[0m00:06:52.187108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAD3BAAA0>]}
[0m00:06:52.191098 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:06:52.192095 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats ......... [RUN]
[0m00:06:52.193093 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m00:06:52.194090 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:06:52.202068 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:06:52.204063 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:06:52.236975 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:06:52.239967 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m00:06:52.239967 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
         as
        (

with per_leg as (

  select
    -- build the same route key
    s.origin || '-' || s.destination       as route,

    -- total_fare from staging, leg distance from int_fare_legs
    s.total_fare / d.leg_sum_distance      as usd_per_mi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches   s
  join (
    select
      legid,
      sum(leg_distance) as leg_sum_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by legid
  ) d using (legid)

  -- only highly concentrated routes
  join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition rc
    on rc.route = s.origin || '-' || s.destination
  where rc.hhi >= 0.90

)

select
  route,
  percentile_cont(0.95)
    within group (order by usd_per_mi)  as p95_usd_per_mi
from per_leg
group by route
        );
[0m00:06:52.240964 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:07:04.622002 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 12.382 seconds
[0m00:07:04.643944 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '946e65a5-cf89-4a83-886d-991886f44160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF9FCCD600>]}
[0m00:07:04.644941 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats .... [[32mSUCCESS 1[0m in 12.45s]
[0m00:07:04.645939 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m00:07:04.646936 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:07:04.647933 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:07:04.647933 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:07:05.084285 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:07:05.084285 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:07:05.409919 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m00:07:05.410916 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m00:07:05.784917 [info ] [MainThread]: 
[0m00:07:05.787910 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 23.07 seconds (23.07s).
[0m00:07:05.789904 [debug] [MainThread]: Command end result
[0m00:07:05.829798 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:07:05.834784 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:07:05.848747 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:07:05.850741 [info ] [MainThread]: 
[0m00:07:05.851738 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:07:05.854730 [info ] [MainThread]: 
[0m00:07:05.855728 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:07:05.860714 [debug] [MainThread]: Command `dbt run` succeeded at 00:07:05.860714 after 25.60 seconds
[0m00:07:05.862709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA2D1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA4293550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAD892BC0>]}
[0m00:07:05.863706 [debug] [MainThread]: Flushing usage events
[0m00:07:06.222255 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:07:53.044206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B64551D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B646C565F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B646C567D0>]}


============================== 00:07:53.049193 | b7744838-afc6-4431-b0c1-bd5b71489e23 ==============================
[0m00:07:53.049193 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:07:53.050191 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m00:07:53.962763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B646C2E0B0>]}
[0m00:07:54.021605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B64F45D240>]}
[0m00:07:54.023600 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:07:54.597570 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:07:54.877340 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:07:54.878337 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:07:55.012485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B641216C80>]}
[0m00:07:55.154106 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:07:55.158096 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:07:55.181034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B646BF38E0>]}
[0m00:07:55.182032 [info ] [MainThread]: Found 12 models, 1 analysis, 2 seeds, 7 data tests, 1 source, 474 macros
[0m00:07:55.183029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B646BF2CE0>]}
[0m00:07:55.185024 [info ] [MainThread]: 
[0m00:07:55.185024 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:07:55.186021 [info ] [MainThread]: 
[0m00:07:55.187019 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:07:55.188016 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:07:55.324650 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:07:55.324650 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:07:55.325647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:08:01.236920 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 5.912 seconds
[0m00:08:01.244899 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:08:01.254872 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:08:01.255870 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:08:01.255870 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:08:05.399855 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 4.144 seconds
[0m00:08:05.404841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B64F4E72E0>]}
[0m00:08:05.408831 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m00:08:05.409828 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m00:08:05.410825 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m00:08:05.411823 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m00:08:05.421796 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m00:08:05.423791 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m00:08:05.454708 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m00:08:05.459694 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m00:08:05.460692 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1. Booking-level facts
-- ╰────────────────────────────────────────────────────────────╯
with booking as (    

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination                     as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between 0  and 3  then '00-03'
            when s.days_to_flight between 4  and 7  then '04-07'
            when s.days_to_flight between 8  and 29 then '08-29'
            else                                       '30+'
        end                                                 as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)                as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                                 as carrier_code,

        /* keep raw distance for fall-back #2 */
        s.totaltraveldistance                               as raw_trip_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2. Summed distance per LEGID  (fall-back #1)
-- ╰────────────────────────────────────────────────────────────╯
trip_distance as (    
    select
        legid,
        sum(leg_distance)          as leg_sum_distance
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
    group by legid
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3. Airport geo lookup  (lat / lon in degrees)
-- ╰────────────────────────────────────────────────────────────╯
airport_geo as (
    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo         -- IATA, lat_deg, lon_deg
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4. Join everything & compute final trip_dist
-- ╰────────────────────────────────────────────────────────────╯
enriched as (

    select
        b.*,

        /* distance cascade:
           1) summed legs
           2) raw distance from booking
           3) great-circle distance between O&D (+2 % padding)
           4) route-level median (unlikely to be used now)
        */
        coalesce(
      d.leg_sum_distance,
      b.raw_trip_distance,
      -- swap ST_DISTANCE_SPHERE for ST_DISTANCE:
      1.02
      * ST_DISTANCE(
          TO_GEOGRAPHY('POINT(' || ao.lon_deg || ' ' || ao.lat_deg || ')'),
          TO_GEOGRAPHY('POINT(' || ad.lon_deg || ' ' || ad.lat_deg || ')')
        )
      / 1609.344,  -- meters → miles
      median(d.leg_sum_distance) OVER (PARTITION BY b.route)
    ) AS trip_dist,

        c.carrier_count,
        c.hhi,

        p.median_fare,
        p.p95_fare,
        p.median_ratio,
        p.p95_ratio,

        dc.carrier_name
    from booking b
    left join trip_distance            d  using (legid)
    left join airport_geo              ao on ao.iata_code = b.origin
    left join airport_geo              ad on ad.iata_code = b.destination
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   c
           on  c.route = b.route
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices  p
           on  p.route         = b.route
           and p.carrier_code  = b.carrier_code
           and p.dtf_bucket    = b.dtf_bucket
           and p.flight_date   = b.flight_date
    left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier  dc
           on dc.carrier_code  = b.carrier_code
),
enriched2 as (

    select
        e.*,
        r.p95_usd_per_mi
    from enriched e
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats r
      on r.route = e.route
),
-- ╭────────────────────────────────────────────────────────────╮
-- 5. Flag logic
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        ----------------------------------------------------
        -- R1  last-minute spike (unchanged)
        ----------------------------------------------------
        case
          when dtf_bucket = '00-03'
           and total_fare > 1.5 * coalesce(median_fare, total_fare)
          then 1 end                                    as r1_last_minute_spike,

        ----------------------------------------------------
        -- R2  opacity / ancillary markup (unchanged)
        ----------------------------------------------------
        case
          when total_base_ratio > 1.2 * coalesce(p95_ratio, total_base_ratio)
          then 1 end                                    as r2_opacity_markup,

        ----------------------------------------------------
        -- R3  monopoly premium  (dynamic)
        ----------------------------------------------------
        case
          when hhi >= 0.90                               -- concentrated route
           and trip_dist > 0                             -- safety guard
           and total_fare / trip_dist >
                    greatest(0.75,                      -- absolute floor
                             1.25 * p95_usd_per_mi)     -- 25 % > route 95-th
          then 1 end                                    as r3_monopoly_premium,

        ----------------------------------------------------
        -- R4  parallel-move placeholder
        ----------------------------------------------------
        0                                               as r4_parallel_move

    from enriched2
)

select * from flags
        );
[0m00:08:05.461689 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:10:23.586736 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 138.125 seconds
[0m00:10:23.611669 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b7744838-afc6-4431-b0c1-bd5b71489e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B64F4E7070>]}
[0m00:10:23.612667 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 138.20s]
[0m00:10:23.613665 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m00:10:23.614662 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:10:23.615659 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:10:23.615659 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:10:23.982184 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:10:23.982184 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:10:24.335745 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m00:10:24.335745 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m00:10:24.676832 [info ] [MainThread]: 
[0m00:10:24.677830 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 29.49 seconds (149.49s).
[0m00:10:24.678828 [debug] [MainThread]: Command end result
[0m00:10:24.706753 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:10:24.708747 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:10:24.716726 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:10:24.716726 [info ] [MainThread]: 
[0m00:10:24.717723 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:10:24.718721 [info ] [MainThread]: 
[0m00:10:24.719718 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:10:24.720716 [debug] [MainThread]: Command `dbt run` succeeded at 00:10:24.720716 after 151.75 seconds
[0m00:10:24.721712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B64551D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6455B2110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B6506E9960>]}
[0m00:10:24.722710 [debug] [MainThread]: Flushing usage events
[0m00:10:25.060311 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:26:05.265964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFC41D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFDB5A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFDB5A170>]}


============================== 17:26:05.289900 | 6ea941ef-a971-46f5-9228-d021c2312cb6 ==============================
[0m17:26:05.289900 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:26:05.290897 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt seed --select seed_fare_bucket_map', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:26:11.627940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFDB29CC0>]}
[0m17:26:11.695758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E8645BB50>]}
[0m17:26:11.703738 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:26:12.440765 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:26:12.637239 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m17:26:12.638238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFD1FEB60>]}
[0m17:26:15.863606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E871F9810>]}
[0m17:26:16.021185 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:26:16.046118 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:26:16.294454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E8717C1C0>]}
[0m17:26:16.295451 [info ] [MainThread]: Found 12 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:26:16.296449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E871FA560>]}
[0m17:26:16.298443 [info ] [MainThread]: 
[0m17:26:16.299441 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:26:16.299441 [info ] [MainThread]: 
[0m17:26:16.301436 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:26:16.304428 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:26:18.921425 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:26:18.922422 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:26:18.923420 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:26:23.908082 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.985 seconds
[0m17:26:23.918056 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:26:23.929025 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:26:23.930024 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:26:23.931021 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:26:27.611173 [debug] [ThreadPool]: SQL status: SUCCESS 11 in 3.681 seconds
[0m17:26:27.617157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E87159CF0>]}
[0m17:26:27.624139 [debug] [Thread-1 (]: Began running node seed.fair_pricing_radar.seed_fare_bucket_map
[0m17:26:27.626134 [info ] [Thread-1 (]: 1 of 1 START seed file WALRUS_PUBLIC.seed_fare_bucket_map ...................... [RUN]
[0m17:26:27.627131 [debug] [Thread-1 (]: Acquiring new snowflake connection 'seed.fair_pricing_radar.seed_fare_bucket_map'
[0m17:26:27.627131 [debug] [Thread-1 (]: Began compiling node seed.fair_pricing_radar.seed_fare_bucket_map
[0m17:26:27.628128 [debug] [Thread-1 (]: Began executing node seed.fair_pricing_radar.seed_fare_bucket_map
[0m17:26:27.666026 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_fare_bucket_map"
[0m17:26:27.666026 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_fare_bucket_map: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_fare_bucket_map"} */
create table FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map (first_letter text,fare_bucket text)
[0m17:26:27.667024 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:26:31.420979 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.755 seconds
[0m17:26:31.435941 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_fare_bucket_map"
[0m17:26:31.435941 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_fare_bucket_map: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_fare_bucket_map"} */
BEGIN
[0m17:26:31.663330 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.226 seconds
[0m17:26:31.664328 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_fare_bucket_map"
[0m17:26:31.664328 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_fare_bucket_map: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_fare_bucket_map"} */
insert into FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map (first_letter, fare_bucket) values
            (%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s),(%s,%s)...
[0m17:26:32.505078 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.840 seconds
[0m17:26:32.506076 [debug] [Thread-1 (]: Using snowflake connection "seed.fair_pricing_radar.seed_fare_bucket_map"
[0m17:26:32.506076 [debug] [Thread-1 (]: On seed.fair_pricing_radar.seed_fare_bucket_map: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "seed.fair_pricing_radar.seed_fare_bucket_map"} */
COMMIT
[0m17:26:32.959861 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.453 seconds
[0m17:26:32.965845 [debug] [Thread-1 (]: Writing runtime SQL for node "seed.fair_pricing_radar.seed_fare_bucket_map"
[0m17:26:32.997760 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ea941ef-a971-46f5-9228-d021c2312cb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFA4CE560>]}
[0m17:26:32.998759 [info ] [Thread-1 (]: 1 of 1 OK loaded seed file WALRUS_PUBLIC.seed_fare_bucket_map .................. [[32mINSERT 26[0m in 5.36s]
[0m17:26:32.999755 [debug] [Thread-1 (]: Finished running node seed.fair_pricing_radar.seed_fare_bucket_map
[0m17:26:33.001750 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:26:33.001750 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:26:33.002747 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:26:33.341839 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:26:33.341839 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:26:33.677941 [debug] [MainThread]: Connection 'seed.fair_pricing_radar.seed_fare_bucket_map' was left open.
[0m17:26:33.677941 [debug] [MainThread]: On seed.fair_pricing_radar.seed_fare_bucket_map: Close
[0m17:26:34.024015 [info ] [MainThread]: 
[0m17:26:34.025012 [info ] [MainThread]: Finished running 1 seed in 0 hours 0 minutes and 17.72 seconds (17.72s).
[0m17:26:34.027006 [debug] [MainThread]: Command end result
[0m17:26:34.058922 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:26:34.061913 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:26:34.070890 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:26:34.071888 [info ] [MainThread]: 
[0m17:26:34.072885 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:26:34.073882 [info ] [MainThread]: 
[0m17:26:34.073882 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:26:34.075876 [debug] [MainThread]: Command `dbt seed` succeeded at 17:26:34.075876 after 28.92 seconds
[0m17:26:34.076873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023EFC41D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E87145690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023E864EE9B0>]}
[0m17:26:34.077871 [debug] [MainThread]: Flushing usage events
[0m17:26:34.428931 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:30:08.801326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ECF81D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED0D56590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED0D56770>]}


============================== 17:30:08.805315 | 8b201f74-6f41-4434-b0d3-351d4fc5d99c ==============================
[0m17:30:08.805315 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:30:08.806312 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:30:09.794667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ECD997010>]}
[0m17:30:09.861488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED935C460>]}
[0m17:30:09.863484 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:30:10.489807 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:30:10.811945 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:30:10.813941 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:30:11.226835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED9F88130>]}
[0m17:30:11.383417 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:30:11.386409 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:30:11.411342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED9F81450>]}
[0m17:30:11.412339 [info ] [MainThread]: Found 12 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:30:11.413337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED9F81690>]}
[0m17:30:11.415331 [info ] [MainThread]: 
[0m17:30:11.416329 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:30:11.416329 [info ] [MainThread]: 
[0m17:30:11.417326 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:30:11.418323 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:30:11.539998 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:30:11.540995 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:30:11.541992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:30:16.102789 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.561 seconds
[0m17:30:16.111765 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:30:16.122735 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:30:16.122735 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:30:16.123733 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:30:19.795907 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.672 seconds
[0m17:30:19.800893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED9DD5870>]}
[0m17:30:19.805880 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:30:19.806878 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:30:19.807875 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:30:19.807875 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:30:19.823832 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:30:19.824830 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:30:19.885666 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:30:19.891651 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:30:19.892648 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)                      as search_date,
        try_to_date(flightdate)                      as flight_date,

        try_to_numeric(totalfare)                    as total_fare,
        try_to_numeric(basefare)                     as base_fare,
        try_to_number(seatsremaining)                as seats_remaining,

        isnonstop                                    as is_nonstop,
        isbasiceconomy                               as is_basic_econ,
        isrefundable                                 as is_refundable,
        farebasiscode,

        try_to_number(totaltraveldistance)           as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          -- sanity filters
          searchdate is not null
      and flightdate is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare is not null
),

-- 2. normalise / derive ---------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first- / last- segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                            as destination,

        datediff('day', search_date, flight_date)    as days_out

    from raw r
),

add_geo as (

    -- join twice to airport-geo seed for lat/lon lookup
    select
        s.*,
        o.lat  as orig_lat,
        o.lon  as orig_lon,
        d.lat  as dest_lat,
        d.lon  as dest_lon
    from split_cols        s
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o on s.origin      = o.iata
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d on s.destination = d.iata
),

with_miles as (

    select
        g.*,

        /* ────────── total miles ──────────
           1) use raw TOTALTRAVELDISTANCE when present
           2) otherwise geodesic distance from seed coords
        */
        coalesce(
            g.raw_total_miles,

            case
                when g.orig_lat is not null and g.dest_lat is not null then
                    st_distance(
                        to_geography('POINT('||g.orig_lon||' '||g.orig_lat||')'),
                        to_geography('POINT('||g.dest_lon||' '||g.dest_lat||')')
                    )/1609.34  -- metres → miles
            end
        )                                          as total_miles
    from add_geo g
),

derived as (

    select
        w.*,

        /* $ / mi */
        w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

        /* seat availability flag (remember the data caps at 9) */
        case
            when seats_remaining =   0 then 'sold_out'
            when seats_remaining between 1 and 8 then 'scarce'
            else '9plus'
        end                                        as seats_flag,

        /* fare bucket from seed map */
        fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
           on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 3. incremental filter ---------------------------------------------
filtered as (

    select * from derived

    
)

-- 4. final select ----------------------------------------------------
select
      legid,
      search_date,
      flight_date,
      days_out                                         as days_to_flight,

      origin,
      destination,
      concat(origin,'-',destination)                  as route,

      total_fare,
      base_fare,
      total_miles,
      usd_per_mi,

      is_nonstop,
      is_basic_econ,
      is_refundable,

      farebasiscode,
      fare_bucket,

      seats_remaining,
      seats_flag,

      -- keep original raw json-style columns for lineage / debug
      travelduration,
      segmentsdepartureairportcode,
      segmentsarrivalairportcode,
      segmentsairlinecode,
      segmentsdistance,
      segmentsdurationinseconds,
      segmentsequipmentdescription,
      segmentscabincode

from filtered
        );
[0m17:30:19.892648 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:30:23.701457 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe81f-0305-0f94-0006-8fdb00186542
[0m17:30:23.701457 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001065 (22023): SQL compilation error:
Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
[0m17:30:23.704448 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:30:23.707440 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b201f74-6f41-4434-b0d3-351d4fc5d99c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ED935FE80>]}
[0m17:30:23.708438 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 3.90s]
[0m17:30:23.709436 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:30:23.709436 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m17:30:23.712427 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:30:23.712427 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:30:23.713425 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:30:24.053514 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:30:24.053514 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:30:24.390613 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:30:24.390613 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:30:24.754638 [info ] [MainThread]: 
[0m17:30:24.754638 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 13.34 seconds (13.34s).
[0m17:30:24.755636 [debug] [MainThread]: Command end result
[0m17:30:24.785556 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:30:24.790543 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:30:24.798521 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:30:24.798521 [info ] [MainThread]: 
[0m17:30:24.799519 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:30:24.800516 [info ] [MainThread]: 
[0m17:30:24.801514 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:30:24.802511 [info ] [MainThread]: 
[0m17:30:24.803508 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:30:24.804505 [debug] [MainThread]: Command `dbt run` failed at 17:30:24.804505 after 16.09 seconds
[0m17:30:24.805502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ECF81D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ECECDBDC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018ECF84E950>]}
[0m17:30:24.805502 [debug] [MainThread]: Flushing usage events
[0m17:30:25.162547 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:32:51.296531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002234671D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022347E59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022347E59EA0>]}


============================== 17:32:51.300520 | ce706c1c-0ff0-4984-b124-ed0d726967c6 ==============================
[0m17:32:51.300520 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:32:51.301517 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:32:52.287877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ce706c1c-0ff0-4984-b124-ed0d726967c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022344A97040>]}
[0m17:32:52.352704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ce706c1c-0ff0-4984-b124-ed0d726967c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000223476FE2C0>]}
[0m17:32:52.353702 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:32:52.956090 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:32:53.276233 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m17:32:53.277231 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\staging\stg_route_stats.sql
[0m17:32:53.277231 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:32:53.563465 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_route_stats' (models\staging\stg_route_stats.sql) depends on a node named 'stg_flight_searches' which was not found
[0m17:32:53.565460 [debug] [MainThread]: Command `dbt run` failed at 17:32:53.565460 after 2.36 seconds
[0m17:32:53.566456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002234671D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022350DA8B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022350E18880>]}
[0m17:32:53.567454 [debug] [MainThread]: Flushing usage events
[0m17:32:53.908541 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:36:06.979977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C9151D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C92C5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C92C5E1A0>]}


============================== 17:36:06.983967 | fb8b5d5b-0589-4de7-a479-b89bbed3127b ==============================
[0m17:36:06.983967 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:36:06.984964 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m17:36:07.947388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb8b5d5b-0589-4de7-a479-b89bbed3127b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C92C2B1F0>]}
[0m17:36:08.012215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb8b5d5b-0589-4de7-a479-b89bbed3127b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C9B25F400>]}
[0m17:36:08.014210 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:36:08.612608 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:36:08.916794 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m17:36:08.916794 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\staging\stg_route_stats.sql
[0m17:36:08.917792 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:36:09.204027 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.fair_pricing_radar.stg_route_stats' (models\staging\stg_route_stats.sql) depends on a node named 'stg_flight_searches' which was not found
[0m17:36:09.206021 [debug] [MainThread]: Command `dbt run` failed at 17:36:09.206021 after 2.32 seconds
[0m17:36:09.207018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C9151D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C9BBA8BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C9BC1A9B0>]}
[0m17:36:09.207018 [debug] [MainThread]: Flushing usage events
[0m17:36:09.546110 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:38:26.492677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89B91D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89D059C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89D059E10>]}


============================== 17:38:26.497665 | 0df144f7-9dc3-4d43-8be9-c445b176ffd7 ==============================
[0m17:38:26.497665 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:38:26.499659 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:38:27.628638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89D032890>]}
[0m17:38:27.693464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89CE92D70>]}
[0m17:38:27.695459 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:38:28.328764 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:38:28.689800 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m17:38:28.691793 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\staging\stg_route_stats.sql
[0m17:38:28.691793 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:38:29.148571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8A6335960>]}
[0m17:38:29.301163 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:38:29.303157 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:38:29.328091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8A63375E0>]}
[0m17:38:29.329088 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:38:29.330085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8A6337520>]}
[0m17:38:29.332080 [info ] [MainThread]: 
[0m17:38:29.333077 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:38:29.333077 [info ] [MainThread]: 
[0m17:38:29.334075 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:38:29.335072 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:38:29.462730 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:38:29.463727 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:38:29.464726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:38:35.882552 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.417 seconds
[0m17:38:35.890531 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:38:35.902500 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:38:35.902500 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:38:35.903496 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:38:39.467959 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.565 seconds
[0m17:38:39.472946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8A63459C0>]}
[0m17:38:39.477932 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:38:39.478930 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:38:39.479927 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:38:39.479927 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:38:39.494887 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:38:39.496883 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:38:39.567692 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:38:39.573676 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:38:39.574673 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------
add_geo as (

    select
        s.*,
        o.lat  as orig_lat,
        o.lon  as orig_lon,
        d.lat  as dest_lat,
        d.lon  as dest_lon
    from split_cols      s
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
      on s.origin      = o.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
      on s.destination = d.iata_code
),

-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    

)

-- 7. final select -------------------------------------------------
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination    as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    /* raw JSON‐style columns for lineage/debug */
    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from filtered
        );
[0m17:38:39.576668 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:38:43.190000 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe827-0305-0bba-0006-8fdb00185c32
[0m17:38:43.190000 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 69 at position 8
invalid identifier 'O.LAT'
[0m17:38:43.192992 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:38:43.194986 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0df144f7-9dc3-4d43-8be9-c445b176ffd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F8A595C2E0>]}
[0m17:38:43.195983 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 3.71s]
[0m17:38:43.196981 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:38:43.197979 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m17:38:43.199973 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:38:43.200970 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:38:43.200970 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:38:43.547044 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:38:43.547044 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:38:43.888131 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:38:43.889189 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:38:44.228222 [info ] [MainThread]: 
[0m17:38:44.230217 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 14.89 seconds (14.89s).
[0m17:38:44.231214 [debug] [MainThread]: Command end result
[0m17:38:44.264125 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:38:44.268115 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:38:44.277092 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:38:44.278089 [info ] [MainThread]: 
[0m17:38:44.279086 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:38:44.280083 [info ] [MainThread]: 
[0m17:38:44.281081 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:38:44.282078 [info ] [MainThread]: 
[0m17:38:44.284073 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:38:44.286067 [debug] [MainThread]: Command `dbt run` failed at 17:38:44.286067 after 17.88 seconds
[0m17:38:44.287064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89B91D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89CE92D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F89B9B0BE0>]}
[0m17:38:44.287064 [debug] [MainThread]: Flushing usage events
[0m17:38:44.638124 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:40:52.554853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D0E1D390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D2359C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D2359E10>]}


============================== 17:40:52.558842 | 254e3e1e-78e1-41dd-8030-9ce8c0fc62a3 ==============================
[0m17:40:52.558842 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:40:52.559839 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:40:53.514285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D2336FE0>]}
[0m17:40:53.579112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D1BFC9A0>]}
[0m17:40:53.580109 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:40:54.190476 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:40:54.505633 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:40:54.506630 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:40:54.960416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0DB521600>]}
[0m17:40:55.114005 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:40:55.116997 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:40:55.141931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0DB4CF0D0>]}
[0m17:40:55.142928 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:40:55.143925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0DB4CD6F0>]}
[0m17:40:55.144923 [info ] [MainThread]: 
[0m17:40:55.145919 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:40:55.146917 [info ] [MainThread]: 
[0m17:40:55.147915 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:40:55.148912 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:40:55.264602 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:40:55.264602 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:40:55.265599 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:01.007237 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.742 seconds
[0m17:41:01.016212 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:41:01.026185 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:41:01.027183 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:41:01.027183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:04.631538 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.604 seconds
[0m17:41:04.635528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0DB892770>]}
[0m17:41:04.641512 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:41:04.642509 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:41:04.643507 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:41:04.643507 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:41:04.657470 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:41:04.659465 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:41:04.720301 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:41:04.726285 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:41:04.726285 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------
add_geo as (

    select
        s.*,
        o.lat  as orig_lat,
        o.lon  as orig_lon,
        d.lat  as dest_lat,
        d.lon  as dest_lon
    from split_cols      s
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
      on s.origin      = o.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
      on s.destination = d.iata_code
),

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
        );
[0m17:41:04.727282 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:41:08.768469 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe829-0305-0bb1-0006-8fdb00183f36
[0m17:41:08.769466 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 69 at position 8
invalid identifier 'O.LAT'
[0m17:41:08.771462 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:41:08.774453 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '254e3e1e-78e1-41dd-8030-9ce8c0fc62a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D22EA590>]}
[0m17:41:08.775451 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 4.13s]
[0m17:41:08.776448 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:41:08.776448 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m17:41:08.779440 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:41:08.779440 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:41:08.780437 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:41:09.130500 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:41:09.130500 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:41:09.499513 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:41:09.500510 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:41:09.840600 [info ] [MainThread]: 
[0m17:41:09.841598 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 14.69 seconds (14.69s).
[0m17:41:09.842595 [debug] [MainThread]: Command end result
[0m17:41:09.873512 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:41:09.876504 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:41:09.884483 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:41:09.885481 [info ] [MainThread]: 
[0m17:41:09.887476 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:41:09.888473 [info ] [MainThread]: 
[0m17:41:09.889470 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:41:09.889470 [info ] [MainThread]: 
[0m17:41:09.890467 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:41:09.892464 [debug] [MainThread]: Command `dbt run` failed at 17:41:09.892464 after 17.42 seconds
[0m17:41:09.893459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D0E1D390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0DB887490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0D0ED4250>]}
[0m17:41:09.893459 [debug] [MainThread]: Flushing usage events
[0m17:41:10.227565 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:42:32.738786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C4B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C6256560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C6256740>]}


============================== 17:42:32.742776 | 3dfb6758-b0e6-4a3d-948a-4b604cd2981e ==============================
[0m17:42:32.742776 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:42:32.743773 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:42:33.693233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C1E97040>]}
[0m17:42:33.757061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C5AFDE10>]}
[0m17:42:33.759057 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:42:34.369423 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:42:34.672612 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:42:34.674607 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:42:34.819220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CF11BC10>]}
[0m17:42:34.972808 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:42:34.975800 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:42:34.999737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CF307CA0>]}
[0m17:42:35.001732 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:42:35.001732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CF307B80>]}
[0m17:42:35.003726 [info ] [MainThread]: 
[0m17:42:35.004724 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:42:35.005721 [info ] [MainThread]: 
[0m17:42:35.006718 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:42:35.007716 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:42:35.125400 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:42:35.125400 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:42:35.126398 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:42:39.512661 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.387 seconds
[0m17:42:39.522635 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:42:39.534603 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:42:39.535600 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:42:39.536597 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:42:43.354382 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.818 seconds
[0m17:42:43.358371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C61F1EA0>]}
[0m17:42:43.363358 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:42:43.364355 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:42:43.365353 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:42:43.366350 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:42:43.386297 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:42:43.387294 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:42:43.447133 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:42:43.453118 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:42:43.453118 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------
add_geo as (

    select
        s.*,
        o.lat  as orig_lat,
        o.lon  as orig_lon,
        d.lat  as dest_lat,
        d.lon  as dest_lon
    from split_cols      s
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
      on s.origin      = o.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
      on s.destination = d.iata_code
),

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
        );
[0m17:42:43.454115 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:42:47.403547 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe82b-0305-0fb8-0006-8fdb001873ee
[0m17:42:47.403547 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 69 at position 8
invalid identifier 'O.LAT'
[0m17:42:47.406539 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:42:47.408534 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3dfb6758-b0e6-4a3d-948a-4b604cd2981e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CEA5FE50>]}
[0m17:42:47.409532 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.stg_fare_searches .... [[31mERROR[0m in 4.04s]
[0m17:42:47.410528 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:42:47.411526 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m17:42:47.413520 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:42:47.414518 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:42:47.414518 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:42:47.774554 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:42:47.775552 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:42:48.123621 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:42:48.124618 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:42:48.500611 [info ] [MainThread]: 
[0m17:42:48.501609 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 13.49 seconds (13.49s).
[0m17:42:48.502607 [debug] [MainThread]: Command end result
[0m17:42:48.533524 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:42:48.537513 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:42:48.545492 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:42:48.546490 [info ] [MainThread]: 
[0m17:42:48.547487 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:42:48.548484 [info ] [MainThread]: 
[0m17:42:48.548484 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 69 at position 8
  invalid identifier 'O.LAT'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m17:42:48.549481 [info ] [MainThread]: 
[0m17:42:48.550479 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:42:48.551476 [debug] [MainThread]: Command `dbt run` failed at 17:42:48.551476 after 15.90 seconds
[0m17:42:48.552473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C4B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CF348370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C4BD44C0>]}
[0m17:42:48.553471 [debug] [MainThread]: Flushing usage events
[0m17:42:48.898547 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:44:00.967708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87D11D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87E859CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87E859ED0>]}


============================== 17:44:00.971698 | 5fc27fb5-267b-444c-a3b6-8f0f732af84f ==============================
[0m17:44:00.971698 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:44:00.972695 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:44:01.929136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87B497010>]}
[0m17:44:01.991968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D80705C460>]}
[0m17:44:01.993963 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:44:02.589369 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:44:02.885577 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:44:02.886574 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m17:44:03.283512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8079055A0>]}
[0m17:44:03.436104 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:44:03.439096 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:44:03.464030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8078D9780>]}
[0m17:44:03.464030 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:44:03.465026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8078D96C0>]}
[0m17:44:03.468018 [info ] [MainThread]: 
[0m17:44:03.468018 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:44:03.469016 [info ] [MainThread]: 
[0m17:44:03.470013 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:44:03.472009 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:44:03.587698 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:44:03.587698 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:44:03.588695 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:44:10.302730 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.714 seconds
[0m17:44:10.310709 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:44:10.320682 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:44:10.321680 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:44:10.321680 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:44:14.032750 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.711 seconds
[0m17:44:14.037737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D807C90AF0>]}
[0m17:44:14.043721 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m17:44:14.044718 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m17:44:14.045715 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m17:44:14.045715 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m17:44:14.058681 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:44:14.059678 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m17:44:14.131485 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m17:44:14.136472 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:44:14.137469 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
        );
[0m17:44:14.137469 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:44:18.454917 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.317 seconds
[0m17:44:18.463893 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m17:44:18.469877 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m17:44:18.470875 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m17:44:18.715221 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.243 seconds
[0m17:44:18.740154 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fc27fb5-267b-444c-a3b6-8f0f732af84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D80705FE80>]}
[0m17:44:18.741151 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 1[0m in 4.69s]
[0m17:44:18.743146 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m17:44:18.744144 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:44:18.745141 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:44:18.745141 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:44:19.120137 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:44:19.121134 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:44:19.461225 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m17:44:19.461225 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m17:44:19.807298 [info ] [MainThread]: 
[0m17:44:19.808296 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 16.34 seconds (16.34s).
[0m17:44:19.809294 [debug] [MainThread]: Command end result
[0m17:44:19.843202 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:44:19.847193 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:44:19.855170 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:44:19.856168 [info ] [MainThread]: 
[0m17:44:19.857165 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:44:19.857165 [info ] [MainThread]: 
[0m17:44:19.858163 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:44:19.861154 [debug] [MainThread]: Command `dbt run` succeeded at 17:44:19.861154 after 18.98 seconds
[0m17:44:19.861154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87D11D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D87D1BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D807C86590>]}
[0m17:44:19.862152 [debug] [MainThread]: Flushing usage events
[0m17:44:20.211218 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:52:41.232223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DF41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E0B5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E0B5E1A0>]}


============================== 17:52:41.236213 | ceca2a30-8c5d-4913-9c45-d0f78b3919ed ==============================
[0m17:52:41.236213 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:52:41.237210 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select stg_route_stats', 'send_anonymous_usage_stats': 'True'}
[0m17:52:42.454952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DD897070>]}
[0m17:52:42.536733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E0402560>]}
[0m17:52:42.539726 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:52:43.287724 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:52:43.669701 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:52:43.671697 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:52:43.855205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E9B1BBB0>]}
[0m17:52:44.048688 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:52:44.051680 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:52:44.086586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E0B21930>]}
[0m17:52:44.087584 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 11 data tests, 1 source, 475 macros
[0m17:52:44.088581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DF421660>]}
[0m17:52:44.091573 [info ] [MainThread]: 
[0m17:52:44.092571 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:52:44.093568 [info ] [MainThread]: 
[0m17:52:44.095563 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:52:44.099552 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:52:44.270095 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:52:44.272090 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:52:44.272090 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:52:49.738464 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.466 seconds
[0m17:52:49.748438 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:52:49.761402 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:52:49.761402 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:52:49.762399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:52:53.481448 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.719 seconds
[0m17:52:53.487432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E9CCCE50>]}
[0m17:52:53.493416 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m17:52:53.494414 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m17:52:53.495411 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m17:52:53.496408 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m17:52:53.508376 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m17:52:53.510374 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m17:52:53.550264 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m17:52:53.554254 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m17:52:53.555251 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with recent_searches as (

    select *
    from   FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where  flight_date >= dateadd('year', -1, current_date)
          -- ensure numeric for percentile calc
      and  usd_per_mi is not null
),

per_route_bucket as (

    select
        route,
        fare_bucket,

        
    percentile_cont(0.5) within group (order by usd_per_mi) over()
  as p50_usd_per_mi,
        
    percentile_cont(0.9) within group (order by usd_per_mi) over()
  as p90_usd_per_mi,
        
    percentile_cont(0.95) within group (order by usd_per_mi) over()
  as p95_usd_per_mi,
        
    percentile_cont(0.97) within group (order by usd_per_mi) over()
  as p97_usd_per_mi,

        max(usd_per_mi)                             as max_usd_per_mi,
        count(*)                                    as legs_sampled

    from recent_searches
    group by
        route,
        fare_bucket
)

select * from per_route_bucket
        );
[0m17:52:53.555251 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:52:57.228421 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe835-0305-0f94-0006-8fdb0018670a
[0m17:52:57.229420 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000979 (42601): SQL compilation error:
[RECENT_SEARCHES.USD_PER_MI] is not a valid group by expression
[0m17:52:57.232411 [debug] [Thread-1 (]: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [RECENT_SEARCHES.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:52:57.235404 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceca2a30-8c5d-4913-9c45-d0f78b3919ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DD4CE1D0>]}
[0m17:52:57.236401 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.stg_route_stats ............ [[31mERROR[0m in 3.74s]
[0m17:52:57.237398 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m17:52:57.238396 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_route_stats' to be skipped because of status 'error'.  Reason: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [RECENT_SEARCHES.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql.
[0m17:52:57.240390 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:52:57.241388 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:52:57.241388 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:52:57.574497 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:52:57.575494 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:52:57.911594 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m17:52:57.912591 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m17:52:58.245699 [info ] [MainThread]: 
[0m17:52:58.246698 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.15 seconds (14.15s).
[0m17:52:58.247695 [debug] [MainThread]: Command end result
[0m17:52:58.279610 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:52:58.282601 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:52:58.293572 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:52:58.293572 [info ] [MainThread]: 
[0m17:52:58.295567 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:52:58.296564 [info ] [MainThread]: 
[0m17:52:58.297562 [error] [MainThread]:   Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [RECENT_SEARCHES.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:52:58.298559 [info ] [MainThread]: 
[0m17:52:58.299556 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:52:58.302549 [debug] [MainThread]: Command `dbt run` failed at 17:52:58.302549 after 17.16 seconds
[0m17:52:58.303546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DF41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148E9D4BC70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148DF4B1030>]}
[0m17:52:58.304543 [debug] [MainThread]: Flushing usage events
[0m17:52:58.647625 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:54:44.933232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C2731D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C28A59D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C28A59F00>]}


============================== 17:54:44.937221 | 85844858-926f-47f5-9c6e-06245a17ecc6 ==============================
[0m17:54:44.937221 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:54:44.938218 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_route_stats', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:54:45.866734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C25597040>]}
[0m17:54:45.930563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C3115F1F0>]}
[0m17:54:45.931560 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:54:46.519986 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:54:46.816193 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m17:54:46.817190 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\schema.yml
[0m17:54:46.818188 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_route_stats.sql
[0m17:54:47.462464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C320E4130>]}
[0m17:54:47.622036 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:54:47.625029 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:54:47.649962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C31BCC280>]}
[0m17:54:47.650960 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m17:54:47.650960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C320EA6B0>]}
[0m17:54:47.652954 [info ] [MainThread]: 
[0m17:54:47.653952 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:54:47.654950 [info ] [MainThread]: 
[0m17:54:47.655947 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:54:47.656944 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:54:47.770639 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:54:47.771637 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:54:47.771637 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:54:51.831315 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.060 seconds
[0m17:54:51.840292 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:54:51.851262 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:54:51.851262 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:54:51.852260 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:54:55.532413 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.680 seconds
[0m17:54:55.536401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C31BCE6E0>]}
[0m17:54:55.541389 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m17:54:55.542386 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m17:54:55.543384 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m17:54:55.543384 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m17:54:55.553357 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m17:54:55.554354 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m17:54:55.587265 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m17:54:55.590258 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m17:54:55.590258 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

    select
        route,
        fare_bucket,
        usd_per_mi
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null
),

bench as (

    select
        route,
        fare_bucket,

        
    percentile_cont(0.5) within group (order by usd_per_mi) over()
  as p50_usd_per_mi,
        
    percentile_cont(0.9) within group (order by usd_per_mi) over()
  as p90_usd_per_mi,
        
    percentile_cont(0.95) within group (order by usd_per_mi) over()
  as p95_usd_per_mi,
        
    percentile_cont(0.97) within group (order by usd_per_mi) over()
  as p97_usd_per_mi,

        max(usd_per_mi)                             as max_usd_per_mi,
        count(*)                                    as legs_sampled
    from base
    group by route, fare_bucket
)

select * from bench
        );
[0m17:54:55.591255 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:55:00.122132 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe837-0305-0c96-0006-8fdb00184f56
[0m17:55:00.122132 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000979 (42601): SQL compilation error:
[BASE.USD_PER_MI] is not a valid group by expression
[0m17:55:00.125124 [debug] [Thread-1 (]: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:55:00.128116 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85844858-926f-47f5-9c6e-06245a17ecc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C253CF4F0>]}
[0m17:55:00.129113 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.stg_route_stats ............ [[31mERROR[0m in 4.58s]
[0m17:55:00.130110 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m17:55:00.131107 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_route_stats' to be skipped because of status 'error'.  Reason: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql.
[0m17:55:00.132105 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:55:00.133102 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:55:00.134100 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:55:00.487155 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:55:00.488153 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:55:00.833229 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m17:55:00.834227 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m17:55:01.195260 [info ] [MainThread]: 
[0m17:55:01.196257 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.54 seconds (13.54s).
[0m17:55:01.197255 [debug] [MainThread]: Command end result
[0m17:55:01.231166 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:55:01.234157 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:55:01.243132 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:55:01.244129 [info ] [MainThread]: 
[0m17:55:01.244129 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:55:01.245127 [info ] [MainThread]: 
[0m17:55:01.246124 [error] [MainThread]:   Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:55:01.247122 [info ] [MainThread]: 
[0m17:55:01.248119 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:55:01.250114 [debug] [MainThread]: Command `dbt run` failed at 17:55:01.250114 after 16.40 seconds
[0m17:55:01.251111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C2731D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C3215AB30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C273D44C0>]}
[0m17:55:01.251111 [debug] [MainThread]: Flushing usage events
[0m17:55:01.615137 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:58:05.482156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247FF01D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478075DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478075E1A0>]}


============================== 17:58:05.486145 | 84b87573-cfca-469f-b219-44ea7d4283a6 ==============================
[0m17:58:05.486145 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:58:05.487143 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_route_stats', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:58:06.400698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247FFFFDB10>]}
[0m17:58:06.462532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024780593460>]}
[0m17:58:06.464528 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:58:07.050958 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:58:07.350158 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:58:07.351155 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m17:58:07.734130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024789991780>]}
[0m17:58:07.880738 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:58:07.883730 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:58:07.908663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478972CD90>]}
[0m17:58:07.908663 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m17:58:07.909661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478972D6C0>]}
[0m17:58:07.911655 [info ] [MainThread]: 
[0m17:58:07.912653 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:58:07.913650 [info ] [MainThread]: 
[0m17:58:07.914647 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:58:07.915645 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:58:08.026348 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:58:08.027345 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:58:08.028343 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:13.221447 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.193 seconds
[0m17:58:13.229426 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m17:58:13.240396 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m17:58:13.241394 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m17:58:13.241394 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:16.970416 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 3.729 seconds
[0m17:58:16.974405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247898E1AE0>]}
[0m17:58:16.979392 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m17:58:16.980390 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m17:58:16.980390 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m17:58:16.981387 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m17:58:16.993355 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m17:58:16.995350 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m17:58:17.025269 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m17:58:17.027264 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m17:58:17.028261 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

    select
        route,
        fare_bucket,
        usd_per_mi
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null
),

bench as (

    select
        route,
        fare_bucket,

        
    percentile_cont(0.5) within group (order by usd_per_mi) over()
  as p50_usd_per_mi,
        
    percentile_cont(0.9) within group (order by usd_per_mi) over()
  as p90_usd_per_mi,
        
    percentile_cont(0.95) within group (order by usd_per_mi) over()
  as p95_usd_per_mi,
        
    percentile_cont(0.97) within group (order by usd_per_mi) over()
  as p97_usd_per_mi,

        max(usd_per_mi)                             as max_usd_per_mi,
        count(*)                                    as legs_sampled
    from base
    group by route, fare_bucket
)

select * from bench
        );
[0m17:58:17.029259 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m17:58:20.729358 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe83b-0305-0bb1-0006-8fdb0018805a
[0m17:58:20.730355 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000979 (42601): SQL compilation error:
[BASE.USD_PER_MI] is not a valid group by expression
[0m17:58:20.732351 [debug] [Thread-1 (]: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:58:20.735342 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84b87573-cfca-469f-b219-44ea7d4283a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247FD0CEFB0>]}
[0m17:58:20.736340 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.stg_route_stats ............ [[31mERROR[0m in 3.75s]
[0m17:58:20.737337 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m17:58:20.738335 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_route_stats' to be skipped because of status 'error'.  Reason: Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql.
[0m17:58:20.740329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:58:20.740329 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m17:58:20.741326 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m17:58:21.086403 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m17:58:21.087400 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m17:58:21.420509 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m17:58:21.421506 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m17:58:21.763591 [info ] [MainThread]: 
[0m17:58:21.764589 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.85 seconds (13.85s).
[0m17:58:21.765586 [debug] [MainThread]: Command end result
[0m17:58:21.797500 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:58:21.800492 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:58:21.809468 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m17:58:21.810492 [info ] [MainThread]: 
[0m17:58:21.811463 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m17:58:21.811463 [info ] [MainThread]: 
[0m17:58:21.812460 [error] [MainThread]:   Database Error in model stg_route_stats (models\staging\stg_route_stats.sql)
  000979 (42601): SQL compilation error:
  [BASE.USD_PER_MI] is not a valid group by expression
  compiled code at target\run\fair_pricing_radar\models\staging\stg_route_stats.sql
[0m17:58:21.813458 [info ] [MainThread]: 
[0m17:58:21.814455 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:58:21.816450 [debug] [MainThread]: Command `dbt run` failed at 17:58:21.815452 after 16.41 seconds
[0m17:58:21.817448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247FF01D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024780593460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247FF0B0430>]}
[0m17:58:21.817448 [debug] [MainThread]: Flushing usage events
[0m17:58:22.165515 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:59:55.252439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023905A1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023907159D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023907159F00>]}


============================== 17:59:55.256428 | 03b0dc47-8c70-4190-9753-f0b13a38ae16 ==============================
[0m17:59:55.256428 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:59:55.257426 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_route_stats', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:59:56.194917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239071220B0>]}
[0m17:59:56.257749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002390FA5F820>]}
[0m17:59:56.258746 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m17:59:56.823236 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m17:59:57.123432 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:59:57.124430 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_route_stats.sql
[0m17:59:57.658002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239107CC130>]}
[0m17:59:57.806604 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m17:59:57.809596 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m17:59:57.833532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239102D28C0>]}
[0m17:59:57.834531 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m17:59:57.835528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239102D2A70>]}
[0m17:59:57.836525 [info ] [MainThread]: 
[0m17:59:57.837522 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:59:57.838519 [info ] [MainThread]: 
[0m17:59:57.838519 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m17:59:57.840514 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m17:59:57.951217 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m17:59:57.951217 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m17:59:57.952215 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:02.761347 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.809 seconds
[0m18:00:02.769325 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:00:02.779299 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:00:02.780296 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:00:02.780296 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.856390 [debug] [ThreadPool]: SQL status: SUCCESS 12 in 4.075 seconds
[0m18:00:06.860379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239102BB370>]}
[0m18:00:06.865366 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m18:00:06.866363 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m18:00:06.867361 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m18:00:06.867361 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m18:00:06.876336 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m18:00:06.877334 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m18:00:06.910246 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m18:00:06.912241 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m18:00:06.913238 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m18:00:06.914235 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:00:11.419181 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.505 seconds
[0m18:00:11.440124 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03b0dc47-8c70-4190-9753-f0b13a38ae16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002390FA5E6E0>]}
[0m18:00:11.441123 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 4.57s]
[0m18:00:11.442120 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m18:00:11.444114 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:11.444114 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:00:11.445111 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:00:11.805148 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:00:11.806145 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:00:12.144241 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m18:00:12.145238 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m18:00:12.494304 [info ] [MainThread]: 
[0m18:00:12.495302 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.66 seconds (14.66s).
[0m18:00:12.496299 [debug] [MainThread]: Command end result
[0m18:00:12.527216 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:00:12.530208 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:00:12.539184 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:00:12.540182 [info ] [MainThread]: 
[0m18:00:12.541179 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:12.542177 [info ] [MainThread]: 
[0m18:00:12.542177 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:00:12.545168 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:12.544172 after 17.37 seconds
[0m18:00:12.545168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000239071220B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023910A28A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023905A1E4A0>]}
[0m18:00:12.546165 [debug] [MainThread]: Flushing usage events
[0m18:00:12.919167 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:01:16.346453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B81B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8325DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8325E1A0>]}


============================== 18:01:16.350441 | bf71fd5a-03db-4a7b-a40d-10fa90c77b46 ==============================
[0m18:01:16.350441 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:01:16.351440 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select +int_route_fare_per_mi_stats', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:01:17.277959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B832320B0>]}
[0m18:01:17.340792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8B95F820>]}
[0m18:01:17.341789 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:01:17.922236 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:01:18.217446 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:01:18.218444 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:01:18.362059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8C22FD30>]}
[0m18:01:18.514651 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:01:18.517643 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:01:18.541579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8C22F5E0>]}
[0m18:01:18.542576 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:01:18.543574 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8C22F610>]}
[0m18:01:18.546565 [info ] [MainThread]: 
[0m18:01:18.547563 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:01:18.548560 [info ] [MainThread]: 
[0m18:01:18.549558 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:01:18.557538 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:01:18.670234 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:01:18.670234 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:01:18.671232 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:24.101701 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.431 seconds
[0m18:01:24.105690 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:01:24.115663 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:01:24.116661 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:01:24.117659 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:27.760910 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.644 seconds
[0m18:01:27.765897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BFEBCF4F0>]}
[0m18:01:27.770884 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m18:01:27.771881 [info ] [Thread-1 (]: 1 of 3 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m18:01:27.772878 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m18:01:27.773876 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m18:01:27.791828 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:27.792825 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m18:01:27.853662 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:27.854659 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
  
   as (
    




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    
      where (legid, search_date) not in (
        select
          t.legid,
          t.search_date
        from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches t
      )
    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
  );
[0m18:01:27.855657 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:01:32.033477 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.179 seconds
[0m18:01:32.043451 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:32.043451 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:01:32.320709 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.276 seconds
[0m18:01:32.325696 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:32.326693 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
[0m18:01:32.713657 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.387 seconds
[0m18:01:32.722633 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:32.723631 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."STG_FARE_SEARCHES"
[0m18:01:32.935065 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.211 seconds
[0m18:01:32.965982 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:32.968974 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:32.969972 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
-- back compat for old kwarg name
  
  begin;
[0m18:01:33.197363 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.226 seconds
[0m18:01:33.197363 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:33.198361 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "LEGID" = DBT_INTERNAL_SOURCE."LEGID","SEARCH_DATE" = DBT_INTERNAL_SOURCE."SEARCH_DATE","FLIGHT_DATE" = DBT_INTERNAL_SOURCE."FLIGHT_DATE","DAYS_TO_FLIGHT" = DBT_INTERNAL_SOURCE."DAYS_TO_FLIGHT","ORIGIN" = DBT_INTERNAL_SOURCE."ORIGIN","DESTINATION" = DBT_INTERNAL_SOURCE."DESTINATION","ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","TOTAL_FARE" = DBT_INTERNAL_SOURCE."TOTAL_FARE","BASE_FARE" = DBT_INTERNAL_SOURCE."BASE_FARE","TOTAL_MILES" = DBT_INTERNAL_SOURCE."TOTAL_MILES","USD_PER_MI" = DBT_INTERNAL_SOURCE."USD_PER_MI","IS_NONSTOP" = DBT_INTERNAL_SOURCE."IS_NONSTOP","IS_BASIC_ECON" = DBT_INTERNAL_SOURCE."IS_BASIC_ECON","IS_REFUNDABLE" = DBT_INTERNAL_SOURCE."IS_REFUNDABLE","FAREBASISCODE" = DBT_INTERNAL_SOURCE."FAREBASISCODE","FARE_BUCKET" = DBT_INTERNAL_SOURCE."FARE_BUCKET","SEATS_REMAINING" = DBT_INTERNAL_SOURCE."SEATS_REMAINING","SEATS_FLAG" = DBT_INTERNAL_SOURCE."SEATS_FLAG","TRAVELDURATION" = DBT_INTERNAL_SOURCE."TRAVELDURATION","SEGMENTSDEPARTUREAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSDEPARTUREAIRPORTCODE","SEGMENTSARRIVALAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSARRIVALAIRPORTCODE","SEGMENTSAIRLINECODE" = DBT_INTERNAL_SOURCE."SEGMENTSAIRLINECODE","SEGMENTSDISTANCE" = DBT_INTERNAL_SOURCE."SEGMENTSDISTANCE","SEGMENTSDURATIONINSECONDS" = DBT_INTERNAL_SOURCE."SEGMENTSDURATIONINSECONDS","SEGMENTSEQUIPMENTDESCRIPTION" = DBT_INTERNAL_SOURCE."SEGMENTSEQUIPMENTDESCRIPTION","SEGMENTSCABINCODE" = DBT_INTERNAL_SOURCE."SEGMENTSCABINCODE"
    

    when not matched then insert
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")
    values
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")

;
[0m18:01:34.290440 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 1.091 seconds
[0m18:01:34.290440 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:34.291436 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
COMMIT
[0m18:01:34.587644 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.295 seconds
[0m18:01:34.595622 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:01:34.601606 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:01:34.602604 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m18:01:34.893824 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.291 seconds
[0m18:01:34.914769 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8B9E0250>]}
[0m18:01:34.915766 [info ] [Thread-1 (]: 1 of 3 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 0[0m in 7.14s]
[0m18:01:34.916763 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m18:01:34.917760 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m18:01:34.918758 [info ] [Thread-3 (]: 2 of 3 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m18:01:34.919755 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m18:01:34.919755 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m18:01:34.923745 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m18:01:34.925740 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m18:01:34.955659 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m18:01:34.958652 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m18:01:34.959649 [debug] [Thread-3 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m18:01:34.960646 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m18:01:39.044717 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 4.084 seconds
[0m18:01:39.049704 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8BC73A30>]}
[0m18:01:39.050702 [info ] [Thread-3 (]: 2 of 3 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 4.13s]
[0m18:01:39.051700 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m18:01:39.052697 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:01:39.053694 [info ] [Thread-2 (]: 3 of 3 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:01:39.054691 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:01:39.054691 [debug] [Thread-2 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:01:39.059677 [debug] [Thread-2 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:01:39.061672 [debug] [Thread-2 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:01:39.066660 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:01:39.067657 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,
        days_out,

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null
),

-------------------------------------------------------------------
-- 2.  Route benchmarks (p50 … max)  – already pre-computed
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  (≈ # of SDs to 95-th in normal dist.)
        (b.usd_per_mi - br.p50_usd_per_mi)
        / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645 , 0)
                                                              as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                              as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                              as is_above_p97

    from base b
    left join bench br
           on  b.route       = br.route
           and b.fare_bucket = br.fare_bucket
)

-------------------------------------------------------------------
-- 4.  Incremental filter
-------------------------------------------------------------------
select *
from joined


where (legid, search_date) not in (
    select legid, search_date from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
)

  );
[0m18:01:39.068654 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m18:01:42.224210 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01bbe83e-0305-0bba-0006-8fdb00185d9e
[0m18:01:42.225208 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 15 at position 8
invalid identifier 'DAYS_OUT'
[0m18:01:42.227203 [debug] [Thread-2 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 15 at position 8
  invalid identifier 'DAYS_OUT'
[0m18:01:42.228199 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bf71fd5a-03db-4a7b-a40d-10fa90c77b46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8B9E0250>]}
[0m18:01:42.229197 [error] [Thread-2 (]: 3 of 3 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.17s]
[0m18:01:42.230194 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:01:42.231192 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 15 at position 8
  invalid identifier 'DAYS_OUT'.
[0m18:01:42.232189 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:42.233186 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:01:42.234183 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:01:42.564300 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:01:42.565298 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:01:42.932315 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m18:01:42.933313 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m18:01:43.277392 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m18:01:43.278389 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m18:01:43.613493 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:01:43.614490 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:01:43.950590 [info ] [MainThread]: 
[0m18:01:43.951589 [info ] [MainThread]: Finished running 2 incremental models, 1 table model in 0 hours 0 minutes and 25.40 seconds (25.40s).
[0m18:01:43.952586 [debug] [MainThread]: Command end result
[0m18:01:43.986494 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:01:43.989565 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:01:43.998462 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:01:43.999460 [info ] [MainThread]: 
[0m18:01:44.000458 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:01:44.001456 [info ] [MainThread]: 
[0m18:01:44.002453 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 15 at position 8
  invalid identifier 'DAYS_OUT'
[0m18:01:44.003450 [info ] [MainThread]: 
[0m18:01:44.004447 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m18:01:44.006442 [debug] [MainThread]: Command `dbt run` failed at 18:01:44.005444 after 27.74 seconds
[0m18:01:44.007440 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B81B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B8C3BF2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020B81BD44C0>]}
[0m18:01:44.008436 [debug] [MainThread]: Flushing usage events
[0m18:01:44.346531 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:04:21.454152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029954E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029956559CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029956559EA0>]}


============================== 18:04:21.459139 | 1c080d13-3326-41a2-bed7-4bf952bfb38c ==============================
[0m18:04:21.459139 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:04:21.460136 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select +int_route_fare_per_mi_stats', 'send_anonymous_usage_stats': 'True'}
[0m18:04:22.379676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299565320B0>]}
[0m18:04:22.441510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995EB5D240>]}
[0m18:04:22.442508 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:04:23.022955 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:04:23.315172 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:04:23.316170 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:04:23.745022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F7A8A00>]}
[0m18:04:23.893624 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:04:23.896617 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:04:23.920553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F42CBB0>]}
[0m18:04:23.921551 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:04:23.922548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F42D1E0>]}
[0m18:04:23.924542 [info ] [MainThread]: 
[0m18:04:23.925539 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:04:23.926537 [info ] [MainThread]: 
[0m18:04:23.927535 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:04:23.935512 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:04:24.045219 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:04:24.045219 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:04:24.046216 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:04:27.425175 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.379 seconds
[0m18:04:27.429164 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:04:27.439137 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:04:27.440136 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:04:27.440136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:04:31.126272 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.686 seconds
[0m18:04:31.131258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029951DCE560>]}
[0m18:04:31.135248 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m18:04:31.136245 [info ] [Thread-1 (]: 1 of 3 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m18:04:31.137242 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m18:04:31.138240 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m18:04:31.152202 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:31.153200 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m18:04:31.206058 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:31.207056 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
  
   as (
    




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    
      where (legid, search_date) not in (
        select
          t.legid,
          t.search_date
        from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches t
      )
    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
  );
[0m18:04:31.208053 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:04:35.764860 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.557 seconds
[0m18:04:35.773836 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:35.774834 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:04:36.018183 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.243 seconds
[0m18:04:36.023169 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:36.024167 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
[0m18:04:36.219644 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.195 seconds
[0m18:04:36.228619 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:36.229617 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."STG_FARE_SEARCHES"
[0m18:04:36.429083 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.198 seconds
[0m18:04:36.460000 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:36.462992 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:36.463989 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
-- back compat for old kwarg name
  
  begin;
[0m18:04:36.694373 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.230 seconds
[0m18:04:36.694373 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:36.695371 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "LEGID" = DBT_INTERNAL_SOURCE."LEGID","SEARCH_DATE" = DBT_INTERNAL_SOURCE."SEARCH_DATE","FLIGHT_DATE" = DBT_INTERNAL_SOURCE."FLIGHT_DATE","DAYS_TO_FLIGHT" = DBT_INTERNAL_SOURCE."DAYS_TO_FLIGHT","ORIGIN" = DBT_INTERNAL_SOURCE."ORIGIN","DESTINATION" = DBT_INTERNAL_SOURCE."DESTINATION","ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","TOTAL_FARE" = DBT_INTERNAL_SOURCE."TOTAL_FARE","BASE_FARE" = DBT_INTERNAL_SOURCE."BASE_FARE","TOTAL_MILES" = DBT_INTERNAL_SOURCE."TOTAL_MILES","USD_PER_MI" = DBT_INTERNAL_SOURCE."USD_PER_MI","IS_NONSTOP" = DBT_INTERNAL_SOURCE."IS_NONSTOP","IS_BASIC_ECON" = DBT_INTERNAL_SOURCE."IS_BASIC_ECON","IS_REFUNDABLE" = DBT_INTERNAL_SOURCE."IS_REFUNDABLE","FAREBASISCODE" = DBT_INTERNAL_SOURCE."FAREBASISCODE","FARE_BUCKET" = DBT_INTERNAL_SOURCE."FARE_BUCKET","SEATS_REMAINING" = DBT_INTERNAL_SOURCE."SEATS_REMAINING","SEATS_FLAG" = DBT_INTERNAL_SOURCE."SEATS_FLAG","TRAVELDURATION" = DBT_INTERNAL_SOURCE."TRAVELDURATION","SEGMENTSDEPARTUREAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSDEPARTUREAIRPORTCODE","SEGMENTSARRIVALAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSARRIVALAIRPORTCODE","SEGMENTSAIRLINECODE" = DBT_INTERNAL_SOURCE."SEGMENTSAIRLINECODE","SEGMENTSDISTANCE" = DBT_INTERNAL_SOURCE."SEGMENTSDISTANCE","SEGMENTSDURATIONINSECONDS" = DBT_INTERNAL_SOURCE."SEGMENTSDURATIONINSECONDS","SEGMENTSEQUIPMENTDESCRIPTION" = DBT_INTERNAL_SOURCE."SEGMENTSEQUIPMENTDESCRIPTION","SEGMENTSCABINCODE" = DBT_INTERNAL_SOURCE."SEGMENTSCABINCODE"
    

    when not matched then insert
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")
    values
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")

;
[0m18:04:37.528142 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 0.832 seconds
[0m18:04:37.529139 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:37.530137 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
COMMIT
[0m18:04:37.766505 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.236 seconds
[0m18:04:37.775482 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:04:37.782462 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:04:37.782462 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m18:04:38.041768 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.258 seconds
[0m18:04:38.062711 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F6C6080>]}
[0m18:04:38.063710 [info ] [Thread-1 (]: 1 of 3 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 0[0m in 6.92s]
[0m18:04:38.065704 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m18:04:38.065704 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m18:04:38.066701 [info ] [Thread-3 (]: 2 of 3 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m18:04:38.067699 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m18:04:38.068696 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m18:04:38.071688 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m18:04:38.072685 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m18:04:38.100610 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m18:04:38.103603 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m18:04:38.104600 [debug] [Thread-3 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m18:04:38.104600 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m18:04:42.131824 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 4.026 seconds
[0m18:04:42.135813 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000299604C9750>]}
[0m18:04:42.136811 [info ] [Thread-3 (]: 2 of 3 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 4.07s]
[0m18:04:42.137808 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m18:04:42.138806 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:04:42.139802 [info ] [Thread-2 (]: 3 of 3 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:04:42.140800 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:04:42.141798 [debug] [Thread-2 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:04:42.146784 [debug] [Thread-2 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:42.147781 [debug] [Thread-2 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:04:42.152767 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:42.153765 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Incremental filter
-------------------------------------------------------------------
select * from joined


where (legid, search_date) not in (
    select legid, search_date from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
)

  );
[0m18:04:42.154763 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m18:04:45.846883 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 3.693 seconds
[0m18:04:45.850872 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:45.851870 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m18:04:46.060312 [debug] [Thread-2 (]: SQL status: SUCCESS 25 in 0.208 seconds
[0m18:04:46.065299 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:46.066296 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
[0m18:04:46.262771 [debug] [Thread-2 (]: SQL status: SUCCESS 2 in 0.196 seconds
[0m18:04:46.266760 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:46.266760 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."INT_ROUTE_FARE_PER_MI_STATS"
[0m18:04:46.485175 [debug] [Thread-2 (]: SQL status: SUCCESS 2 in 0.217 seconds
[0m18:04:46.488167 [debug] [Thread-2 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:46.490162 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:46.490162 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
-- back compat for old kwarg name
  
  begin;
[0m18:04:46.734508 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 0.244 seconds
[0m18:04:46.735506 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:04:46.736503 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","P95_USD_PER_MI" = DBT_INTERNAL_SOURCE."P95_USD_PER_MI"
    

    when not matched then insert
        ("ROUTE", "P95_USD_PER_MI")
    values
        ("ROUTE", "P95_USD_PER_MI")

;
[0m18:04:46.986833 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01bbe841-0305-0c96-0006-8fdb00184fce
[0m18:04:46.987830 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 4 at position 48
invalid identifier 'DBT_INTERNAL_DEST.LEGID'
[0m18:04:46.989826 [debug] [Thread-2 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:04:46.990822 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c080d13-3326-41a2-bed7-4bf952bfb38c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F6C6080>]}
[0m18:04:46.991819 [error] [Thread-2 (]: 3 of 3 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 4.85s]
[0m18:04:46.992818 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:04:46.993814 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql.
[0m18:04:46.994812 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:04:46.995809 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:04:46.996806 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:04:47.346870 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:04:47.346870 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:04:47.723861 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m18:04:47.724858 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m18:04:48.074921 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m18:04:48.075919 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m18:04:48.437950 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:04:48.438948 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:04:48.772056 [info ] [MainThread]: 
[0m18:04:48.773054 [info ] [MainThread]: Finished running 2 incremental models, 1 table model in 0 hours 0 minutes and 24.85 seconds (24.85s).
[0m18:04:48.774051 [debug] [MainThread]: Command end result
[0m18:04:48.807960 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:04:48.810952 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:04:48.818931 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:04:48.819929 [info ] [MainThread]: 
[0m18:04:48.819929 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:04:48.820926 [info ] [MainThread]: 
[0m18:04:48.821923 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:04:48.822920 [info ] [MainThread]: 
[0m18:04:48.822920 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m18:04:48.824915 [debug] [MainThread]: Command `dbt run` failed at 18:04:48.824915 after 27.45 seconds
[0m18:04:48.825912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029954E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002995F62B220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029954EBF1F0>]}
[0m18:04:48.825912 [debug] [MainThread]: Flushing usage events
[0m18:04:49.167997 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:05:46.164489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE8EC1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9035A2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9035A0E0>]}


============================== 18:05:46.168478 | b44b7bec-4249-4b1a-9627-08ff70b2716f ==============================
[0m18:05:46.168478 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:05:46.169476 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select +int_route_fare_per_mi_stats', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:05:47.148855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE98C5C3A0>]}
[0m18:05:47.210689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE98C5FB50>]}
[0m18:05:47.211688 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:05:47.794129 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:05:48.094325 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:05:48.095323 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:05:48.475306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE998A3E50>]}
[0m18:05:48.622911 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:05:48.625903 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:05:48.649839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9932CCD0>]}
[0m18:05:48.650836 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:05:48.651833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9932C430>]}
[0m18:05:48.653828 [info ] [MainThread]: 
[0m18:05:48.654825 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:05:48.655823 [info ] [MainThread]: 
[0m18:05:48.656820 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:05:48.661806 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:05:48.772511 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:05:48.773508 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:05:48.774506 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:05:51.997880 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.223 seconds
[0m18:05:52.000872 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:05:52.011843 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:05:52.011843 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:05:52.012840 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:05:55.720918 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.708 seconds
[0m18:05:55.724907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9932D6F0>]}
[0m18:05:55.729894 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m18:05:55.730892 [info ] [Thread-1 (]: 1 of 3 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m18:05:55.731889 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m18:05:55.731889 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m18:05:55.745851 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:05:55.747847 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m18:05:55.800704 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:05:55.801702 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
  
   as (
    




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    
      where (legid, search_date) not in (
        select
          t.legid,
          t.search_date
        from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches t
      )
    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
  );
[0m18:05:55.802699 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:06:00.032382 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.229 seconds
[0m18:06:00.042356 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.043353 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:06:00.262765 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.219 seconds
[0m18:06:00.267752 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.267752 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
[0m18:06:00.484173 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.216 seconds
[0m18:06:00.493149 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.494146 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."STG_FARE_SEARCHES"
[0m18:06:00.710567 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.215 seconds
[0m18:06:00.740487 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.743479 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.744476 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
-- back compat for old kwarg name
  
  begin;
[0m18:06:00.993810 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.248 seconds
[0m18:06:00.993810 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:00.994807 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "LEGID" = DBT_INTERNAL_SOURCE."LEGID","SEARCH_DATE" = DBT_INTERNAL_SOURCE."SEARCH_DATE","FLIGHT_DATE" = DBT_INTERNAL_SOURCE."FLIGHT_DATE","DAYS_TO_FLIGHT" = DBT_INTERNAL_SOURCE."DAYS_TO_FLIGHT","ORIGIN" = DBT_INTERNAL_SOURCE."ORIGIN","DESTINATION" = DBT_INTERNAL_SOURCE."DESTINATION","ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","TOTAL_FARE" = DBT_INTERNAL_SOURCE."TOTAL_FARE","BASE_FARE" = DBT_INTERNAL_SOURCE."BASE_FARE","TOTAL_MILES" = DBT_INTERNAL_SOURCE."TOTAL_MILES","USD_PER_MI" = DBT_INTERNAL_SOURCE."USD_PER_MI","IS_NONSTOP" = DBT_INTERNAL_SOURCE."IS_NONSTOP","IS_BASIC_ECON" = DBT_INTERNAL_SOURCE."IS_BASIC_ECON","IS_REFUNDABLE" = DBT_INTERNAL_SOURCE."IS_REFUNDABLE","FAREBASISCODE" = DBT_INTERNAL_SOURCE."FAREBASISCODE","FARE_BUCKET" = DBT_INTERNAL_SOURCE."FARE_BUCKET","SEATS_REMAINING" = DBT_INTERNAL_SOURCE."SEATS_REMAINING","SEATS_FLAG" = DBT_INTERNAL_SOURCE."SEATS_FLAG","TRAVELDURATION" = DBT_INTERNAL_SOURCE."TRAVELDURATION","SEGMENTSDEPARTUREAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSDEPARTUREAIRPORTCODE","SEGMENTSARRIVALAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSARRIVALAIRPORTCODE","SEGMENTSAIRLINECODE" = DBT_INTERNAL_SOURCE."SEGMENTSAIRLINECODE","SEGMENTSDISTANCE" = DBT_INTERNAL_SOURCE."SEGMENTSDISTANCE","SEGMENTSDURATIONINSECONDS" = DBT_INTERNAL_SOURCE."SEGMENTSDURATIONINSECONDS","SEGMENTSEQUIPMENTDESCRIPTION" = DBT_INTERNAL_SOURCE."SEGMENTSEQUIPMENTDESCRIPTION","SEGMENTSCABINCODE" = DBT_INTERNAL_SOURCE."SEGMENTSCABINCODE"
    

    when not matched then insert
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")
    values
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")

;
[0m18:06:02.119797 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 1.124 seconds
[0m18:06:02.120794 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:02.120794 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
COMMIT
[0m18:06:02.384089 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.263 seconds
[0m18:06:02.393066 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:06:02.399050 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:06:02.400047 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m18:06:02.650377 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.250 seconds
[0m18:06:02.671322 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE98C5F370>]}
[0m18:06:02.672319 [info ] [Thread-1 (]: 1 of 3 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 0[0m in 6.94s]
[0m18:06:02.673316 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m18:06:02.674313 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m18:06:02.675311 [info ] [Thread-3 (]: 2 of 3 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m18:06:02.676308 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m18:06:02.676308 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m18:06:02.680297 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m18:06:02.681294 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m18:06:02.708223 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m18:06:02.710217 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m18:06:02.711214 [debug] [Thread-3 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m18:06:02.712212 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m18:06:06.640700 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 3.928 seconds
[0m18:06:06.644689 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9A1C5720>]}
[0m18:06:06.645687 [info ] [Thread-3 (]: 2 of 3 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 3.97s]
[0m18:06:06.646684 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m18:06:06.647681 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:06:06.648679 [info ] [Thread-2 (]: 3 of 3 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:06:06.649677 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:06:06.650673 [debug] [Thread-2 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:06:06.655660 [debug] [Thread-2 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:06:06.656657 [debug] [Thread-2 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:06:06.661643 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:06:06.662641 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select
    j.*
from joined j


  where not exists (
    select 1
    from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats t
    where t.legid       = j.legid
      and t.search_date = j.search_date
  )

  );
[0m18:06:06.662641 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m18:06:09.921920 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01bbe842-0305-0c96-0006-8fdb00184fde
[0m18:06:09.922918 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 92 at position 10
invalid identifier 'T.LEGID'
[0m18:06:09.924912 [debug] [Thread-2 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 10
  invalid identifier 'T.LEGID'
[0m18:06:09.925909 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b44b7bec-4249-4b1a-9627-08ff70b2716f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE98C5F370>]}
[0m18:06:09.926907 [error] [Thread-2 (]: 3 of 3 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.28s]
[0m18:06:09.927905 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:06:09.928902 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 10
  invalid identifier 'T.LEGID'.
[0m18:06:09.929899 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:06:09.930896 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:06:09.930896 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:06:10.271983 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:06:10.272981 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:06:10.617060 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m18:06:10.618058 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m18:06:10.971113 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m18:06:10.972110 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m18:06:11.321176 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:06:11.321176 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:06:11.678221 [info ] [MainThread]: 
[0m18:06:11.679218 [info ] [MainThread]: Finished running 2 incremental models, 1 table model in 0 hours 0 minutes and 23.02 seconds (23.02s).
[0m18:06:11.681213 [debug] [MainThread]: Command end result
[0m18:06:11.713127 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:06:11.716120 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:06:11.725095 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:06:11.725095 [info ] [MainThread]: 
[0m18:06:11.726093 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:06:11.727090 [info ] [MainThread]: 
[0m18:06:11.728088 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 10
  invalid identifier 'T.LEGID'
[0m18:06:11.729085 [info ] [MainThread]: 
[0m18:06:11.729085 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m18:06:11.731080 [debug] [MainThread]: Command `dbt run` failed at 18:06:11.731080 after 25.65 seconds
[0m18:06:11.732076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE8EC1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE994BDB10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CE9A663E20>]}
[0m18:06:11.732076 [debug] [MainThread]: Flushing usage events
[0m18:06:12.088124 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:07:09.488536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200C721D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200C8959D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200C8959F30>]}


============================== 18:07:09.493522 | 68ea5ca9-e5ec-42ed-81ac-79e321840e6f ==============================
[0m18:07:09.493522 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:07:09.494521 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select +int_route_fare_per_mi_stats', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:07:10.470906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D125C3A0>]}
[0m18:07:10.538726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D125FB50>]}
[0m18:07:10.539723 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:07:11.146100 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:07:11.452281 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:07:11.453278 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:07:11.856200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D1E83E80>]}
[0m18:07:12.010787 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:07:12.013778 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:07:12.038712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D192CA30>]}
[0m18:07:12.039709 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:07:12.041704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D192C400>]}
[0m18:07:12.044696 [info ] [MainThread]: 
[0m18:07:12.044696 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:07:12.045694 [info ] [MainThread]: 
[0m18:07:12.047689 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:07:12.054669 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:07:12.172354 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:07:12.173351 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:07:12.174350 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:07:16.578565 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.405 seconds
[0m18:07:16.582553 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:07:16.594522 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:07:16.594522 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:07:16.595519 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:07:20.250739 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.655 seconds
[0m18:07:20.254728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D125F370>]}
[0m18:07:20.259714 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m18:07:20.260712 [info ] [Thread-1 (]: 1 of 3 START sql incremental model WALRUS_PUBLIC.stg_fare_searches ............. [RUN]
[0m18:07:20.261709 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m18:07:20.262707 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m18:07:20.273677 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:20.275672 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m18:07:20.331522 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:20.332520 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
  
   as (
    




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    
      where (legid, search_date) not in (
        select
          t.legid,
          t.search_date
        from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches t
      )
    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
  );
[0m18:07:20.333517 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:07:24.467455 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.135 seconds
[0m18:07:24.476431 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:24.477429 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:07:24.690858 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.212 seconds
[0m18:07:24.694847 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:24.695844 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
[0m18:07:24.901295 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.204 seconds
[0m18:07:24.910271 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:24.910271 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."STG_FARE_SEARCHES"
[0m18:07:25.102756 [debug] [Thread-1 (]: SQL status: SUCCESS 26 in 0.191 seconds
[0m18:07:25.133673 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:25.136665 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:25.136665 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
-- back compat for old kwarg name
  
  begin;
[0m18:07:25.437859 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.300 seconds
[0m18:07:25.437859 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:25.438856 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "LEGID" = DBT_INTERNAL_SOURCE."LEGID","SEARCH_DATE" = DBT_INTERNAL_SOURCE."SEARCH_DATE","FLIGHT_DATE" = DBT_INTERNAL_SOURCE."FLIGHT_DATE","DAYS_TO_FLIGHT" = DBT_INTERNAL_SOURCE."DAYS_TO_FLIGHT","ORIGIN" = DBT_INTERNAL_SOURCE."ORIGIN","DESTINATION" = DBT_INTERNAL_SOURCE."DESTINATION","ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","TOTAL_FARE" = DBT_INTERNAL_SOURCE."TOTAL_FARE","BASE_FARE" = DBT_INTERNAL_SOURCE."BASE_FARE","TOTAL_MILES" = DBT_INTERNAL_SOURCE."TOTAL_MILES","USD_PER_MI" = DBT_INTERNAL_SOURCE."USD_PER_MI","IS_NONSTOP" = DBT_INTERNAL_SOURCE."IS_NONSTOP","IS_BASIC_ECON" = DBT_INTERNAL_SOURCE."IS_BASIC_ECON","IS_REFUNDABLE" = DBT_INTERNAL_SOURCE."IS_REFUNDABLE","FAREBASISCODE" = DBT_INTERNAL_SOURCE."FAREBASISCODE","FARE_BUCKET" = DBT_INTERNAL_SOURCE."FARE_BUCKET","SEATS_REMAINING" = DBT_INTERNAL_SOURCE."SEATS_REMAINING","SEATS_FLAG" = DBT_INTERNAL_SOURCE."SEATS_FLAG","TRAVELDURATION" = DBT_INTERNAL_SOURCE."TRAVELDURATION","SEGMENTSDEPARTUREAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSDEPARTUREAIRPORTCODE","SEGMENTSARRIVALAIRPORTCODE" = DBT_INTERNAL_SOURCE."SEGMENTSARRIVALAIRPORTCODE","SEGMENTSAIRLINECODE" = DBT_INTERNAL_SOURCE."SEGMENTSAIRLINECODE","SEGMENTSDISTANCE" = DBT_INTERNAL_SOURCE."SEGMENTSDISTANCE","SEGMENTSDURATIONINSECONDS" = DBT_INTERNAL_SOURCE."SEGMENTSDURATIONINSECONDS","SEGMENTSEQUIPMENTDESCRIPTION" = DBT_INTERNAL_SOURCE."SEGMENTSEQUIPMENTDESCRIPTION","SEGMENTSCABINCODE" = DBT_INTERNAL_SOURCE."SEGMENTSCABINCODE"
    

    when not matched then insert
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")
    values
        ("LEGID", "SEARCH_DATE", "FLIGHT_DATE", "DAYS_TO_FLIGHT", "ORIGIN", "DESTINATION", "ROUTE", "TOTAL_FARE", "BASE_FARE", "TOTAL_MILES", "USD_PER_MI", "IS_NONSTOP", "IS_BASIC_ECON", "IS_REFUNDABLE", "FAREBASISCODE", "FARE_BUCKET", "SEATS_REMAINING", "SEATS_FLAG", "TRAVELDURATION", "SEGMENTSDEPARTUREAIRPORTCODE", "SEGMENTSARRIVALAIRPORTCODE", "SEGMENTSAIRLINECODE", "SEGMENTSDISTANCE", "SEGMENTSDURATIONINSECONDS", "SEGMENTSEQUIPMENTDESCRIPTION", "SEGMENTSCABINCODE")

;
[0m18:07:26.954800 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 1.515 seconds
[0m18:07:26.955798 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:26.955798 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
COMMIT
[0m18:07:27.179199 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.222 seconds
[0m18:07:27.188175 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp
[0m18:07:27.194159 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m18:07:27.194159 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches__dbt_tmp cascade
[0m18:07:27.439503 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.245 seconds
[0m18:07:27.461444 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D1B65720>]}
[0m18:07:27.462442 [info ] [Thread-1 (]: 1 of 3 OK created sql incremental model WALRUS_PUBLIC.stg_fare_searches ........ [[32mSUCCESS 0[0m in 7.20s]
[0m18:07:27.463439 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m18:07:27.464436 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m18:07:27.464436 [info ] [Thread-3 (]: 2 of 3 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m18:07:27.465434 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m18:07:27.466431 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m18:07:27.470420 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m18:07:27.472415 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m18:07:27.496351 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m18:07:27.499344 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m18:07:27.500341 [debug] [Thread-3 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m18:07:27.501338 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m18:07:31.638268 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 4.137 seconds
[0m18:07:31.642258 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D2C50B20>]}
[0m18:07:31.643255 [info ] [Thread-3 (]: 2 of 3 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 4.18s]
[0m18:07:31.645250 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m18:07:31.646247 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:07:31.646247 [info ] [Thread-2 (]: 3 of 3 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:07:31.647244 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:07:31.648242 [debug] [Thread-2 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:07:31.653228 [debug] [Thread-2 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:31.654226 [debug] [Thread-2 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:07:31.660209 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:31.660209 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Incremental filter
-------------------------------------------------------------------
select * from joined


where (legid, search_date) not in (
    select legid, search_date from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
)

  );
[0m18:07:31.661207 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m18:07:35.665000 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 4.004 seconds
[0m18:07:35.668989 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:35.668989 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m18:07:35.896381 [debug] [Thread-2 (]: SQL status: SUCCESS 25 in 0.227 seconds
[0m18:07:35.902365 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:35.902365 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
[0m18:07:36.086872 [debug] [Thread-2 (]: SQL status: SUCCESS 2 in 0.183 seconds
[0m18:07:36.090861 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:36.090861 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."INT_ROUTE_FARE_PER_MI_STATS"
[0m18:07:36.304290 [debug] [Thread-2 (]: SQL status: SUCCESS 2 in 0.212 seconds
[0m18:07:36.306284 [debug] [Thread-2 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:36.308280 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:36.309277 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
-- back compat for old kwarg name
  
  begin;
[0m18:07:36.539660 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 0.230 seconds
[0m18:07:36.540658 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:07:36.541655 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","P95_USD_PER_MI" = DBT_INTERNAL_SOURCE."P95_USD_PER_MI"
    

    when not matched then insert
        ("ROUTE", "P95_USD_PER_MI")
    values
        ("ROUTE", "P95_USD_PER_MI")

;
[0m18:07:36.793981 [debug] [Thread-2 (]: Snowflake adapter: Snowflake query id: 01bbe844-0305-0f94-0006-8fdb001867a2
[0m18:07:36.794977 [debug] [Thread-2 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 4 at position 48
invalid identifier 'DBT_INTERNAL_DEST.LEGID'
[0m18:07:36.797970 [debug] [Thread-2 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:07:36.798967 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68ea5ca9-e5ec-42ed-81ac-79e321840e6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D1B65720>]}
[0m18:07:36.799964 [error] [Thread-2 (]: 3 of 3 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 5.15s]
[0m18:07:36.801958 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:07:36.802956 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql.
[0m18:07:36.805948 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:07:36.806946 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:07:36.807943 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:07:37.205878 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:07:37.206875 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:07:37.555447 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m18:07:37.556444 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m18:07:37.907516 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m18:07:37.908513 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m18:07:38.284507 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:07:38.285505 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:07:38.615621 [info ] [MainThread]: 
[0m18:07:38.616619 [info ] [MainThread]: Finished running 2 incremental models, 1 table model in 0 hours 0 minutes and 26.57 seconds (26.57s).
[0m18:07:38.617616 [debug] [MainThread]: Command end result
[0m18:07:38.651034 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:07:38.653028 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:07:38.662004 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:07:38.663002 [info ] [MainThread]: 
[0m18:07:38.663999 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:07:38.663999 [info ] [MainThread]: 
[0m18:07:38.664997 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:07:38.665995 [info ] [MainThread]: 
[0m18:07:38.666991 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m18:07:38.668985 [debug] [MainThread]: Command `dbt run` failed at 18:07:38.668985 after 29.27 seconds
[0m18:07:38.668985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200C721D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D125FB50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200C6DDCD90>]}
[0m18:07:38.669983 [debug] [MainThread]: Flushing usage events
[0m18:07:39.018051 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:10:35.060514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013104F1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310665DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310665E1A0>]}


============================== 18:10:35.064504 | b3cff93c-8dc4-447a-88f8-52303dab53a9 ==============================
[0m18:10:35.064504 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:10:35.065501 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:10:36.012965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013103197070>]}
[0m18:10:36.079787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013105EFDBD0>]}
[0m18:10:36.081782 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:10:36.680181 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:10:36.984366 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:10:36.985364 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:10:37.394269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310F984A60>]}
[0m18:10:37.541874 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:10:37.544866 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:10:37.569800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310F62C340>]}
[0m18:10:37.570798 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:10:37.571795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310F62D5D0>]}
[0m18:10:37.572792 [info ] [MainThread]: 
[0m18:10:37.573789 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:10:37.574787 [info ] [MainThread]: 
[0m18:10:37.574787 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:10:37.576782 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:10:37.686488 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:10:37.687485 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:10:37.688482 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:10:44.176123 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.488 seconds
[0m18:10:44.184101 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:10:44.195072 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:10:44.196070 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:10:44.196070 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:10:47.940051 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.744 seconds
[0m18:10:47.945038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310F7E3580>]}
[0m18:10:47.950025 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:10:47.951023 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:10:47.952020 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:10:47.952020 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:10:47.962990 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:10:47.963987 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:10:48.016846 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:10:48.017844 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

  select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    route,
    origin,
    destination,
    fare_bucket,

    total_miles,
    usd_per_mi,
    total_fare,
    base_fare,

    seats_flag,
    is_nonstop,
    is_basic_econ,
    is_refundable

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (pre-computed)
-------------------------------------------------------------------
bench as (

  select * from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + compute z-score & flags
-------------------------------------------------------------------
joined as (

  select
    b.*,
    br.p50_usd_per_mi,
    br.p90_usd_per_mi,
    br.p95_usd_per_mi,
    br.p97_usd_per_mi,
    br.max_usd_per_mi,
    br.legs_sampled,

    -- approximate z-score
    (b.usd_per_mi - br.p50_usd_per_mi)
      / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
      as usd_per_mi_z,

    -- flags
    case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end as is_above_p95,
    case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end as is_above_p97

  from base b
  left join bench br
    on b.route       = br.route
   and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Incremental load: anti-join on legid + search_date
-------------------------------------------------------------------
select
  *
from joined j


where not exists (
  select 1
  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats t
  where t.legid       = j.legid
    and t.search_date = j.search_date
)

  );
[0m18:10:48.018841 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:10:51.944337 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe847-0305-0c96-0006-8fdb00189052
[0m18:10:51.944337 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 87 at position 8
invalid identifier 'T.LEGID'
[0m18:10:51.947329 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 87 at position 8
  invalid identifier 'T.LEGID'
[0m18:10:51.949324 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3cff93c-8dc4-447a-88f8-52303dab53a9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001310ED5FE50>]}
[0m18:10:51.950322 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 4.00s]
[0m18:10:51.951319 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:10:51.952316 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 87 at position 8
  invalid identifier 'T.LEGID'.
[0m18:10:51.954310 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:10:51.955308 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:10:51.955308 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:10:52.285425 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:10:52.285425 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:10:52.632495 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:10:52.632495 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:10:52.973583 [info ] [MainThread]: 
[0m18:10:52.973583 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 15.40 seconds (15.40s).
[0m18:10:52.975578 [debug] [MainThread]: Command end result
[0m18:10:53.007492 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:10:53.010484 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:10:53.018464 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:10:53.018464 [info ] [MainThread]: 
[0m18:10:53.019461 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:10:53.020458 [info ] [MainThread]: 
[0m18:10:53.020458 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 87 at position 8
  invalid identifier 'T.LEGID'
[0m18:10:53.021456 [info ] [MainThread]: 
[0m18:10:53.022453 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:10:53.023450 [debug] [MainThread]: Command `dbt run` failed at 18:10:53.023450 after 18.05 seconds
[0m18:10:53.024447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013104F1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013105EFDBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013104FB1030>]}
[0m18:10:53.025445 [debug] [MainThread]: Flushing usage events
[0m18:10:53.370521 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:11:22.455697 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F72831D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F729A5A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F729A5A170>]}


============================== 18:11:22.459686 | 4ce6babf-af29-4092-b3d9-73435f4b6c2e ==============================
[0m18:11:22.459686 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:11:22.460684 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:11:23.376233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F726597070>]}
[0m18:11:23.438068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7292FDBD0>]}
[0m18:11:23.439065 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:11:23.999566 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:11:24.296771 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:11:24.297768 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:11:24.677752 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732D9CA60>]}
[0m18:11:24.826353 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:11:24.828348 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:11:24.852284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732A2C340>]}
[0m18:11:24.853281 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:11:24.854279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732A2D5D0>]}
[0m18:11:24.856274 [info ] [MainThread]: 
[0m18:11:24.857271 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:11:24.857271 [info ] [MainThread]: 
[0m18:11:24.858268 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:11:24.859266 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:11:24.969969 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:11:24.970967 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:11:24.970967 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:11:28.566346 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.595 seconds
[0m18:11:28.574324 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:11:28.585296 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:11:28.586293 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:11:28.586293 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:11:32.285395 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.699 seconds
[0m18:11:32.290381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732BE3580>]}
[0m18:11:32.294371 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:11:32.295368 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:11:32.296365 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:11:32.297363 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:11:32.308333 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:11:32.309331 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:11:32.363187 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:11:32.364184 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select
    j.*
from joined j


  where not exists (
    select 1
      from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as existing
     where existing.legid       = j.legid
       and existing.search_date = j.search_date
  )

  );
[0m18:11:32.365182 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:11:36.042343 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe848-0305-0fb8-0006-8fdb00187616
[0m18:11:36.042343 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 92 at position 11
invalid identifier 'EXISTING.LEGID'
[0m18:11:36.045335 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 11
  invalid identifier 'EXISTING.LEGID'
[0m18:11:36.047329 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4ce6babf-af29-4092-b3d9-73435f4b6c2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73215FE50>]}
[0m18:11:36.048327 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.75s]
[0m18:11:36.049324 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:11:36.050321 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 11
  invalid identifier 'EXISTING.LEGID'.
[0m18:11:36.052316 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:11:36.052316 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:11:36.053313 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:11:36.482165 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:11:36.483163 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:11:36.813279 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:11:36.814277 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:11:37.176308 [info ] [MainThread]: 
[0m18:11:37.177306 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 12.32 seconds (12.32s).
[0m18:11:37.178303 [debug] [MainThread]: Command end result
[0m18:11:37.210217 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:11:37.214207 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:11:37.222186 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:11:37.223183 [info ] [MainThread]: 
[0m18:11:37.224182 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:11:37.225178 [info ] [MainThread]: 
[0m18:11:37.226175 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 92 at position 11
  invalid identifier 'EXISTING.LEGID'
[0m18:11:37.227173 [info ] [MainThread]: 
[0m18:11:37.227173 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:11:37.230164 [debug] [MainThread]: Command `dbt run` failed at 18:11:37.229167 after 14.86 seconds
[0m18:11:37.230164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F72831D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7292FDBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7283B0BE0>]}
[0m18:11:37.231161 [debug] [MainThread]: Flushing usage events
[0m18:11:37.574243 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:14:21.973384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516D11D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516E85DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516E85E1A0>]}


============================== 18:14:21.977373 | bca5af03-3b46-4521-afab-1e6897fd2a85 ==============================
[0m18:14:21.977373 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:14:21.978371 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:14:22.899904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bca5af03-3b46-4521-afab-1e6897fd2a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516B397070>]}
[0m18:14:22.961739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bca5af03-3b46-4521-afab-1e6897fd2a85', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516E101BD0>]}
[0m18:14:22.962736 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:14:23.540191 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:14:23.856346 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m18:14:23.857343 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m18:14:23.857343 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:14:24.109668 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  invalid syntax for function call expression
    line 2
      config(
[0m18:14:24.111662 [debug] [MainThread]: Command `dbt run` failed at 18:14:24.111662 after 2.22 seconds
[0m18:14:24.112659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002516D11D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025177AC4A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025177AC49D0>]}
[0m18:14:24.112659 [debug] [MainThread]: Flushing usage events
[0m18:14:24.460728 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:15:12.458299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B3E1D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B555DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B555E1A0>]}


============================== 18:15:12.461291 | 2b722c52-e218-4e54-8c1f-d5a6769de2e7 ==============================
[0m18:15:12.461291 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:15:12.462288 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:15:13.403769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BDB5C640>]}
[0m18:15:13.467598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BDB5E3B0>]}
[0m18:15:13.469594 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:15:14.047048 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:15:14.334279 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:15:14.335277 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:15:14.719249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE983E50>]}
[0m18:15:14.867852 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:15:14.869846 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:15:14.894780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE42CA00>]}
[0m18:15:14.895777 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:15:14.896775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE42D4B0>]}
[0m18:15:14.897772 [info ] [MainThread]: 
[0m18:15:14.898769 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:15:14.899767 [info ] [MainThread]: 
[0m18:15:14.900764 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:15:14.901761 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:15:15.014460 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:15:15.014460 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:15:15.015457 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:15:19.299992 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.285 seconds
[0m18:15:19.307971 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:15:19.318941 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:15:19.319939 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:15:19.320937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:15:23.302283 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.982 seconds
[0m18:15:23.307270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE5E3520>]}
[0m18:15:23.311259 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:15:23.312257 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:15:23.313254 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:15:23.314252 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:15:23.325222 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:23.326220 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:15:23.380075 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:23.381073 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select
  *
from joined j


where not exists (
  select 1
  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats                -- no alias here!
  where legid       = j.legid
    and search_date = j.search_date
)

  );
[0m18:15:23.381073 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:15:27.992733 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.612 seconds
[0m18:15:28.002707 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.002707 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m18:15:28.257026 [debug] [Thread-1 (]: SQL status: SUCCESS 25 in 0.253 seconds
[0m18:15:28.262012 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.263012 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
[0m18:15:28.474444 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.211 seconds
[0m18:15:28.481426 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.482423 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."INT_ROUTE_FARE_PER_MI_STATS"
[0m18:15:28.678897 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.196 seconds
[0m18:15:28.707820 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.709814 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.709814 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
-- back compat for old kwarg name
  
  begin;
[0m18:15:28.962139 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.251 seconds
[0m18:15:28.963136 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:15:28.963136 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
merge into FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as DBT_INTERNAL_DEST
        using FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp as DBT_INTERNAL_SOURCE
        on (
                    DBT_INTERNAL_SOURCE.legid = DBT_INTERNAL_DEST.legid
                ) and (
                    DBT_INTERNAL_SOURCE.search_date = DBT_INTERNAL_DEST.search_date
                )

    
    when matched then update set
        "ROUTE" = DBT_INTERNAL_SOURCE."ROUTE","P95_USD_PER_MI" = DBT_INTERNAL_SOURCE."P95_USD_PER_MI"
    

    when not matched then insert
        ("ROUTE", "P95_USD_PER_MI")
    values
        ("ROUTE", "P95_USD_PER_MI")

;
[0m18:15:29.228426 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe84c-0305-0fb8-0006-8fdb00187662
[0m18:15:29.229424 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 4 at position 48
invalid identifier 'DBT_INTERNAL_DEST.LEGID'
[0m18:15:29.231418 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:15:29.234411 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2b722c52-e218-4e54-8c1f-d5a6769de2e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BDB5F370>]}
[0m18:15:29.234411 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 5.92s]
[0m18:15:29.235409 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:15:29.236406 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql.
[0m18:15:29.238400 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:15:29.239397 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:15:29.239397 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:15:29.588463 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:15:29.589460 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:15:29.918580 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:15:29.919577 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:15:30.259667 [info ] [MainThread]: 
[0m18:15:30.260664 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 15.36 seconds (15.36s).
[0m18:15:30.261662 [debug] [MainThread]: Command end result
[0m18:15:30.294574 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:15:30.297566 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:15:30.306542 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:15:30.306542 [info ] [MainThread]: 
[0m18:15:30.307540 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:15:30.308537 [info ] [MainThread]: 
[0m18:15:30.308537 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 4 at position 48
  invalid identifier 'DBT_INTERNAL_DEST.LEGID'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:15:30.309534 [info ] [MainThread]: 
[0m18:15:30.310531 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:15:30.312526 [debug] [MainThread]: Command `dbt run` failed at 18:15:30.312526 after 17.94 seconds
[0m18:15:30.312526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B3E1D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE5BDAB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B3ED62F0>]}
[0m18:15:30.313523 [debug] [MainThread]: Flushing usage events
[0m18:15:30.651618 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:29:17.181123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002860821D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028609959D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028609959F00>]}


============================== 18:29:17.185113 | d8fce969-74a9-4fac-813c-5f8d6081b077 ==============================
[0m18:29:17.185113 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:29:17.186110 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'send_anonymous_usage_stats': 'True'}
[0m18:29:18.227324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028606397040>]}
[0m18:29:18.291153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028611F5F1F0>]}
[0m18:29:18.293148 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:29:18.866613 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:29:19.175786 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:29:19.176784 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:29:19.559758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028612BA8A30>]}
[0m18:29:19.708361 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:29:19.710356 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:29:19.737284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002861282CC10>]}
[0m18:29:19.738281 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:29:19.738281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002861282D3F0>]}
[0m18:29:19.740276 [info ] [MainThread]: 
[0m18:29:19.741273 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:29:19.742270 [info ] [MainThread]: 
[0m18:29:19.742270 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:29:19.744265 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:29:19.869929 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:29:19.870926 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:29:19.870926 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:29:25.074004 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.203 seconds
[0m18:29:25.081982 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:29:25.092953 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:29:25.092953 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:29:25.093951 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:29:28.738199 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.644 seconds
[0m18:29:28.743186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286129FC7C0>]}
[0m18:29:28.748173 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:29:28.748173 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:29:28.749170 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:29:28.750168 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:29:28.761141 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:29:28.763133 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:29:28.815991 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:29:28.816988 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select
  j.*
from joined j


  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats t
    on j.legid       = t.legid
   and j.search_date = t.search_date

  where t.legid is null

  );
[0m18:29:28.817986 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:29:32.447275 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe85a-0305-0fb8-0006-8fdb001876ba
[0m18:29:32.447275 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 90 at position 23
invalid identifier 'T.LEGID'
[0m18:29:32.450267 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 23
  invalid identifier 'T.LEGID'
[0m18:29:32.452262 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd8fce969-74a9-4fac-813c-5f8d6081b077', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028611F5FE80>]}
[0m18:29:32.453259 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.70s]
[0m18:29:32.454257 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:29:32.455255 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 23
  invalid identifier 'T.LEGID'.
[0m18:29:32.457248 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:29:32.457248 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:29:32.458246 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:29:32.797338 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:29:32.797338 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:29:33.124463 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:29:33.125460 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:29:33.475524 [info ] [MainThread]: 
[0m18:29:33.476521 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 13.73 seconds (13.73s).
[0m18:29:33.477519 [debug] [MainThread]: Command end result
[0m18:29:33.510431 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:29:33.513422 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:29:33.520403 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:29:33.521401 [info ] [MainThread]: 
[0m18:29:33.522399 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:29:33.523396 [info ] [MainThread]: 
[0m18:29:33.523396 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 23
  invalid identifier 'T.LEGID'
[0m18:29:33.524393 [info ] [MainThread]: 
[0m18:29:33.525390 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:29:33.526388 [debug] [MainThread]: Command `dbt run` failed at 18:29:33.526388 after 16.43 seconds
[0m18:29:33.527385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002860821D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286127D2860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286082D72B0>]}
[0m18:29:33.528383 [debug] [MainThread]: Flushing usage events
[0m18:29:33.871464 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:30:00.598949 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A051D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A1C5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A1C5E1A0>]}


============================== 18:30:00.603935 | 702e315f-5ea9-4784-82e1-68c16d92ad12 ==============================
[0m18:30:00.603935 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:30:00.609920 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:30:02.663425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA35C3A0>]}
[0m18:30:02.742214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA35FB50>]}
[0m18:30:02.744208 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:30:03.374522 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:30:03.698654 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:30:03.699652 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:30:04.113544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAFA3E50>]}
[0m18:30:04.270125 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:30:04.273117 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:30:04.302040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC2CCD0>]}
[0m18:30:04.303038 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:30:04.304035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC2C610>]}
[0m18:30:04.306029 [info ] [MainThread]: 
[0m18:30:04.307027 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:30:04.307027 [info ] [MainThread]: 
[0m18:30:04.309022 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:30:04.311016 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:30:04.458621 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:30:04.459619 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:30:04.460616 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:08.135782 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.675 seconds
[0m18:30:08.143761 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:30:08.155729 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:30:08.155729 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:30:08.156726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:11.840868 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.684 seconds
[0m18:30:11.845856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AADEDA20>]}
[0m18:30:11.849844 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:30:11.850842 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:30:11.851839 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:30:11.852836 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:30:11.865802 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:30:11.867796 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:30:11.922649 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:30:11.923648 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select * from joined j


where not exists (
  select 1
  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as _dest
  where _dest.legid       = j.legid
    and _dest.search_date = j.search_date
)

  );
[0m18:30:11.924644 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:30:15.541965 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe85b-0305-0c96-0006-8fdb00189132
[0m18:30:15.542962 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 90 at position 8
invalid identifier '_DEST.LEGID'
[0m18:30:15.544957 [debug] [Thread-1 (]: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 8
  invalid identifier '_DEST.LEGID'
[0m18:30:15.546952 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '702e315f-5ea9-4784-82e1-68c16d92ad12', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA35F370>]}
[0m18:30:15.547949 [error] [Thread-1 (]: 1 of 1 ERROR creating sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[31mERROR[0m in 3.69s]
[0m18:30:15.548946 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:30:15.549944 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_fare_per_mi_stats' to be skipped because of status 'error'.  Reason: Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 8
  invalid identifier '_DEST.LEGID'.
[0m18:30:15.551939 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:30:15.552936 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:30:15.552936 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:30:15.892028 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:30:15.893026 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:30:16.235110 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:30:16.236107 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:30:16.615093 [info ] [MainThread]: 
[0m18:30:16.616091 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 12.31 seconds (12.31s).
[0m18:30:16.617088 [debug] [MainThread]: Command end result
[0m18:30:16.650000 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:30:16.652992 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:30:16.660971 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:30:16.661968 [info ] [MainThread]: 
[0m18:30:16.662966 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:30:16.662966 [info ] [MainThread]: 
[0m18:30:16.663963 [error] [MainThread]:   Database Error in model int_route_fare_per_mi_stats (models\intermediate\int_route_fare_per_mi_stats.sql)
  000904 (42000): SQL compilation error: error line 90 at position 8
  invalid identifier '_DEST.LEGID'
[0m18:30:16.664960 [info ] [MainThread]: 
[0m18:30:16.664960 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:30:16.666955 [debug] [MainThread]: Command `dbt run` failed at 18:30:16.666955 after 16.41 seconds
[0m18:30:16.667952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A051D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AADB9B10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2ABCCA620>]}
[0m18:30:16.667952 [debug] [MainThread]: Flushing usage events
[0m18:30:17.004052 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:33:08.881154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4DD1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4F45DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4F45E1A0>]}


============================== 18:33:08.885143 | 92a28bc8-7dbd-496a-8aa6-5855e2388970 ==============================
[0m18:33:08.885143 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:33:08.885143 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'send_anonymous_usage_stats': 'True'}
[0m18:33:09.831611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4AF97070>]}
[0m18:33:09.894442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4ECFDBD0>]}
[0m18:33:09.896437 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:33:10.513786 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:33:10.851882 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:33:10.852878 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m18:33:11.288712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C58967FD0>]}
[0m18:33:11.438311 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:33:11.441304 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:33:11.468232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C58965B40>]}
[0m18:33:11.469229 [info ] [MainThread]: Found 13 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:33:11.470227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C58965B10>]}
[0m18:33:11.472221 [info ] [MainThread]: 
[0m18:33:11.472221 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:33:11.473218 [info ] [MainThread]: 
[0m18:33:11.474216 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:33:11.475214 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:33:11.597885 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:33:11.598882 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:33:11.599880 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:18.503408 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.904 seconds
[0m18:33:18.513381 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:33:18.526346 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:33:18.528341 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:33:18.529338 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:33:22.149651 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.620 seconds
[0m18:33:22.154638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C58966170>]}
[0m18:33:22.159625 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:33:22.160623 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m18:33:22.162617 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m18:33:22.162617 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:33:22.172590 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:22.174585 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:33:22.231432 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:22.232430 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select * from joined j
  );
[0m18:33:22.233428 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:33:26.312513 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.079 seconds
[0m18:33:26.323484 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:26.324481 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m18:33:26.538907 [debug] [Thread-1 (]: SQL status: SUCCESS 25 in 0.214 seconds
[0m18:33:26.544891 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:26.544891 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
[0m18:33:26.742363 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.197 seconds
[0m18:33:26.751338 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:26.751338 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."INT_ROUTE_FARE_PER_MI_STATS"
[0m18:33:26.935845 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.183 seconds
[0m18:33:26.951802 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:26.953797 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:26.954794 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
-- back compat for old kwarg name
  
  begin;
[0m18:33:27.212105 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.257 seconds
[0m18:33:27.213103 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:27.214100 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
insert into FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats ("ROUTE", "P95_USD_PER_MI")
        (
            select "ROUTE", "P95_USD_PER_MI"
            from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
        );
[0m18:33:27.937165 [debug] [Thread-1 (]: SQL status: SUCCESS 0 in 0.722 seconds
[0m18:33:27.938163 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:27.938163 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
COMMIT
[0m18:33:28.203453 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.264 seconds
[0m18:33:28.212429 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m18:33:28.219410 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m18:33:28.220408 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp cascade
[0m18:33:28.441814 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.221 seconds
[0m18:33:28.464754 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92a28bc8-7dbd-496a-8aa6-5855e2388970', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C57B5FE50>]}
[0m18:33:28.465751 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[32mSUCCESS 0[0m in 6.30s]
[0m18:33:28.466748 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m18:33:28.468743 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:33:28.468743 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:33:28.469740 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:33:28.808833 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:33:28.809830 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:33:29.166875 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m18:33:29.166875 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m18:33:29.505967 [info ] [MainThread]: 
[0m18:33:29.506965 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 18.03 seconds (18.03s).
[0m18:33:29.507963 [debug] [MainThread]: Command end result
[0m18:33:29.543866 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:33:29.547856 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:33:29.556832 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:33:29.556832 [info ] [MainThread]: 
[0m18:33:29.557829 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:33:29.558826 [info ] [MainThread]: 
[0m18:33:29.559824 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:33:29.561819 [debug] [MainThread]: Command `dbt run` succeeded at 18:33:29.561819 after 20.77 seconds
[0m18:33:29.562816 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4DD1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4ECFDBD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4DDACA60>]}
[0m18:33:29.563813 [debug] [MainThread]: Flushing usage events
[0m18:33:29.908889 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:36:20.936264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002948301D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029484759D80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029484759F60>]}


============================== 18:36:20.941251 | 6e143aa2-535a-436e-9065-9a2d5ee74cc0 ==============================
[0m18:36:20.941251 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:36:20.941251 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m18:36:21.866774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e143aa2-535a-436e-9065-9a2d5ee74cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029483DFCFA0>]}
[0m18:36:21.929606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e143aa2-535a-436e-9065-9a2d5ee74cc0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029483DFEB90>]}
[0m18:36:21.930604 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:36:22.509056 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:36:22.814239 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:36:22.814239 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m18:36:23.064569 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  invalid syntax for function call expression
    line 2
      config(
[0m18:36:23.066564 [debug] [MainThread]: Command `dbt run` failed at 18:36:23.066564 after 2.21 seconds
[0m18:36:23.067561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002948301D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002948DA4CA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002948DA4CA00>]}
[0m18:36:23.068559 [debug] [MainThread]: Flushing usage events
[0m18:36:23.428595 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:43:39.250449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017124C1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017126359CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017126359EA0>]}


============================== 18:43:39.254438 | 00408540-4632-43cc-b4af-21bf12c4b2d3 ==============================
[0m18:43:39.254438 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:43:39.255435 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:43:40.170985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017122D97070>]}
[0m18:43:40.232820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000171259FE560>]}
[0m18:43:40.233817 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:43:40.808280 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:43:41.103490 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:43:41.104488 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m18:43:41.478487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001712F570E80>]}
[0m18:43:41.629084 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:43:41.631079 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:43:41.656012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001712F570280>]}
[0m18:43:41.657010 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:43:41.658007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001712F58DAE0>]}
[0m18:43:41.660001 [info ] [MainThread]: 
[0m18:43:41.660999 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:43:41.660999 [info ] [MainThread]: 
[0m18:43:41.661996 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:43:41.663991 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:43:41.777686 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:43:41.777686 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:43:41.778684 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:46.952839 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.175 seconds
[0m18:43:46.960817 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:43:46.971788 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:43:46.972785 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:43:46.972785 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:50.636981 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.663 seconds
[0m18:43:50.640970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001712F573160>]}
[0m18:43:50.645957 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:43:50.646955 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m18:43:50.647952 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m18:43:50.648949 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:43:50.656928 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:43:50.658923 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:43:50.691834 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:43:50.694826 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:43:50.695824 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (

-------------------------------------------------------------------
-- 1.  Core booking row with benchmark deltas
-------------------------------------------------------------------
with base as (

    select
        s.legid,
        s.route,
        s.flight_date,
        s.search_date,
        s.days_to_flight,
        s.fare_bucket,
        s.usd_per_mi,
        s.seats_flag,

        f.usd_per_mi_z               as z_usd_per_mi,           -- from int_route_fare_per_mi_stats
        -- if you have premium_pct_usd_per_mi, include it here
        f.premium_pct_usd_per_mi,    as premium_pct_usd_per_mi, 
        f.p90_usd_per_mi,
        f.p95_usd_per_mi,
        f.p97_usd_per_mi,

        c.carrier_count,
        c.hhi

    from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats  f
    join FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches            s using (legid)
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   c using (route)

),

-------------------------------------------------------------------
-- 2.  Apply Rules 1–3
-------------------------------------------------------------------
rules as (

    select
        *,
        /* Rule 1: statistical outlier (z ≥ 2) */
        case when z_usd_per_mi >= 2 then 1 else 0 end
            as r1_price_outlier_flag,

        /* Rule 2: seat scarcity + price ≥ p97 */
        case
          when seats_flag in ('sold_out','scarce')
            and usd_per_mi >= p97_usd_per_mi
          then 1 else 0
        end as r2_seat_scarcity_flag,

        /* Rule 3: monopoly premium (HHI ≥ 0.9 AND price ≥ p95) */
        case
          when hhi >= 0.90
            and usd_per_mi >= p95_usd_per_mi
          then 1 else 0
        end as r3_monopoly_premium_flag

    from base

)

-------------------------------------------------------------------
-- 3.  Final select with “any rule” flag
-------------------------------------------------------------------
select
    *,
    case
      when r1_price_outlier_flag = 1
        or r2_seat_scarcity_flag = 1
        or r3_monopoly_premium_flag = 1
      then 1 else 0
    end as any_rule_flag
from rules
        );
[0m18:43:50.695824 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:43:54.326110 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe868-0305-0c96-0006-8fdb00189186
[0m18:43:54.327108 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 22 at position 37 unexpected 'as'.
syntax error line 23 at position 9 unexpected '.'.
syntax error line 24 at position 9 unexpected '.'.
syntax error line 25 at position 9 unexpected '.'.
syntax error line 27 at position 9 unexpected '.'.
syntax error line 28 at position 9 unexpected '.'.
syntax error line 31 at position 75 unexpected 'legid'.
syntax error line 32 at position 4 unexpected 'left'.
[0m18:43:54.330099 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 22 at position 37 unexpected 'as'.
  syntax error line 23 at position 9 unexpected '.'.
  syntax error line 24 at position 9 unexpected '.'.
  syntax error line 25 at position 9 unexpected '.'.
  syntax error line 27 at position 9 unexpected '.'.
  syntax error line 28 at position 9 unexpected '.'.
  syntax error line 31 at position 75 unexpected 'legid'.
  syntax error line 32 at position 4 unexpected 'left'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m18:43:54.332094 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '00408540-4632-43cc-b4af-21bf12c4b2d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017122BCE1D0>]}
[0m18:43:54.333091 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.68s]
[0m18:43:54.334089 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:43:54.335086 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 22 at position 37 unexpected 'as'.
  syntax error line 23 at position 9 unexpected '.'.
  syntax error line 24 at position 9 unexpected '.'.
  syntax error line 25 at position 9 unexpected '.'.
  syntax error line 27 at position 9 unexpected '.'.
  syntax error line 28 at position 9 unexpected '.'.
  syntax error line 31 at position 75 unexpected 'legid'.
  syntax error line 32 at position 4 unexpected 'left'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m18:43:54.337081 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:54.338078 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:43:54.338078 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:43:54.688141 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:43:54.689139 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:43:55.032221 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m18:43:55.033218 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m18:43:55.472044 [info ] [MainThread]: 
[0m18:43:55.473041 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.81 seconds (13.81s).
[0m18:43:55.474039 [debug] [MainThread]: Command end result
[0m18:43:55.506951 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:43:55.509943 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:43:55.518919 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:43:55.519916 [info ] [MainThread]: 
[0m18:43:55.520914 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:43:55.520914 [info ] [MainThread]: 
[0m18:43:55.521911 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 22 at position 37 unexpected 'as'.
  syntax error line 23 at position 9 unexpected '.'.
  syntax error line 24 at position 9 unexpected '.'.
  syntax error line 25 at position 9 unexpected '.'.
  syntax error line 27 at position 9 unexpected '.'.
  syntax error line 28 at position 9 unexpected '.'.
  syntax error line 31 at position 75 unexpected 'legid'.
  syntax error line 32 at position 4 unexpected 'left'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m18:43:55.522908 [info ] [MainThread]: 
[0m18:43:55.523905 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:43:55.525900 [debug] [MainThread]: Command `dbt run` failed at 18:43:55.525900 after 16.36 seconds
[0m18:43:55.526897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017124C1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001712F3E3760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017124CB1030>]}
[0m18:43:55.526897 [debug] [MainThread]: Flushing usage events
[0m18:43:55.866987 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:46:38.723226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB36C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB3815DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB3815E1A0>]}


============================== 18:46:38.727215 | 6ddc6d5a-9896-4754-b9d1-205e30b6c504 ==============================
[0m18:46:38.727215 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:46:38.728213 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m18:46:39.644760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB34B97010>]}
[0m18:46:39.706594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4075C460>]}
[0m18:46:39.708589 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:46:40.285047 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:46:40.590230 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:46:40.591228 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m18:46:41.012101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4156CE50>]}
[0m18:46:41.165690 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:46:41.168683 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:46:41.193616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB41593670>]}
[0m18:46:41.194613 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:46:41.195611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB41592F80>]}
[0m18:46:41.197605 [info ] [MainThread]: 
[0m18:46:41.198603 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:46:41.198603 [info ] [MainThread]: 
[0m18:46:41.199600 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:46:41.201595 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:46:41.315290 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:46:41.315290 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:46:41.316288 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:46:46.341841 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.025 seconds
[0m18:46:46.349819 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:46:46.359792 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:46:46.360790 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:46:46.361787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:46:49.859428 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.498 seconds
[0m18:46:49.864414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4156E2C0>]}
[0m18:46:49.868404 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:46:49.869402 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m18:46:49.870399 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m18:46:49.871396 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:46:49.880372 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:46:49.881369 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:46:49.914281 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:46:49.917274 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:46:49.918270 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (

-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    -- pick up your percentile benchmarks from stg_route_stats
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches     as s

  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    using (route, fare_bucket)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    using (route)

),

-- 2. Apply Rules 1–3
rules as (

  select
    *,
    /* Rule 1: statistical outlier */
    ((usd_per_mi - p50_usd_per_mi)
       / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
    ) >= 2
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
        and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
        and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag = 1
      or r2_seat_scarcity_flag = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m18:46:49.919268 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:46:53.700151 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe86b-0305-0f94-0006-8fdb001868f6
[0m18:46:53.700151 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 46 at position 6 unexpected 'then'.
syntax error line 51 at position 6 unexpected 'when'.
syntax error line 51 at position 26 unexpected ''sold_out''.
syntax error line 52 at position 8 unexpected 'and'.
[0m18:46:53.703144 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 46 at position 6 unexpected 'then'.
  syntax error line 51 at position 6 unexpected 'when'.
  syntax error line 51 at position 26 unexpected ''sold_out''.
  syntax error line 52 at position 8 unexpected 'and'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m18:46:53.705138 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6ddc6d5a-9896-4754-b9d1-205e30b6c504', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB349CE560>]}
[0m18:46:53.706136 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.83s]
[0m18:46:53.707133 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:46:53.708131 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 46 at position 6 unexpected 'then'.
  syntax error line 51 at position 6 unexpected 'when'.
  syntax error line 51 at position 26 unexpected ''sold_out''.
  syntax error line 52 at position 8 unexpected 'and'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m18:46:53.710125 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:46:53.711123 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:46:53.711123 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:46:54.051212 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:46:54.052209 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:46:54.391302 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m18:46:54.391302 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m18:46:54.741365 [info ] [MainThread]: 
[0m18:46:54.742362 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.54 seconds (13.54s).
[0m18:46:54.743361 [debug] [MainThread]: Command end result
[0m18:46:54.776272 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:46:54.778266 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:46:54.788241 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:46:54.788241 [info ] [MainThread]: 
[0m18:46:54.789238 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:46:54.790235 [info ] [MainThread]: 
[0m18:46:54.790235 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 46 at position 6 unexpected 'then'.
  syntax error line 51 at position 6 unexpected 'when'.
  syntax error line 51 at position 26 unexpected ''sold_out''.
  syntax error line 52 at position 8 unexpected 'and'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m18:46:54.791232 [info ] [MainThread]: 
[0m18:46:54.792229 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:46:54.794224 [debug] [MainThread]: Command `dbt run` failed at 18:46:54.794224 after 16.15 seconds
[0m18:46:54.795221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB36C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB36C4E950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB420D2830>]}
[0m18:46:54.795221 [debug] [MainThread]: Flushing usage events
[0m18:46:55.140298 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:48:25.949316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017191B1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719325DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719325E1D0>]}


============================== 18:48:25.953306 | b0ac5138-c070-4513-981d-5bda59b6bb1f ==============================
[0m18:48:25.953306 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:48:25.954304 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:48:26.871848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000171932220B0>]}
[0m18:48:26.933682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719BA5F820>]}
[0m18:48:26.934680 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:48:27.510140 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:48:27.812332 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:48:27.813329 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m18:48:28.190320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719C66CE20>]}
[0m18:48:28.338923 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:48:28.340918 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:48:28.365850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719C6935B0>]}
[0m18:48:28.366848 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:48:28.367846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719C693B50>]}
[0m18:48:28.368843 [info ] [MainThread]: 
[0m18:48:28.369840 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:48:28.370838 [info ] [MainThread]: 
[0m18:48:28.371835 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:48:28.372832 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:48:28.484533 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:48:28.484533 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:48:28.485530 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:48:33.155036 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.669 seconds
[0m18:48:33.163014 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:48:33.173985 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:48:33.173985 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:48:33.174983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:48:36.719498 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.544 seconds
[0m18:48:36.723487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001719C66E3B0>]}
[0m18:48:36.728474 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:48:36.729472 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m18:48:36.730470 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m18:48:36.730470 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:48:36.739445 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:48:36.741440 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:48:36.774351 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:48:36.777343 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m18:48:36.778341 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (

-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    -- percentile benchmarks
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches     as s

  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    using (route, fare_bucket)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    using (route)

),

-- 2. Apply Rules 1–3
rules as (

  select
    *,
    /* Rule 1: statistical outlier */
    case
      when (
        (usd_per_mi - p50_usd_per_mi)
          / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
      ) >= 2
    then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
        and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
        and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag = 1
      or r2_seat_scarcity_flag = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m18:48:36.779339 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:48:41.056893 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.278 seconds
[0m18:48:41.078834 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0ac5138-c070-4513-981d-5bda59b6bb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001718EACEB00>]}
[0m18:48:41.079832 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 4.35s]
[0m18:48:41.080829 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m18:48:41.082823 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:48:41.082823 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:48:41.083820 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:48:41.438870 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:48:41.439867 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:48:41.771979 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m18:48:41.772976 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m18:48:42.102096 [info ] [MainThread]: 
[0m18:48:42.103093 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.73 seconds (13.73s).
[0m18:48:42.104091 [debug] [MainThread]: Command end result
[0m18:48:42.136005 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:48:42.138000 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:48:42.147973 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:48:42.147973 [info ] [MainThread]: 
[0m18:48:42.148971 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:48:42.149968 [info ] [MainThread]: 
[0m18:48:42.149968 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:48:42.151962 [debug] [MainThread]: Command `dbt run` succeeded at 18:48:42.151962 after 16.28 seconds
[0m18:48:42.152960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017191B1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017191BD77F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017191BB2110>]}
[0m18:48:42.152960 [debug] [MainThread]: Flushing usage events
[0m18:48:42.497039 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:53:51.296300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC731D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC8A56590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC8A56770>]}


============================== 18:53:51.300290 | 71ec5f19-66b1-4d16-a01d-e85d047fa870 ==============================
[0m18:53:51.300290 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:53:51.301287 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m18:53:52.285653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC5597010>]}
[0m18:53:52.348485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD135C460>]}
[0m18:53:52.349482 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:53:52.931924 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:53:53.242094 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:53:53.243091 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m18:53:53.624072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD1F6CDC0>]}
[0m18:53:53.774669 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:53:53.776664 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:53:53.803591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD1F6EB90>]}
[0m18:53:53.804589 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:53:53.805587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD1F6EE00>]}
[0m18:53:53.806584 [info ] [MainThread]: 
[0m18:53:53.807581 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:53:53.808578 [info ] [MainThread]: 
[0m18:53:53.809576 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:53:53.810573 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:53:53.939229 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:53:53.940226 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:53:53.940226 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:53:59.531266 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.591 seconds
[0m18:53:59.539244 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:53:59.550215 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:53:59.551212 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:53:59.551212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:54:03.403903 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.853 seconds
[0m18:54:03.408890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD1F6F4C0>]}
[0m18:54:03.413877 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m18:54:03.414874 [info ] [Thread-1 (]: 1 of 1 START sql view model WALRUS_PUBLIC.mart_pricing_features ................ [RUN]
[0m18:54:03.415872 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m18:54:03.416869 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m18:54:03.428838 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:03.429835 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m18:54:03.453770 [debug] [Thread-1 (]: Dropping relation "FLIGHT_PRICES"."WALRUS_PUBLIC"."MART_PRICING_FEATURES" because it is of type table
[0m18:54:03.459754 [debug] [Thread-1 (]: Applying DROP to: "FLIGHT_PRICES"."WALRUS_PUBLIC"."MART_PRICING_FEATURES"
[0m18:54:03.465738 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:03.466735 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
drop table if exists "FLIGHT_PRICES"."WALRUS_PUBLIC"."MART_PRICING_FEATURES" cascade
[0m18:54:03.467734 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:54:06.878607 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.411 seconds
[0m18:54:06.888579 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:06.893566 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:06.894564 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace   view FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
  
   as (
    with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)          as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                           as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* distance from staging (may still be null) */
        s.total_miles                                 as staging_trip_dist,

        /* keep for convenience */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭──────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE  (great-circle padding)
-- ╰──────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        /* fall back to great-circle * 1.02 padding */
        coalesce(
            b.staging_trip_dist,

            1.02 * st_distance(
                     to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
                     to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
                   ) / 1609.344     -- metres → miles
        )                                                   as trip_dist

    from bookings b

    /* airport geo (small seed) */
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og
           on og.iata_code = b.origin
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg
           on dg.iata_code = b.destination
),

-- ╭──────────────────────────────────────────────╮
-- 3 · BENCHMARKS  (join z-score & percentiles)
-- ╰──────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        r.z_usd_per_mi,
        r.p50_usd_per_mi,
        r.p90_usd_per_mi,
        r.p95_usd_per_mi,
        r.p97_usd_per_mi,
        r.premium_pct_usd_per_mi

    from gc_dist g
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats r
           on r.legid = g.legid        -- same grain
),

-- ╭──────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰──────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi
    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
           on c.route = b.route
),

-- ╭──────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰──────────────────────────────────────────────╯
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- R1 · statistical price outlier  (z-score ≥ 2)
        ------------------------------------------------------------------
        case
            when z_usd_per_mi >= 2 then 1 else 0
        end                                                       as r1_price_outlier,

        ------------------------------------------------------------------
        -- R2 · seat-scarcity *and* price ≥ route P97
        ------------------------------------------------------------------
        case
            when seats_flag in ('sold_out','scarce')
             and usd_per_mi    >= p97_usd_per_mi
            then 1 else 0
        end                                                       as r2_seat_scarcity,

        ------------------------------------------------------------------
        -- R3 · monopoly (HHI ≥ .90) *and* price ≥ route P95
        ------------------------------------------------------------------
        case
            when hhi           >= 0.90
             and usd_per_mi    >= p95_usd_per_mi
            then 1 else 0
        end                                                       as r3_monopoly_premium

    from comp
),

-- ╭──────────────────────────────────────────────╮
-- 6 · FINAL SELECT  (add any_rule_flag)
-- ╰──────────────────────────────────────────────╯
final as (

    select
        *,
        case
            when r1_price_outlier   = 1
              or r2_seat_scarcity   = 1
              or r3_monopoly_premium= 1
            then 1 else 0
        end as any_rule_flag
    from flags
)

select * from final
  );
[0m18:54:07.116968 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe872-0305-0bb1-0006-8fdb0018825a
[0m18:54:07.117966 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 003001 (42501): SQL access control error:
Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
[0m18:54:07.120958 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m18:54:07.122952 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71ec5f19-66b1-4d16-a01d-e85d047fa870', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC6EDCD90>]}
[0m18:54:07.123950 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model WALRUS_PUBLIC.mart_pricing_features ....... [[31mERROR[0m in 3.71s]
[0m18:54:07.124947 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m18:54:07.125944 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m18:54:07.127940 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:54:07.127940 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:54:07.128936 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:54:07.500941 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:54:07.501938 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:54:07.867959 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m18:54:07.868956 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m18:54:08.214033 [info ] [MainThread]: 
[0m18:54:08.215030 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 14.41 seconds (14.41s).
[0m18:54:08.216028 [debug] [MainThread]: Command end result
[0m18:54:08.247944 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:54:08.250934 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:54:08.259911 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:54:08.260908 [info ] [MainThread]: 
[0m18:54:08.261905 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:54:08.261905 [info ] [MainThread]: 
[0m18:54:08.262902 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  003001 (42501): SQL access control error:
  Insufficient privileges to operate on schema 'WALRUS_PUBLIC'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m18:54:08.263900 [info ] [MainThread]: 
[0m18:54:08.264898 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:54:08.266892 [debug] [MainThread]: Command `dbt run` failed at 18:54:08.266892 after 17.05 seconds
[0m18:54:08.266892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC731D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CC73BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025CD2B0B9D0>]}
[0m18:54:08.267889 [debug] [MainThread]: Flushing usage events
[0m18:54:08.613962 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m18:54:42.393577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADBE1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD559C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD559E10>]}


============================== 18:54:42.397567 | 34d24a05-5466-49c8-b156-6807dc65249d ==============================
[0m18:54:42.397567 [info ] [MainThread]: Running with dbt=1.9.4
[0m18:54:42.397567 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:54:43.320098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD536890>]}
[0m18:54:43.382930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADD392D70>]}
[0m18:54:43.383928 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m18:54:44.022220 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m18:54:44.325408 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:54:44.326405 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m18:54:44.754260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAE6A68E20>]}
[0m18:54:44.904858 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:54:44.906852 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:54:44.931785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAE6A6ABF0>]}
[0m18:54:44.932783 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m18:54:44.932783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAE6A6AE60>]}
[0m18:54:44.934778 [info ] [MainThread]: 
[0m18:54:44.935775 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m18:54:44.936773 [info ] [MainThread]: 
[0m18:54:44.937770 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m18:54:44.938767 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m18:54:45.051465 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m18:54:45.052463 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m18:54:45.052463 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:54:50.373226 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.321 seconds
[0m18:54:50.381205 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m18:54:50.393173 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m18:54:50.393173 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m18:54:50.394170 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:54:54.927041 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 4.533 seconds
[0m18:54:54.932027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAE6A6B520>]}
[0m18:54:54.937015 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m18:54:54.937015 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m18:54:54.938012 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m18:54:54.939009 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m18:54:54.948983 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:54.949980 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m18:54:54.982892 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:54.987878 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m18:54:54.988876 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1. Booking-level facts
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)          as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                           as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* distance from staging (may still be null) */
        s.total_miles                                 as staging_trip_dist,

        /* keep for convenience */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭──────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE  (great-circle padding)
-- ╰──────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        /* fall back to great-circle * 1.02 padding */
        coalesce(
            b.staging_trip_dist,

            1.02 * st_distance(
                     to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
                     to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
                   ) / 1609.344     -- metres → miles
        )                                                   as trip_dist

    from bookings b

    /* airport geo (small seed) */
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og
           on og.iata_code = b.origin
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg
           on dg.iata_code = b.destination
),

-- ╭──────────────────────────────────────────────╮
-- 3 · BENCHMARKS  (join z-score & percentiles)
-- ╰──────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        r.z_usd_per_mi,
        r.p50_usd_per_mi,
        r.p90_usd_per_mi,
        r.p95_usd_per_mi,
        r.p97_usd_per_mi,
        r.premium_pct_usd_per_mi

    from gc_dist g
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats r
           on r.legid = g.legid        -- same grain
),

-- ╭──────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰──────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi
    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
           on c.route = b.route
),

-- ╭──────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰──────────────────────────────────────────────╯
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- R1 · statistical price outlier  (z-score ≥ 2)
        ------------------------------------------------------------------
        case
            when z_usd_per_mi >= 2 then 1 else 0
        end                                                       as r1_price_outlier,

        ------------------------------------------------------------------
        -- R2 · seat-scarcity *and* price ≥ route P97
        ------------------------------------------------------------------
        case
            when seats_flag in ('sold_out','scarce')
             and usd_per_mi    >= p97_usd_per_mi
            then 1 else 0
        end                                                       as r2_seat_scarcity,

        ------------------------------------------------------------------
        -- R3 · monopoly (HHI ≥ .90) *and* price ≥ route P95
        ------------------------------------------------------------------
        case
            when hhi           >= 0.90
             and usd_per_mi    >= p95_usd_per_mi
            then 1 else 0
        end                                                       as r3_monopoly_premium

    from comp
),

-- ╭──────────────────────────────────────────────╮
-- 6 · FINAL SELECT  (add any_rule_flag)
-- ╰──────────────────────────────────────────────╯
final as (

    select
        *,
        case
            when r1_price_outlier   = 1
              or r2_seat_scarcity   = 1
              or r3_monopoly_premium= 1
            then 1 else 0
        end as any_rule_flag
    from flags
)

select * from final
        );
[0m18:54:54.988876 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m18:54:59.072947 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe873-0305-0bba-0006-8fdb00185f8e
[0m18:54:59.073945 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 31 at position 8
invalid identifier 'S.SEGMENT_COUNT'
[0m18:54:59.075939 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m18:54:59.077934 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '34d24a05-5466-49c8-b156-6807dc65249d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAD8ECE1D0>]}
[0m18:54:59.078932 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 4.14s]
[0m18:54:59.080927 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m18:54:59.080927 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m18:54:59.082921 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:54:59.083918 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m18:54:59.083918 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m18:54:59.426003 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m18:54:59.427000 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m18:54:59.770082 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m18:54:59.770082 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m18:55:00.111170 [info ] [MainThread]: 
[0m18:55:00.112167 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 15.17 seconds (15.17s).
[0m18:55:00.113165 [debug] [MainThread]: Command end result
[0m18:55:00.144081 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m18:55:00.148071 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m18:55:00.157047 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m18:55:00.157047 [info ] [MainThread]: 
[0m18:55:00.159042 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m18:55:00.160039 [info ] [MainThread]: 
[0m18:55:00.161036 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m18:55:00.161036 [info ] [MainThread]: 
[0m18:55:00.162034 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:55:00.164028 [debug] [MainThread]: Command `dbt run` failed at 18:55:00.163031 after 17.85 seconds
[0m18:55:00.165026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADBE1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CADBEB0A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CAE75C2FE0>]}
[0m18:55:00.165026 [debug] [MainThread]: Flushing usage events
[0m18:55:00.530049 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:08:11.163518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3311D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3485DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3485E1A0>]}


============================== 19:08:11.167507 | c9e6faa1-7422-4072-a538-2d1a8cb4b03f ==============================
[0m19:08:11.167507 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:08:11.168505 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:08:12.106994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B34835CF0>]}
[0m19:08:12.171820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B346929E0>]}
[0m19:08:12.173815 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:08:12.748277 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:08:13.053461 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:08:13.053461 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:08:13.434442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3DC6CDC0>]}
[0m19:08:13.585039 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:08:13.588030 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:08:13.611966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3DC6EB60>]}
[0m19:08:13.612964 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:08:13.613962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3DC6EE00>]}
[0m19:08:13.615957 [info ] [MainThread]: 
[0m19:08:13.616953 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:08:13.616953 [info ] [MainThread]: 
[0m19:08:13.617951 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:08:13.618948 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:08:13.731646 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:08:13.732644 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:08:13.733641 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:08:18.353280 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.620 seconds
[0m19:08:18.361258 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:08:18.372229 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:08:18.373227 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:08:18.373227 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:08:22.088286 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.715 seconds
[0m19:08:22.093272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3DC6F4F0>]}
[0m19:08:22.098259 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:08:22.099257 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:08:22.099257 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:08:22.100254 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:08:22.110228 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:08:22.112223 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:08:22.144137 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:08:22.148126 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:08:22.149123 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1 · BOOKINGS (clean staging)
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)          as total_base_ratio,

        s.segment_count,
        s.marketing_carrier                           as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* distance from staging (may still be null) */
        s.total_miles                                 as staging_trip_dist,

        /* convenience metric */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE (great-circle + 2 % pad)
-- ╰────────────────────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * st_distance(
                     to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
                     to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
                   ) / 1609.344     -- metres → miles
        )                                                   as trip_dist

    from bookings b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og
           on og.iata_code = b.origin
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg
           on dg.iata_code = b.destination
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3 · BENCHMARKS (route $/mi stats & z-score)
-- ╰────────────────────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        r.z_usd_per_mi,
        r.p50_usd_per_mi,
        r.p90_usd_per_mi,
        r.p95_usd_per_mi,
        r.p97_usd_per_mi,
        r.premium_pct_usd_per_mi

    from gc_dist g
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats r
           on r.legid = g.legid        -- same grain
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰────────────────────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi
    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition c
           on c.route = b.route
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- R1 · statistical price outlier (z ≥ 2)
        ------------------------------------------------------------------
        case
            when z_usd_per_mi >= 2 then 1 else 0
        end                                                       as r1_price_outlier,

        ------------------------------------------------------------------
        -- R2 · seat-scarcity & price ≥ route P97
        ------------------------------------------------------------------
        case
            when seats_flag in ('sold_out','scarce')
             and usd_per_mi    >= p97_usd_per_mi
            then 1 else 0
        end                                                       as r2_seat_scarcity,

        ------------------------------------------------------------------
        -- R3 · monopoly (HHI ≥ 0.90) & price ≥ route P95
        ------------------------------------------------------------------
        case
            when hhi           >= 0.90
             and usd_per_mi    >= p95_usd_per_mi
            then 1 else 0
        end                                                       as r3_monopoly_premium

    from comp
),

-- ╭────────────────────────────────────────────────────────────╮
-- 6 · FINAL SELECT (any-rule flag)
-- ╰────────────────────────────────────────────────────────────╯
final as (

    select
        *,
        case
            when r1_price_outlier   = 1
              or r2_seat_scarcity   = 1
              or r3_monopoly_premium= 1
            then 1 else 0
        end as any_rule_flag
    from flags
)

select * from final
        );
[0m19:08:22.150121 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:08:25.848225 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe881-0305-0f94-0006-8fdb001869ba
[0m19:08:25.848225 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 31 at position 8
invalid identifier 'S.SEGMENT_COUNT'
[0m19:08:25.851217 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:08:25.853212 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c9e6faa1-7422-4072-a538-2d1a8cb4b03f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B310CF4F0>]}
[0m19:08:25.854210 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.75s]
[0m19:08:25.855207 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:08:25.856204 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:08:25.858199 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:08:25.859197 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:08:25.859197 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:08:26.227211 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:08:26.228209 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:08:26.605200 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:08:26.606197 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:08:26.953268 [info ] [MainThread]: 
[0m19:08:26.954267 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.34 seconds (13.34s).
[0m19:08:26.955264 [debug] [MainThread]: Command end result
[0m19:08:26.986181 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:08:26.990170 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:08:26.999146 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:08:26.999146 [info ] [MainThread]: 
[0m19:08:27.000144 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:08:27.001141 [info ] [MainThread]: 
[0m19:08:27.002139 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 31 at position 8
  invalid identifier 'S.SEGMENT_COUNT'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:08:27.004133 [info ] [MainThread]: 
[0m19:08:27.005131 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:08:27.007124 [debug] [MainThread]: Command `dbt run` failed at 19:08:27.006128 after 15.94 seconds
[0m19:08:27.007124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3311D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B331D72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B3E8C2410>]}
[0m19:08:27.008122 [debug] [MainThread]: Flushing usage events
[0m19:08:27.352201 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:13:29.526660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD801D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD975DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD975E1A0>]}


============================== 19:13:29.530649 | c32a2d60-0936-4ffd-8f81-25b663607e61 ==============================
[0m19:13:29.530649 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:13:29.531648 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:13:30.449192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD6497070>]}
[0m19:13:30.512024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD8DFDBD0>]}
[0m19:13:30.513021 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:13:31.080502 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:13:31.384689 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:13:31.384689 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:13:31.758688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DE2B70EE0>]}
[0m19:13:31.905296 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:13:31.908288 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:13:31.932225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DE2B92500>]}
[0m19:13:31.933221 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:13:31.934221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DE2B92EF0>]}
[0m19:13:31.936213 [info ] [MainThread]: 
[0m19:13:31.936213 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:13:31.937211 [info ] [MainThread]: 
[0m19:13:31.938208 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:13:31.940202 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:13:32.048911 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:13:32.049909 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:13:32.049909 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:13:36.559841 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.509 seconds
[0m19:13:36.567820 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:13:36.578792 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:13:36.579788 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:13:36.579788 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:13:40.450431 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.871 seconds
[0m19:13:40.455418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DE2B73F10>]}
[0m19:13:40.460405 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:13:40.460405 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:13:40.461402 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:13:40.462400 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:13:40.473370 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:13:40.475365 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:13:40.505284 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:13:40.510271 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:13:40.511269 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1 · BOOKINGS (clean staging)
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)          as total_base_ratio,

        /* derive number of segments */
        array_size(split(s.segmentsdepartureairportcode, '||')) 
                                                      as segment_count,

        /* first-marketing carrier on the itinerary */
        split(s.segmentsairlinecode, '||')[0]         as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* distance from staging (may still be null) */
        s.total_miles                                 as staging_trip_dist,

        /* convenience metric */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
-- ╰────────────────────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * (
              st_distance(
                to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
                to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
              )
              / 1609.344     -- metres → miles
            )
        )                                                   as trip_dist

    from bookings b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
      on og.iata = b.origin
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
      on dg.iata = b.destination
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3 · BENCHMARKS (route $/mi z-score + pct metrics)
-- ╰────────────────────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        -- per-leg z-score from the intermediate model
        r.usd_per_mi_z                              as z_usd_per_mi,

        -- route/fare_bucket stats from the staging model
        rs.p50_usd_per_mi,
        rs.p90_usd_per_mi,
        rs.p95_usd_per_mi,
        rs.p97_usd_per_mi,
        rs.premium_pct_usd_per_mi

    from gc_dist g

    -- bring in each leg’s z-score
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as r
      on r.legid = g.legid

    -- bring in route-level percentiles & premium_pct
    left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
      on rs.route       = g.route
     and rs.fare_bucket = g.fare_bucket
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰────────────────────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi
    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
      on c.route = b.route
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- R1 · statistical price outlier (z ≥ 2)
        ------------------------------------------------------------------
        case
            when z_usd_per_mi >= 2 then 1 else 0
        end                                                       as r1_price_outlier,

        ------------------------------------------------------------------
        -- R2 · seat-scarcity & price ≥ route P97
        ------------------------------------------------------------------
        case
            when seats_flag in ('sold_out','scarce')
              and usd_per_mi    >= p97_usd_per_mi
            then 1 else 0
        end                                                       as r2_seat_scarcity,

        ------------------------------------------------------------------
        -- R3 · monopoly (HHI ≥ 0.90) & price ≥ route P95
        ------------------------------------------------------------------
        case
            when hhi           >= 0.90
              and usd_per_mi    >= p95_usd_per_mi
            then 1 else 0
        end                                                       as r3_monopoly_premium

    from comp
),

-- ╭────────────────────────────────────────────────────────────╮
-- 6 · FINAL SELECT (any-rule flag)
-- ╰────────────────────────────────────────────────────────────╯
final as (

    select
        *,
        case
            when r1_price_outlier    = 1
              or r2_seat_scarcity    = 1
              or r3_monopoly_premium = 1
            then 1 else 0
        end as any_rule_flag
    from flags
)

select * from final;
[0m19:13:40.512266 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:13:44.139561 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe886-0305-0bba-0006-8fdb0018a066
[0m19:13:44.140558 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 171 at position 19 unexpected ';'.
[0m19:13:44.142552 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 171 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:13:44.145544 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c32a2d60-0936-4ffd-8f81-25b663607e61', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD4FCE1D0>]}
[0m19:13:44.146542 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.68s]
[0m19:13:44.147539 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:13:44.148537 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 171 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:13:44.150532 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:13:44.151529 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:13:44.151529 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:13:44.517548 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:13:44.518546 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:13:44.875591 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:13:44.875591 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:13:45.223660 [info ] [MainThread]: 
[0m19:13:45.223660 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.28 seconds (13.28s).
[0m19:13:45.225654 [debug] [MainThread]: Command end result
[0m19:13:45.257568 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:13:45.261559 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:13:45.269537 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:13:45.269537 [info ] [MainThread]: 
[0m19:13:45.270534 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:13:45.271532 [info ] [MainThread]: 
[0m19:13:45.272529 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 171 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:13:45.273526 [info ] [MainThread]: 
[0m19:13:45.273526 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:13:45.275521 [debug] [MainThread]: Command `dbt run` failed at 19:13:45.275521 after 15.83 seconds
[0m19:13:45.276518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD801D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DE2049630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019DD80B0BE0>]}
[0m19:13:45.276518 [debug] [MainThread]: Flushing usage events
[0m19:13:45.636554 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:13:52.278782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B5871D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B59E5A380>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B59E5A1A0>]}


============================== 19:13:52.282771 | ead8e929-4b78-492c-a24c-45850e6ef4a5 ==============================
[0m19:13:52.282771 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:13:52.283768 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:13:53.202311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B56A970A0>]}
[0m19:13:53.265142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B59C92D70>]}
[0m19:13:53.266140 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:13:53.833621 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:13:54.130826 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:13:54.131823 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:13:54.505823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B63270F10>]}
[0m19:13:54.655422 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:13:54.657417 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:13:54.682350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B63293580>]}
[0m19:13:54.683348 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:13:54.683348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B632938B0>]}
[0m19:13:54.685342 [info ] [MainThread]: 
[0m19:13:54.686340 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:13:54.687337 [info ] [MainThread]: 
[0m19:13:54.688334 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:13:54.689332 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:13:54.800035 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:13:54.800035 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:13:54.801033 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:13:58.674668 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.874 seconds
[0m19:13:58.682646 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:13:58.693617 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:13:58.694615 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:13:58.694615 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:14:02.416655 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.722 seconds
[0m19:14:02.421642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B63271EA0>]}
[0m19:14:02.425631 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:14:02.426629 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:14:02.427626 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:14:02.428624 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:14:02.438597 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:14:02.439594 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:14:02.472506 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:14:02.476495 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:14:02.477493 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1 · BOOKINGS (clean staging)
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare,0)          as total_base_ratio,

        /* derive number of segments */
        array_size(split(s.segmentsdepartureairportcode, '||')) 
                                                      as segment_count,

        /* first-marketing carrier on the itinerary */
        split(s.segmentsairlinecode, '||')[0]         as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* distance from staging (may still be null) */
        s.total_miles                                 as staging_trip_dist,

        /* convenience metric */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
-- ╰────────────────────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * (
              st_distance(
                to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
                to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
              )
              / 1609.344     -- metres → miles
            )
        )                                                   as trip_dist

    from bookings b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
      on og.iata = b.origin
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
      on dg.iata = b.destination
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3 · BENCHMARKS (route $/mi z-score + pct metrics)
-- ╰────────────────────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        -- per-leg z-score from the intermediate model
        r.usd_per_mi_z                              as z_usd_per_mi,

        -- route/fare_bucket stats from the staging model
        rs.p50_usd_per_mi,
        rs.p90_usd_per_mi,
        rs.p95_usd_per_mi,
        rs.p97_usd_per_mi,
        rs.premium_pct_usd_per_mi

    from gc_dist g

    -- bring in each leg’s z-score
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as r
      on r.legid = g.legid

    -- bring in route-level percentiles & premium_pct
    left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
      on rs.route       = g.route
     and rs.fare_bucket = g.fare_bucket
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰────────────────────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi
    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
      on c.route = b.route
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        ------------------------------------------------------------------
        -- R1 · statistical price outlier (z ≥ 2)
        ------------------------------------------------------------------
        case
            when z_usd_per_mi >= 2 then 1 else 0
        end                                                       as r1_price_outlier,

        ------------------------------------------------------------------
        -- R2 · seat-scarcity & price ≥ route P97
        ------------------------------------------------------------------
        case
            when seats_flag in ('sold_out','scarce')
              and usd_per_mi    >= p97_usd_per_mi
            then 1 else 0
        end                                                       as r2_seat_scarcity,

        ------------------------------------------------------------------
        -- R3 · monopoly (HHI ≥ 0.90) & price ≥ route P95
        ------------------------------------------------------------------
        case
            when hhi           >= 0.90
              and usd_per_mi    >= p95_usd_per_mi
            then 1 else 0
        end                                                       as r3_monopoly_premium

    from comp
),

-- ╭────────────────────────────────────────────────────────────╮
-- 6 · FINAL SELECT (any-rule flag)
-- ╰────────────────────────────────────────────────────────────╯
final as (

    select
        *,
        case
            when r1_price_outlier    = 1
              or r2_seat_scarcity    = 1
              or r3_monopoly_premium = 1
            then 1 else 0
        end as any_rule_flag
    from flags
)

select * from final
        );
[0m19:14:02.478490 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:14:06.134707 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe886-0305-0bba-0006-8fdb0018a06e
[0m19:14:06.135705 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 62 at position 41
invalid identifier 'OG.LON'
[0m19:14:06.137699 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:14:06.139694 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ead8e929-4b78-492c-a24c-45850e6ef4a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B566CE200>]}
[0m19:14:06.140691 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.71s]
[0m19:14:06.141688 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:14:06.142686 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:14:06.144681 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:14:06.145677 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:14:06.145677 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:14:06.486765 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:14:06.487762 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:14:06.827852 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:14:06.827852 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:14:07.166945 [info ] [MainThread]: 
[0m19:14:07.167942 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.48 seconds (12.48s).
[0m19:14:07.168940 [debug] [MainThread]: Command end result
[0m19:14:07.200854 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:14:07.202849 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:14:07.212822 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:14:07.212822 [info ] [MainThread]: 
[0m19:14:07.214818 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:14:07.215814 [info ] [MainThread]: 
[0m19:14:07.215814 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:14:07.216812 [info ] [MainThread]: 
[0m19:14:07.217809 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:14:07.218806 [debug] [MainThread]: Command `dbt run` failed at 19:14:07.218806 after 15.02 seconds
[0m19:14:07.220801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B5871D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B62FAA3B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022B587D43D0>]}
[0m19:14:07.220801 [debug] [MainThread]: Flushing usage events
[0m19:14:07.560890 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:14:52.892594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906AB1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906C25DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906C25E1A0>]}


============================== 19:14:52.896584 | b877be7c-456f-4c51-8e21-0ea5da19d6a3 ==============================
[0m19:14:52.896584 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:14:52.897582 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:14:53.854022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906C235CF0>]}
[0m19:14:53.915857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906C0929E0>]}
[0m19:14:53.917851 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:14:54.495306 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:14:54.794506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:14:54.795503 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:14:55.168505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029075670EB0>]}
[0m19:14:55.362985 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:14:55.365977 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:14:55.389912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029075692710>]}
[0m19:14:55.390910 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:14:55.390910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029075692E00>]}
[0m19:14:55.392905 [info ] [MainThread]: 
[0m19:14:55.393903 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:14:55.394900 [info ] [MainThread]: 
[0m19:14:55.395897 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:14:55.397892 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:14:55.506600 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:14:55.507598 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:14:55.508596 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:00.507220 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.999 seconds
[0m19:15:00.515198 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:15:00.526169 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:15:00.527167 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:15:00.527167 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:04.178397 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.651 seconds
[0m19:15:04.183384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029075673D90>]}
[0m19:15:04.188370 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:15:04.188370 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:15:04.189368 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:15:04.190365 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:15:04.200338 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:04.202333 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:15:04.235244 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:04.240231 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:04.241229 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1 · BOOKINGS (clean staging)
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare, 0)         as total_base_ratio,

        /* derive number of segments from the pipe-delimited list */
        array_size(split(s.segmentsdepartureairportcode, '||'))
                                                      as segment_count,

        /* first airline in the itinerary string */
        split(s.segmentsairlinecode, '||')[0]          as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* raw staging miles (may be null) */
        s.total_miles                                 as staging_trip_dist,

        /* convenience metric */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
-- ╰────────────────────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * (
              st_distance(
                to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
                to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
              )
              / 1609.344     -- metres → miles
            )
        )                                                   as trip_dist

    from bookings b

    -- join on the IATA code column in your geo seed
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
      on og.iata = b.origin

    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
      on dg.iata = b.destination
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3 · BENCHMARKS (route $/mi z-score + pct metrics)
-- ╰────────────────────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        -- bring in the per-leg z-score
        r.usd_per_mi_z                             as z_usd_per_mi,

        -- and the route/fare_bucket stats
        rs.p50_usd_per_mi,
        rs.p90_usd_per_mi,
        rs.p95_usd_per_mi,
        rs.p97_usd_per_mi,
        rs.premium_pct_usd_per_mi

    from gc_dist g

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as r
      on r.legid = g.legid

    left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
      on rs.route       = g.route
     and rs.fare_bucket = g.fare_bucket
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰────────────────────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi

    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
      on c.route = b.route
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        -- R1 · statistical price outlier (z ≥ 2)
        case when z_usd_per_mi >= 2 then 1 else 0 end as r1_price_outlier,

        -- R2 · seat-scarcity & price ≥ route P97
        case 
          when seats_flag in ('sold_out','scarce')
           and usd_per_mi    >= p97_usd_per_mi
          then 1 else 0
        end                                               as r2_seat_scarcity,

        -- R3 · monopoly (HHI ≥ 0.90) & price ≥ route P95
        case
          when hhi           >= 0.90
           and usd_per_mi    >= p95_usd_per_mi
          then 1 else 0
        end                                               as r3_monopoly_premium

    from comp
),

-- ╭────────────────────────────────────────────────────────────╮
-- 6 · FINAL SELECT (any-rule flag)
-- ╰────────────────────────────────────────────────────────────╯
final as (

    select
        *,
        case
          when r1_price_outlier    = 1
            or r2_seat_scarcity    = 1
            or r3_monopoly_premium = 1
          then 1 else 0
        end                                               as any_rule_flag
    from flags
)

select * from final;
[0m19:15:04.242226 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:15:07.816662 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe887-0305-0f94-0006-8fdb001869f6
[0m19:15:07.817659 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 165 at position 19 unexpected ';'.
[0m19:15:07.820651 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 165 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:15:07.822646 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b877be7c-456f-4c51-8e21-0ea5da19d6a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029067ACF4F0>]}
[0m19:15:07.823643 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.63s]
[0m19:15:07.824641 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:15:07.825638 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 165 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:15:07.827633 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:15:07.827633 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:15:07.828630 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:15:08.173707 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:15:08.174704 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:15:08.506815 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:15:08.506815 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:15:08.849897 [info ] [MainThread]: 
[0m19:15:08.850894 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.45 seconds (13.45s).
[0m19:15:08.851892 [debug] [MainThread]: Command end result
[0m19:15:08.883806 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:15:08.886798 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:15:08.894777 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:15:08.895775 [info ] [MainThread]: 
[0m19:15:08.896772 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:15:08.897770 [info ] [MainThread]: 
[0m19:15:08.897770 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 165 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:15:08.898767 [info ] [MainThread]: 
[0m19:15:08.899764 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:15:08.901759 [debug] [MainThread]: Command `dbt run` failed at 19:15:08.900761 after 16.09 seconds
[0m19:15:08.901759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906AB1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002906ABD72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000290761C2D10>]}
[0m19:15:08.902756 [debug] [MainThread]: Flushing usage events
[0m19:15:09.246835 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:15:19.857444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDC41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDDB5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDDB5E1A0>]}


============================== 19:15:19.861433 | 166841d1-1d82-43ae-a5f5-0c88dc4a2ae5 ==============================
[0m19:15:19.861433 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:15:19.862432 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:15:20.778978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDA597070>]}
[0m19:15:20.840812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDD1FE560>]}
[0m19:15:20.841810 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:15:21.406300 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:15:21.704502 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:15:21.705499 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:15:22.078501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EE6D70EE0>]}
[0m19:15:22.226106 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:15:22.228101 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:15:22.253034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EE6D924A0>]}
[0m19:15:22.254032 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:15:22.255029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EE6D938B0>]}
[0m19:15:22.256026 [info ] [MainThread]: 
[0m19:15:22.257023 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:15:22.258021 [info ] [MainThread]: 
[0m19:15:22.258021 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:15:22.260015 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:15:22.370719 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:15:22.370719 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:15:22.371716 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:26.404925 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.033 seconds
[0m19:15:26.412903 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:15:26.423873 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:15:26.423873 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:15:26.424871 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:15:29.982352 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.557 seconds
[0m19:15:29.987339 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EE6D73E50>]}
[0m19:15:29.991328 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:15:29.992325 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:15:29.993323 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:15:29.994320 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:15:30.006289 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:30.007285 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:15:30.037205 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:30.042192 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:15:30.043190 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- ╭────────────────────────────────────────────────────────────╮
-- 1 · BOOKINGS (clean staging)
-- ╰────────────────────────────────────────────────────────────╯
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,

        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                            as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare, 0)         as total_base_ratio,

        /* derive number of segments from the pipe-delimited list */
        array_size(split(s.segmentsdepartureairportcode, '||'))
                                                      as segment_count,

        /* first airline in the itinerary string */
        split(s.segmentsairlinecode, '||')[0]          as carrier_code,

        s.seats_flag,
        s.fare_bucket,

        /* raw staging miles (may be null) */
        s.total_miles                                 as staging_trip_dist,

        /* convenience metric */
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- ╭────────────────────────────────────────────────────────────╮
-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
-- ╰────────────────────────────────────────────────────────────╯
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * (
              st_distance(
                to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
                to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
              )
              / 1609.344     -- metres → miles
            )
        )                                                   as trip_dist

    from bookings b

    -- join on the IATA code column in your geo seed
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
      on og.iata = b.origin

    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
      on dg.iata = b.destination
),

-- ╭────────────────────────────────────────────────────────────╮
-- 3 · BENCHMARKS (route $/mi z-score + pct metrics)
-- ╰────────────────────────────────────────────────────────────╯
benchmarks as (

    select
        g.*,

        -- bring in the per-leg z-score
        r.usd_per_mi_z                             as z_usd_per_mi,

        -- and the route/fare_bucket stats
        rs.p50_usd_per_mi,
        rs.p90_usd_per_mi,
        rs.p95_usd_per_mi,
        rs.p97_usd_per_mi,
        rs.premium_pct_usd_per_mi

    from gc_dist g

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats as r
      on r.legid = g.legid

    left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
      on rs.route       = g.route
     and rs.fare_bucket = g.fare_bucket
),

-- ╭────────────────────────────────────────────────────────────╮
-- 4 · COMPETITION METRICS
-- ╰────────────────────────────────────────────────────────────╯
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi

    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
      on c.route = b.route
),

-- ╭────────────────────────────────────────────────────────────╮
-- 5 · RULE FLAGS
-- ╰────────────────────────────────────────────────────────────╯
flags as (

    select
        *,
        -- R1 · statistical price outlier (z ≥ 2)
        case when z_usd_per_mi >= 2 then 1 else 0 end as r1_price_outlier,

        -- R2 · seat-scarcity & price ≥ route P97
        case 
          when seats_flag in ('sold_out','scarce')
           and usd_per_mi    >= p97_usd_per_mi
          then 1 else 0
        end                                               as r2_seat_scarcity,

        -- R3 · monopoly (HHI ≥ 0.90) & price ≥ route P95
        case
          when hhi           >= 0.90
           and usd_per_mi    >= p95_usd_per_mi
          then 1 else 0
        end                                               as r3_monopoly_premium

    from comp
),

-- ╭────────────────────────────────────────────────────────────╮
-- 6 · FINAL SELECT (any-rule flag)
-- ╰────────────────────────────────────────────────────────────╯
final as (

    select
        *,
        case
          when r1_price_outlier    = 1
            or r2_seat_scarcity    = 1
            or r3_monopoly_premium = 1
          then 1 else 0
        end                                               as any_rule_flag
    from flags
)

select * from final
        );
[0m19:15:30.043190 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:15:34.008579 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe888-0305-0bb1-0006-8fdb00188346
[0m19:15:34.009576 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 62 at position 41
invalid identifier 'OG.LON'
[0m19:15:34.011571 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:15:34.014563 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '166841d1-1d82-43ae-a5f5-0c88dc4a2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDA3CE1D0>]}
[0m19:15:34.015560 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 4.02s]
[0m19:15:34.016558 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:15:34.016558 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:15:34.018552 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:15:34.019550 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:15:34.020547 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:15:34.348669 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:15:34.349666 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:15:34.711698 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:15:34.712695 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:15:35.050790 [info ] [MainThread]: 
[0m19:15:35.051788 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.79 seconds (12.79s).
[0m19:15:35.052785 [debug] [MainThread]: Command end result
[0m19:15:35.085698 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:15:35.088689 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:15:35.095670 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:15:35.097666 [info ] [MainThread]: 
[0m19:15:35.097666 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:15:35.098663 [info ] [MainThread]: 
[0m19:15:35.099660 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 62 at position 41
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:15:35.100658 [info ] [MainThread]: 
[0m19:15:35.101655 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:15:35.103650 [debug] [MainThread]: Command `dbt run` failed at 19:15:35.103650 after 15.33 seconds
[0m19:15:35.103650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDC41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EDD1FE560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016EE7AC2D40>]}
[0m19:15:35.104646 [debug] [MainThread]: Flushing usage events
[0m19:15:35.442742 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:16:50.150842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001430651D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014307C59CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014307C59ED0>]}


============================== 19:16:50.154831 | 73bb5c4c-29fe-4613-a87e-8e107dc49483 ==============================
[0m19:16:50.154831 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:16:50.155829 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m19:16:51.096312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014304797010>]}
[0m19:16:51.158147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001431035C460>]}
[0m19:16:51.159144 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:16:51.753553 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:16:52.132540 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:16:52.133537 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:16:52.555408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014310F70EB0>]}
[0m19:16:52.704010 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:16:52.707003 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:16:52.730939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014310F91DE0>]}
[0m19:16:52.731936 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:16:52.732933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014310F92D70>]}
[0m19:16:52.734928 [info ] [MainThread]: 
[0m19:16:52.734928 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:16:52.735925 [info ] [MainThread]: 
[0m19:16:52.736923 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:16:52.737920 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:16:52.905471 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:16:52.905471 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:16:52.906470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:16:57.089276 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.182 seconds
[0m19:16:57.097255 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:16:57.107228 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:16:57.108226 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:16:57.108226 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:17:00.842235 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.734 seconds
[0m19:17:00.847221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014310F73CA0>]}
[0m19:17:00.852208 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:17:00.852208 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:17:00.853205 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:17:00.854203 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:17:00.864176 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:17:00.866171 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:17:00.900080 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:17:00.905066 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:17:00.906064 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)  
with bookings as (

    select
        s.legid,
        s.origin,
        s.destination,
        s.origin || '-' || s.destination              as route,
        s.search_date,
        s.flight_date,
        s.days_to_flight,

        case
            when s.days_to_flight between  0 and  3  then '00-03'
            when s.days_to_flight between  4 and  7  then '04-07'
            when s.days_to_flight between  8 and 29  then '08-29'
            else                                          '30+'
        end                                             as dtf_bucket,

        s.total_fare,
        s.base_fare,
        s.total_fare / nullif(s.base_fare, 0)          as total_base_ratio,

        array_size(split(s.segmentsdepartureairportcode, '||'))
                                                      as segment_count,
        split(s.segmentsairlinecode, '||')[0]          as carrier_code,
        s.seats_flag,
        s.fare_bucket,
        s.total_miles                                 as staging_trip_dist,
        s.usd_per_mi

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)  
gc_dist as (

    select
        b.*,

        coalesce(
            b.staging_trip_dist,
            1.02 * (
              st_distance(
                to_geography(
                  'POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'
                ),
                to_geography(
                  'POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')'
                )
              ) / 1609.344
            )
        )                                           as trip_dist

    from bookings b

    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
      on og.iata_code = b.origin

    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
      on dg.iata_code = b.destination
),

-- 3 · BENCHMARKS  
benchmarks as (

    select
        g.*,
        r.usd_per_mi_z,
        rs.p50_usd_per_mi,
        rs.p90_usd_per_mi,
        rs.p95_usd_per_mi,
        rs.p97_usd_per_mi,
        rs.premium_pct_usd_per_mi

    from gc_dist g

    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats  as r
      on r.legid = g.legid

    left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats             as rs
      on rs.route       = g.route
     and rs.fare_bucket = g.fare_bucket
),

-- 4 · COMPETITION METRICS  
comp as (

    select
        b.*,
        c.carrier_count,
        c.hhi

    from benchmarks b
    left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
      on c.route = b.route
),

-- 5 · RULE FLAGS  
flags as (

    select
        *,
        case when z_usd_per_mi >= 2 then 1 else 0 end  as r1_price_outlier,
        case
          when seats_flag   in ('sold_out','scarce')
            and usd_per_mi >= p97_usd_per_mi
          then 1 else 0
        end                                             as r2_seat_scarcity,
        case
          when hhi           >= 0.90
           and usd_per_mi    >= p95_usd_per_mi
          then 1 else 0
        end                                             as r3_monopoly_premium

    from comp
),

-- 6 · FINAL SELECT (any-rule flag)  
final as (

    select
        *,
        case
          when r1_price_outlier    = 1
            or r2_seat_scarcity    = 1
            or r3_monopoly_premium = 1
          then 1 else 0
        end                                             as any_rule_flag
    from flags
)

select * from final
        );
[0m19:17:00.906064 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:17:05.195586 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe889-0305-0bb1-0006-8fdb0018834e
[0m19:17:05.196583 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 73 at position 8
invalid identifier 'R.USD_PER_MI_Z'
[0m19:17:05.199576 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 73 at position 8
  invalid identifier 'R.USD_PER_MI_Z'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:17:05.201570 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73bb5c4c-29fe-4613-a87e-8e107dc49483', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000143045CE560>]}
[0m19:17:05.202568 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 4.35s]
[0m19:17:05.203565 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:17:05.204562 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 73 at position 8
  invalid identifier 'R.USD_PER_MI_Z'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m19:17:05.206557 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:17:05.206557 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:17:05.207554 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:17:05.537671 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:17:05.538668 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:17:05.867787 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:17:05.867787 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:17:06.211867 [info ] [MainThread]: 
[0m19:17:06.211867 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.47 seconds (13.47s).
[0m19:17:06.212864 [debug] [MainThread]: Command end result
[0m19:17:06.245777 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:17:06.248768 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:17:06.257744 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:17:06.258742 [info ] [MainThread]: 
[0m19:17:06.259739 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:17:06.260736 [info ] [MainThread]: 
[0m19:17:06.260736 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 73 at position 8
  invalid identifier 'R.USD_PER_MI_Z'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m19:17:06.261734 [info ] [MainThread]: 
[0m19:17:06.262731 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:17:06.264726 [debug] [MainThread]: Command `dbt run` failed at 19:17:06.264726 after 16.20 seconds
[0m19:17:06.265723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001430651D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001431035C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014311CC2740>]}
[0m19:17:06.266720 [debug] [MainThread]: Flushing usage events
[0m19:17:06.618778 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:18:02.822392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AD81D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AEF5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AEF5E1A0>]}


============================== 19:18:02.826381 | 03d9ab24-be29-4056-9594-143aae4e1f71 ==============================
[0m19:18:02.826381 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:18:02.827379 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:18:03.745920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156ABC97070>]}
[0m19:18:03.808753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AE802560>]}
[0m19:18:03.809750 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:18:04.379226 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:18:04.680420 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:18:04.681418 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:18:05.057412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B848CE20>]}
[0m19:18:05.206013 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:18:05.209006 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:18:05.232943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B848EB00>]}
[0m19:18:05.233940 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:18:05.234937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B80F0BB0>]}
[0m19:18:05.235934 [info ] [MainThread]: 
[0m19:18:05.236931 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:18:05.237929 [info ] [MainThread]: 
[0m19:18:05.238926 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:18:05.239923 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:18:05.351624 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:18:05.352622 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:18:05.353619 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:18:09.103585 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.750 seconds
[0m19:18:09.111563 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:18:09.121537 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:18:09.122534 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:18:09.123531 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:18:12.879481 [debug] [ThreadPool]: SQL status: SUCCESS 13 in 3.756 seconds
[0m19:18:12.883471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B848F430>]}
[0m19:18:12.888457 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:18:12.889455 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:18:12.890453 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:18:12.890453 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:18:12.900425 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:18:12.901423 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:18:12.934335 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:18:12.938324 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:18:12.939321 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,

    s.search_date,
    s.flight_date,
    s.days_to_flight,

    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,

    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,

    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,

    split(s.segmentsairlinecode, '||')[0]      as carrier_code,

    s.seats_flag,
    s.fare_bucket,

    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,

    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist

  from bookings b

  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin

  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    g.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi

  from gc_dist g

  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = g.route
   and rs.fare_bucket = g.fare_bucket
),

-- 4 · COMPETITION METRICS
comp as (
  select
    b.*,
    c.carrier_count,
    c.hhi

  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 5 · RULE FLAGS
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 */
    case
      when (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 6 · FINAL SELECT (any-rule flag)
final as (
  select
    *,
    case
      when r1_price_outlier = 1
        or r2_seat_scarcity = 1
        or r3_monopoly_premium = 1
      then 1 else 0
    end as any_rule_flag
  from flags
)

select * from final
        );
[0m19:18:12.940319 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:18:17.079244 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.139 seconds
[0m19:18:17.101185 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03d9ab24-be29-4056-9594-143aae4e1f71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B785FE50>]}
[0m19:18:17.102183 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 4.21s]
[0m19:18:17.103180 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:18:17.104177 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:18:17.105175 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:18:17.105175 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:18:17.453243 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:18:17.454240 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:18:17.793333 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:18:17.793333 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:18:18.126442 [info ] [MainThread]: 
[0m19:18:18.127440 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.89 seconds (12.89s).
[0m19:18:18.128437 [debug] [MainThread]: Command end result
[0m19:18:18.161349 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:18:18.163343 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:18:18.172320 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:18:18.173318 [info ] [MainThread]: 
[0m19:18:18.174314 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:18:18.175311 [info ] [MainThread]: 
[0m19:18:18.175311 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:18:18.177306 [debug] [MainThread]: Command `dbt run` succeeded at 19:18:18.177306 after 15.44 seconds
[0m19:18:18.177306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AD81D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156B79C2B30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000156AC3A0C40>]}
[0m19:18:18.178303 [debug] [MainThread]: Flushing usage events
[0m19:18:18.542329 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:24:04.732520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080CC1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080E359CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080E359EA0>]}


============================== 19:24:04.736510 | 11126d11-29fb-4555-9856-85898419138b ==============================
[0m19:24:04.736510 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:24:04.737507 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features --full-refresh', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:24:05.811633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080B097070>]}
[0m19:24:05.894411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080DBFE560>]}
[0m19:24:05.896406 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:24:06.616480 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:24:06.946596 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:24:06.947593 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m19:24:07.320595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020817570E20>]}
[0m19:24:07.489144 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:24:07.491138 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:24:07.518067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020817572B60>]}
[0m19:24:07.518067 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:24:07.519064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020817572DD0>]}
[0m19:24:07.521059 [info ] [MainThread]: 
[0m19:24:07.522057 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:24:07.523054 [info ] [MainThread]: 
[0m19:24:07.524052 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:24:07.526047 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:24:07.651709 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:24:07.651709 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:24:07.652706 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:24:12.032986 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.380 seconds
[0m19:24:12.040964 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:24:12.051935 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:24:12.051935 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:24:12.052932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:24:15.920585 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.867 seconds
[0m19:24:15.925571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020817573490>]}
[0m19:24:15.929560 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m19:24:15.930557 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m19:24:15.931555 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m19:24:15.932552 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m19:24:15.942525 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:24:15.945518 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m19:24:15.976435 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m19:24:15.980423 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m19:24:15.981421 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (guarding against NULL percentiles)
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 (only when both p50 and p95 are present) */
    case
      when p50_usd_per_mi  is not null
       and p95_usd_per_mi  is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price (only when p97 present) */
    case
      when seats_flag in ('sold_out','scarce')
       and p97_usd_per_mi  is not null
       and usd_per_mi     >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.90 AND price ≥ p95, only when p95 present) */
    case
      when hhi            >= 0.90
       and p95_usd_per_mi  is not null
       and usd_per_mi     >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    *,
    case
      when r1_price_outlier    = 1
        or r2_seat_scarcity    = 1
        or r3_monopoly_premium = 1
      then 1 else 0
    end as any_rule_flag
  from flags
)

select * from final
        );
[0m19:24:15.982418 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:24:19.954789 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 3.973 seconds
[0m19:24:19.979723 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '11126d11-29fb-4555-9856-85898419138b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208175714B0>]}
[0m19:24:19.980720 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 4.05s]
[0m19:24:19.981717 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m19:24:19.982714 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:24:19.982714 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:24:19.983712 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:24:20.320810 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:24:20.320810 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:24:20.671870 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m19:24:20.672868 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m19:24:21.012958 [info ] [MainThread]: 
[0m19:24:21.013955 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.49 seconds (13.49s).
[0m19:24:21.015950 [debug] [MainThread]: Command end result
[0m19:24:21.045870 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:24:21.048862 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:24:21.057838 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:24:21.058835 [info ] [MainThread]: 
[0m19:24:21.059833 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:24:21.059833 [info ] [MainThread]: 
[0m19:24:21.060830 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:24:21.062825 [debug] [MainThread]: Command `dbt run` succeeded at 19:24:21.062825 after 16.46 seconds
[0m19:24:21.062825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080CC1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020816CC2980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002080B7A0C40>]}
[0m19:24:21.063822 [debug] [MainThread]: Flushing usage events
[0m19:24:21.408898 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:37:46.443344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6121D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D62959C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D62959E40>]}


============================== 19:37:46.447333 | da76d97d-7b1b-45fa-b827-3cdf96c02fd0 ==============================
[0m19:37:46.447333 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:37:46.448332 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:37:47.428707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D629331F0>]}
[0m19:37:47.491539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6AF5F400>]}
[0m19:37:47.492536 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:37:48.056029 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:37:48.361212 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:37:48.362209 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m19:37:48.932684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6BEE8130>]}
[0m19:37:49.084278 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:37:49.086272 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:37:49.112203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6B9D28F0>]}
[0m19:37:49.112203 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:37:49.113200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6B9D2BC0>]}
[0m19:37:49.115195 [info ] [MainThread]: 
[0m19:37:49.116192 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:37:49.117190 [info ] [MainThread]: 
[0m19:37:49.117190 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:37:49.118187 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:37:49.231883 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:37:49.232880 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:37:49.232880 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:37:54.963546 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.730 seconds
[0m19:37:54.971525 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:37:54.982495 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:37:54.983493 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:37:54.983493 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:37:59.033655 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 4.050 seconds
[0m19:37:59.038642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6B9D2650>]}
[0m19:37:59.043629 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m19:37:59.044626 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m19:37:59.045624 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m19:37:59.046621 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m19:37:59.056594 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:37:59.057592 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m19:37:59.090503 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:37:59.095490 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m19:37:59.096487 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1. pull raw -------------------------------------------------------
with raw as (

    select
        legid,
        try_to_date(searchdate)            as search_date,
        try_to_date(flightdate)            as flight_date,

        cast(totalfare       as numeric)   as total_fare,
        cast(basefare        as numeric)   as base_fare,
        cast(seatsremaining  as numeric)   as seats_remaining,

        isnonstop                          as is_nonstop,
        isbasiceconomy                     as is_basic_econ,
        isrefundable                       as is_refundable,
        farebasiscode,

        cast(totaltraveldistance as numeric) as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where
          searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null
),

-- 2. normalize / derive -------------------------------------------
split_cols as (

    select
        r.*,

        /* derive origin / destination from first / last segment */
        split(trim(segmentsdepartureairportcode),   '||')[0] 
                                              as origin,
        split(trim(segmentsarrivalairportcode),     '||')[
              array_size(split(segmentsarrivalairportcode,'||')) - 1
        ]                                     as destination,

        datediff('day', search_date, flight_date) 
                                              as days_to_flight

    from raw r
),

-- 3. add airport geos ---------------------------------------------

add_geo as (

  select
    s.*,
    o.lat_deg  as orig_lat,   -- was o.lat
    o.lon_deg  as orig_lon,   -- was o.lon
    d.lat_deg  as dest_lat,   -- was d.lat
    d.lon_deg  as dest_lon    -- was d.lon
  from split_cols s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo o
    on s.origin      = o.iata_code
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo d
    on s.destination = d.iata_code
),


-- 4. compute total miles ------------------------------------------
with_miles as (

    select
        g.*,

        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              st_distance(
                to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
              ) / 1609.344
          end
        ) as total_miles

    from add_geo g
),

-- 5. derive business fields ---------------------------------------
derived as (

    select
      w.*,

      /* $ per mile */
      w.total_fare / nullif(w.total_miles,0)     as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0      then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else '9plus'
      end                                       as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from with_miles w
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(w.farebasiscode,1)) = fb.first_letter
),

-- 6. incremental filter -------------------------------------------
filtered as (

    select * from derived

    

)

-- 7. final select -------------------------------------------------
select
  legid,
  search_date,
  flight_date,
  days_to_flight,
  origin,
  destination,
  origin || '-' || destination    as route,
  total_fare,
  base_fare,
  total_miles,
  usd_per_mi,
  is_nonstop,
  is_basic_econ,
  is_refundable,
  farebasiscode,
  fare_bucket,
  seats_remaining,
  seats_flag,
  travelduration,
  segmentsdepartureairportcode,
  segmentsarrivalairportcode,
  segmentsairlinecode,
  segmentsdistance,
  segmentsdurationinseconds,
  segmentsequipmentdescription,
  segmentscabincode
from filtered
        );
[0m19:37:59.097485 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:38:03.969449 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.872 seconds
[0m19:38:03.993385 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'da76d97d-7b1b-45fa-b827-3cdf96c02fd0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D61FCACE0>]}
[0m19:38:03.994382 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 4.95s]
[0m19:38:03.995379 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m19:38:03.997374 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:38:03.997374 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:38:03.998371 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:38:04.342450 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:38:04.342450 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:38:04.963788 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m19:38:04.964785 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m19:38:05.302880 [info ] [MainThread]: 
[0m19:38:05.303878 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 16.19 seconds (16.19s).
[0m19:38:05.304876 [debug] [MainThread]: Command end result
[0m19:38:05.336790 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:38:05.339782 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:38:05.347761 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:38:05.347761 [info ] [MainThread]: 
[0m19:38:05.348759 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:38:05.349756 [info ] [MainThread]: 
[0m19:38:05.350753 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:38:05.351750 [debug] [MainThread]: Command `dbt run` succeeded at 19:38:05.351750 after 19.00 seconds
[0m19:38:05.352747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6121D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6BA482B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D6B2753C0>]}
[0m19:38:05.352747 [debug] [MainThread]: Flushing usage events
[0m19:38:05.697824 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:43:31.106723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DC0E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DC255A2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DC255A0E0>]}


============================== 19:43:31.110712 | aede30d7-4cd2-4dca-9d4f-251b9bb5082b ==============================
[0m19:43:31.110712 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:43:31.111710 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:43:32.056182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DC252E0B0>]}
[0m19:43:32.119014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCAE5F820>]}
[0m19:43:32.120011 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:43:32.699463 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:43:33.054511 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:43:33.055508 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m19:43:33.760623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCBBDC130>]}
[0m19:43:33.923187 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:43:33.925182 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:43:33.951112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCB6D2A10>]}
[0m19:43:33.952110 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:43:33.953107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCB6D2170>]}
[0m19:43:33.955101 [info ] [MainThread]: 
[0m19:43:33.955101 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:43:33.956099 [info ] [MainThread]: 
[0m19:43:33.957096 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:43:33.958093 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:43:34.083758 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:43:34.084755 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:43:34.084755 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:43:40.954373 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.870 seconds
[0m19:43:40.962352 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:43:40.973322 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:43:40.974320 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:43:40.975317 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:43:45.884182 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 4.909 seconds
[0m19:43:45.889168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCB6D1780>]}
[0m19:43:45.894156 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m19:43:45.895153 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m19:43:45.896150 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m19:43:45.896150 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m19:43:45.907122 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:43:45.908119 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m19:43:45.946016 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:43:45.952000 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m19:43:45.952998 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- ╭──────────────────────────────────────────────────────────────╮
-- 1 · RAW PULL  (keep only sensible rows)
-- ╰──────────────────────────────────────────────────────────────╯
with raw as (

    select
        legid,

        try_to_date(searchdate)                                  as search_date,
        try_to_date(flightdate)                                  as flight_date,

        try_to_number(totalfare)                                 as total_fare,
        try_to_number(basefare)                                  as base_fare,
        try_to_number(seatsremaining)                            as seats_remaining,

        isnonstop                                                as is_nonstop,
        isbasiceconomy                                           as is_basic_econ,
        isrefundable                                             as is_refundable,
        trim(farebasiscode)                                      as farebasiscode,

        try_to_number(totaltraveldistance)                       as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA

    where searchdate is not null
      and flightdate is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare is not null               -- must have a price
),

-- ╭──────────────────────────────────────────────────────────────╮
-- 2 · BASIC DERIVATIONS (origin / destination, days-out …)
-- ╰──────────────────────────────────────────────────────────────╯
prep as (

    select
        r.*,

        split(trim(segmentsdepartureairportcode), '||')          as dep_arr,
        split(trim(segmentsarrivalairportcode),   '||')          as arr_arr,

        /* ← first / last elements become origin / destination */
        trim(replace(
              split(trim(segmentsdepartureairportcode),'||')[0] , '"','')
        )                                                        as origin,

        trim(replace(
              split(trim(segmentsarrivalairportcode),'||')[
                  array_size(split(trim(segmentsarrivalairportcode),'||'))-1
              ], '"','')
        )                                                        as destination,

        split(trim(segmentsairlinecode),'||')[0]                 as carrier_code,

        datediff('day',
                 try_to_date(searchdate),
                 try_to_date(flightdate))                        as days_to_flight

    from raw r
),

-- ╭──────────────────────────────────────────────────────────────╮
-- 3 · AIRPORT GEO LOOK-UP  (for gc-distance fallback)
-- ╰──────────────────────────────────────────────────────────────╯
add_geo as (

    select
        p.*,
        og.lat_deg  as orig_lat,
        og.lon_deg  as orig_lon,
        dg.lat_deg  as dest_lat,
        dg.lon_deg  as dest_lon
    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- ╭──────────────────────────────────────────────────────────────╮
-- 4 · TOTAL MILES  (raw distance → geo fallback)
-- ╰──────────────────────────────────────────────────────────────╯
add_miles as (

    select
        g.*,

        coalesce(
            g.raw_total_miles,
            case
              when g.orig_lat is not null and g.dest_lat is not null then
                   1.02 * st_distance(
                           to_geography('POINT('||g.orig_lon||' '||g.orig_lat||')'),
                           to_geography('POINT('||g.dest_lon||' '||g.dest_lat||')')
                         ) / 1609.344      -- metres → miles
            end
        )                                                       as total_miles
    from add_geo g
),

-- ╭──────────────────────────────────────────────────────────────╮
-- 5 · BUSINESS FIELDS  (usd/mi, seat flag, fare bucket)
-- ╰──────────────────────────────────────────────────────────────╯
ready as (

    select
        a.*,

        /* price per mile */
        a.total_fare / nullif(a.total_miles,0)                  as usd_per_mi,

        /* seat-availability flag */
        case
          when seats_remaining = 0                 then 'sold_out'
          when seats_remaining between 1 and 8     then 'scarce'
          else                                          '9plus'
        end                                                          as seats_flag,

        /* fare bucket from first letter of fare-basis */
        fb.fare_bucket
    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter
)

-- ╭──────────────────────────────────────────────────────────────╮
-- 6 · EMIT THE STAGING TABLE
-- ╰──────────────────────────────────────────────────────────────╯
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                              as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode
from ready
        );
[0m19:43:45.953996 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:43:49.586276 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8a4-0305-0bb1-0006-8fdb00188406
[0m19:43:49.587273 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001065 (22023): SQL compilation error:
Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
[0m19:43:49.589268 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m19:43:49.592260 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aede30d7-4cd2-4dca-9d4f-251b9bb5082b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DBDECEB00>]}
[0m19:43:49.592260 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.stg_fare_searches .......... [[31mERROR[0m in 3.70s]
[0m19:43:49.593258 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m19:43:49.594255 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m19:43:49.596249 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:43:49.597247 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:43:49.597247 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:43:49.953294 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:43:49.954292 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:43:50.301363 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m19:43:50.302360 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m19:43:50.633474 [info ] [MainThread]: 
[0m19:43:50.634472 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 16.68 seconds (16.68s).
[0m19:43:50.635469 [debug] [MainThread]: Command end result
[0m19:43:50.669378 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:43:50.672371 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:43:50.681346 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:43:50.682344 [info ] [MainThread]: 
[0m19:43:50.682344 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:43:50.683341 [info ] [MainThread]: 
[0m19:43:50.684338 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  001065 (22023): SQL compilation error:
  Function TRY_CAST cannot be used with arguments of types FLOAT and NUMBER(38,0)
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m19:43:50.685336 [info ] [MainThread]: 
[0m19:43:50.686333 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:43:50.688328 [debug] [MainThread]: Command `dbt run` failed at 19:43:50.688328 after 19.68 seconds
[0m19:43:50.689325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DC0E1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCAE5F820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020DCC75A3B0>]}
[0m19:43:50.689325 [debug] [MainThread]: Flushing usage events
[0m19:43:51.033404 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:50:56.491020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D1621D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D1795DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D1795E1D0>]}


============================== 19:50:56.495009 | 700691fe-64f7-4838-aa6b-f180a9f11878 ==============================
[0m19:50:56.495009 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:50:56.496007 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:50:57.413551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D179320B0>]}
[0m19:50:57.488351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D2025F820>]}
[0m19:50:57.489349 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:50:58.081763 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:50:58.402904 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:50:58.403902 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m19:50:58.959415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D20FE0130>]}
[0m19:50:59.110011 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:50:59.113004 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:50:59.136940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D20AD2A10>]}
[0m19:50:59.137938 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:50:59.138936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D20AD2170>]}
[0m19:50:59.140929 [info ] [MainThread]: 
[0m19:50:59.140929 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:50:59.141927 [info ] [MainThread]: 
[0m19:50:59.142924 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:50:59.144919 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:50:59.254625 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:50:59.255622 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:50:59.255622 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:51:05.015211 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.759 seconds
[0m19:51:05.023189 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:51:05.034160 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:51:05.034160 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:51:05.035158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:51:08.560724 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.526 seconds
[0m19:51:08.565710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D20AD1780>]}
[0m19:51:08.570698 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m19:51:08.571695 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m19:51:08.572692 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m19:51:08.572692 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m19:51:08.582665 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:51:08.583663 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m19:51:08.616575 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:51:08.621561 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m19:51:08.622559 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1 · RAW PULL  
with raw as (

    select
        legid,
        try_to_date(searchdate)                     as search_date,
        try_to_date(flightdate)                     as flight_date,

        cast(totalfare         as numeric)          as total_fare,
        cast(basefare          as numeric)          as base_fare,
        cast(seatsremaining    as numeric)          as seats_remaining,

        isnonstop                                    as is_nonstop,
        isbasiceconomy                               as is_basic_econ,
        isrefundable                                 as is_refundable,
        trim(farebasiscode)                          as farebasiscode,

        cast(totaltraveldistance as numeric)         as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where searchdate is not null
      and flightdate is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare is not null

),

-- 2 · DERIVATIONS (origin/dest, days_out, etc.)
prep as (

    select
        r.*,

        split(trim(segmentsdepartureairportcode), '||')    as dep_arr,
        split(trim(segmentsarrivalairportcode),   '||')    as arr_arr,

        /* first / last leg → origin / destination */
        trim(replace(dep_arr[0], '"',''))                  as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1], '"',''))
                                                          as destination,

        split(trim(segmentsairlinecode), '||')[0]          as carrier_code,

        datediff(
          'day',
          try_to_date(searchdate),
          try_to_date(flightdate)
        )                                                   as days_to_flight

    from raw r

),

-- 3 · GEO LOOKUP
add_geo as (

    select
        p.*,
        og.lat_deg  as orig_lat,
        og.lon_deg  as orig_lon,
        dg.lat_deg  as dest_lat,
        dg.lon_deg  as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code

),

-- 4 · TOTAL MILES (raw → geo fallback)
add_miles as (

    select
        g.*,
        coalesce(
          g.raw_total_miles,
          case
            when g.orig_lat is not null and g.dest_lat is not null then
              1.02 * st_distance(
                      to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                      to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                    ) / 1609.344
          end
        )                                           as total_miles

    from add_geo g

),

-- 5 · BUSINESS FIELDS
ready as (

    select
      a.*,

      /* ALWAYS re-calc $/mi now that we have total_miles */
      a.total_fare / nullif(a.total_miles, 0)      as usd_per_mi,

      /* seat availability */
      case
        when seats_remaining = 0           then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else                                   '9plus'
      end                                        as seats_flag,

      /* fare bucket via seed map */
      fb.fare_bucket

    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter

)

-- 6 · EMIT FINAL STAGING
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination            as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from ready
        );
[0m19:51:08.623557 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:51:12.216941 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8ab-0305-0c96-0006-8fdb001893da
[0m19:51:12.217938 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 62 at position 22
invalid identifier 'SEARCHDATE'
[0m19:51:12.219933 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 62 at position 22
  invalid identifier 'SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m19:51:12.222925 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '700691fe-64f7-4838-aa6b-f180a9f11878', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D2025E6E0>]}
[0m19:51:12.223923 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.stg_fare_searches .......... [[31mERROR[0m in 3.65s]
[0m19:51:12.224920 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m19:51:12.224920 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 62 at position 22
  invalid identifier 'SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m19:51:12.226914 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:51:12.227913 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:51:12.227913 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:51:12.588946 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:51:12.589943 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:51:12.922055 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m19:51:12.923052 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m19:51:13.283088 [info ] [MainThread]: 
[0m19:51:13.284085 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.14 seconds (14.14s).
[0m19:51:13.285083 [debug] [MainThread]: Command end result
[0m19:51:13.318993 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:51:13.321984 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:51:13.329963 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:51:13.329963 [info ] [MainThread]: 
[0m19:51:13.330961 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m19:51:13.331958 [info ] [MainThread]: 
[0m19:51:13.332956 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 62 at position 22
  invalid identifier 'SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m19:51:13.332956 [info ] [MainThread]: 
[0m19:51:13.333952 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:51:13.335947 [debug] [MainThread]: Command `dbt run` failed at 19:51:13.334950 after 16.93 seconds
[0m19:51:13.335947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D1621D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D162B2110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022D21B5AE60>]}
[0m19:51:13.336945 [debug] [MainThread]: Flushing usage events
[0m19:51:13.690997 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:53:33.503928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013365E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013367559CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013367559ED0>]}


============================== 19:53:33.508915 | 56dd566a-3d45-4d5b-8573-b028c07c35da ==============================
[0m19:53:33.508915 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:53:33.509913 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:53:34.472337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013367535CF0>]}
[0m19:53:34.534171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133673929E0>]}
[0m19:53:34.536167 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:53:35.111627 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:53:35.408831 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:53:35.409828 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m19:53:35.968334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013370ADC130>]}
[0m19:53:36.116936 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:53:36.119928 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:53:36.144862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133705D3B20>]}
[0m19:53:36.145859 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:53:36.146857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133705D3AF0>]}
[0m19:53:36.148851 [info ] [MainThread]: 
[0m19:53:36.149848 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:53:36.149848 [info ] [MainThread]: 
[0m19:53:36.150846 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:53:36.151844 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:53:36.279501 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:53:36.279501 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:53:36.280499 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:53:41.091626 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.811 seconds
[0m19:53:41.099604 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:53:41.110576 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:53:41.111572 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:53:41.111572 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:53:45.126828 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 4.015 seconds
[0m19:53:45.131815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133705D2980>]}
[0m19:53:45.135804 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m19:53:45.136802 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m19:53:45.137799 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m19:53:45.138796 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m19:53:45.147772 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:53:45.149767 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m19:53:45.182679 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:53:45.187665 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m19:53:45.188663 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1 · RAW PULL  (keep only sensible rows)
with raw as (

    select
        legid,
        try_to_date(searchdate)                    as search_date,
        try_to_date(flightdate)                    as flight_date,

        cast(totalfare          as numeric)        as total_fare,
        cast(basefare           as numeric)        as base_fare,
        cast(seatsremaining     as numeric)        as seats_remaining,

        isnonstop                                   as is_nonstop,
        isbasiceconomy                              as is_basic_econ,
        isrefundable                                as is_refundable,
        trim(farebasiscode)                         as farebasiscode,

        cast(totaltraveldistance as numeric)        as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null

),

-- 2 · BASIC DERIVATIONS (origin / destination, days-to-flight, etc.)
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* first / last elements become origin / destination */
        trim(replace(dep_arr[0], '"',''))                        as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1], '"',''))    as destination,

        split(trim(r.segmentsairlinecode), '||')[0]              as carrier_code,

        /* use the aliased columns, not raw SEARCHDATE */
        datediff('day', r.search_date, r.flight_date)            as days_to_flight

    from raw r
),

-- 3 · AIRPORT GEO LOOK-UP  (for geo fallback)
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- 4 · TOTAL MILES  (raw distance → geo fallback)
add_miles as (

    select
        g.*,
        coalesce(
            g.raw_total_miles,
            case
              when g.orig_lat is not null
                and g.dest_lat is not null then
                1.02 * st_distance(
                         to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                         to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
            end
        )                                                      as total_miles

    from add_geo g
),

-- 5 · BUSINESS FIELDS  (usd/mi, seat flag, fare bucket)
ready as (

    select
      a.*,

      /* re-calculate $/mi now that trip_dist is filled */
      a.total_fare / nullif(a.total_miles, 0)                as usd_per_mi,

      /* seat availability flag */
      case
        when seats_remaining = 0          then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else                                   '9plus'
      end                                                     as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter

)

-- 6 · EMIT THE STAGING TABLE
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                            as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from ready
        );
[0m19:53:45.189660 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:53:49.996798 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.807 seconds
[0m19:53:50.021731 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '56dd566a-3d45-4d5b-8573-b028c07c35da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001336FB5FE80>]}
[0m19:53:50.022728 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 4.88s]
[0m19:53:50.023726 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m19:53:50.024723 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:53:50.025720 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:53:50.025720 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:53:50.369800 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:53:50.370797 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:53:50.715873 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m19:53:50.715873 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m19:53:51.088875 [info ] [MainThread]: 
[0m19:53:51.088875 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.94 seconds (14.94s).
[0m19:53:51.089873 [debug] [MainThread]: Command end result
[0m19:53:51.181627 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:53:51.184619 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:53:51.192598 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:53:51.193596 [info ] [MainThread]: 
[0m19:53:51.193596 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:53:51.194593 [info ] [MainThread]: 
[0m19:53:51.195590 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:53:51.197584 [debug] [MainThread]: Command `dbt run` succeeded at 19:53:51.197584 after 17.77 seconds
[0m19:53:51.197584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013365E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013365ED72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000133718B0640>]}
[0m19:53:51.198582 [debug] [MainThread]: Flushing usage events
[0m19:53:51.537675 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m19:54:13.686410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A7F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A9659CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A9659ED0>]}


============================== 19:54:13.690400 | 2a3454b0-4faf-4168-ba58-9c7806f42c59 ==============================
[0m19:54:13.690400 [info ] [MainThread]: Running with dbt=1.9.4
[0m19:54:13.691397 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run -m stg_fare_searches', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:54:14.623902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A9631CF0>]}
[0m19:54:14.686733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A94929E0>]}
[0m19:54:14.688729 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m19:54:15.271170 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m19:54:15.568374 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:54:15.569372 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:54:15.710993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B2633A90>]}
[0m19:54:15.864582 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:54:15.867574 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:54:15.891510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B2631780>]}
[0m19:54:15.892508 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m19:54:15.893505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B26313F0>]}
[0m19:54:15.895500 [info ] [MainThread]: 
[0m19:54:15.896497 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m19:54:15.896497 [info ] [MainThread]: 
[0m19:54:15.897494 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m19:54:15.899489 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m19:54:16.014182 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m19:54:16.015181 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m19:54:16.015181 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:19.858894 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.843 seconds
[0m19:54:19.866873 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m19:54:19.877843 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m19:54:19.877843 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m19:54:19.878841 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:54:23.582930 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.704 seconds
[0m19:54:23.587917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B204BB50>]}
[0m19:54:23.592903 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m19:54:23.593901 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m19:54:23.594899 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m19:54:23.595895 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m19:54:23.604871 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:54:23.606866 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m19:54:23.639778 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m19:54:23.644764 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m19:54:23.645762 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1 · RAW PULL  (keep only sensible rows)
with raw as (

    select
        legid,
        try_to_date(searchdate)                    as search_date,
        try_to_date(flightdate)                    as flight_date,

        cast(totalfare          as numeric)        as total_fare,
        cast(basefare           as numeric)        as base_fare,
        cast(seatsremaining     as numeric)        as seats_remaining,

        isnonstop                                   as is_nonstop,
        isbasiceconomy                              as is_basic_econ,
        isrefundable                                as is_refundable,
        trim(farebasiscode)                         as farebasiscode,

        cast(totaltraveldistance as numeric)        as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null

),

-- 2 · BASIC DERIVATIONS (origin / destination, days-to-flight, etc.)
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* first / last elements become origin / destination */
        trim(replace(dep_arr[0], '"',''))                        as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1], '"',''))    as destination,

        split(trim(r.segmentsairlinecode), '||')[0]              as carrier_code,

        /* use the aliased columns, not raw SEARCHDATE */
        datediff('day', r.search_date, r.flight_date)            as days_to_flight

    from raw r
),

-- 3 · AIRPORT GEO LOOK-UP  (for geo fallback)
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- 4 · TOTAL MILES  (raw distance → geo fallback)
add_miles as (

    select
        g.*,
        coalesce(
            g.raw_total_miles,
            case
              when g.orig_lat is not null
                and g.dest_lat is not null then
                1.02 * st_distance(
                         to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                         to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
            end
        )                                                      as total_miles

    from add_geo g
),

-- 5 · BUSINESS FIELDS  (usd/mi, seat flag, fare bucket)
ready as (

    select
      a.*,

      /* re-calculate $/mi now that trip_dist is filled */
      a.total_fare / nullif(a.total_miles, 0)                as usd_per_mi,

      /* seat availability flag */
      case
        when seats_remaining = 0          then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else                                   '9plus'
      end                                                     as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter

)

-- 6 · EMIT THE STAGING TABLE
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                            as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from ready
        );
[0m19:54:23.646759 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m19:54:28.040004 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.393 seconds
[0m19:54:28.063939 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a3454b0-4faf-4168-ba58-9c7806f42c59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B1D63E80>]}
[0m19:54:28.064938 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 4.47s]
[0m19:54:28.065935 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m19:54:28.067929 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:54:28.067929 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m19:54:28.068927 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m19:54:28.407022 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m19:54:28.407022 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m19:54:28.749107 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m19:54:28.750104 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m19:54:29.094183 [info ] [MainThread]: 
[0m19:54:29.095181 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.20 seconds (13.20s).
[0m19:54:29.096179 [debug] [MainThread]: Command end result
[0m19:54:29.129090 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m19:54:29.132083 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m19:54:29.141058 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m19:54:29.142055 [info ] [MainThread]: 
[0m19:54:29.144050 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:54:29.144050 [info ] [MainThread]: 
[0m19:54:29.145048 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:54:29.147042 [debug] [MainThread]: Command `dbt run` succeeded at 19:54:29.146045 after 15.54 seconds
[0m19:54:29.147042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A7F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276A94929E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000276B27BF520>]}
[0m19:54:29.148040 [debug] [MainThread]: Flushing usage events
[0m19:54:29.490123 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:12:10.642880 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A74B1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7625A3B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7625A1D0>]}


============================== 20:12:10.645872 | dbdbb17f-f902-4ec6-9cea-53dd0f4158db ==============================
[0m20:12:10.645872 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:12:10.646869 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:12:11.552446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7622B1F0>]}
[0m20:12:11.612286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7EA5F400>]}
[0m20:12:11.613283 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:12:12.178770 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:12:12.460018 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:12:12.460018 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:12:12.597649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7F31D210>]}
[0m20:12:12.746252 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:12:12.749245 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:12:12.774178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7F31EDA0>]}
[0m20:12:12.775175 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:12:12.776172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7F31E8C0>]}
[0m20:12:12.778167 [info ] [MainThread]: 
[0m20:12:12.779164 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:12:12.780162 [info ] [MainThread]: 
[0m20:12:12.781159 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:12:12.783154 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:12:12.893857 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:12:12.893857 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:12:12.894855 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:17.166425 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.272 seconds
[0m20:12:17.174403 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:12:17.185374 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:12:17.185374 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:12:17.186371 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:12:20.845580 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.660 seconds
[0m20:12:20.850567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7F321AB0>]}
[0m20:12:20.854556 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m20:12:20.855554 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m20:12:20.856551 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m20:12:20.857548 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m20:12:20.867521 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m20:12:20.868519 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m20:12:20.900433 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m20:12:20.905420 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m20:12:20.906418 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1 · RAW PULL  (keep only sensible rows)
with raw as (

    select
        legid,
        try_to_date(searchdate)                    as search_date,
        try_to_date(flightdate)                    as flight_date,

        cast(totalfare          as numeric)        as total_fare,
        cast(basefare           as numeric)        as base_fare,
        cast(seatsremaining     as numeric)        as seats_remaining,

        isnonstop                                   as is_nonstop,
        isbasiceconomy                              as is_basic_econ,
        isrefundable                                as is_refundable,
        trim(farebasiscode)                         as farebasiscode,

        cast(totaltraveldistance as numeric)        as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null

),

-- 2 · BASIC DERIVATIONS (origin / destination, days-to-flight, etc.)
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* first / last elements become origin / destination */
        trim(replace(dep_arr[0], '"',''))                        as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1], '"',''))    as destination,

        split(trim(r.segmentsairlinecode), '||')[0]              as carrier_code,

        /* use the aliased columns, not raw SEARCHDATE */
        datediff('day', r.search_date, r.flight_date)            as days_to_flight

    from raw r
),

-- 3 · AIRPORT GEO LOOK-UP  (for geo fallback)
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- 4 · TOTAL MILES  (raw distance → geo fallback)
add_miles as (

    select
        g.*,
        coalesce(
            g.raw_total_miles,
            case
              when g.orig_lat is not null
                and g.dest_lat is not null then
                1.02 * st_distance(
                         to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                         to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
            end
        )                                                      as total_miles

    from add_geo g
),

-- 5 · BUSINESS FIELDS  (usd/mi, seat flag, fare bucket)
ready as (

    select
      a.*,

      /* re-calculate $/mi now that trip_dist is filled */
      a.total_fare / nullif(a.total_miles, 0)                as usd_per_mi,

      /* seat availability flag */
      case
        when seats_remaining = 0          then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else                                   '9plus'
      end                                                     as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter

)

-- 6 · EMIT THE STAGING TABLE
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                            as route,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from ready
        );
[0m20:12:20.906418 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:14:11.238198 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 110.331 seconds
[0m20:14:11.262134 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dbdbb17f-f902-4ec6-9cea-53dd0f4158db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7EBC0CD0>]}
[0m20:14:11.263132 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 110.40s]
[0m20:14:11.264130 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m20:14:11.265126 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:14:11.266124 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:14:11.266124 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:14:11.627157 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:14:11.627157 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:14:12.008138 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m20:14:12.009135 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m20:14:12.349225 [info ] [MainThread]: 
[0m20:14:12.350223 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 59.57 seconds (119.57s).
[0m20:14:12.351221 [debug] [MainThread]: Command end result
[0m20:14:12.382137 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:14:12.385129 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:14:12.393108 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:14:12.394106 [info ] [MainThread]: 
[0m20:14:12.395103 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:14:12.396101 [info ] [MainThread]: 
[0m20:14:12.397098 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:14:12.399092 [debug] [MainThread]: Command `dbt run` succeeded at 20:14:12.399092 after 121.84 seconds
[0m20:14:12.399092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A74B1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7EA787C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A7F2BF640>]}
[0m20:14:12.400089 [debug] [MainThread]: Flushing usage events
[0m20:14:12.750152 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:15:08.325448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CC11D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CD85A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CD85A170>]}


============================== 20:15:08.330434 | a8380603-fee1-4277-a603-26f83215e130 ==============================
[0m20:15:08.330434 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:15:08.330434 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run -m stg_route_stats --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m20:15:09.232022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CA497070>]}
[0m20:15:09.294853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CD0FE560>]}
[0m20:15:09.295851 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:15:09.868319 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:15:10.148569 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:15:10.148569 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:15:10.285203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D67BBA90>]}
[0m20:15:10.432809 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:15:10.434803 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:15:10.459737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D67B9900>]}
[0m20:15:10.459737 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:15:10.460734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D67B9630>]}
[0m20:15:10.462729 [info ] [MainThread]: 
[0m20:15:10.463726 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:15:10.463726 [info ] [MainThread]: 
[0m20:15:10.464724 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:15:10.465721 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:15:10.577422 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:15:10.578419 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:15:10.578419 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:15:15.571060 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.992 seconds
[0m20:15:15.579039 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:15:15.589012 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:15:15.590009 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:15:15.591007 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:15:19.539441 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.949 seconds
[0m20:15:19.544428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D614A890>]}
[0m20:15:19.549415 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m20:15:19.550412 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m20:15:19.551410 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m20:15:19.551410 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m20:15:19.559388 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m20:15:19.561383 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m20:15:19.593297 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m20:15:19.596290 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m20:15:19.596290 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m20:15:19.597287 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:15:34.756724 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 15.159 seconds
[0m20:15:34.779663 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8380603-fee1-4277-a603-26f83215e130', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D70F9510>]}
[0m20:15:34.780660 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 15.23s]
[0m20:15:34.781658 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m20:15:34.783652 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:15:34.783652 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:15:34.784650 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:15:35.133715 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:15:35.133715 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:15:35.480787 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m20:15:35.481784 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m20:15:35.847805 [info ] [MainThread]: 
[0m20:15:35.848802 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 25.38 seconds (25.38s).
[0m20:15:35.849800 [debug] [MainThread]: Command end result
[0m20:15:35.881715 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:15:35.884706 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:15:35.892686 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:15:35.893682 [info ] [MainThread]: 
[0m20:15:35.893682 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:15:35.894680 [info ] [MainThread]: 
[0m20:15:35.895677 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:15:35.896674 [debug] [MainThread]: Command `dbt run` succeeded at 20:15:35.896674 after 27.65 seconds
[0m20:15:35.897672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CC11D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200CD0FE560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200D68BDAE0>]}
[0m20:15:35.898669 [debug] [MainThread]: Flushing usage events
[0m20:15:36.265686 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:16:31.125895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147DF1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147F659C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147F659E10>]}


============================== 20:16:31.130881 | 07e58cc7-e50a-4329-a329-fa6dab5a56a7 ==============================
[0m20:16:31.130881 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:16:31.130881 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run -m int_route_competition', 'send_anonymous_usage_stats': 'True'}
[0m20:16:32.032469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147F632890>]}
[0m20:16:32.092309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147F492D70>]}
[0m20:16:32.093306 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:16:32.656798 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:16:32.932062 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:16:32.932062 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:16:33.066702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021408819210>]}
[0m20:16:33.213309 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:16:33.216302 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:16:33.239240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021408818CD0>]}
[0m20:16:33.240238 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:16:33.241235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002140881ABF0>]}
[0m20:16:33.243230 [info ] [MainThread]: 
[0m20:16:33.244227 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:16:33.244227 [info ] [MainThread]: 
[0m20:16:33.245225 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:16:33.246222 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:16:33.354931 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:16:33.355928 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:16:33.355928 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:16:37.604560 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.248 seconds
[0m20:16:37.612538 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:16:37.622512 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:16:37.623509 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:16:37.623509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:16:41.343555 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.719 seconds
[0m20:16:41.348541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021408827AC0>]}
[0m20:16:41.352531 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:16:41.353529 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:16:41.354526 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:16:41.354526 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:16:41.363501 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:16:41.364499 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:16:41.396414 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:16:41.398409 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:16:41.399406 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with base as (

    select
        origin || '-' || destination                as route,
        marketing_carrier,
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    -- how many bookings each carrier operates on each route
    select
        route,
        marketing_carrier,
        count(*)                                  as flight_bookings
    from base
    group by
        route,
        marketing_carrier

), concentration as (

    /* HHI = Σ(s_i^2) where s_i = share of bookings per carrier */
    select
        route,
        sum(flight_bookings)                      as total_bookings,
        sum(power(flight_bookings, 2)) 
          / power(sum(flight_bookings), 2)        as hhi,
        count(marketing_carrier)                  as carrier_count
    from carrier_flights
    group by
        route

)

select
    route,
    carrier_count,
    hhi                                         -- 1.0 = pure monopoly, <0.2 highly competitive
from concentration
        );
[0m20:16:41.399406 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:16:45.150369 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8c5-0305-0bb1-0006-8fdb00188656
[0m20:16:45.151366 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 9 at position 8
invalid identifier 'MARKETING_CARRIER'
[0m20:16:45.153361 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:16:45.155356 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07e58cc7-e50a-4329-a329-fa6dab5a56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147AFCE1D0>]}
[0m20:16:45.156353 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.80s]
[0m20:16:45.157351 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:16:45.158348 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:16:45.160342 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:16:45.160342 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:16:45.161340 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:16:45.512400 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:16:45.513398 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:16:45.848501 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:16:45.849498 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:16:46.194575 [info ] [MainThread]: 
[0m20:16:46.195572 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.95 seconds (12.95s).
[0m20:16:46.196570 [debug] [MainThread]: Command end result
[0m20:16:46.228484 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:16:46.230479 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:16:46.239456 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:16:46.239456 [info ] [MainThread]: 
[0m20:16:46.240452 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:16:46.241450 [info ] [MainThread]: 
[0m20:16:46.241450 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:16:46.242447 [info ] [MainThread]: 
[0m20:16:46.243444 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:16:46.245439 [debug] [MainThread]: Command `dbt run` failed at 20:16:46.245439 after 15.20 seconds
[0m20:16:46.245439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002147DF1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214087BF760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000214092A3DC0>]}
[0m20:16:46.246436 [debug] [MainThread]: Flushing usage events
[0m20:16:46.592510 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:18:48.749649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943191D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943305DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943305E1A0>]}


============================== 20:18:48.752641 | 2e615fdb-5905-4b2f-892f-1889011282a8 ==============================
[0m20:18:48.752641 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:18:48.753639 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run -m dim_carrier --full-refresh', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:18:49.640266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001942FC970A0>]}
[0m20:18:49.701104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000194328FE2F0>]}
[0m20:18:49.702100 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:18:50.264595 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:18:50.540856 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:18:50.540856 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:18:50.675496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943BFB7A90>]}
[0m20:18:50.820109 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:18:50.823101 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:18:50.849032 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943BFB4DC0>]}
[0m20:18:50.850030 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:18:50.850030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943BFB4C40>]}
[0m20:18:50.852024 [info ] [MainThread]: 
[0m20:18:50.853021 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:18:50.854019 [info ] [MainThread]: 
[0m20:18:50.854019 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:18:50.856014 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:18:50.968712 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:18:50.969709 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:18:50.969709 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:18:56.795122 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.825 seconds
[0m20:18:56.803100 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:18:56.813073 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:18:56.814071 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:18:56.815068 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:19:00.506192 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.691 seconds
[0m20:19:00.511178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943B94A8F0>]}
[0m20:19:00.515168 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.dim_carrier
[0m20:19:00.516165 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.dim_carrier ......................... [RUN]
[0m20:19:00.517163 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.dim_carrier'
[0m20:19:00.517163 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.dim_carrier
[0m20:19:00.525141 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.dim_carrier"
[0m20:19:00.526138 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.dim_carrier
[0m20:19:00.558053 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.dim_carrier"
[0m20:19:00.560048 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.dim_carrier"
[0m20:19:00.560048 [debug] [Thread-1 (]: On model.fair_pricing_radar.dim_carrier: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.dim_carrier"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier
         as
        (

select
  code   as carrier_code,
  name   as carrier_name
from FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping
        );
[0m20:19:00.561045 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:19:04.948306 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.387 seconds
[0m20:19:04.971244 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e615fdb-5905-4b2f-892f-1889011282a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943B863E50>]}
[0m20:19:04.972242 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.dim_carrier .................... [[32mSUCCESS 1[0m in 4.45s]
[0m20:19:04.973239 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.dim_carrier
[0m20:19:04.974237 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:19:04.975234 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:19:04.975234 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:19:05.322305 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:19:05.323302 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:19:06.475220 [debug] [MainThread]: Connection 'model.fair_pricing_radar.dim_carrier' was left open.
[0m20:19:06.476218 [debug] [MainThread]: On model.fair_pricing_radar.dim_carrier: Close
[0m20:19:06.816307 [info ] [MainThread]: 
[0m20:19:06.817305 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 15.96 seconds (15.96s).
[0m20:19:06.818303 [debug] [MainThread]: Command end result
[0m20:19:06.848222 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:19:06.851215 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:19:06.860191 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:19:06.861188 [info ] [MainThread]: 
[0m20:19:06.863183 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:19:06.864180 [info ] [MainThread]: 
[0m20:19:06.864180 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:19:06.866174 [debug] [MainThread]: Command `dbt run` succeeded at 20:19:06.866174 after 18.20 seconds
[0m20:19:06.867171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943191D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000194328FE2F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001943C0BE5F0>]}
[0m20:19:06.867171 [debug] [MainThread]: Flushing usage events
[0m20:19:07.213245 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:19:14.150682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F17871D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F179E59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F179E59EA0>]}


============================== 20:19:14.154672 | f83f0ad6-403b-41fd-a057-182c15ffa50a ==============================
[0m20:19:14.154672 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:19:14.155669 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run -m int_route_competition', 'send_anonymous_usage_stats': 'True'}
[0m20:19:15.052270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F179E325F0>]}
[0m20:19:15.112110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102663B50>]}
[0m20:19:15.114105 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:19:15.675602 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:19:15.958844 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:19:15.959842 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:19:16.094481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102D33A90>]}
[0m20:19:16.239095 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:19:16.241089 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:19:16.265025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102F1CDF0>]}
[0m20:19:16.266023 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:19:16.266023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F1027498D0>]}
[0m20:19:16.268017 [info ] [MainThread]: 
[0m20:19:16.269015 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:19:16.270012 [info ] [MainThread]: 
[0m20:19:16.270012 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:19:16.271009 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:19:16.379718 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:19:16.380716 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:19:16.380716 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:19:19.953156 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.572 seconds
[0m20:19:19.961135 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:19:19.972106 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:19:19.973103 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:19:19.973103 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:19:23.609373 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.636 seconds
[0m20:19:23.614360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102F1C910>]}
[0m20:19:23.618350 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:19:23.619347 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:19:23.620345 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:19:23.620345 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:19:23.629321 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:19:23.630319 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:19:23.662232 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:19:23.664227 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:19:23.664227 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with base as (

    select
        origin || '-' || destination                as route,
        marketing_carrier,
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    -- how many bookings each carrier operates on each route
    select
        route,
        marketing_carrier,
        count(*)                                  as flight_bookings
    from base
    group by
        route,
        marketing_carrier

), concentration as (

    /* HHI = Σ(s_i^2) where s_i = share of bookings per carrier */
    select
        route,
        sum(flight_bookings)                      as total_bookings,
        sum(power(flight_bookings, 2)) 
          / power(sum(flight_bookings), 2)        as hhi,
        count(marketing_carrier)                  as carrier_count
    from carrier_flights
    group by
        route

)

select
    route,
    carrier_count,
    hhi                                         -- 1.0 = pure monopoly, <0.2 highly competitive
from concentration
        );
[0m20:19:23.665224 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:19:27.296508 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8c8-0305-0fb8-0006-8fdb00187b06
[0m20:19:27.297505 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 9 at position 8
invalid identifier 'MARKETING_CARRIER'
[0m20:19:27.300497 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:19:27.302492 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f83f0ad6-403b-41fd-a057-182c15ffa50a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102C948E0>]}
[0m20:19:27.303489 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.68s]
[0m20:19:27.304487 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:19:27.304487 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:19:27.306481 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:19:27.307479 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:19:27.307479 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:19:27.656544 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:19:27.657542 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:19:27.988656 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:19:27.988656 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:19:28.337722 [info ] [MainThread]: 
[0m20:19:28.338720 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.07 seconds (12.07s).
[0m20:19:28.339717 [debug] [MainThread]: Command end result
[0m20:19:28.370634 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:19:28.372629 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:19:28.381604 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:19:28.382602 [info ] [MainThread]: 
[0m20:19:28.382602 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:19:28.383600 [info ] [MainThread]: 
[0m20:19:28.384596 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 9 at position 8
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:19:28.385594 [info ] [MainThread]: 
[0m20:19:28.385594 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:19:28.387589 [debug] [MainThread]: Command `dbt run` failed at 20:19:28.387589 after 14.32 seconds
[0m20:19:28.388586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F17871D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F102CDA9E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F17874E950>]}
[0m20:19:28.388586 [debug] [MainThread]: Flushing usage events
[0m20:19:28.747625 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:27:04.959919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001841891D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001841A059CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001841A059EA0>]}


============================== 20:27:04.963908 | e83dff85-e08c-4678-a39c-d2bf11f182e8 ==============================
[0m20:27:04.963908 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:27:04.964906 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run -m int_route_competition', 'send_anonymous_usage_stats': 'True'}
[0m20:27:05.934312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018416B97040>]}
[0m20:27:05.996146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184199022C0>]}
[0m20:27:05.998141 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:27:06.568614 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:27:06.861829 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:27:06.862827 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m20:27:07.243807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842337CDF0>]}
[0m20:27:07.400389 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:27:07.402383 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:27:07.431307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842338DC30>]}
[0m20:27:07.432305 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:27:07.433302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184232E7AF0>]}
[0m20:27:07.435296 [info ] [MainThread]: 
[0m20:27:07.436293 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:27:07.437291 [info ] [MainThread]: 
[0m20:27:07.439285 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:27:07.441280 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:27:07.572927 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:27:07.573924 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:27:07.573924 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:27:19.658589 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 12.085 seconds
[0m20:27:19.666567 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:27:19.677538 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:27:19.677538 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:27:19.678536 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:27:23.444459 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.766 seconds
[0m20:27:23.449445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842338DDE0>]}
[0m20:27:23.454432 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:27:23.454432 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:27:23.455430 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:27:23.456427 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:27:23.464405 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:27:23.465403 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:27:23.498315 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:27:23.500310 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:27:23.501307 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with flights as (

    /* one record per booking */
    select
        origin || '-' || destination      as route,
        carrier_code,                     -- <-- renamed field
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    /* bookings operated by each carrier on each route */
    select
        route,
        carrier_code,
        count(*)                          as flight_bookings
    from flights
    group by
        route,
        carrier_code

), hhi_calc as (

    /* Herfindahl-Hirschman Index */
    select
        route,
        sum(flight_bookings)                              as total_bookings,
        sum(power(flight_bookings, 2))
            / power(sum(flight_bookings), 2)              as hhi,
        count(distinct carrier_code)                      as carrier_count
    from carrier_flights
    group by route

)

select
    route,
    carrier_count,
    hhi                                                 -- 1 = monopoly, < 0.2 highly competitive
from hhi_calc
        );
[0m20:27:23.502304 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:27:27.052804 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8d0-0305-0fb8-0006-8fdb00187b92
[0m20:27:27.053801 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 10 at position 8
invalid identifier 'CARRIER_CODE'
[0m20:27:27.055796 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:27:27.058788 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e83dff85-e08c-4678-a39c-d2bf11f182e8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018422763E50>]}
[0m20:27:27.059785 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.60s]
[0m20:27:27.060783 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:27:27.060783 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:27:27.062777 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:27:27.063775 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:27:27.063775 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:27:27.427801 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:27:27.427801 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:27:27.803795 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:27:27.804792 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:27:28.149868 [info ] [MainThread]: 
[0m20:27:28.150866 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 20.71 seconds (20.71s).
[0m20:27:28.151864 [debug] [MainThread]: Command end result
[0m20:27:28.182780 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:27:28.185773 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:27:28.193751 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:27:28.194748 [info ] [MainThread]: 
[0m20:27:28.194748 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:27:28.195746 [info ] [MainThread]: 
[0m20:27:28.196744 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:27:28.197741 [info ] [MainThread]: 
[0m20:27:28.198739 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:27:28.200733 [debug] [MainThread]: Command `dbt run` failed at 20:27:28.200733 after 23.32 seconds
[0m20:27:28.201730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001841891D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184189D72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184240C3D00>]}
[0m20:27:28.201730 [debug] [MainThread]: Flushing usage events
[0m20:27:28.545809 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:32:12.357415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6DC1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6F3564D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6F3566B0>]}


============================== 20:32:12.361405 | e8630295-9834-4113-ab06-36d5e0d69d07 ==============================
[0m20:32:12.361405 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:32:12.362402 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select stg_fare_searches --full-refresh', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:32:13.417578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6F332890>]}
[0m20:32:13.490384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6F192D70>]}
[0m20:32:13.492379 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:32:14.169567 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:32:14.647288 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:32:14.648286 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m20:32:15.317495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A788E4130>]}
[0m20:32:15.465101 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:32:15.467095 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:32:15.492028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A783D2B30>]}
[0m20:32:15.493026 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:32:15.493026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A783D3FA0>]}
[0m20:32:15.495020 [info ] [MainThread]: 
[0m20:32:15.496017 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:32:15.497015 [info ] [MainThread]: 
[0m20:32:15.497015 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:32:15.498012 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:32:15.606721 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:32:15.607718 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:32:15.607718 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:32:20.248301 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.640 seconds
[0m20:32:20.256280 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:32:20.267251 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:32:20.268248 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:32:20.268248 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:32:24.052123 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.784 seconds
[0m20:32:24.057110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A783D2890>]}
[0m20:32:24.061100 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m20:32:24.062097 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m20:32:24.063095 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m20:32:24.064092 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m20:32:24.073067 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m20:32:24.075063 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m20:32:24.106976 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m20:32:24.111963 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m20:32:24.112960 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- 1 · RAW PULL  (keep only sensible rows)
with raw as (

    select
        legid,
        try_to_date(searchdate)                    as search_date,
        try_to_date(flightdate)                    as flight_date,

        cast(totalfare          as numeric)        as total_fare,
        cast(basefare           as numeric)        as base_fare,
        cast(seatsremaining     as numeric)        as seats_remaining,

        isnonstop                                   as is_nonstop,
        isbasiceconomy                              as is_basic_econ,
        isrefundable                                as is_refundable,
        trim(farebasiscode)                         as farebasiscode,

        cast(totaltraveldistance as numeric)        as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where searchdate  is not null
      and flightdate  is not null
      and try_to_date(flightdate) >= try_to_date(searchdate)
      and totalfare   is not null

),

-- 2 · BASIC DERIVATIONS (origin / destination, days-to-flight, etc.)
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* first / last elements become origin / destination */
        trim(replace(dep_arr[0], '"',''))                        as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1], '"',''))    as destination,

        split(trim(r.segmentsairlinecode), '||')[0]              as carrier_code,

        /* use the aliased columns, not raw SEARCHDATE */
        datediff('day', r.search_date, r.flight_date)            as days_to_flight

    from raw r
),

-- 3 · AIRPORT GEO LOOK-UP  (for geo fallback)
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- 4 · TOTAL MILES  (raw distance → geo fallback)
add_miles as (

    select
        g.*,
        coalesce(
            g.raw_total_miles,
            case
              when g.orig_lat is not null
                and g.dest_lat is not null then
                1.02 * st_distance(
                         to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                         to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
            end
        )                                                      as total_miles

    from add_geo g
),

-- 5 · BUSINESS FIELDS  (usd/mi, seat flag, fare bucket)
ready as (

    select
      a.*,

      /* re-calculate $/mi now that trip_dist is filled */
      a.total_fare / nullif(a.total_miles, 0)                as usd_per_mi,

      /* seat availability flag */
      case
        when seats_remaining = 0          then 'sold_out'
        when seats_remaining between 1 and 8 then 'scarce'
        else                                   '9plus'
      end                                                     as seats_flag,

      /* fare bucket from seed map */
      fb.fare_bucket

    from add_miles a
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(a.farebasiscode,1)) = fb.first_letter

)

-- 6 · EMIT THE STAGING TABLE
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination            as route,

    carrier_code                            as marketing_carrier,   
 
    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode
from ready
        );
[0m20:32:24.113958 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:34:18.937719 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 114.824 seconds
[0m20:34:18.961655 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e8630295-9834-4113-ab06-36d5e0d69d07', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7795C2E0>]}
[0m20:34:18.962652 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 114.90s]
[0m20:34:18.963650 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m20:34:18.964647 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:34:18.965645 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:34:18.966642 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:34:19.325681 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:34:19.326678 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:34:19.694693 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m20:34:19.694693 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m20:34:20.050741 [info ] [MainThread]: 
[0m20:34:20.051738 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 4.55 seconds (124.55s).
[0m20:34:20.052736 [debug] [MainThread]: Command end result
[0m20:34:20.085649 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:34:20.088640 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:34:20.096618 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:34:20.097616 [info ] [MainThread]: 
[0m20:34:20.098614 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:34:20.098614 [info ] [MainThread]: 
[0m20:34:20.099610 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:34:20.101605 [debug] [MainThread]: Command `dbt run` succeeded at 20:34:20.100608 after 127.82 seconds
[0m20:34:20.101605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6DC1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6F192D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6DCB11B0>]}
[0m20:34:20.102602 [debug] [MainThread]: Flushing usage events
[0m20:34:20.467625 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:37:18.867274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEB401D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEB575DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEB575E1D0>]}


============================== 20:37:18.871264 | 9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97 ==============================
[0m20:37:18.871264 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:37:18.872261 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_route_competition', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:37:19.770856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEB57320B0>]}
[0m20:37:19.830696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBE063820>]}
[0m20:37:19.831694 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:37:20.409148 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:37:20.706353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:37:20.706353 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m20:37:21.076363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBEC7CD90>]}
[0m20:37:21.222971 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:37:21.224965 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:37:21.249899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBEC8DCF0>]}
[0m20:37:21.250897 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:37:21.250897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBE9E5480>]}
[0m20:37:21.252891 [info ] [MainThread]: 
[0m20:37:21.253889 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:37:21.253889 [info ] [MainThread]: 
[0m20:37:21.254886 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:37:21.255884 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:37:21.365590 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:37:21.366586 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:37:21.366586 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:37:26.175719 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.809 seconds
[0m20:37:26.183697 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:37:26.194668 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:37:26.195665 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:37:26.195665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:37:29.969567 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.773 seconds
[0m20:37:29.974554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBEC8EBF0>]}
[0m20:37:29.979541 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:37:29.979541 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:37:29.980538 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:37:29.981536 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:37:29.990512 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:37:29.992507 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:37:30.023423 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:37:30.025418 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:37:30.026415 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with flights as (

    /* one record per booking */
    select
        origin || '-' || destination      as route,
        marketing_carrier_code,                     
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    /* bookings operated by each carrier on each route */
    select
        route,
        carrier_code,
        count(*)                          as flight_bookings
    from flights
    group by
        route,
        carrier_code

), hhi_calc as (

    /* Herfindahl-Hirschman Index */
    select
        route,
        sum(flight_bookings)                              as total_bookings,
        sum(power(flight_bookings, 2))
            / power(sum(flight_bookings), 2)              as hhi,
        count(distinct carrier_code)                      as carrier_count
    from carrier_flights
    group by route

)

select
    route,
    carrier_count,
    hhi                                                 -- 1 = monopoly, < 0.2 highly competitive
from hhi_calc
        );
[0m20:37:30.026415 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:37:33.745464 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8da-0305-0f94-0006-8fdb00186e0a
[0m20:37:33.745464 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 10 at position 8
invalid identifier 'MARKETING_CARRIER_CODE'
[0m20:37:33.748456 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'MARKETING_CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:37:33.750450 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f1ca7dc-7e5b-4a18-8eff-f3b25412ed97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBE0626E0>]}
[0m20:37:33.751448 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.77s]
[0m20:37:33.752446 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:37:33.753443 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'MARKETING_CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:37:33.755438 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:37:33.755438 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:37:33.756435 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:37:34.085554 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:37:34.086551 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:37:34.411681 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:37:34.412678 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:37:34.752769 [info ] [MainThread]: 
[0m20:37:34.753766 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.50 seconds (13.50s).
[0m20:37:34.754764 [debug] [MainThread]: Command end result
[0m20:37:34.787675 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:37:34.791665 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:37:34.798646 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:37:34.799644 [info ] [MainThread]: 
[0m20:37:34.800641 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:37:34.801639 [info ] [MainThread]: 
[0m20:37:34.801639 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'MARKETING_CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:37:34.802636 [info ] [MainThread]: 
[0m20:37:34.803633 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:37:34.805627 [debug] [MainThread]: Command `dbt run` failed at 20:37:34.804630 after 16.02 seconds
[0m20:37:34.805627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEB401D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBF7C64D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEBF7C7CA0>]}
[0m20:37:34.806625 [debug] [MainThread]: Flushing usage events
[0m20:37:35.169653 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:38:06.732200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42951D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42AC59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42AC59EA0>]}


============================== 20:38:06.736189 | b7201f1e-63dc-4140-80c9-f1e7e94c1b1d ==============================
[0m20:38:06.736189 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:38:06.737187 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run -m int_route_competition', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:38:07.652737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D427797040>]}
[0m20:38:07.713574 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42A4FE2C0>]}
[0m20:38:07.714572 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:38:08.293024 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:38:08.593220 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:38:08.594218 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m20:38:08.963230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433F70DF0>]}
[0m20:38:09.108841 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:38:09.111833 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:38:09.135769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433F91C30>]}
[0m20:38:09.136766 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:38:09.137764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433EE7AF0>]}
[0m20:38:09.139758 [info ] [MainThread]: 
[0m20:38:09.139758 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:38:09.140756 [info ] [MainThread]: 
[0m20:38:09.141753 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:38:09.142751 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:38:09.251459 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:38:09.251459 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:38:09.252456 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:38:14.402676 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.150 seconds
[0m20:38:14.410654 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:38:14.420628 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:38:14.421625 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:38:14.422622 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:38:18.175580 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.753 seconds
[0m20:38:18.179569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433F91DE0>]}
[0m20:38:18.184556 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:38:18.185554 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:38:18.186551 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:38:18.186551 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:38:18.194530 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:38:18.196524 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:38:18.227441 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:38:18.229436 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:38:18.230434 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

with flights as (

    /* one record per booking */
    select
        origin || '-' || destination      as route,
        marketing_carrier,                     
        flight_date
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), carrier_flights as (

    /* bookings operated by each carrier on each route */
    select
        route,
        carrier_code,
        count(*)                          as flight_bookings
    from flights
    group by
        route,
        carrier_code

), hhi_calc as (

    /* Herfindahl-Hirschman Index */
    select
        route,
        sum(flight_bookings)                              as total_bookings,
        sum(power(flight_bookings, 2))
            / power(sum(flight_bookings), 2)              as hhi,
        count(distinct carrier_code)                      as carrier_count
    from carrier_flights
    group by route

)

select
    route,
    carrier_count,
    hhi                                                 -- 1 = monopoly, < 0.2 highly competitive
from hhi_calc
        );
[0m20:38:18.231431 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:38:21.823819 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8db-0305-0fb8-0006-8fdb00187c7e
[0m20:38:21.824816 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 19 at position 8
invalid identifier 'CARRIER_CODE'
[0m20:38:21.826811 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 19 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:38:21.829803 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b7201f1e-63dc-4140-80c9-f1e7e94c1b1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D433463E50>]}
[0m20:38:21.829803 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.64s]
[0m20:38:21.831798 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:38:21.831798 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 19 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:38:21.833792 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:38:21.834790 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:38:21.834790 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:38:22.182858 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:38:22.182858 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:38:22.521951 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:38:22.522948 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:38:22.872015 [info ] [MainThread]: 
[0m20:38:22.873012 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.73 seconds (13.73s).
[0m20:38:22.874009 [debug] [MainThread]: Command end result
[0m20:38:22.906921 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:38:22.909913 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:38:22.918889 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:38:22.918889 [info ] [MainThread]: 
[0m20:38:22.920884 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:38:22.921881 [info ] [MainThread]: 
[0m20:38:22.922879 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  000904 (42000): SQL compilation error: error line 19 at position 8
  invalid identifier 'CARRIER_CODE'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:38:22.923875 [info ] [MainThread]: 
[0m20:38:22.923875 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:38:22.925870 [debug] [MainThread]: Command `dbt run` failed at 20:38:22.925870 after 16.27 seconds
[0m20:38:22.926868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D42951D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4295D72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D434CC7D00>]}
[0m20:38:22.927865 [debug] [MainThread]: Flushing usage events
[0m20:38:23.273938 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:39:57.901739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA3C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA5359CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA5359ED0>]}


============================== 20:39:57.905728 | fa804bf1-2856-43a1-b457-aa88ae4d4809 ==============================
[0m20:39:57.905728 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:39:57.906727 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run -m int_route_competition', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:39:58.812303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA2097010>]}
[0m20:39:58.872142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFADC60460>]}
[0m20:39:58.874137 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:39:59.444610 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:39:59.739820 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:39:59.740818 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m20:40:00.109830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAE870DC0>]}
[0m20:40:00.254444 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:40:00.257436 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:40:00.281372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAE891960>]}
[0m20:40:00.282370 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:40:00.283366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAE893940>]}
[0m20:40:00.285361 [info ] [MainThread]: 
[0m20:40:00.286359 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:40:00.286359 [info ] [MainThread]: 
[0m20:40:00.287356 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:40:00.288353 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:40:00.397062 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:40:00.398059 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:40:00.399057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:40:04.853139 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.454 seconds
[0m20:40:04.860120 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:40:04.871090 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:40:04.872088 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:40:04.872088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:40:08.486418 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.614 seconds
[0m20:40:08.491404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAE893790>]}
[0m20:40:08.495393 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:40:08.496390 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:40:08.497388 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:40:08.498385 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:40:08.506364 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:40:08.508359 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:40:08.541271 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:40:08.543265 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:40:08.544262 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

-- ────────────────────────────────────────────────────────────────────────────────
-- 1 ·  Base rows: one record per booking
-- ────────────────────────────────────────────────────────────────────────────────
with base as (

    select
        /* canonical route key */
        origin || '-' || destination            as route,

        /* airline operating (first marketing carrier) */
        marketing_carrier,                      -- ← must exist in stg_fare_searches

        /* optional: keep flight_date so we can aggregate by period later */
        flight_date

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

    /* safeguard: ignore records with no carrier code */
    where marketing_carrier is not null

),


-- ────────────────────────────────────────────────────────────────────────────────
-- 2 ·  Count bookings per carrier on each route
-- ────────────────────────────────────────────────────────────────────────────────
carrier_flights as (

    select
        route,
        marketing_carrier,
        count(*)                                as flight_bookings
    from base
    group by
        route,
        marketing_carrier

),

-- ────────────────────────────────────────────────────────────────────────────────
-- 3 ·  Competition metrics (HHI + carrier_count)
--     HHI = Σ(sᵢ²) where sᵢ = share of bookings for carrier i on the route
-- ────────────────────────────────────────────────────────────────────────────────
concentration as (

    select
        route,

        /* denominator for shares */
        sum(flight_bookings)                         as total_bookings,

        /* Herfindahl-Hirschman Index */
        sum( power(flight_bookings, 2) )
            / power(sum(flight_bookings), 2)         as hhi,

        /* # distinct carriers */
        count(marketing_carrier)                     as carrier_count
    from carrier_flights
    group by route

)

-- ────────────────────────────────────────────────────────────────────────────────
-- 4 ·  Final output
-- ────────────────────────────────────────────────────────────────────────────────
select
    route,
    carrier_count,      -- e.g. 1  = monopoly, 2+ = competing carriers
    hhi                 -- 1.0 = pure monopoly; < 0.20 = highly competitive
from concentration;
[0m20:40:08.545260 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:40:12.154602 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe8dc-0305-0c96-0006-8fdb0018975a
[0m20:40:12.154602 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 74 at position 18 unexpected ';'.
[0m20:40:12.157595 [debug] [Thread-1 (]: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 74 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:40:12.159589 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa804bf1-2856-43a1-b457-aa88ae4d4809', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFADC63E80>]}
[0m20:40:12.160586 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_competition ...... [[31mERROR[0m in 3.66s]
[0m20:40:12.161584 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:40:12.162581 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_competition' to be skipped because of status 'error'.  Reason: Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 74 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql.
[0m20:40:12.163578 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:40:12.164575 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:40:12.165573 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:40:12.509652 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:40:12.510649 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:40:12.866697 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:40:12.867694 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:40:13.199806 [info ] [MainThread]: 
[0m20:40:13.200803 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.91 seconds (12.91s).
[0m20:40:13.201800 [debug] [MainThread]: Command end result
[0m20:40:13.232717 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:40:13.235710 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:40:13.243689 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:40:13.244686 [info ] [MainThread]: 
[0m20:40:13.245683 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m20:40:13.245683 [info ] [MainThread]: 
[0m20:40:13.246680 [error] [MainThread]:   Database Error in model int_route_competition (models\intermediate\int_route_competition.sql)
  001003 (42000): SQL compilation error:
  syntax error line 74 at position 18 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_competition.sql
[0m20:40:13.247677 [info ] [MainThread]: 
[0m20:40:13.248676 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:40:13.250670 [debug] [MainThread]: Command `dbt run` failed at 20:40:13.250670 after 15.43 seconds
[0m20:40:13.251667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA3C1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFA3CBF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFAF3C6620>]}
[0m20:40:13.252664 [debug] [MainThread]: Flushing usage events
[0m20:40:13.597740 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:40:22.719333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422541D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014226B5DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014226B5E1D0>]}


============================== 20:40:22.723323 | d39fd974-1a14-43c8-bfd2-224067c78ad3 ==============================
[0m20:40:22.723323 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:40:22.724321 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run -m int_route_competition', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:40:23.626906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422F460640>]}
[0m20:40:23.686745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422F4623B0>]}
[0m20:40:23.687742 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m20:40:24.257218 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m20:40:24.550434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:40:24.551431 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_competition.sql
[0m20:40:24.918449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230070D30>]}
[0m20:40:25.065057 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:40:25.067051 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:40:25.090988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230091A80>]}
[0m20:40:25.091985 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m20:40:25.092982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422FDE4DF0>]}
[0m20:40:25.094977 [info ] [MainThread]: 
[0m20:40:25.095974 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m20:40:25.095974 [info ] [MainThread]: 
[0m20:40:25.096972 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m20:40:25.097969 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m20:40:25.207676 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m20:40:25.207676 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m20:40:25.208672 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:40:29.473262 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.264 seconds
[0m20:40:29.481240 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m20:40:29.491213 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m20:40:29.492211 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m20:40:29.493209 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:40:33.297030 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.804 seconds
[0m20:40:33.301019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014230092AA0>]}
[0m20:40:33.306007 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m20:40:33.307004 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m20:40:33.308001 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m20:40:33.308001 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m20:40:33.316977 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m20:40:33.319970 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m20:40:33.350886 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m20:40:33.353878 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m20:40:33.354876 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

-- ────────────────────────────────────────────────────────────────────────────────
-- 1 ·  Base rows: one record per booking
-- ────────────────────────────────────────────────────────────────────────────────
with base as (

    select
        /* canonical route key */
        origin || '-' || destination            as route,

        /* airline operating (first marketing carrier) */
        marketing_carrier,                      -- ← must exist in stg_fare_searches

        /* optional: keep flight_date so we can aggregate by period later */
        flight_date

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

    /* safeguard: ignore records with no carrier code */
    where marketing_carrier is not null

),


-- ────────────────────────────────────────────────────────────────────────────────
-- 2 ·  Count bookings per carrier on each route
-- ────────────────────────────────────────────────────────────────────────────────
carrier_flights as (

    select
        route,
        marketing_carrier,
        count(*)                                as flight_bookings
    from base
    group by
        route,
        marketing_carrier

),

-- ────────────────────────────────────────────────────────────────────────────────
-- 3 ·  Competition metrics (HHI + carrier_count)
--     HHI = Σ(sᵢ²) where sᵢ = share of bookings for carrier i on the route
-- ────────────────────────────────────────────────────────────────────────────────
concentration as (

    select
        route,

        /* denominator for shares */
        sum(flight_bookings)                         as total_bookings,

        /* Herfindahl-Hirschman Index */
        sum( power(flight_bookings, 2) )
            / power(sum(flight_bookings), 2)         as hhi,

        /* # distinct carriers */
        count(marketing_carrier)                     as carrier_count
    from carrier_flights
    group by route

)

-- ────────────────────────────────────────────────────────────────────────────────
-- 4 ·  Final output
-- ────────────────────────────────────────────────────────────────────────────────
select
    route,
    carrier_count,      -- e.g. 1  = monopoly, 2+ = competing carriers
    hhi                 -- 1.0 = pure monopoly; < 0.20 = highly competitive
from concentration
        );
[0m20:40:33.354876 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m20:40:39.966185 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.611 seconds
[0m20:40:39.991119 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd39fd974-1a14-43c8-bfd2-224067c78ad3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422F463370>]}
[0m20:40:39.992116 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_competition .......... [[32mSUCCESS 1[0m in 6.68s]
[0m20:40:39.993113 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m20:40:39.995108 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:40:39.995108 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m20:40:39.996106 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m20:40:40.343177 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m20:40:40.343177 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m20:40:40.702216 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m20:40:40.703215 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m20:40:41.041308 [info ] [MainThread]: 
[0m20:40:41.042308 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 15.94 seconds (15.94s).
[0m20:40:41.044301 [debug] [MainThread]: Command end result
[0m20:40:41.083197 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m20:40:41.088184 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m20:40:41.099155 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m20:40:41.100152 [info ] [MainThread]: 
[0m20:40:41.101149 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:40:41.102146 [info ] [MainThread]: 
[0m20:40:41.104141 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:40:41.106135 [debug] [MainThread]: Command `dbt run` succeeded at 20:40:41.106135 after 18.47 seconds
[0m20:40:41.106135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422541D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001422FD49000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000142254D7E50>]}
[0m20:40:41.107133 [debug] [MainThread]: Flushing usage events
[0m20:40:41.473154 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:48:25.250041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364F91D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365105A2F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365105A110>]}


============================== 21:48:25.254030 | d00b70d8-9872-4bf3-9f45-da04abc034f2 ==============================
[0m21:48:25.254030 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:48:25.255028 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run -m stg_route_stats', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:48:31.147262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364DB97040>]}
[0m21:48:31.207101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236597631F0>]}
[0m21:48:31.214083 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:48:31.869329 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:48:33.280554 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:48:33.281551 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:48:33.418185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365A033A90>]}
[0m21:48:33.563795 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:48:33.576761 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:48:33.791187 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365A031AE0>]}
[0m21:48:33.791187 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:48:33.792185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365A0312A0>]}
[0m21:48:33.794179 [info ] [MainThread]: 
[0m21:48:33.795177 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:48:33.795177 [info ] [MainThread]: 
[0m21:48:33.796174 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:48:33.797171 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:48:36.220686 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:48:36.221684 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:48:36.222681 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:48:40.118258 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.896 seconds
[0m21:48:40.135212 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:48:40.169122 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:48:40.170119 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:48:40.172114 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:48:43.925071 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.753 seconds
[0m21:48:43.930058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023659A49540>]}
[0m21:48:43.938036 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m21:48:43.939034 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m21:48:43.940031 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_route_stats'
[0m21:48:43.940031 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m21:48:43.949007 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m21:48:43.950004 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m21:48:43.984911 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m21:48:43.987903 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m21:48:43.987903 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m21:48:43.988900 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:48:58.845973 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 14.858 seconds
[0m21:48:58.878886 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00b70d8-9872-4bf3-9f45-da04abc034f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365ACA3880>]}
[0m21:48:58.879883 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 14.93s]
[0m21:48:58.881878 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m21:48:58.882874 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:48:58.883385 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:48:58.884377 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:48:59.274854 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:48:59.275852 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:48:59.628906 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_route_stats' was left open.
[0m21:48:59.629904 [debug] [MainThread]: On model.fair_pricing_radar.stg_route_stats: Close
[0m21:48:59.971989 [info ] [MainThread]: 
[0m21:48:59.972986 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 26.18 seconds (26.18s).
[0m21:48:59.973984 [debug] [MainThread]: Command end result
[0m21:49:00.009887 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:49:00.012880 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:49:00.021855 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:49:00.022853 [info ] [MainThread]: 
[0m21:49:00.023851 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:49:00.023851 [info ] [MainThread]: 
[0m21:49:00.025846 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:49:00.026842 [debug] [MainThread]: Command `dbt run` succeeded at 21:49:00.026842 after 34.86 seconds
[0m21:49:00.027839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364F91D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365A1BF670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002365A1BE6B0>]}
[0m21:49:00.028836 [debug] [MainThread]: Flushing usage events
[0m21:49:00.389870 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:49:32.323952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478501D210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478675DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478675E1A0>]}


============================== 21:49:32.327942 | 08fa76d7-59b3-4374-9497-47ebbc5e6aa8 ==============================
[0m21:49:32.327942 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:49:32.328940 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_route_fare_per_mi_stats', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:49:33.226552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478ED614B0>]}
[0m21:49:33.286392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000247865BD030>]}
[0m21:49:33.287389 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:49:33.855868 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:49:34.134629 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:49:34.135627 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:49:34.272766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478F6B7DF0>]}
[0m21:49:34.419374 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:49:34.421368 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:49:34.446302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478F6B7670>]}
[0m21:49:34.447299 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:49:34.448297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478F06D930>]}
[0m21:49:34.450292 [info ] [MainThread]: 
[0m21:49:34.450292 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:49:34.451289 [info ] [MainThread]: 
[0m21:49:34.452286 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:49:34.454281 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:49:34.564984 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:49:34.565981 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:49:34.565981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:49:38.800210 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.234 seconds
[0m21:49:38.807191 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:49:38.818162 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:49:38.819159 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:49:38.819159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:49:42.398633 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.579 seconds
[0m21:49:42.403620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478F6B4130>]}
[0m21:49:42.408607 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:49:42.408607 [info ] [Thread-1 (]: 1 of 1 START sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats ... [RUN]
[0m21:49:42.409604 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m21:49:42.410602 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:49:42.419578 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:42.421572 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:49:42.473433 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:42.474431 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace  temporary view FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
  
   as (
    

-------------------------------------------------------------------
-- 1.  Search–level facts
-------------------------------------------------------------------
with base as (

    select
        legid,
        search_date,
        flight_date,

        days_to_flight,           -- use the correct column name

        route,
        origin,
        destination,
        fare_bucket,

        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,

        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-------------------------------------------------------------------
-- 2.  Route benchmarks (already pre-computed)
-------------------------------------------------------------------
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-------------------------------------------------------------------
-- 3.  Join + metrics
-------------------------------------------------------------------
joined as (

    select
        b.*,

        -- benchmarks ----------------------------------------------------------
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        br.legs_sampled,

        -- σ  ~=  (p95 – p50) / 1.645  
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                                  as usd_per_mi_z,

        -- premium flags -------------------------------------------------------
        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                                  as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                                  as is_above_p97

    from base b
    left join bench br
      on b.route       = br.route
     and b.fare_bucket = br.fare_bucket

)

-------------------------------------------------------------------
-- 4.  Final select + incremental filter
-------------------------------------------------------------------
select * from joined j
  );
[0m21:49:42.475428 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:49:46.561041 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 4.086 seconds
[0m21:49:46.570018 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:46.570018 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m21:49:46.771986 [debug] [Thread-1 (]: SQL status: SUCCESS 25 in 0.201 seconds
[0m21:49:46.776969 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:46.777967 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
[0m21:49:47.008350 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.229 seconds
[0m21:49:47.015331 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:47.016329 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
describe table "FLIGHT_PRICES"."WALRUS_PUBLIC"."INT_ROUTE_FARE_PER_MI_STATS"
[0m21:49:47.219785 [debug] [Thread-1 (]: SQL status: SUCCESS 2 in 0.203 seconds
[0m21:49:47.233747 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:47.235742 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:47.235742 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
-- back compat for old kwarg name
  
  begin;
[0m21:49:47.475614 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.239 seconds
[0m21:49:47.476612 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:47.477610 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
insert into FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats ("ROUTE", "P95_USD_PER_MI")
        (
            select "ROUTE", "P95_USD_PER_MI"
            from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
        );
[0m21:49:53.941390 [debug] [Thread-1 (]: SQL status: SUCCESS 77239984 in 6.463 seconds
[0m21:49:53.941390 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:53.942388 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
COMMIT
[0m21:49:54.291464 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.348 seconds
[0m21:49:54.299443 [debug] [Thread-1 (]: Applying DROP to: FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp
[0m21:49:54.305426 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:49:54.306424 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
drop view if exists FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats__dbt_tmp cascade
[0m21:49:54.561740 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 0.255 seconds
[0m21:49:54.581687 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '08fa76d7-59b3-4374-9497-47ebbc5e6aa8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478ED63F40>]}
[0m21:49:54.582684 [info ] [Thread-1 (]: 1 of 1 OK created sql incremental model WALRUS_PUBLIC.int_route_fare_per_mi_stats  [[32mSUCCESS 77239984[0m in 12.17s]
[0m21:49:54.583682 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:49:54.585677 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:49:54.585677 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:49:54.586674 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:49:54.959676 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:49:54.959676 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:49:55.299272 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m21:49:55.300269 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m21:49:55.668299 [info ] [MainThread]: 
[0m21:49:55.669297 [info ] [MainThread]: Finished running 1 incremental model in 0 hours 0 minutes and 21.22 seconds (21.22s).
[0m21:49:55.671291 [debug] [MainThread]: Command end result
[0m21:49:55.720160 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:49:55.725656 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:49:55.738621 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:49:55.741614 [info ] [MainThread]: 
[0m21:49:55.743608 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:49:55.744606 [info ] [MainThread]: 
[0m21:49:55.745603 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:49:55.748595 [debug] [MainThread]: Command `dbt run` succeeded at 21:49:55.748595 after 23.50 seconds
[0m21:49:55.749592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478501D210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002478508DF90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024790399600>]}
[0m21:49:55.750590 [debug] [MainThread]: Flushing usage events
[0m21:49:56.100162 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:50:01.486850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018407F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018409659CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018409659EA0>]}


============================== 21:50:01.490839 | 901f0005-1da7-4c3a-9a11-21e9da7d868c ==============================
[0m21:50:01.490839 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:50:01.491837 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_rules_r1_r2_r3', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:50:02.402905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018406197040>]}
[0m21:50:02.465244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018408F022C0>]}
[0m21:50:02.466241 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:50:03.035235 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:50:03.315485 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:50:03.315485 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:50:03.456109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184126BBA90>]}
[0m21:50:03.603715 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:50:03.605709 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:50:03.629645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001841204A620>]}
[0m21:50:03.630643 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:50:03.631640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184126B81F0>]}
[0m21:50:03.633634 [info ] [MainThread]: 
[0m21:50:03.634632 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:50:03.634632 [info ] [MainThread]: 
[0m21:50:03.635629 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:50:03.636627 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:50:03.747330 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:50:03.747330 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:50:03.748327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:50:07.197131 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.449 seconds
[0m21:50:07.205109 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:50:07.216079 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:50:07.216079 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:50:07.217077 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:50:10.959632 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.743 seconds
[0m21:50:10.964619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018412048460>]}
[0m21:50:10.969605 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m21:50:10.969605 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m21:50:10.970604 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m21:50:10.971601 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m21:50:10.980576 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m21:50:10.981574 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m21:50:11.014486 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m21:50:11.017477 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m21:50:11.018475 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (

-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    -- percentile benchmarks
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches     as s

  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    using (route, fare_bucket)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    using (route)

),

-- 2. Apply Rules 1–3
rules as (

  select
    *,
    /* Rule 1: statistical outlier */
    case
      when (
        (usd_per_mi - p50_usd_per_mi)
          / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
      ) >= 2
    then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
        and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
        and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag = 1
      or r2_seat_scarcity_flag = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m21:50:11.018475 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:50:44.509816 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 33.490 seconds
[0m21:50:44.532755 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '901f0005-1da7-4c3a-9a11-21e9da7d868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018412FF94E0>]}
[0m21:50:44.533752 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 33.56s]
[0m21:50:44.534749 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m21:50:44.536744 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:50:44.536744 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:50:44.537742 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:50:44.883815 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:50:44.884812 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:50:45.239862 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m21:50:45.240860 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m21:50:45.576467 [info ] [MainThread]: 
[0m21:50:45.576467 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 41.94 seconds (41.94s).
[0m21:50:45.578462 [debug] [MainThread]: Command end result
[0m21:50:45.610377 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:50:45.613369 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:50:45.621347 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:50:45.622346 [info ] [MainThread]: 
[0m21:50:45.623861 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:50:45.624849 [info ] [MainThread]: 
[0m21:50:45.625846 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:50:45.626843 [debug] [MainThread]: Command `dbt run` succeeded at 21:50:45.626843 after 44.22 seconds
[0m21:50:45.628839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018407F1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018408F022C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184127D3B80>]}
[0m21:50:45.628839 [debug] [MainThread]: Flushing usage events
[0m21:50:45.973915 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:51:14.286574 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340A41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340BB5DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340BB5E140>]}


============================== 21:51:14.290563 | 0c90be6a-5479-4b4c-8be2-7f2d099753d8 ==============================
[0m21:51:14.290563 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:51:14.291561 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run -m int_fare_per_mi_stats', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:51:15.245513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c90be6a-5479-4b4c-8be2-7f2d099753d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340BB32890>]}
[0m21:51:15.307852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c90be6a-5479-4b4c-8be2-7f2d099753d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340B992D70>]}
[0m21:51:15.308849 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:51:15.880834 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:51:16.164076 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:51:16.165074 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:51:16.300711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c90be6a-5479-4b4c-8be2-7f2d099753d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023414C19210>]}
[0m21:51:16.446321 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:51:16.449313 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:51:16.475244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c90be6a-5479-4b4c-8be2-7f2d099753d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023414C18760>]}
[0m21:51:16.476241 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:51:16.477239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c90be6a-5479-4b4c-8be2-7f2d099753d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023414C1A710>]}
[0m21:51:16.478236 [warn ] [MainThread]: The selection criterion 'int_fare_per_mi_stats' does not match any enabled nodes
[0m21:51:16.479233 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m21:51:16.481228 [debug] [MainThread]: Command end result
[0m21:51:16.514646 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:51:16.517636 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:51:16.521625 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:51:16.522622 [debug] [MainThread]: Command `dbt run` succeeded at 21:51:16.522622 after 2.32 seconds
[0m21:51:16.523619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340A41D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002340B992D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023414BBF700>]}
[0m21:51:16.524617 [debug] [MainThread]: Flushing usage events
[0m21:51:16.874681 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:52:15.687199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C1D1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C3456560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C3456740>]}


============================== 21:52:15.691188 | ffef2b90-51c6-4c7e-9e09-8fed1fcceee7 ==============================
[0m21:52:15.691188 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:52:15.692186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run -m int_fare_legs', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:52:16.829173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C34320B0>]}
[0m21:52:16.927418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CBC61240>]}
[0m21:52:16.929413 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:52:17.586653 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:52:17.895333 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:52:17.896330 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:52:18.045930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CC3BBAC0>]}
[0m21:52:18.211487 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:52:18.214479 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:52:18.241407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CC51FCA0>]}
[0m21:52:18.241407 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:52:18.243402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CBD48370>]}
[0m21:52:18.245396 [info ] [MainThread]: 
[0m21:52:18.246393 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:52:18.247392 [info ] [MainThread]: 
[0m21:52:18.248388 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:52:18.249386 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:52:18.412960 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:52:18.413957 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:52:18.413957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:52:21.615437 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.201 seconds
[0m21:52:21.622419 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:52:21.633389 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:52:21.634386 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:52:21.635385 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:52:25.205378 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.570 seconds
[0m21:52:25.210365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CC51FE20>]}
[0m21:52:25.214355 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m21:52:25.215352 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m21:52:25.216350 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m21:52:25.216350 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m21:52:25.225325 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m21:52:25.226323 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m21:52:25.262226 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m21:52:25.265219 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m21:52:25.266216 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Bring in the arrays we need */
    select
        LEGID,
        dep_airport_arr,
        arr_airport_arr,
        seg_airline_arr,
        seg_dist_arr,
        seg_dur_arr
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * Use FLATTEN to explode index positions.
     * For each index, pull the matching element from every array.
     */
    select
        b.LEGID,
        f.index + 1                                                 as leg_number,

        trim(replace(b.dep_airport_arr[f.index] , '\"',''))        as departure_airport,
        trim(replace(b.arr_airport_arr[f.index] , '\"',''))        as arrival_airport,

        trim(replace(b.seg_airline_arr[f.index] ,  '\"',''))       as operating_carrier,

        /* distance & duration arrays may contain blanks—try_to_number keeps nulls */
        try_to_number( trim(replace(b.seg_dist_arr[f.index],'\"','')) ) as leg_distance,
        try_to_number( trim(replace(b.seg_dur_arr[f.index] ,'\"','')) ) as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f

)

select
    LEGID,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened
        );
[0m21:52:25.267214 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:52:29.014241 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe925-0305-0bba-0006-8fdb0018a9aa
[0m21:52:29.014241 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 10 at position 8
invalid identifier 'DEP_AIRPORT_ARR'
[0m21:52:29.017233 [debug] [Thread-1 (]: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'DEP_AIRPORT_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m21:52:29.019227 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffef2b90-51c6-4c7e-9e09-8fed1fcceee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5BECCE560>]}
[0m21:52:29.020225 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_fare_legs .............. [[31mERROR[0m in 3.80s]
[0m21:52:29.021222 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m21:52:29.022220 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_fare_legs' to be skipped because of status 'error'.  Reason: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'DEP_AIRPORT_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql.
[0m21:52:29.024214 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:52:29.024214 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:52:29.025212 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:52:29.364304 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:52:29.365302 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:52:29.729832 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m21:52:29.730829 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m21:52:30.081900 [info ] [MainThread]: 
[0m21:52:30.082898 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 11.83 seconds (11.83s).
[0m21:52:30.083896 [debug] [MainThread]: Command end result
[0m21:52:30.115810 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:52:30.118803 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:52:30.127779 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:52:30.128776 [info ] [MainThread]: 
[0m21:52:30.129774 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m21:52:30.130771 [info ] [MainThread]: 
[0m21:52:30.131768 [error] [MainThread]:   Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  000904 (42000): SQL compilation error: error line 10 at position 8
  invalid identifier 'DEP_AIRPORT_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m21:52:30.132766 [info ] [MainThread]: 
[0m21:52:30.133278 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:52:30.136265 [debug] [MainThread]: Command `dbt run` failed at 21:52:30.136265 after 14.53 seconds
[0m21:52:30.137262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C1D1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CC4BD900>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C1DBF1F0>]}
[0m21:52:30.138260 [debug] [MainThread]: Flushing usage events
[0m21:52:30.482842 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:54:22.400084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228C451D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228C5C5DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228C5C5E1D0>]}


============================== 21:54:22.405070 | ebe08e28-2d40-4595-b989-f15d03c72d6c ==============================
[0m21:54:22.405070 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:54:22.406068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_fare_per_mi_stats', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:54:23.437323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ebe08e28-2d40-4595-b989-f15d03c72d6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CE360640>]}
[0m21:54:23.505141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ebe08e28-2d40-4595-b989-f15d03c72d6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CE3623B0>]}
[0m21:54:23.507136 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:54:24.122490 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:54:24.440638 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:54:24.442633 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_fare_per_mi_stats.sql
[0m21:54:24.871989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ebe08e28-2d40-4595-b989-f15d03c72d6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CF17CD30>]}
[0m21:54:25.026084 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:54:25.029075 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:54:25.056003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ebe08e28-2d40-4595-b989-f15d03c72d6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CF18DA50>]}
[0m21:54:25.056003 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:54:25.057001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ebe08e28-2d40-4595-b989-f15d03c72d6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CF18F7F0>]}
[0m21:54:25.057998 [warn ] [MainThread]: The selection criterion 'int_fare_per_mi_stats' does not match any enabled nodes
[0m21:54:25.059993 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m21:54:25.060990 [debug] [MainThread]: Command end result
[0m21:54:25.097892 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:54:25.100884 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:54:25.107865 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:54:25.109860 [debug] [MainThread]: Command `dbt run` succeeded at 21:54:25.108863 after 2.80 seconds
[0m21:54:25.109860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228C451D240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CE37C7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228CF047070>]}
[0m21:54:25.110857 [debug] [MainThread]: Flushing usage events
[0m21:54:25.456930 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:55:17.929908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA561D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA6D59D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA6D59F00>]}


============================== 21:55:17.933897 | c3f93f43-cbe5-4958-89a8-b236011cb2f7 ==============================
[0m21:55:17.933897 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:55:17.934895 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_fare_legs', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:55:18.826521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA3797040>]}
[0m21:55:18.885363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CAF3631F0>]}
[0m21:55:18.886361 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:55:19.449853 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:55:19.742071 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:55:19.743069 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m21:55:20.104114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CAFF7CDC0>]}
[0m21:55:20.245735 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:55:20.247729 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:55:20.271665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CAFF8F610>]}
[0m21:55:20.272663 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:55:20.273660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CAFEA8F10>]}
[0m21:55:20.275655 [info ] [MainThread]: 
[0m21:55:20.275655 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:55:20.276652 [info ] [MainThread]: 
[0m21:55:20.277650 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:55:20.278647 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:55:20.388353 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:55:20.389350 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:55:20.389350 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:23.803750 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.414 seconds
[0m21:55:23.810731 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:55:23.821701 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:55:23.822699 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:55:23.822699 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:27.644032 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.821 seconds
[0m21:55:27.648021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CAFF8F8E0>]}
[0m21:55:27.653008 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m21:55:27.654005 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m21:55:27.655003 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m21:55:27.655003 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m21:55:27.662981 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m21:55:27.664976 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m21:55:27.695893 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m21:55:27.697888 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m21:55:27.698885 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Pull the raw pipe-delimited strings from staging */
    select
        legid,

        -- turn each pipe-delimited string into an ARRAY
        split(trim(segmentsdepartureairportcode), '||')  as dep_airport_arr,
        split(trim(segmentsarrivalairportcode),   '||')  as arr_airport_arr,
        split(trim(segmentsairlinecode),          '||')  as seg_airline_arr,
        split(trim(segmentsdistance),             '||')  as seg_dist_arr,
        split(trim(segmentsdurationinseconds),    '||')  as seg_dur_arr

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * FLATTEN explodes the arrays.  `f.index` is the 0-based position.
     * For each position, pull the matching element from every array.
     */
    select
        b.legid,
        f.index + 1                                                   as leg_number,

        trim(replace(b.dep_airport_arr[f.index], '\"',''))            as departure_airport,
        trim(replace(b.arr_airport_arr[f.index], '\"',''))            as arrival_airport,
        trim(replace(b.seg_airline_arr[f.index],  '\"',''))           as operating_carrier,

        try_to_number(
            trim(replace(b.seg_dist_arr[f.index], '\"',''))
        )                                                             as leg_distance,

        try_to_number(
            trim(replace(b.seg_dur_arr[f.index],  '\"',''))
        )                                                             as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f                -- drive the explode

)

select
    legid,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened;
[0m21:55:27.699882 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:55:31.517214 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe928-0305-0bba-0006-8fdb0018aa16
[0m21:55:31.518212 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 55 at position 14 unexpected ';'.
[0m21:55:31.520206 [debug] [Thread-1 (]: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 55 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m21:55:31.522201 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c3f93f43-cbe5-4958-89a8-b236011cb2f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA35CF4F0>]}
[0m21:55:31.523198 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_fare_legs .............. [[31mERROR[0m in 3.87s]
[0m21:55:31.524196 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m21:55:31.525193 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_fare_legs' to be skipped because of status 'error'.  Reason: Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 55 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql.
[0m21:55:31.527187 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:55:31.527187 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:55:31.528185 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:55:31.871267 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:55:31.871267 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:55:32.229309 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m21:55:32.229309 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m21:55:32.569902 [info ] [MainThread]: 
[0m21:55:32.570900 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.29 seconds (12.29s).
[0m21:55:32.572894 [debug] [MainThread]: Command end result
[0m21:55:32.603812 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:55:32.605806 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:55:32.614783 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:55:32.614783 [info ] [MainThread]: 
[0m21:55:32.615780 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m21:55:32.616777 [info ] [MainThread]: 
[0m21:55:32.616777 [error] [MainThread]:   Database Error in model int_fare_legs (models\intermediate\int_fare_legs.sql)
  001003 (42000): SQL compilation error:
  syntax error line 55 at position 14 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_fare_legs.sql
[0m21:55:32.617775 [info ] [MainThread]: 
[0m21:55:32.618772 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:55:32.620766 [debug] [MainThread]: Command `dbt run` failed at 21:55:32.620766 after 14.77 seconds
[0m21:55:32.620766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA561D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CA56D72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020CB0CC7A90>]}
[0m21:55:32.621763 [debug] [MainThread]: Flushing usage events
[0m21:55:32.961360 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:55:41.728088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8B81D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8CF59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8CF59EA0>]}


============================== 21:55:41.732077 | 9b44702a-3f01-4412-a005-1c16a3d8738b ==============================
[0m21:55:41.732077 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:55:41.733075 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run -m int_fare_legs', 'send_anonymous_usage_stats': 'True'}
[0m21:55:42.627681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8CF320B0>]}
[0m21:55:42.687521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F95861240>]}
[0m21:55:42.689516 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:55:43.248031 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:55:43.539252 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:55:43.540249 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_fare_legs.sql
[0m21:55:43.906270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F9646CD90>]}
[0m21:55:44.047892 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:55:44.050884 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:55:44.074326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F9648F490>]}
[0m21:55:44.075324 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:55:44.075324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F961E6140>]}
[0m21:55:44.077318 [info ] [MainThread]: 
[0m21:55:44.078316 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:55:44.079313 [info ] [MainThread]: 
[0m21:55:44.079313 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:55:44.081308 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:55:44.187024 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:55:44.188022 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:55:44.188022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:47.391995 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.204 seconds
[0m21:55:47.399973 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:55:47.409947 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:55:47.410944 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:55:47.411941 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:51.252222 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.841 seconds
[0m21:55:51.257209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F9648F730>]}
[0m21:55:51.261198 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m21:55:51.262196 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m21:55:51.263194 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m21:55:51.263194 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m21:55:51.272169 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m21:55:51.273166 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m21:55:51.305081 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m21:55:51.308073 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m21:55:51.309070 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Pull the raw pipe-delimited strings from staging */
    select
        legid,

        -- turn each pipe-delimited string into an ARRAY
        split(trim(segmentsdepartureairportcode), '||')  as dep_airport_arr,
        split(trim(segmentsarrivalairportcode),   '||')  as arr_airport_arr,
        split(trim(segmentsairlinecode),          '||')  as seg_airline_arr,
        split(trim(segmentsdistance),             '||')  as seg_dist_arr,
        split(trim(segmentsdurationinseconds),    '||')  as seg_dur_arr

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * FLATTEN explodes the arrays.  `f.index` is the 0-based position.
     * For each position, pull the matching element from every array.
     */
    select
        b.legid,
        f.index + 1                                                   as leg_number,

        trim(replace(b.dep_airport_arr[f.index], '\"',''))            as departure_airport,
        trim(replace(b.arr_airport_arr[f.index], '\"',''))            as arrival_airport,
        trim(replace(b.seg_airline_arr[f.index],  '\"',''))           as operating_carrier,

        try_to_number(
            trim(replace(b.seg_dist_arr[f.index], '\"',''))
        )                                                             as leg_distance,

        try_to_number(
            trim(replace(b.seg_dur_arr[f.index],  '\"',''))
        )                                                             as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f                -- drive the explode

)

select
    legid,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened
        );
[0m21:55:51.310068 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:57:42.690614 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 111.381 seconds
[0m21:57:42.713552 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9b44702a-3f01-4412-a005-1c16a3d8738b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F9648FF40>]}
[0m21:57:42.714549 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_fare_legs .................. [[32mSUCCESS 1[0m in 111.45s]
[0m21:57:42.715547 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m21:57:42.717541 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:57:42.717541 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:57:42.718538 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:57:43.060130 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:57:43.061127 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:57:43.444617 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m21:57:43.445614 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m21:57:43.850531 [info ] [MainThread]: 
[0m21:57:43.851529 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 59.77 seconds (119.77s).
[0m21:57:43.852526 [debug] [MainThread]: Command end result
[0m21:57:43.885438 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:57:43.887433 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:57:43.896410 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:57:43.897406 [info ] [MainThread]: 
[0m21:57:43.898403 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:57:43.899401 [info ] [MainThread]: 
[0m21:57:43.899401 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:57:43.901395 [debug] [MainThread]: Command `dbt run` succeeded at 21:57:43.901395 after 122.25 seconds
[0m21:57:43.902393 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8B81D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F8B8BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017F9594B5E0>]}
[0m21:57:43.903390 [debug] [MainThread]: Flushing usage events
[0m21:57:44.444449 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:57:55.270643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C65A71D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C65BE59C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C65BE59E40>]}


============================== 21:57:55.274631 | 1f7beaf7-b375-489f-9ecb-51a01812f003 ==============================
[0m21:57:55.274631 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:57:55.275629 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -m int_fare_per_mi_stats', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:57:56.171738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f7beaf7-b375-489f-9ecb-51a01812f003', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C65BE331F0>]}
[0m21:57:56.232082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f7beaf7-b375-489f-9ecb-51a01812f003', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C664663400>]}
[0m21:57:56.234077 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:57:56.808058 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:57:57.108254 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:57:57.109252 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:57:57.252867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1f7beaf7-b375-489f-9ecb-51a01812f003', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C664F1D210>]}
[0m21:57:57.402971 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:57:57.405963 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:57:57.431894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1f7beaf7-b375-489f-9ecb-51a01812f003', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C664F1E7D0>]}
[0m21:57:57.432892 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:57:57.432892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f7beaf7-b375-489f-9ecb-51a01812f003', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C664F1CF70>]}
[0m21:57:57.434886 [warn ] [MainThread]: The selection criterion 'int_fare_per_mi_stats' does not match any enabled nodes
[0m21:57:57.435884 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m21:57:57.438875 [debug] [MainThread]: Command end result
[0m21:57:57.470790 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:57:57.473782 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:57:57.480764 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:57:57.482758 [debug] [MainThread]: Command `dbt run` succeeded at 21:57:57.481761 after 2.29 seconds
[0m21:57:57.482758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C65A71D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C66467C7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C664EBF640>]}
[0m21:57:57.483755 [debug] [MainThread]: Flushing usage events
[0m21:57:57.852768 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:59:04.569232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CAC0E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CAC235DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CAC235E1D0>]}


============================== 21:59:04.573221 | 99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8 ==============================
[0m21:59:04.573221 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:59:04.574220 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_route_fare_per_mi_stats', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:59:05.463346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CABDD97040>]}
[0m21:59:05.521695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACAB5F1F0>]}
[0m21:59:05.523689 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m21:59:06.093178 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m21:59:06.363465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:59:06.364463 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:59:06.540497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACB22FA90>]}
[0m21:59:06.687105 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:59:06.689100 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:59:06.713036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACB61F4F0>]}
[0m21:59:06.713036 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m21:59:06.714033 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACAC48580>]}
[0m21:59:06.716028 [info ] [MainThread]: 
[0m21:59:06.717025 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m21:59:06.718023 [info ] [MainThread]: 
[0m21:59:06.718023 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m21:59:06.720017 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m21:59:06.828726 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m21:59:06.828726 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m21:59:06.829723 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:59:13.078073 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.248 seconds
[0m21:59:13.086051 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m21:59:13.096025 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m21:59:13.097022 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m21:59:13.098019 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:59:17.001130 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.903 seconds
[0m21:59:17.005119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACB61D060>]}
[0m21:59:17.010106 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:59:17.011103 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats ......... [RUN]
[0m21:59:17.012101 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats'
[0m21:59:17.012101 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:59:17.021076 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:59:17.022074 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:59:17.052991 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:59:17.055983 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m21:59:17.056981 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
         as
        (

-- ╭──────────────────────────────────────────────────────────╮
-- 1.  Booking-level facts
-- ╰──────────────────────────────────────────────────────────╯
with base as (

    select
        legid,
        search_date,
        flight_date,
        days_to_flight,
        route,
        origin,
        destination,
        fare_bucket,
        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,
        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-- ╭──────────────────────────────────────────────────────────╮
-- 2.  Route-bucket benchmarks
-- ╰──────────────────────────────────────────────────────────╯
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-- ╭──────────────────────────────────────────────────────────╮
-- 3.  Join + z-scores & premium flags
-- ╰──────────────────────────────────────────────────────────╯
joined as (

    select
        b.*,

        -- bring in benchmarks
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        coalesce(br.legs_sampled, 0)          as legs_sampled,

        -- σ ≈ (p95 – p50) / 1.645
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                              as usd_per_mi_z,

        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                              as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                              as is_above_p97

    from base  b
    left join bench br
      on  b.route       = br.route
      and b.fare_bucket = br.fare_bucket

)

select * from joined
        );
[0m21:59:17.056981 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:59:57.191662 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 40.134 seconds
[0m21:59:57.214600 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '99924857-c7cc-4bd3-b92c-e1fd8fdfd9c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACAB5FE80>]}
[0m21:59:57.215598 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats .... [[32mSUCCESS 1[0m in 40.20s]
[0m21:59:57.216595 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m21:59:57.218590 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:59:57.218590 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m21:59:57.219587 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m21:59:57.553693 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m21:59:57.554690 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m21:59:57.882319 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m21:59:57.883316 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m21:59:58.228897 [info ] [MainThread]: 
[0m21:59:58.228897 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 51.51 seconds (51.51s).
[0m21:59:58.230892 [debug] [MainThread]: Command end result
[0m21:59:58.261809 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m21:59:58.264801 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m21:59:58.273776 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m21:59:58.273776 [info ] [MainThread]: 
[0m21:59:58.274775 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:59:58.275772 [info ] [MainThread]: 
[0m21:59:58.276769 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:59:58.277766 [debug] [MainThread]: Command `dbt run` succeeded at 21:59:58.277766 after 53.79 seconds
[0m21:59:58.278763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CAC0E1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACB3BE3E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CACB3BE6B0>]}
[0m21:59:58.278763 [debug] [MainThread]: Flushing usage events
[0m21:59:58.642789 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:00:52.899831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89BF1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89D65DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89D65E140>]}


============================== 22:00:52.903820 | fe49700f-3f8b-454c-856f-61288bb981a3 ==============================
[0m22:00:52.903820 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:00:52.904818 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select int_daily_prices', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:00:53.803917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fe49700f-3f8b-454c-856f-61288bb981a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89D62E890>]}
[0m22:00:53.863757 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fe49700f-3f8b-454c-856f-61288bb981a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89D492D70>]}
[0m22:00:53.864754 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:00:54.437245 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:00:54.713506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:54.714503 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:54.850140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fe49700f-3f8b-454c-856f-61288bb981a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89A0604C0>]}
[0m22:00:54.997745 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:00:55.000738 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:00:55.025671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fe49700f-3f8b-454c-856f-61288bb981a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8A6819D20>]}
[0m22:00:55.026669 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:00:55.027666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fe49700f-3f8b-454c-856f-61288bb981a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89A4D3310>]}
[0m22:00:55.028663 [warn ] [MainThread]: The selection criterion 'int_daily_prices' does not match any enabled nodes
[0m22:00:55.030658 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m22:00:55.032653 [debug] [MainThread]: Command end result
[0m22:00:55.064567 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:00:55.067559 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:00:55.072545 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:00:55.073543 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:55.073543 after 2.25 seconds
[0m22:00:55.074541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89BF1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D89D492D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D8A67BF700>]}
[0m22:00:55.075538 [debug] [MainThread]: Flushing usage events
[0m22:00:55.435081 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:04.203052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A477E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A47955DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A47955E1A0>]}


============================== 22:02:04.207041 | e6ec5dbd-e018-45ed-921a-a6ce21b0110b ==============================
[0m22:02:04.207041 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:02:04.208039 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_route_daily_prices', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:02:05.098666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A476297010>]}
[0m22:02:05.157509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A401E5C460>]}
[0m22:02:05.158506 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:02:05.725509 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:02:05.999775 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:02:05.999775 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:02:06.134415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A40252FA90>]}
[0m22:02:06.279028 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:02:06.281528 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:02:06.306461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A40252DB40>]}
[0m22:02:06.307459 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:02:06.308456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A40252D0C0>]}
[0m22:02:06.310451 [info ] [MainThread]: 
[0m22:02:06.310451 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:02:06.311448 [info ] [MainThread]: 
[0m22:02:06.312446 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:02:06.313443 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:02:06.423149 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:02:06.424146 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:02:06.424146 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:02:11.211912 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.788 seconds
[0m22:02:11.219890 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:02:11.230861 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:02:11.231858 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:02:11.231858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:02:14.934475 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.702 seconds
[0m22:02:14.939462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A401F49A80>]}
[0m22:02:14.943451 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m22:02:14.944449 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m22:02:14.945446 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m22:02:14.946444 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m22:02:14.955420 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:02:14.956417 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m22:02:14.987334 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:02:14.990326 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m22:02:14.991324 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

  select
    origin,
    destination,
    -- Define a route key so JFK-LAX and LAX-JFK stay distinct
    origin || '-' || destination        as route,

    /* bucket days_to_flight */
    case
      when days_to_flight between  0 and  3 then '00-03'
      when days_to_flight between  4 and  7 then '04-07'
      when days_to_flight between  8 and 29 then '08-29'
      else                                  '30+'
    end                                  as dtf_bucket,

    flight_date,
    search_date,

    -- cleaned two-letter carrier code
    replace(seg_airline_arr[0], '"', '') as marketing_carrier_code,

    total_fare,
    base_fare,
    total_fare / nullif(base_fare, 0)     as total_base_ratio

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

  select
    route,
    marketing_carrier_code           as marketing_carrier,  -- still code here
    dtf_bucket,
    flight_date,                      -- keep flight_date for like-for-like comparisons
    count(*)                          as obs,
    median(total_fare)                as median_fare,
    percentile_cont(0.95) within group (order by total_fare) as p95_fare,
    median(total_base_ratio)          as median_ratio,
    percentile_cont(0.95) within group (order by total_base_ratio) as p95_ratio

  from base
  group by
    route,
    marketing_carrier_code,
    dtf_bucket,
    flight_date

),

with_named as (

  select
    a.*,
    m.name as marketing_carrier_name
  from agg as a
  left join FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping as m
    on a.marketing_carrier = m.code

)

select
  route,
  marketing_carrier        as carrier_code,
  marketing_carrier_name   as carrier_name,
  dtf_bucket,
  flight_date,
  obs,
  median_fare,
  p95_fare,
  median_ratio,
  p95_ratio
from with_named
        );
[0m22:02:14.991324 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:02:18.732877 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe92f-0305-0bb1-0006-8fdb00188cfe
[0m22:02:18.733875 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 25 at position 12
invalid identifier 'SEG_AIRLINE_ARR'
[0m22:02:18.735870 [debug] [Thread-1 (]: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 25 at position 12
  invalid identifier 'SEG_AIRLINE_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m22:02:18.737865 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6ec5dbd-e018-45ed-921a-a6ce21b0110b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A474ECE560>]}
[0m22:02:18.738862 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_route_daily_prices ..... [[31mERROR[0m in 3.79s]
[0m22:02:18.739859 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m22:02:18.740856 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_route_daily_prices' to be skipped because of status 'error'.  Reason: Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 25 at position 12
  invalid identifier 'SEG_AIRLINE_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql.
[0m22:02:18.742851 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:02:18.742851 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:02:18.743848 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:02:19.085441 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:02:19.085441 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:02:19.439494 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m22:02:19.439494 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m22:02:19.783080 [info ] [MainThread]: 
[0m22:02:19.784077 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.47 seconds (13.47s).
[0m22:02:19.785075 [debug] [MainThread]: Command end result
[0m22:02:19.816989 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:02:19.819982 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:02:19.827960 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:02:19.827960 [info ] [MainThread]: 
[0m22:02:19.828958 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:02:19.829955 [info ] [MainThread]: 
[0m22:02:19.830952 [error] [MainThread]:   Database Error in model int_route_daily_prices (models\intermediate\int_route_daily_prices.sql)
  000904 (42000): SQL compilation error: error line 25 at position 12
  invalid identifier 'SEG_AIRLINE_ARR'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_route_daily_prices.sql
[0m22:02:19.832948 [info ] [MainThread]: 
[0m22:02:19.833945 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:02:19.835939 [debug] [MainThread]: Command `dbt run` failed at 22:02:19.835939 after 15.71 seconds
[0m22:02:19.836936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A477E1D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4026BEF50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A4026BDFF0>]}
[0m22:02:19.836936 [debug] [MainThread]: Flushing usage events
[0m22:02:20.177530 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:03:17.053789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7401D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7575DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7575E1A0>]}


============================== 22:03:17.057778 | 02c5a205-4e89-4a7e-a278-64e77ef5d848 ==============================
[0m22:03:17.057778 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:03:17.058775 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_daily_prices', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:03:17.946413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F72497040>]}
[0m22:03:18.006253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F750022C0>]}
[0m22:03:18.008248 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:03:18.572244 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:03:18.857998 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:03:18.857998 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_route_daily_prices.sql
[0m22:03:19.218540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7EC70DF0>]}
[0m22:03:19.359163 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:03:19.362156 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:03:19.385094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7EC93DC0>]}
[0m22:03:19.386092 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:03:19.387089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7E93A0E0>]}
[0m22:03:19.389083 [info ] [MainThread]: 
[0m22:03:19.389083 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:03:19.390082 [info ] [MainThread]: 
[0m22:03:19.391079 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:03:19.392076 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:03:19.500785 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:03:19.501782 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:03:19.502779 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:03:22.911708 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.409 seconds
[0m22:03:22.919687 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:03:22.929661 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:03:22.930658 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:03:22.930658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:03:26.449284 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.518 seconds
[0m22:03:26.454270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7EC93E80>]}
[0m22:03:26.458260 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m22:03:26.459257 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m22:03:26.460254 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m22:03:26.461252 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m22:03:26.469230 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:03:26.470228 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m22:03:26.502142 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:03:26.505134 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m22:03:26.505134 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

  select
    origin,
    destination,
    -- Define a route key so JFK-LAX and LAX-JFK stay distinct
    origin || '-' || destination        as route,

    /* bucket days_to_flight */
    case
      when days_to_flight between  0 and  3 then '00-03'
      when days_to_flight between  4 and  7 then '04-07'
      when days_to_flight between  8 and 29 then '08-29'
      else                                  '30+'
    end                                  as dtf_bucket,

    flight_date,
    search_date,

    -- cleaned two-letter carrier code (first element of the pipe-delimited string)
    trim(
      replace(
        split(segmentsairlinecode, '||')[0],
        '"',''
      )
    )                                    as carrier_code,

    total_fare,
    base_fare,
    total_fare / nullif(base_fare, 0)     as total_base_ratio

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

  select
    route,
    carrier_code              as marketing_carrier,
    dtf_bucket,
    flight_date,               -- keep flight_date for like-for-like comparisons
    count(*)                   as obs,
    median(total_fare)         as median_fare,
    percentile_cont(0.95)
      within group (order by total_fare)  as p95_fare,
    median(total_base_ratio)   as median_ratio,
    percentile_cont(0.95)
      within group (order by total_base_ratio) as p95_ratio

  from base
  group by
    route,
    carrier_code,
    dtf_bucket,
    flight_date

),

with_named as (

  select
    a.*,
    m.name as marketing_carrier_name
  from agg as a
  left join FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping as m
    on a.marketing_carrier = m.code

)

select
  route,
  marketing_carrier        as carrier_code,
  marketing_carrier_name   as carrier_name,
  dtf_bucket,
  flight_date,
  obs,
  median_fare,
  p95_fare,
  median_ratio,
  p95_ratio
from with_named
        );
[0m22:03:26.506132 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:04:15.426907 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 48.921 seconds
[0m22:04:15.450843 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '02c5a205-4e89-4a7e-a278-64e77ef5d848', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7E05FE50>]}
[0m22:04:15.451840 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_daily_prices ......... [[32mSUCCESS 1[0m in 48.99s]
[0m22:04:15.452838 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m22:04:15.453836 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:04:15.453836 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:04:15.454833 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:04:15.807887 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:04:15.808885 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:04:16.166949 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m22:04:16.167947 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m22:04:16.504552 [info ] [MainThread]: 
[0m22:04:16.505549 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 57.11 seconds (57.11s).
[0m22:04:16.506548 [debug] [MainThread]: Command end result
[0m22:04:16.539460 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:04:16.542451 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:04:16.550429 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:04:16.551428 [info ] [MainThread]: 
[0m22:04:16.552426 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:04:16.553422 [info ] [MainThread]: 
[0m22:04:16.553422 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:04:16.555416 [debug] [MainThread]: Command `dbt run` succeeded at 22:04:16.555416 after 59.58 seconds
[0m22:04:16.555416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F7401D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F750022C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F740D72B0>]}
[0m22:04:16.556413 [debug] [MainThread]: Flushing usage events
[0m22:04:16.899495 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:04:34.114652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002240CA1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002240E15DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002240E15E1D0>]}


============================== 22:04:34.118641 | e4086a46-bdff-4255-bda2-3639619af4f6 ==============================
[0m22:04:34.118641 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:04:34.119639 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select int_route_competition', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:04:35.014749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002240E1320B0>]}
[0m22:04:35.074096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002241675F820>]}
[0m22:04:35.076091 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:04:35.642082 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:04:35.931826 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:04:35.932823 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:04:36.070455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002241702FA90>]}
[0m22:04:36.215068 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:04:36.218060 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:04:36.241996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022416A48F70>]}
[0m22:04:36.242993 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:04:36.242993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022416A4B6A0>]}
[0m22:04:36.244988 [info ] [MainThread]: 
[0m22:04:36.245985 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:04:36.246983 [info ] [MainThread]: 
[0m22:04:36.246983 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:04:36.248977 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:04:36.359681 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:04:36.360678 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:04:36.360678 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:04:39.860354 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.499 seconds
[0m22:04:39.868332 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:04:39.879303 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:04:39.880300 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:04:39.880300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:04:43.960937 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 4.081 seconds
[0m22:04:43.965924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002241721F8E0>]}
[0m22:04:43.970911 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m22:04:43.971908 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m22:04:43.971908 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m22:04:43.972906 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m22:04:43.980884 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m22:04:43.982879 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m22:04:44.017296 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m22:04:44.020288 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m22:04:44.020288 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

-- ────────────────────────────────────────────────────────────────────────────────
-- 1 ·  Base rows: one record per booking
-- ────────────────────────────────────────────────────────────────────────────────
with base as (

    select
        /* canonical route key */
        origin || '-' || destination            as route,

        /* airline operating (first marketing carrier) */
        marketing_carrier,                      -- ← must exist in stg_fare_searches

        /* optional: keep flight_date so we can aggregate by period later */
        flight_date

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

    /* safeguard: ignore records with no carrier code */
    where marketing_carrier is not null

),


-- ────────────────────────────────────────────────────────────────────────────────
-- 2 ·  Count bookings per carrier on each route
-- ────────────────────────────────────────────────────────────────────────────────
carrier_flights as (

    select
        route,
        marketing_carrier,
        count(*)                                as flight_bookings
    from base
    group by
        route,
        marketing_carrier

),

-- ────────────────────────────────────────────────────────────────────────────────
-- 3 ·  Competition metrics (HHI + carrier_count)
--     HHI = Σ(sᵢ²) where sᵢ = share of bookings for carrier i on the route
-- ────────────────────────────────────────────────────────────────────────────────
concentration as (

    select
        route,

        /* denominator for shares */
        sum(flight_bookings)                         as total_bookings,

        /* Herfindahl-Hirschman Index */
        sum( power(flight_bookings, 2) )
            / power(sum(flight_bookings), 2)         as hhi,

        /* # distinct carriers */
        count(marketing_carrier)                     as carrier_count
    from carrier_flights
    group by route

)

-- ────────────────────────────────────────────────────────────────────────────────
-- 4 ·  Final output
-- ────────────────────────────────────────────────────────────────────────────────
select
    route,
    carrier_count,      -- e.g. 1  = monopoly, 2+ = competing carriers
    hhi                 -- 1.0 = pure monopoly; < 0.20 = highly competitive
from concentration
        );
[0m22:04:44.021285 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:04:50.488547 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 6.467 seconds
[0m22:04:50.511485 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e4086a46-bdff-4255-bda2-3639619af4f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002241675E6E0>]}
[0m22:04:50.512483 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_route_competition .......... [[32mSUCCESS 1[0m in 6.54s]
[0m22:04:50.513480 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m22:04:50.514477 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:04:50.515475 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:04:50.515475 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:04:50.865548 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:04:50.866545 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:04:51.205638 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_competition' was left open.
[0m22:04:51.206635 [debug] [MainThread]: On model.fair_pricing_radar.int_route_competition: Close
[0m22:04:51.536752 [info ] [MainThread]: 
[0m22:04:51.537750 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 15.29 seconds (15.29s).
[0m22:04:51.538747 [debug] [MainThread]: Command end result
[0m22:04:51.571169 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:04:51.574161 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:04:51.581142 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:04:51.582140 [info ] [MainThread]: 
[0m22:04:51.583138 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:04:51.583138 [info ] [MainThread]: 
[0m22:04:51.584135 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:04:51.586129 [debug] [MainThread]: Command `dbt run` succeeded at 22:04:51.586129 after 17.55 seconds
[0m22:04:51.586129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002240CA1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224171BEE60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224171BE050>]}
[0m22:04:51.587126 [debug] [MainThread]: Flushing usage events
[0m22:04:51.939183 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:16.794608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B180B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18225A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18225A170>]}


============================== 22:05:16.798597 | af60cf87-e51f-48ab-8d7e-74b17ae0dd24 ==============================
[0m22:05:16.798597 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:05:16.799594 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select mart_pricing_features', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:05:17.697220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B17DE97040>]}
[0m22:05:17.757060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B181AFE2C0>]}
[0m22:05:17.758057 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:05:18.327040 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:05:18.604298 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:05:18.604298 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:05:18.738938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18B12FA90>]}
[0m22:05:18.885052 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:05:18.888044 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:05:18.912486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18B12FB50>]}
[0m22:05:18.912486 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:05:18.913483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18B12FA30>]}
[0m22:05:18.915478 [info ] [MainThread]: 
[0m22:05:18.916476 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:05:18.916476 [info ] [MainThread]: 
[0m22:05:18.917473 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:05:18.918470 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:05:19.031673 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:05:19.032671 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:05:19.033668 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:05:22.816094 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.783 seconds
[0m22:05:22.824073 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:05:22.834046 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:05:22.835043 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:05:22.835043 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:05:26.581058 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.745 seconds
[0m22:05:26.585047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18AB48E20>]}
[0m22:05:26.590034 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m22:05:26.591032 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m22:05:26.592029 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m22:05:26.592029 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m22:05:26.603000 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:05:26.603997 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m22:05:26.633917 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:05:26.637906 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m22:05:26.638904 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (guarding against NULL percentiles)
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 (only when both p50 and p95 are present) */
    case
      when p50_usd_per_mi  is not null
       and p95_usd_per_mi  is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price (only when p97 present) */
    case
      when seats_flag in ('sold_out','scarce')
       and p97_usd_per_mi  is not null
       and usd_per_mi     >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.90 AND price ≥ p95, only when p95 present) */
    case
      when hhi            >= 0.90
       and p95_usd_per_mi  is not null
       and usd_per_mi     >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    *,
    case
      when r1_price_outlier    = 1
        or r2_seat_scarcity    = 1
        or r3_monopoly_premium = 1
      then 1 else 0
    end as any_rule_flag
  from flags
)

select * from final
        );
[0m22:05:26.639901 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:07:37.148463 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 130.509 seconds
[0m22:07:37.172399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'af60cf87-e51f-48ab-8d7e-74b17ae0dd24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18AB48970>]}
[0m22:07:37.173396 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 130.58s]
[0m22:07:37.174394 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m22:07:37.176388 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:07:37.176388 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:07:37.177385 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:07:37.522473 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:07:37.523470 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:07:37.888493 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m22:07:37.889492 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m22:07:38.232572 [info ] [MainThread]: 
[0m22:07:38.233570 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 19.32 seconds (139.32s).
[0m22:07:38.234568 [debug] [MainThread]: Command end result
[0m22:07:38.267479 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:07:38.270471 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:07:38.278450 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:07:38.279447 [info ] [MainThread]: 
[0m22:07:38.280445 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:07:38.280445 [info ] [MainThread]: 
[0m22:07:38.281442 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:07:38.283438 [debug] [MainThread]: Command `dbt run` succeeded at 22:07:38.283438 after 141.57 seconds
[0m22:07:38.284434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B180B1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B181AFE2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B18B2BDD50>]}
[0m22:07:38.284434 [debug] [MainThread]: Flushing usage events
[0m22:07:38.637992 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:25:25.286364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF05C1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF07359D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF07359F30>]}


============================== 22:25:25.290353 | 9de6ce7a-c2a0-406b-a416-b2910af18191 ==============================
[0m22:25:25.290353 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:25:25.291351 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run -m stg_fare_searches+', 'send_anonymous_usage_stats': 'True'}
[0m22:25:26.250783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF073320B0>]}
[0m22:25:26.310623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF0FC63820>]}
[0m22:25:26.312618 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:25:26.887080 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:25:27.179299 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m22:25:27.180296 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m22:25:27.180296 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m22:25:27.729825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF109E8130>]}
[0m22:25:27.875436 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:25:27.878428 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:25:27.903361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF104D3970>]}
[0m22:25:27.904359 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:25:27.905356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF104BF490>]}
[0m22:25:27.908348 [info ] [MainThread]: 
[0m22:25:27.909345 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:25:27.909345 [info ] [MainThread]: 
[0m22:25:27.910342 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:25:27.918321 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:25:28.038998 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:25:28.039996 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:25:28.040993 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:25:33.337820 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.297 seconds
[0m22:25:33.340812 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:25:33.350785 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:25:33.351782 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:25:33.352780 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:25:37.045898 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.694 seconds
[0m22:25:37.050884 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF0FC626E0>]}
[0m22:25:37.055871 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m22:25:37.055871 [info ] [Thread-1 (]: 1 of 9 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m22:25:37.056869 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m22:25:37.057866 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m22:25:37.067839 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:25:37.069834 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m22:25:37.100751 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:25:37.105737 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m22:25:37.106735 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- ╔══════════════════════════════════════════════╗
-- 1 · RAW rows (keep only sensible bookings)
-- ╚══════════════════════════════════════════════╝
with raw as (

    select
        legid,
        try_to_date(searchdate)                  as search_date,
        try_to_date(flightdate)                  as flight_date,

        cast(totalfare      as numeric)          as total_fare,
        cast(basefare       as numeric)          as base_fare,
        cast(seatsremaining as numeric)          as seats_remaining,

        isnonstop                                as is_nonstop,
        isbasiceconomy                           as is_basic_econ,
        isrefundable                             as is_refundable,
        trim(farebasiscode)                      as farebasiscode,

        cast(totaltraveldistance as numeric)     as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where   searchdate is not null
        and flightdate is not null
        and try_to_date(flightdate) >= try_to_date(searchdate)
        and totalfare is not null
),

-- ╔══════════════════════════════════════════════╗
-- 2 · BASIC DERIVATIONS
-- ╚══════════════════════════════════════════════╝
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* origin / destination (first & last element) */
        trim(replace(dep_arr[0],                       '\"',''))              as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1],   '\"',''))              as destination,

        /* CLEAN marketing carrier (1st code, no stray quotes) */
        replace(split(trim(r.segmentsairlinecode), '||')[0], '\"','')         as marketing_carrier,

        datediff('day', try_to_date(r.searchdate), try_to_date(r.flightdate)) as days_to_flight

    from raw r
),

-- ╔══════════════════════════════════════════════╗
-- 3 · ADD AIRPORT GEO (for GC fallback)
-- ╚══════════════════════════════════════════════╝
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon
    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- ╔══════════════════════════════════════════════╗
-- 4 · DISTANCE: choose “reasonable” miles
--      • raw_total_miles  (path) kept **iff**
--        it is ≤ 2 × GC; otherwise fall back to GC
--      • GC always padded by 2 % to approximate routing
-- ╚══════════════════════════════════════════════╝
with_gc as (

    select
        g.*,

        /* great-circle miles (+2 % pad) */
        case
          when g.orig_lat is not null and g.dest_lat is not null then
               1.02 * st_distance(
                       to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                       to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
        end                                                    as gc_miles

    from add_geo g
),

choose_dist as (

    select
        c.*,

        coalesce(
            -- 1️⃣ keep path distance if “reasonable”
            case
              when c.raw_total_miles is not null
               and c.gc_miles        is not null
               and c.raw_total_miles <= 2 * c.gc_miles
              then c.raw_total_miles
            end,
            -- 2️⃣ else GC-miles
            c.gc_miles,
            -- 3️⃣ else raw (last resort)
            c.raw_total_miles
        )                                                       as total_miles

    from with_gc c
),

-- ╔══════════════════════════════════════════════╗
-- 5 · BUSINESS FIELDS
-- ╚══════════════════════════════════════════════╝
ready as (

    select
        d.*,

        d.total_fare / nullif(d.total_miles,0)                  as usd_per_mi,

        case
            when seats_remaining = 0          then 'sold_out'
            when seats_remaining between 1 and 8 then 'scarce'
            else                                   '9plus'
        end                                                    as seats_flag,

        fb.fare_bucket
    from choose_dist d
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(d.farebasiscode,1)) = fb.first_letter
)

-- ╔══════════════════════════════════════════════╗
-- 6 · FINAL STAGING SELECT
-- ╚══════════════════════════════════════════════╝
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                          as route,

    marketing_carrier,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode
from ready
        );
[0m22:25:37.107732 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:25:40.744002 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe946-0305-0fb8-0006-8fdb0018c3e2
[0m22:25:40.745000 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 63 at position 36
invalid identifier 'R.SEARCHDATE'
[0m22:25:40.746994 [debug] [Thread-1 (]: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 63 at position 36
  invalid identifier 'R.SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:25:40.748989 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9de6ce7a-c2a0-406b-a416-b2910af18191', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF0FC626E0>]}
[0m22:25:40.749987 [error] [Thread-1 (]: 1 of 9 ERROR creating sql table model WALRUS_PUBLIC.stg_fare_searches .......... [[31mERROR[0m in 3.69s]
[0m22:25:40.750984 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m22:25:40.751981 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.stg_fare_searches' to be skipped because of status 'error'.  Reason: Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 63 at position 36
  invalid identifier 'R.SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql.
[0m22:25:40.752978 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m22:25:40.753976 [debug] [Thread-4 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m22:25:40.753976 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m22:25:40.754974 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m22:25:40.754974 [info ] [Thread-3 (]: 2 of 9 SKIP relation WALRUS_PUBLIC.int_fare_legs ............................... [[33mSKIP[0m]
[0m22:25:40.755971 [info ] [Thread-4 (]: 3 of 9 SKIP relation WALRUS_PUBLIC.int_route_competition ....................... [[33mSKIP[0m]
[0m22:25:40.756969 [info ] [Thread-2 (]: 4 of 9 SKIP relation WALRUS_PUBLIC.int_route_daily_prices ...................... [[33mSKIP[0m]
[0m22:25:40.758964 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m22:25:40.757966 [info ] [Thread-1 (]: 5 of 9 SKIP relation WALRUS_PUBLIC.stg_route_stats ............................. [[33mSKIP[0m]
[0m22:25:40.759961 [debug] [Thread-4 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m22:25:40.760957 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m22:25:40.762952 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m22:25:40.763950 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:25:40.764946 [debug] [Thread-4 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:25:40.764946 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m22:25:40.765944 [info ] [Thread-3 (]: 6 of 9 SKIP relation WALRUS_PUBLIC.int_route_fare_per_mi_stats ................. [[33mSKIP[0m]
[0m22:25:40.765944 [info ] [Thread-4 (]: 7 of 9 SKIP relation WALRUS_PUBLIC.int_rules_r1_r2_r3 .......................... [[33mSKIP[0m]
[0m22:25:40.768937 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:25:40.767940 [info ] [Thread-2 (]: 8 of 9 SKIP relation WALRUS_PUBLIC.mart_pricing_features ....................... [[33mSKIP[0m]
[0m22:25:40.769935 [debug] [Thread-4 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:25:40.770931 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m22:25:40.771928 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m22:25:40.772925 [info ] [Thread-1 (]: 9 of 9 SKIP relation WALRUS_PUBLIC.mart_pricing_alerts ......................... [[33mSKIP[0m]
[0m22:25:40.774921 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m22:25:40.776915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:25:40.776915 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:25:40.777912 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:25:41.112018 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:25:41.113015 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:25:41.456097 [debug] [MainThread]: Connection 'model.fair_pricing_radar.stg_fare_searches' was left open.
[0m22:25:41.457094 [debug] [MainThread]: On model.fair_pricing_radar.stg_fare_searches: Close
[0m22:25:41.819125 [info ] [MainThread]: 
[0m22:25:41.820123 [info ] [MainThread]: Finished running 9 table models in 0 hours 0 minutes and 13.91 seconds (13.91s).
[0m22:25:41.822118 [debug] [MainThread]: Command end result
[0m22:25:41.853035 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:25:41.856027 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:25:41.864006 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:25:41.865003 [info ] [MainThread]: 
[0m22:25:41.865003 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:25:41.866000 [info ] [MainThread]: 
[0m22:25:41.866997 [error] [MainThread]:   Database Error in model stg_fare_searches (models\staging\stg_fare_searches.sql)
  000904 (42000): SQL compilation error: error line 63 at position 36
  invalid identifier 'R.SEARCHDATE'
  compiled code at target\run\fair_pricing_radar\models\staging\stg_fare_searches.sql
[0m22:25:41.867995 [info ] [MainThread]: 
[0m22:25:41.867995 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=8 TOTAL=9
[0m22:25:41.869989 [debug] [MainThread]: Command `dbt run` failed at 22:25:41.869989 after 16.66 seconds
[0m22:25:41.870987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF05C1D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF05CB2110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002CF115718D0>]}
[0m22:25:41.870987 [debug] [MainThread]: Flushing usage events
[0m22:25:42.230026 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:27:41.401150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001978881D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019789F5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019789F5E1A0>]}


============================== 22:27:41.405139 | 89816f2a-e899-4f9f-b107-c906e1444aca ==============================
[0m22:27:41.405139 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:27:41.406137 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run -m stg_fare_searches+', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:27:42.288775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019786997010>]}
[0m22:27:42.346620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019792560460>]}
[0m22:27:42.348615 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:27:42.906123 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:27:43.196347 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:27:43.197344 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\staging\stg_fare_searches.sql
[0m22:27:43.735903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197934DC130>]}
[0m22:27:43.878521 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:27:43.881513 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:27:43.904452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019792FD28F0>]}
[0m22:27:43.905450 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:27:43.906447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019792FBDC60>]}
[0m22:27:43.909439 [info ] [MainThread]: 
[0m22:27:43.909439 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:27:43.910436 [info ] [MainThread]: 
[0m22:27:43.911433 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:27:43.919412 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:27:44.025129 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:27:44.025129 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:27:44.026126 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:27:50.797009 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 6.771 seconds
[0m22:27:50.800001 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:27:50.809974 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:27:50.810971 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:27:50.810971 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:27:54.600831 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.789 seconds
[0m22:27:54.605817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019792563E80>]}
[0m22:27:54.609807 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_fare_searches
[0m22:27:54.610804 [info ] [Thread-1 (]: 1 of 9 START sql table model WALRUS_PUBLIC.stg_fare_searches ................... [RUN]
[0m22:27:54.611802 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.stg_fare_searches'
[0m22:27:54.612799 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_fare_searches
[0m22:27:54.622772 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:27:54.623770 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_fare_searches
[0m22:27:54.655684 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_fare_searches"
[0m22:27:54.660670 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_fare_searches"
[0m22:27:54.661668 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_fare_searches: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_fare_searches"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
         as
        (




-- ╔══════════════════════════════════════════════╗
-- 1 · RAW rows (keep only sensible bookings)
-- ╚══════════════════════════════════════════════╝
with raw as (

    select
        legid,

        try_to_date(searchdate)                  as search_date,
        try_to_date(flightdate)                  as flight_date,

        cast(totalfare         as numeric)       as total_fare,
        cast(basefare          as numeric)       as base_fare,
        cast(seatsremaining    as numeric)       as seats_remaining,

        isnonstop                                as is_nonstop,
        isbasiceconomy                           as is_basic_econ,
        isrefundable                             as is_refundable,
        trim(farebasiscode)                      as farebasiscode,

        cast(totaltraveldistance as numeric)     as raw_total_miles,

        travelduration,
        segmentsdepartureairportcode,
        segmentsarrivalairportcode,
        segmentsairlinecode,
        segmentsdistance,
        segmentsdurationinseconds,
        segmentsequipmentdescription,
        segmentscabincode

    from FLIGHT_PRICES.WALRUS_PUBLIC.FLIGHT_PRICING_DATA
    where   searchdate    is not null
        and flightdate    is not null
        and flightdate   >= searchdate
        and totalfare     is not null

),

-- ╔══════════════════════════════════════════════╗
-- 2 · BASIC DERIVATIONS
-- ╚══════════════════════════════════════════════╝
prep as (

    select
        r.*,

        split(trim(r.segmentsdepartureairportcode), '||') as dep_arr,
        split(trim(r.segmentsarrivalairportcode),   '||') as arr_arr,

        /* origin / destination (first & last element) */
        trim(replace(dep_arr[0],                       '"',''))              as origin,
        trim(replace(arr_arr[array_size(arr_arr)-1],   '"',''))              as destination,

        /* CLEAN marketing carrier (1st code, no stray quotes) */
        replace(split(trim(r.segmentsairlinecode), '||')[0], '"','')         as marketing_carrier,

        /* use the aliased columns, not raw SEARCHDATE */
        datediff('day', r.search_date, r.flight_date)                         as days_to_flight

    from raw r

),

-- ╔══════════════════════════════════════════════╗
-- 3 · ADD AIRPORT GEO (for GC fallback)
-- ╚══════════════════════════════════════════════╝
add_geo as (

    select
        p.*,
        og.lat_deg   as orig_lat,
        og.lon_deg   as orig_lon,
        dg.lat_deg   as dest_lat,
        dg.lon_deg   as dest_lon

    from prep p
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo og on p.origin      = og.iata_code
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo dg on p.destination = dg.iata_code
),

-- ╔══════════════════════════════════════════════╗
-- 4 · DISTANCE: choose “reasonable” miles
--      • raw_total_miles  (path) kept **iff**
--        it is ≤ 2 × GC; otherwise fall back to GC
--      • GC always padded by 2 % to approximate routing
-- ╚══════════════════════════════════════════════╝
with_gc as (

    select
        g.*,

        /* great-circle miles (+2 % pad) */
        case
          when g.orig_lat is not null and g.dest_lat is not null then
               1.02 * st_distance(
                       to_geography('POINT(' || g.orig_lon || ' ' || g.orig_lat || ')'),
                       to_geography('POINT(' || g.dest_lon || ' ' || g.dest_lat || ')')
                     ) / 1609.344
        end                                                    as gc_miles

    from add_geo g
),

choose_dist as (

    select
        c.*,

        coalesce(
            -- 1️⃣ keep path distance if “reasonable”
            case
              when c.raw_total_miles is not null
               and c.gc_miles        is not null
               and c.raw_total_miles <= 2 * c.gc_miles
              then c.raw_total_miles
            end,
            -- 2️⃣ else GC-miles
            c.gc_miles,
            -- 3️⃣ else raw (last resort)
            c.raw_total_miles
        )                                                       as total_miles

    from with_gc c
),

-- ╔══════════════════════════════════════════════╗
-- 5 · BUSINESS FIELDS
-- ╚══════════════════════════════════════════════╝
ready as (

    select
        d.*,

        d.total_fare / nullif(d.total_miles,0)                  as usd_per_mi,

        case
            when seats_remaining = 0          then 'sold_out'
            when seats_remaining between 1 and 8 then 'scarce'
            else                                   '9plus'
        end                                                    as seats_flag,

        fb.fare_bucket
    from choose_dist d
    left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_fare_bucket_map fb
      on upper(left(d.farebasiscode,1)) = fb.first_letter
)

-- ╔══════════════════════════════════════════════╗
-- 6 · FINAL STAGING SELECT
-- ╚══════════════════════════════════════════════╝
select
    legid,
    search_date,
    flight_date,
    days_to_flight,

    origin,
    destination,
    origin || '-' || destination                          as route,

    marketing_carrier,

    total_fare,
    base_fare,
    total_miles,
    usd_per_mi,

    is_nonstop,
    is_basic_econ,
    is_refundable,

    farebasiscode,
    fare_bucket,

    seats_remaining,
    seats_flag,

    travelduration,
    segmentsdepartureairportcode,
    segmentsarrivalairportcode,
    segmentsairlinecode,
    segmentsdistance,
    segmentsdurationinseconds,
    segmentsequipmentdescription,
    segmentscabincode

from ready
        );
[0m22:27:54.662665 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:30:59.305601 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 184.643 seconds
[0m22:30:59.329537 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019792563E80>]}
[0m22:30:59.330534 [info ] [Thread-1 (]: 1 of 9 OK created sql table model WALRUS_PUBLIC.stg_fare_searches .............. [[32mSUCCESS 1[0m in 184.72s]
[0m22:30:59.331532 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_fare_searches
[0m22:30:59.332530 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.int_fare_legs
[0m22:30:59.333527 [debug] [Thread-4 (]: Began running node model.fair_pricing_radar.int_route_competition
[0m22:30:59.333527 [debug] [Thread-2 (]: Began running node model.fair_pricing_radar.int_route_daily_prices
[0m22:30:59.334524 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.stg_route_stats
[0m22:30:59.334524 [info ] [Thread-3 (]: 2 of 9 START sql table model WALRUS_PUBLIC.int_fare_legs ....................... [RUN]
[0m22:30:59.335521 [info ] [Thread-4 (]: 3 of 9 START sql table model WALRUS_PUBLIC.int_route_competition ............... [RUN]
[0m22:30:59.336519 [info ] [Thread-2 (]: 4 of 9 START sql table model WALRUS_PUBLIC.int_route_daily_prices .............. [RUN]
[0m22:30:59.338515 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_fare_legs'
[0m22:30:59.337517 [info ] [Thread-1 (]: 5 of 9 START sql table model WALRUS_PUBLIC.stg_route_stats ..................... [RUN]
[0m22:30:59.339511 [debug] [Thread-4 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_competition'
[0m22:30:59.340508 [debug] [Thread-2 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_route_daily_prices'
[0m22:30:59.341507 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.int_fare_legs
[0m22:30:59.343500 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.fair_pricing_radar.stg_fare_searches, now model.fair_pricing_radar.stg_route_stats)
[0m22:30:59.343500 [debug] [Thread-4 (]: Began compiling node model.fair_pricing_radar.int_route_competition
[0m22:30:59.344498 [debug] [Thread-2 (]: Began compiling node model.fair_pricing_radar.int_route_daily_prices
[0m22:30:59.349484 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.int_fare_legs"
[0m22:30:59.350481 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.stg_route_stats
[0m22:30:59.354470 [debug] [Thread-4 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_competition"
[0m22:30:59.359458 [debug] [Thread-2 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:30:59.364444 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.stg_route_stats"
[0m22:30:59.365442 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.int_fare_legs
[0m22:30:59.366445 [debug] [Thread-4 (]: Began executing node model.fair_pricing_radar.int_route_competition
[0m22:30:59.367436 [debug] [Thread-2 (]: Began executing node model.fair_pricing_radar.int_route_daily_prices
[0m22:30:59.371425 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.int_fare_legs"
[0m22:30:59.371425 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.stg_route_stats
[0m22:30:59.374417 [debug] [Thread-4 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_competition"
[0m22:30:59.378406 [debug] [Thread-2 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_daily_prices"
[0m22:30:59.382396 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.stg_route_stats"
[0m22:30:59.445228 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.int_fare_legs"
[0m22:30:59.447222 [debug] [Thread-4 (]: Using snowflake connection "model.fair_pricing_radar.int_route_competition"
[0m22:30:59.450214 [debug] [Thread-2 (]: Using snowflake connection "model.fair_pricing_radar.int_route_daily_prices"
[0m22:30:59.450214 [debug] [Thread-3 (]: On model.fair_pricing_radar.int_fare_legs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_fare_legs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_fare_legs
         as
        (

with bookings as (

    /* Pull the raw pipe-delimited strings from staging */
    select
        legid,

        -- turn each pipe-delimited string into an ARRAY
        split(trim(segmentsdepartureairportcode), '||')  as dep_airport_arr,
        split(trim(segmentsarrivalairportcode),   '||')  as arr_airport_arr,
        split(trim(segmentsairlinecode),          '||')  as seg_airline_arr,
        split(trim(segmentsdistance),             '||')  as seg_dist_arr,
        split(trim(segmentsdurationinseconds),    '||')  as seg_dur_arr

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

), flattened as (

    /*
     * FLATTEN explodes the arrays.  `f.index` is the 0-based position.
     * For each position, pull the matching element from every array.
     */
    select
        b.legid,
        f.index + 1                                                   as leg_number,

        trim(replace(b.dep_airport_arr[f.index], '\"',''))            as departure_airport,
        trim(replace(b.arr_airport_arr[f.index], '\"',''))            as arrival_airport,
        trim(replace(b.seg_airline_arr[f.index],  '\"',''))           as operating_carrier,

        try_to_number(
            trim(replace(b.seg_dist_arr[f.index], '\"',''))
        )                                                             as leg_distance,

        try_to_number(
            trim(replace(b.seg_dur_arr[f.index],  '\"',''))
        )                                                             as leg_duration_sec

    from bookings b,
         lateral flatten(input => b.dep_airport_arr) f                -- drive the explode

)

select
    legid,
    leg_number,
    departure_airport,
    arrival_airport,
    operating_carrier,
    leg_distance,
    leg_duration_sec
from flattened
        );
[0m22:30:59.452209 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.stg_route_stats"
[0m22:30:59.452209 [debug] [Thread-4 (]: On model.fair_pricing_radar.int_route_competition: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_competition"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition
         as
        (

-- ────────────────────────────────────────────────────────────────────────────────
-- 1 ·  Base rows: one record per booking
-- ────────────────────────────────────────────────────────────────────────────────
with base as (

    select
        /* canonical route key */
        origin || '-' || destination            as route,

        /* airline operating (first marketing carrier) */
        marketing_carrier,                      -- ← must exist in stg_fare_searches

        /* optional: keep flight_date so we can aggregate by period later */
        flight_date

    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

    /* safeguard: ignore records with no carrier code */
    where marketing_carrier is not null

),


-- ────────────────────────────────────────────────────────────────────────────────
-- 2 ·  Count bookings per carrier on each route
-- ────────────────────────────────────────────────────────────────────────────────
carrier_flights as (

    select
        route,
        marketing_carrier,
        count(*)                                as flight_bookings
    from base
    group by
        route,
        marketing_carrier

),

-- ────────────────────────────────────────────────────────────────────────────────
-- 3 ·  Competition metrics (HHI + carrier_count)
--     HHI = Σ(sᵢ²) where sᵢ = share of bookings for carrier i on the route
-- ────────────────────────────────────────────────────────────────────────────────
concentration as (

    select
        route,

        /* denominator for shares */
        sum(flight_bookings)                         as total_bookings,

        /* Herfindahl-Hirschman Index */
        sum( power(flight_bookings, 2) )
            / power(sum(flight_bookings), 2)         as hhi,

        /* # distinct carriers */
        count(marketing_carrier)                     as carrier_count
    from carrier_flights
    group by route

)

-- ────────────────────────────────────────────────────────────────────────────────
-- 4 ·  Final output
-- ────────────────────────────────────────────────────────────────────────────────
select
    route,
    carrier_count,      -- e.g. 1  = monopoly, 2+ = competing carriers
    hhi                 -- 1.0 = pure monopoly; < 0.20 = highly competitive
from concentration
        );
[0m22:30:59.453206 [debug] [Thread-2 (]: On model.fair_pricing_radar.int_route_daily_prices: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_daily_prices"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices
         as
        (

with base as (

  select
    origin,
    destination,
    -- Define a route key so JFK-LAX and LAX-JFK stay distinct
    origin || '-' || destination        as route,

    /* bucket days_to_flight */
    case
      when days_to_flight between  0 and  3 then '00-03'
      when days_to_flight between  4 and  7 then '04-07'
      when days_to_flight between  8 and 29 then '08-29'
      else                                  '30+'
    end                                  as dtf_bucket,

    flight_date,
    search_date,

    -- cleaned two-letter carrier code (first element of the pipe-delimited string)
    trim(
      replace(
        split(segmentsairlinecode, '||')[0],
        '"',''
      )
    )                                    as carrier_code,

    total_fare,
    base_fare,
    total_fare / nullif(base_fare, 0)     as total_base_ratio

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches

),

agg as (

  select
    route,
    carrier_code              as marketing_carrier,
    dtf_bucket,
    flight_date,               -- keep flight_date for like-for-like comparisons
    count(*)                   as obs,
    median(total_fare)         as median_fare,
    percentile_cont(0.95)
      within group (order by total_fare)  as p95_fare,
    median(total_base_ratio)   as median_ratio,
    percentile_cont(0.95)
      within group (order by total_base_ratio) as p95_ratio

  from base
  group by
    route,
    carrier_code,
    dtf_bucket,
    flight_date

),

with_named as (

  select
    a.*,
    m.name as marketing_carrier_name
  from agg as a
  left join FLIGHT_PRICES.WALRUS_PUBLIC.carrier_mapping as m
    on a.marketing_carrier = m.code

)

select
  route,
  marketing_carrier        as carrier_code,
  marketing_carrier_name   as carrier_name,
  dtf_bucket,
  flight_date,
  obs,
  median_fare,
  p95_fare,
  median_ratio,
  p95_ratio
from with_named
        );
[0m22:30:59.453206 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m22:30:59.454203 [debug] [Thread-1 (]: On model.fair_pricing_radar.stg_route_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.stg_route_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats
         as
        (

with base as (

  select
    route,
    fare_bucket,
    usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
  where usd_per_mi is not null

),

bench as (

  select
    route,
    fare_bucket,

    -- Percentile benchmarks (unqualified usd_per_mi)
    percentile_cont(0.50) within group (order by usd_per_mi) as p50_usd_per_mi,
    percentile_cont(0.90) within group (order by usd_per_mi) as p90_usd_per_mi,
    percentile_cont(0.95) within group (order by usd_per_mi) as p95_usd_per_mi,
    percentile_cont(0.97) within group (order by usd_per_mi) as p97_usd_per_mi,

    max(usd_per_mi)   as max_usd_per_mi,
    count(*)          as legs_sampled

  from base
  group by
    route,
    fare_bucket

)

select * from bench
        );
[0m22:30:59.455201 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m22:30:59.455201 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m22:31:12.800491 [debug] [Thread-4 (]: SQL status: SUCCESS 1 in 13.346 seconds
[0m22:31:12.802486 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019794315FF0>]}
[0m22:31:12.803484 [info ] [Thread-4 (]: 3 of 9 OK created sql table model WALRUS_PUBLIC.int_route_competition .......... [[32mSUCCESS 1[0m in 13.46s]
[0m22:31:12.804481 [debug] [Thread-4 (]: Finished running node model.fair_pricing_radar.int_route_competition
[0m22:31:13.534527 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 14.077 seconds
[0m22:31:13.536522 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197934FAE30>]}
[0m22:31:13.537520 [info ] [Thread-1 (]: 5 of 9 OK created sql table model WALRUS_PUBLIC.stg_route_stats ................ [[32mSUCCESS 1[0m in 14.19s]
[0m22:31:13.538517 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.stg_route_stats
[0m22:31:13.538517 [debug] [Thread-4 (]: Began running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:31:13.539514 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:31:13.539514 [info ] [Thread-4 (]: 6 of 9 START sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats ......... [RUN]
[0m22:31:13.541510 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.fair_pricing_radar.int_route_competition, now model.fair_pricing_radar.int_route_fare_per_mi_stats)
[0m22:31:13.540512 [info ] [Thread-1 (]: 7 of 9 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m22:31:13.541510 [debug] [Thread-4 (]: Began compiling node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:31:13.542507 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.fair_pricing_radar.stg_route_stats, now model.fair_pricing_radar.int_rules_r1_r2_r3)
[0m22:31:13.546495 [debug] [Thread-4 (]: Writing injected SQL for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m22:31:13.547493 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:31:13.552480 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:31:13.553477 [debug] [Thread-4 (]: Began executing node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:31:13.556469 [debug] [Thread-4 (]: Writing runtime sql for node "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m22:31:13.557467 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:31:13.560458 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:31:13.562453 [debug] [Thread-4 (]: Using snowflake connection "model.fair_pricing_radar.int_route_fare_per_mi_stats"
[0m22:31:13.565445 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:31:13.566443 [debug] [Thread-4 (]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_route_fare_per_mi_stats"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_route_fare_per_mi_stats
         as
        (

-- ╭──────────────────────────────────────────────────────────╮
-- 1.  Booking-level facts
-- ╰──────────────────────────────────────────────────────────╯
with base as (

    select
        legid,
        search_date,
        flight_date,
        days_to_flight,
        route,
        origin,
        destination,
        fare_bucket,
        total_miles,
        usd_per_mi,
        total_fare,
        base_fare,
        seats_flag,
        is_nonstop,
        is_basic_econ,
        is_refundable
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches
    where usd_per_mi is not null

),

-- ╭──────────────────────────────────────────────────────────╮
-- 2.  Route-bucket benchmarks
-- ╰──────────────────────────────────────────────────────────╯
bench as (

    select *
    from FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats

),

-- ╭──────────────────────────────────────────────────────────╮
-- 3.  Join + z-scores & premium flags
-- ╰──────────────────────────────────────────────────────────╯
joined as (

    select
        b.*,

        -- bring in benchmarks
        br.p50_usd_per_mi,
        br.p90_usd_per_mi,
        br.p95_usd_per_mi,
        br.p97_usd_per_mi,
        br.max_usd_per_mi,
        coalesce(br.legs_sampled, 0)          as legs_sampled,

        -- σ ≈ (p95 – p50) / 1.645
        (b.usd_per_mi - br.p50_usd_per_mi)
          / nullif((br.p95_usd_per_mi - br.p50_usd_per_mi) / 1.645, 0)
                                              as usd_per_mi_z,

        case when b.usd_per_mi >= br.p95_usd_per_mi then 1 else 0 end
                                              as is_above_p95,
        case when b.usd_per_mi >= br.p97_usd_per_mi then 1 else 0 end
                                              as is_above_p97

    from base  b
    left join bench br
      on  b.route       = br.route
      and b.fare_bucket = br.fare_bucket

)

select * from joined
        );
[0m22:31:13.567439 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (

-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    -- percentile benchmarks
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches     as s

  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    using (route, fare_bucket)

  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    using (route)

),

-- 2. Apply Rules 1–3
rules as (

  select
    *,
    /* Rule 1: statistical outlier */
    case
      when (
        (usd_per_mi - p50_usd_per_mi)
          / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
      ) >= 2
    then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
        and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
        and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag = 1
      or r2_seat_scarcity_flag = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m22:33:12.955982 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 119.388 seconds
[0m22:33:12.957977 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019793F49E10>]}
[0m22:33:12.958974 [info ] [Thread-1 (]: 7 of 9 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 119.42s]
[0m22:33:12.959972 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:33:12.960969 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m22:33:12.960969 [info ] [Thread-1 (]: 8 of 9 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m22:33:12.961966 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.fair_pricing_radar.int_rules_r1_r2_r3, now model.fair_pricing_radar.mart_pricing_features)
[0m22:33:12.962963 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m22:33:12.967950 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:33:12.969945 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m22:33:12.973934 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:33:12.977923 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m22:33:12.978922 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (guarding against NULL percentiles)
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 (only when both p50 and p95 are present) */
    case
      when p50_usd_per_mi  is not null
       and p95_usd_per_mi  is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price (only when p97 present) */
    case
      when seats_flag in ('sold_out','scarce')
       and p97_usd_per_mi  is not null
       and usd_per_mi     >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.90 AND price ≥ p95, only when p95 present) */
    case
      when hhi            >= 0.90
       and p95_usd_per_mi  is not null
       and usd_per_mi     >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    f.*,
    r1_price_outlier,
    r2_seat_scarcity,
    r3_monopoly_premium,
    case
        when r1_price_outlier = 1
          or r2_seat_scarcity = 1
          or r3_monopoly_premium = 1
        then 1 else 0
    end as any_rule_flag
  from flags f
)

select * from final
        );
[0m22:33:13.317016 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe94d-0305-0f94-0006-8fdb0018b5d6
[0m22:33:13.318013 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 002025 (42S21): SQL compilation error:
duplicate column name 'R1_PRICE_OUTLIER'
[0m22:33:13.320008 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m22:33:13.321005 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197933307C0>]}
[0m22:33:13.322002 [error] [Thread-1 (]: 8 of 9 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 0.36s]
[0m22:33:13.323000 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m22:33:13.323998 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m22:33:13.324994 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m22:33:13.324994 [info ] [Thread-1 (]: 9 of 9 SKIP relation WALRUS_PUBLIC.mart_pricing_alerts ......................... [[33mSKIP[0m]
[0m22:33:13.325992 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m22:33:29.883687 [debug] [Thread-4 (]: SQL status: SUCCESS 1 in 136.316 seconds
[0m22:33:29.885681 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197932C1660>]}
[0m22:33:29.886679 [info ] [Thread-4 (]: 6 of 9 OK created sql table model WALRUS_PUBLIC.int_route_fare_per_mi_stats .... [[32mSUCCESS 1[0m in 136.34s]
[0m22:33:29.887677 [debug] [Thread-4 (]: Finished running node model.fair_pricing_radar.int_route_fare_per_mi_stats
[0m22:33:35.559500 [debug] [Thread-2 (]: SQL status: SUCCESS 1 in 156.104 seconds
[0m22:33:35.561495 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001979432E9E0>]}
[0m22:33:35.562492 [info ] [Thread-2 (]: 4 of 9 OK created sql table model WALRUS_PUBLIC.int_route_daily_prices ......... [[32mSUCCESS 1[0m in 156.22s]
[0m22:33:35.563489 [debug] [Thread-2 (]: Finished running node model.fair_pricing_radar.int_route_daily_prices
[0m22:34:41.057242 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 221.604 seconds
[0m22:34:41.060234 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89816f2a-e899-4f9f-b107-c906e1444aca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019786772F20>]}
[0m22:34:41.061231 [info ] [Thread-3 (]: 2 of 9 OK created sql table model WALRUS_PUBLIC.int_fare_legs .................. [[32mSUCCESS 1[0m in 221.72s]
[0m22:34:41.062229 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.int_fare_legs
[0m22:34:41.064224 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:34:41.064224 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:34:41.065221 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:34:42.147325 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:34:42.148323 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:34:43.221451 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m22:34:43.222448 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m22:34:43.593456 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_fare_legs' was left open.
[0m22:34:43.594453 [debug] [MainThread]: On model.fair_pricing_radar.int_fare_legs: Close
[0m22:34:43.942522 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_fare_per_mi_stats' was left open.
[0m22:34:43.943519 [debug] [MainThread]: On model.fair_pricing_radar.int_route_fare_per_mi_stats: Close
[0m22:34:44.309539 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_route_daily_prices' was left open.
[0m22:34:44.310537 [debug] [MainThread]: On model.fair_pricing_radar.int_route_daily_prices: Close
[0m22:34:44.670573 [info ] [MainThread]: 
[0m22:34:44.671571 [info ] [MainThread]: Finished running 9 table models in 0 hours 7 minutes and 0.76 seconds (420.76s).
[0m22:34:44.673566 [debug] [MainThread]: Command end result
[0m22:34:44.705480 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:34:44.708472 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:34:44.718446 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:34:44.719443 [info ] [MainThread]: 
[0m22:34:44.720441 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:34:44.721544 [info ] [MainThread]: 
[0m22:34:44.722435 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m22:34:44.722435 [info ] [MainThread]: 
[0m22:34:44.723433 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=1 SKIP=1 TOTAL=9
[0m22:34:44.725428 [debug] [MainThread]: Command `dbt run` failed at 22:34:44.725428 after 423.40 seconds
[0m22:34:44.726425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197867CE560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019789D92A40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019789D92EC0>]}
[0m22:34:44.727422 [debug] [MainThread]: Flushing usage events
[0m22:34:45.160264 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:36:17.188017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243E9E1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243EB55DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243EB55E140>]}


============================== 22:36:17.192007 | 4d457032-a1b2-4a36-925d-320ac89f6bbb ==============================
[0m22:36:17.192007 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:36:17.193004 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m22:36:18.074645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243EB52E890>]}
[0m22:36:18.134484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243EB392D70>]}
[0m22:36:18.135482 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:36:18.694985 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:36:18.976232 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:36:18.977230 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:36:19.111869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F471D210>]}
[0m22:36:19.256483 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:36:19.259474 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:36:19.282413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F471F580>]}
[0m22:36:19.283411 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:36:19.284409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F471F790>]}
[0m22:36:19.286402 [info ] [MainThread]: 
[0m22:36:19.286402 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:36:19.287400 [info ] [MainThread]: 
[0m22:36:19.288397 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:36:19.289395 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:36:19.399101 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:36:19.400098 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:36:19.400098 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:24.300984 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.901 seconds
[0m22:36:24.308963 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:36:24.319934 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:36:24.319934 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:36:24.320931 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:27.972161 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.651 seconds
[0m22:36:27.977148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F4720E20>]}
[0m22:36:27.981137 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m22:36:27.982134 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m22:36:27.983132 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m22:36:27.983132 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m22:36:27.993105 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:36:27.994103 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m22:36:28.026017 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:36:28.031003 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m22:36:28.032001 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (guarding against NULL percentiles)
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 (only when both p50 and p95 are present) */
    case
      when p50_usd_per_mi  is not null
       and p95_usd_per_mi  is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price (only when p97 present) */
    case
      when seats_flag in ('sold_out','scarce')
       and p97_usd_per_mi  is not null
       and usd_per_mi     >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.90 AND price ≥ p95, only when p95 present) */
    case
      when hhi            >= 0.90
       and p95_usd_per_mi  is not null
       and usd_per_mi     >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    f.*,
    r1_price_outlier,
    r2_seat_scarcity,
    r3_monopoly_premium,
    case
        when r1_price_outlier = 1
          or r2_seat_scarcity = 1
          or r3_monopoly_premium = 1
        then 1 else 0
    end as any_rule_flag
  from flags f
)

select * from final
        );
[0m22:36:28.032001 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:36:32.050249 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe951-0305-0c96-0006-8fdb00189f82
[0m22:36:32.051246 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 002025 (42S21): SQL compilation error:
duplicate column name 'R1_PRICE_OUTLIER'
[0m22:36:32.053241 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m22:36:32.055236 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d457032-a1b2-4a36-925d-320ac89f6bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F5423CD0>]}
[0m22:36:32.056233 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 4.07s]
[0m22:36:32.057231 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m22:36:32.058228 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m22:36:32.060223 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:36:32.061220 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:36:32.061220 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:36:32.418264 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:36:32.418264 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:36:32.756360 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m22:36:32.757357 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m22:36:33.127367 [info ] [MainThread]: 
[0m22:36:33.128365 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.84 seconds (13.84s).
[0m22:36:33.129362 [debug] [MainThread]: Command end result
[0m22:36:33.160279 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:36:33.163271 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:36:33.170252 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:36:33.171250 [info ] [MainThread]: 
[0m22:36:33.172247 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:36:33.172247 [info ] [MainThread]: 
[0m22:36:33.173245 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  002025 (42S21): SQL compilation error:
  duplicate column name 'R1_PRICE_OUTLIER'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m22:36:33.174242 [info ] [MainThread]: 
[0m22:36:33.174242 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:36:33.176236 [debug] [MainThread]: Command `dbt run` failed at 22:36:33.176236 after 16.07 seconds
[0m22:36:33.177236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243E9E1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243F46BF760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000243E9EB0BE0>]}
[0m22:36:33.177236 [debug] [MainThread]: Flushing usage events
[0m22:36:33.530289 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:39:04.547201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4AE1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4C55DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4C55E1A0>]}


============================== 22:39:04.551190 | c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f ==============================
[0m22:39:04.551190 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:39:04.552188 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_pricing_features', 'send_anonymous_usage_stats': 'True'}
[0m22:39:05.436820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E47F97040>]}
[0m22:39:05.495663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4BBFE2C0>]}
[0m22:39:05.496661 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:39:06.053171 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:39:06.334418 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:39:06.335416 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m22:39:06.694455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E55788E20>]}
[0m22:39:06.836076 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:39:06.838070 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:39:06.862007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E55793D90>]}
[0m22:39:06.863004 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:39:06.864002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E55791D80>]}
[0m22:39:06.865996 [info ] [MainThread]: 
[0m22:39:06.865996 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:39:06.866994 [info ] [MainThread]: 
[0m22:39:06.867991 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:39:06.868988 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:39:06.975703 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:39:06.975703 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:39:06.976700 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:39:12.184764 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.208 seconds
[0m22:39:12.192742 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:39:12.202716 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:39:12.203713 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:39:12.203713 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:39:15.940714 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.736 seconds
[0m22:39:15.945700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E55793610>]}
[0m22:39:15.949690 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m22:39:15.950687 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m22:39:15.951685 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m22:39:15.951685 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m22:39:15.961658 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:39:15.962655 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m22:39:15.993572 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m22:39:15.997562 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m22:39:15.998559 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (

-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (guarding against NULL percentiles)
flags as (
  select
    *,
    /* Rule 1: z-score ≥ 2 */
    case
      when p50_usd_per_mi is not null
       and p95_usd_per_mi is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0) >= 2
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-3% price */
    case
      when seats_flag in ('sold_out','scarce')
       and p97_usd_per_mi is not null
       and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium */
    case
      when hhi >= 0.90
       and p95_usd_per_mi is not null
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
)

-- 7 · FINAL SELECT (any-rule flag)  
select
  f.*,
  case
    when f.r1_price_outlier    = 1
      or f.r2_seat_scarcity    = 1
      or f.r3_monopoly_premium = 1
    then 1 else 0
  end as any_rule_flag
from flags f
        );
[0m22:39:15.998559 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:41:12.574627 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 116.576 seconds
[0m22:41:12.598563 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2af2b0b-7b7c-4498-bdbc-5413d6ee8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E54B5FE50>]}
[0m22:41:12.599560 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 116.65s]
[0m22:41:12.600558 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m22:41:12.602553 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:41:12.602553 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:41:12.603550 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:41:12.957602 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:41:12.958600 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:41:13.320631 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m22:41:13.321628 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m22:41:13.654737 [info ] [MainThread]: 
[0m22:41:13.655735 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 6.79 seconds (126.79s).
[0m22:41:13.657729 [debug] [MainThread]: Command end result
[0m22:41:13.689643 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:41:13.692636 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:41:13.701612 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:41:13.702609 [info ] [MainThread]: 
[0m22:41:13.703607 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:41:13.704604 [info ] [MainThread]: 
[0m22:41:13.705602 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:41:13.707596 [debug] [MainThread]: Command `dbt run` succeeded at 22:41:13.707596 after 129.24 seconds
[0m22:41:13.707596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4AE1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E54EC1D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E55634670>]}
[0m22:41:13.708593 [debug] [MainThread]: Flushing usage events
[0m22:41:14.056661 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:49:56.876710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBAD1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBC45DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBC45E1A0>]}


============================== 22:49:56.880699 | d6f05ef1-1fe6-4e97-9b88-75a33b3dd205 ==============================
[0m22:49:56.880699 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:49:56.880699 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:49:57.820185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd6f05ef1-1fe6-4e97-9b88-75a33b3dd205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACB9097040>]}
[0m22:49:57.878030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd6f05ef1-1fe6-4e97-9b88-75a33b3dd205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBBCFDE10>]}
[0m22:49:57.880025 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:49:58.442520 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:49:58.618050 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m22:49:58.619047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd6f05ef1-1fe6-4e97-9b88-75a33b3dd205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBBCFD540>]}
[0m22:49:59.737056 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  expected token 'end of statement block', got 'set'
    line 5
      set r2_pct       = var('r2_pct_threshold', 0.97)
[0m22:49:59.739051 [debug] [MainThread]: Command `dbt run` failed at 22:49:59.739051 after 2.95 seconds
[0m22:49:59.740048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACBAD1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACC5565ED0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ACC5567460>]}
[0m22:49:59.740048 [debug] [MainThread]: Flushing usage events
[0m22:50:00.105071 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:50:36.626348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE351D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE4C59CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE4C59ED0>]}


============================== 22:50:36.629340 | 73305c4a-bed3-4771-96e2-8476bb3119e2 ==============================
[0m22:50:36.629340 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:50:36.630337 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m22:50:37.518959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73305c4a-bed3-4771-96e2-8476bb3119e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE1797010>]}
[0m22:50:37.578799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73305c4a-bed3-4771-96e2-8476bb3119e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AED45C460>]}
[0m22:50:37.579797 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:50:38.130323 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:50:38.296878 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m22:50:38.297876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '73305c4a-bed3-4771-96e2-8476bb3119e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE44FEB60>]}
[0m22:50:39.384966 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  expected token 'end of statement block', got 'set'
    line 5
      set r2_pct       = var('r2_pct_threshold', 0.97)
[0m22:50:39.386961 [debug] [MainThread]: Command `dbt run` failed at 22:50:39.386961 after 2.84 seconds
[0m22:50:39.386961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AE351D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AEDE65EA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AEDE67430>]}
[0m22:50:39.387959 [debug] [MainThread]: Flushing usage events
[0m22:50:39.723062 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:58:53.928687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A741D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A8B5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A8B5E1A0>]}


============================== 22:58:53.932676 | 43e99dfb-23a5-4e9d-9543-8030397bb6ec ==============================
[0m22:58:53.932676 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:58:53.932676 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:58:54.949954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A5897040>]}
[0m22:58:55.012786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A81FE2C0>]}
[0m22:58:55.013784 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m22:58:55.579270 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:58:55.746822 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m22:58:55.747819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A81FEB90>]}
[0m22:58:57.623799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B21ACFA0>]}
[0m22:58:57.766417 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:58:57.769410 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:58:57.795340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B20CB6D0>]}
[0m22:58:57.796338 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m22:58:57.797336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B20CB7C0>]}
[0m22:58:57.798333 [info ] [MainThread]: 
[0m22:58:57.799330 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:58:57.800328 [info ] [MainThread]: 
[0m22:58:57.800328 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m22:58:57.802322 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m22:58:57.935964 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m22:58:57.935964 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m22:58:57.936962 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:59:03.271687 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.334 seconds
[0m22:59:03.278668 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m22:59:03.289639 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m22:59:03.290636 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m22:59:03.290636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:59:06.937877 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.647 seconds
[0m22:59:06.941866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B20CB070>]}
[0m22:59:06.946853 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:59:06.947851 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m22:59:06.948848 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m22:59:06.948848 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:59:06.959818 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:59:06.960816 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:59:06.991733 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:59:06.993728 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m22:59:06.994725 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (









-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches       as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats   as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c using (route)

),

-- 2. Apply Rules 1–3 with variable thresholds
rules as (
  select
    *,
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi)/1.645,0))
           >= 2
      then 1 else 0
    end as r1_price_outlier_flag,

    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= p97.0_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    case
      when hhi >= 0.9
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag
  from base
)

select
  *,
  case when r1_price_outlier_flag = 1
         or r2_seat_scarcity_flag = 1
         or r3_monopoly_premium_flag = 1
       then 1 else 0
  end as any_rule_flag
from rules
        );
[0m22:59:06.995722 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:59:10.693827 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe967-0305-0c96-0006-8fdb0018e106
[0m22:59:10.693827 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 53 at position 28 unexpected '.0'.
syntax error line 54 at position 6 unexpected 'then'.
syntax error line 58 at position 6 unexpected 'when'.
syntax error line 65 at position 0 unexpected 'select'.
[0m22:59:10.696819 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 53 at position 28 unexpected '.0'.
  syntax error line 54 at position 6 unexpected 'then'.
  syntax error line 58 at position 6 unexpected 'when'.
  syntax error line 65 at position 0 unexpected 'select'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m22:59:10.698813 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43e99dfb-23a5-4e9d-9543-8030397bb6ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B20C8370>]}
[0m22:59:10.699811 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.75s]
[0m22:59:10.700809 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m22:59:10.701806 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 53 at position 28 unexpected '.0'.
  syntax error line 54 at position 6 unexpected 'then'.
  syntax error line 58 at position 6 unexpected 'when'.
  syntax error line 65 at position 0 unexpected 'select'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m22:59:10.702803 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:59:10.703801 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m22:59:10.703801 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m22:59:11.057853 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m22:59:11.057853 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m22:59:11.408913 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m22:59:11.409911 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m22:59:11.735041 [info ] [MainThread]: 
[0m22:59:11.736039 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.93 seconds (13.93s).
[0m22:59:11.737036 [debug] [MainThread]: Command end result
[0m22:59:11.769948 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m22:59:11.771942 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m22:59:11.779921 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m22:59:11.779921 [info ] [MainThread]: 
[0m22:59:11.780919 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:59:11.781916 [info ] [MainThread]: 
[0m22:59:11.782913 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 53 at position 28 unexpected '.0'.
  syntax error line 54 at position 6 unexpected 'then'.
  syntax error line 58 at position 6 unexpected 'when'.
  syntax error line 65 at position 0 unexpected 'select'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m22:59:11.783910 [info ] [MainThread]: 
[0m22:59:11.783910 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:59:11.785905 [debug] [MainThread]: Command `dbt run` failed at 22:59:11.785905 after 17.94 seconds
[0m22:59:11.785905 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A741D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B25443A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228A74D44C0>]}
[0m22:59:11.786902 [debug] [MainThread]: Flushing usage events
[0m22:59:12.141952 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:01:31.423266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3A941D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3AAB5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3AAB5E1A0>]}


============================== 23:01:31.427255 | 88fbb1b2-e2ef-4e32-8671-3f0f90ac0edf ==============================
[0m23:01:31.427255 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:01:31.428253 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:01:32.319866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88fbb1b2-e2ef-4e32-8671-3f0f90ac0edf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3A7897040>]}
[0m23:01:32.379706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88fbb1b2-e2ef-4e32-8671-3f0f90ac0edf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3AA1FE2C0>]}
[0m23:01:32.380704 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:01:32.940206 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:01:33.233422 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:01:33.233422 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:01:33.472782 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  unexpected '~'
    line 9
      {% set r2_field    = 'p' ~ r2_pctile ~~ '_usd_per_mi' %}
[0m23:01:33.474777 [debug] [MainThread]: Command `dbt run` failed at 23:01:33.474777 after 2.13 seconds
[0m23:01:33.475774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3A941D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3B3C3EA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E3B3C3E830>]}
[0m23:01:33.475774 [debug] [MainThread]: Flushing usage events
[0m23:01:33.843789 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:01:59.724538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA61D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CBD5A350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CBD5A170>]}


============================== 23:01:59.728527 | 0fe3419f-16c6-4213-b992-01bb46c7a62c ==============================
[0m23:01:59.728527 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:01:59.729525 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:02:00.613160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0fe3419f-16c6-4213-b992-01bb46c7a62c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221C8A97040>]}
[0m23:02:00.672002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0fe3419f-16c6-4213-b992-01bb46c7a62c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CB3FE2C0>]}
[0m23:02:00.673997 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:02:01.234497 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:02:01.510758 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:02:01.511755 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:02:01.754107 [error] [MainThread]: Encountered an error:
Compilation Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  unexpected '~'
    line 9
      {% set r2_field    = 'p' ~ r2_pctile ~~ '_usd_per_mi' %}
[0m23:02:01.756102 [debug] [MainThread]: Command `dbt run` failed at 23:02:01.756102 after 2.11 seconds
[0m23:02:01.757099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221CA61D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221D4F3EA40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000221D4F3E830>]}
[0m23:02:01.757099 [debug] [MainThread]: Flushing usage events
[0m23:02:02.107162 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:03:17.096507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E351D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E4C59C30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E4C59E10>]}


============================== 23:03:17.100496 | 3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc ==============================
[0m23:03:17.100496 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:03:17.101494 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:03:17.983135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E4C37DF0>]}
[0m23:03:18.042975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E4A92D70>]}
[0m23:03:18.043973 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:03:18.604472 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:03:18.884722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:03:18.885720 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:03:19.250743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207EE0A4B50>]}
[0m23:03:19.399345 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:03:19.402337 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:03:19.426274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207EDCF6260>]}
[0m23:03:19.427271 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:03:19.427271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207EDCF72E0>]}
[0m23:03:19.429265 [info ] [MainThread]: 
[0m23:03:19.430263 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:03:19.431261 [info ] [MainThread]: 
[0m23:03:19.431261 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:03:19.432257 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:03:19.540966 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:03:19.540966 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:03:19.541964 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:03:24.261336 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.719 seconds
[0m23:03:24.269314 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:03:24.279287 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:03:24.280285 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:03:24.281282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:03:27.868683 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.588 seconds
[0m23:03:27.873670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207EDCF4B20>]}
[0m23:03:27.877659 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:27.878657 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:03:27.879654 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:03:27.880651 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:27.891622 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:27.892619 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:27.923536 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:27.926528 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:27.927526 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (









-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches             as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats         as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   as c  using (route)

),

-- 2. Apply Rules 1–3 with variable thresholds
rules as (

  select
    *,
    /* Rule 1: z-score ≥ 2 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 2
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-97% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.9) */
    case
      when hhi >= 0.9
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules;
[0m23:03:27.927526 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:03:31.500964 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe96c-0305-0bb1-0006-8fdb0018d286
[0m23:03:31.500964 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 81 at position 10 unexpected ';'.
[0m23:03:31.503956 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 81 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:03:31.505951 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d2d7e31-53b9-4fed-9f7b-50f6f731b8dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207EDCF6500>]}
[0m23:03:31.506948 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.62s]
[0m23:03:31.507946 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:31.508943 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 81 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m23:03:31.510937 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:03:31.510937 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:03:31.511935 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:03:31.851027 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:03:31.852025 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:03:32.195107 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:03:32.196104 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:03:32.534200 [info ] [MainThread]: 
[0m23:03:32.534200 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.10 seconds (13.10s).
[0m23:03:32.536195 [debug] [MainThread]: Command end result
[0m23:03:32.569106 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:03:32.573096 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:03:32.581074 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:03:32.582072 [info ] [MainThread]: 
[0m23:03:32.583069 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:03:32.584067 [info ] [MainThread]: 
[0m23:03:32.585064 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 81 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:03:32.586061 [info ] [MainThread]: 
[0m23:03:32.587058 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:03:32.589053 [debug] [MainThread]: Command `dbt run` failed at 23:03:32.589053 after 15.57 seconds
[0m23:03:32.590051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E351D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E4A92D70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207E35B1030>]}
[0m23:03:32.590051 [debug] [MainThread]: Flushing usage events
[0m23:03:32.959063 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:03:42.981245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C88D1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C8A45DF60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C8A45E140>]}


============================== 23:03:42.985235 | 0c223e40-d917-4f82-ba9d-c791bcea3adb ==============================
[0m23:03:42.985235 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:03:42.986232 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m23:03:43.870865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C8A437DF0>]}
[0m23:03:43.930704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C8A292D70>]}
[0m23:03:43.931702 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:03:44.509157 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:03:44.797386 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:03:44.798383 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:03:45.166398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C93590B50>]}
[0m23:03:45.311011 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:03:45.313006 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:03:45.336942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C934F21D0>]}
[0m23:03:45.337939 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:03:45.337939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C934F2470>]}
[0m23:03:45.339934 [info ] [MainThread]: 
[0m23:03:45.340932 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:03:45.341929 [info ] [MainThread]: 
[0m23:03:45.341929 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:03:45.342926 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:03:45.450638 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:03:45.451635 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:03:45.451635 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:03:48.514440 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.063 seconds
[0m23:03:48.522418 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:03:48.533389 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:03:48.533389 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:03:48.534386 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:03:52.189606 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.655 seconds
[0m23:03:52.193595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C934F1060>]}
[0m23:03:52.198582 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:52.199579 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:03:52.199579 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:03:52.200577 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:52.211547 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:52.212544 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:03:52.244459 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:52.246454 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:03:52.247451 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (









-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches             as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats         as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   as c  using (route)

),

-- 2. Apply Rules 1–3 with variable thresholds
rules as (

  select
    *,
    /* Rule 1: z-score ≥ 2 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 2
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-97% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= p97_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.9) */
    case
      when hhi >= 0.9
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:03:52.248448 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:04:27.046337 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 34.798 seconds
[0m23:04:27.069275 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c223e40-d917-4f82-ba9d-c791bcea3adb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C92C5C2E0>]}
[0m23:04:27.070273 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 34.87s]
[0m23:04:27.071271 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:04:27.073265 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:04:27.073265 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:04:27.074262 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:04:27.412357 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:04:27.413355 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:04:27.760426 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:04:27.761423 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:04:28.092538 [info ] [MainThread]: 
[0m23:04:28.093535 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 42.75 seconds (42.75s).
[0m23:04:28.094532 [debug] [MainThread]: Command end result
[0m23:04:28.126446 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:04:28.130437 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:04:28.138414 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:04:28.139412 [info ] [MainThread]: 
[0m23:04:28.141407 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:04:28.142405 [info ] [MainThread]: 
[0m23:04:28.143402 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:04:28.144399 [debug] [MainThread]: Command `dbt run` succeeded at 23:04:28.144399 after 45.24 seconds
[0m23:04:28.145396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C88D1D330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C93869C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026C877A0C40>]}
[0m23:04:28.146394 [debug] [MainThread]: Flushing usage events
[0m23:04:28.481496 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:09:16.512788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990A31D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990BA5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990BA5E1A0>]}


============================== 23:09:16.516777 | 5fdb23fa-301e-4877-94a6-bb123790f129 ==============================
[0m23:09:16.516777 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:09:16.517775 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:09:17.433325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019908597040>]}
[0m23:09:17.495159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990B2FE2C0>]}
[0m23:09:17.497154 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:09:18.058651 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:09:18.233184 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:09:18.234182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990B2FEB90>]}
[0m23:09:20.182967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019915386830>]}
[0m23:09:20.327580 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:09:20.329575 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:09:20.354509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199152F49D0>]}
[0m23:09:20.355506 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:09:20.356504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001991536B520>]}
[0m23:09:20.358498 [info ] [MainThread]: 
[0m23:09:20.359495 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:09:20.360493 [info ] [MainThread]: 
[0m23:09:20.360493 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:09:20.362487 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:09:20.475186 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:09:20.476183 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:09:20.476183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:09:26.455184 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.978 seconds
[0m23:09:26.463163 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:09:26.473136 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:09:26.474133 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:09:26.474133 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:09:30.203155 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.729 seconds
[0m23:09:30.208142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199152F5780>]}
[0m23:09:30.212131 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:09:30.213129 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:09:30.214126 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:09:30.215124 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:09:30.226094 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:09:30.227092 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:09:30.258009 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:09:30.261001 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:09:30.261998 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (









-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches             as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats         as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition   as c  using (route)

),

-- 2. Apply Rules 1–3 with variable thresholds
rules as (

  select
    *,
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + top-93% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= p93_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:09:30.261998 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:09:33.905249 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe972-0305-0fb8-0006-8fdb0018c7a6
[0m23:09:33.905249 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 56 at position 25
invalid identifier 'P93_USD_PER_MI'
[0m23:09:33.908241 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  000904 (42000): SQL compilation error: error line 56 at position 25
  invalid identifier 'P93_USD_PER_MI'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:09:33.910236 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fdb23fa-301e-4877-94a6-bb123790f129', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199083CF4F0>]}
[0m23:09:33.911234 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.69s]
[0m23:09:33.912231 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:09:33.913228 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  000904 (42000): SQL compilation error: error line 56 at position 25
  invalid identifier 'P93_USD_PER_MI'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m23:09:33.914225 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:09:33.915223 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:09:33.915223 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:09:34.251324 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:09:34.252321 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:09:34.593408 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:09:34.594405 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:09:34.940479 [info ] [MainThread]: 
[0m23:09:34.941477 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 14.58 seconds (14.58s).
[0m23:09:34.942474 [debug] [MainThread]: Command end result
[0m23:09:34.974389 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:09:34.977381 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:09:34.985360 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:09:34.986357 [info ] [MainThread]: 
[0m23:09:34.987355 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:09:34.987355 [info ] [MainThread]: 
[0m23:09:34.988352 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  000904 (42000): SQL compilation error: error line 56 at position 25
  invalid identifier 'P93_USD_PER_MI'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:09:34.989349 [info ] [MainThread]: 
[0m23:09:34.990346 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:09:34.991344 [debug] [MainThread]: Command `dbt run` failed at 23:09:34.991344 after 18.56 seconds
[0m23:09:34.992340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990A31D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199152AFA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001990A3D44C0>]}
[0m23:09:34.992340 [debug] [MainThread]: Flushing usage events
[0m23:09:35.336420 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:20:03.869602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027737C1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002773935DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002773935E1A0>]}


============================== 23:20:03.873592 | f492a7be-cab1-4c52-a8f4-8f919c8ea107 ==============================
[0m23:20:03.873592 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:20:03.874590 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m23:20:04.787147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002773932BE20>]}
[0m23:20:04.845990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027741C5F400>]}
[0m23:20:04.846987 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:20:05.403498 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:20:05.690729 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:20:05.691727 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:20:06.058744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277428A4B20>]}
[0m23:20:06.201363 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:20:06.203358 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:20:06.228292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277425393F0>]}
[0m23:20:06.228292 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:20:06.229288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000277425330D0>]}
[0m23:20:06.231283 [info ] [MainThread]: 
[0m23:20:06.232281 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:20:06.232281 [info ] [MainThread]: 
[0m23:20:06.233278 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:20:06.234276 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:20:06.342984 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:20:06.343981 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:20:06.343981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:20:10.885829 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.542 seconds
[0m23:20:10.893807 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:20:10.904778 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:20:10.904778 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:20:10.905775 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:20:14.595901 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.690 seconds
[0m23:20:14.599890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027742538310>]}
[0m23:20:14.604877 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:14.605875 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:20:14.605875 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:20:14.606872 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:14.618841 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:14.619837 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:14.649757 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:14.652749 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:14.652749 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (





-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches           as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats       as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c  using (route)

),

-- 2. Apply Rules 1–3 with dynamic Rule 2 threshold
rules as (

  select
    *,
    
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + price ≥ dynamic 93.0th percentile */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= percentile_cont(0.93)
                            within group (order by usd_per_mi)
                            over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules;
[0m23:20:14.653747 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:20:18.257104 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe97d-0305-0fb8-0006-8fdb0018c832
[0m23:20:18.258102 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 80 at position 10 unexpected ';'.
[0m23:20:18.260097 [debug] [Thread-1 (]: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 80 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:20:18.263089 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f492a7be-cab1-4c52-a8f4-8f919c8ea107', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027734CCE200>]}
[0m23:20:18.263089 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ......... [[31mERROR[0m in 3.66s]
[0m23:20:18.265084 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:18.265084 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_rules_r1_r2_r3' to be skipped because of status 'error'.  Reason: Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 80 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql.
[0m23:20:18.267078 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:20:18.268075 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:20:18.268075 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:20:18.603178 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:20:18.604176 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:20:18.939279 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:20:18.940276 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:20:19.280366 [info ] [MainThread]: 
[0m23:20:19.281364 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.05 seconds (13.05s).
[0m23:20:19.282362 [debug] [MainThread]: Command end result
[0m23:20:19.313279 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:20:19.316270 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:20:19.324249 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:20:19.325248 [info ] [MainThread]: 
[0m23:20:19.326245 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:20:19.327242 [info ] [MainThread]: 
[0m23:20:19.327242 [error] [MainThread]:   Database Error in model int_rules_r1_r2_r3 (models\intermediate\int_rules_r1_r2_r3.sql)
  001003 (42000): SQL compilation error:
  syntax error line 80 at position 10 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_rules_r1_r2_r3.sql
[0m23:20:19.328239 [info ] [MainThread]: 
[0m23:20:19.329236 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:20:19.331231 [debug] [MainThread]: Command `dbt run` failed at 23:20:19.331231 after 15.54 seconds
[0m23:20:19.332228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027737C1D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027742527F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027737CD43D0>]}
[0m23:20:19.332228 [debug] [MainThread]: Flushing usage events
[0m23:20:19.686280 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:20:29.756335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582441D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015825B59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015825B59EA0>]}


============================== 23:20:29.760324 | de42268e-9278-405c-93f7-2d9a935e6af7 ==============================
[0m23:20:29.760324 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:20:29.761322 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m23:20:30.834450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015822897040>]}
[0m23:20:30.905261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000158251FE2C0>]}
[0m23:20:30.907256 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:20:31.502662 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:20:31.793883 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:20:31.794880 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_rules_r1_r2_r3.sql
[0m23:20:32.161898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582F0A4AC0>]}
[0m23:20:32.304516 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:20:32.307509 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:20:32.330447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582ED3D240>]}
[0m23:20:32.331445 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:20:32.332443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582ED3FD60>]}
[0m23:20:32.333440 [info ] [MainThread]: 
[0m23:20:32.334437 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:20:32.335434 [info ] [MainThread]: 
[0m23:20:32.335434 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:20:32.337429 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:20:32.443146 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:20:32.444143 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:20:32.444143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:20:36.011597 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.567 seconds
[0m23:20:36.019577 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:20:36.029549 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:20:36.030547 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:20:36.030547 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:20:39.718678 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.688 seconds
[0m23:20:39.723664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582ED3E2C0>]}
[0m23:20:39.728652 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:39.728652 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:20:39.729649 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:20:39.730647 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:39.740619 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:39.741617 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:20:39.773531 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:39.776523 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:20:39.777521 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (





-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches           as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats       as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c  using (route)

),

-- 2. Apply Rules 1–3 with dynamic Rule 2 threshold
rules as (

  select
    *,
    
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + price ≥ dynamic 93.0th percentile */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= percentile_cont(0.93)
                            within group (order by usd_per_mi)
                            over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:20:39.777521 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:21:30.659372 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 50.881 seconds
[0m23:21:30.689292 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de42268e-9278-405c-93f7-2d9a935e6af7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582E45FE50>]}
[0m23:21:30.691287 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 50.96s]
[0m23:21:30.694280 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:21:30.696274 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:30.697271 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:21:30.698268 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:21:31.077256 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:21:31.078252 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:21:31.425322 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:21:31.426320 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:21:31.753444 [info ] [MainThread]: 
[0m23:21:31.754443 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 59.42 seconds (59.42s).
[0m23:21:31.756437 [debug] [MainThread]: Command end result
[0m23:21:31.788351 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:21:31.791344 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:21:31.799322 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:21:31.799322 [info ] [MainThread]: 
[0m23:21:31.800320 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:31.801317 [info ] [MainThread]: 
[0m23:21:31.801317 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:21:31.804309 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:31.803316 after 62.13 seconds
[0m23:21:31.804309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582441D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582E5722F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001582ED2B2E0>]}
[0m23:21:31.805306 [debug] [MainThread]: Flushing usage events
[0m23:21:32.158361 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:22:10.536669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5D61D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5ED5A2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5ED5A0E0>]}


============================== 23:22:10.540658 | 885222d1-db4c-49bb-8edb-80b241e8937a ==============================
[0m23:22:10.540658 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:22:10.541657 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:22:11.469173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5ED35CC0>]}
[0m23:22:11.528016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F6735F820>]}
[0m23:22:11.530011 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:22:12.091508 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:22:12.266041 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:22:12.267039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5E3FEB30>]}
[0m23:22:14.144016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F688206A0>]}
[0m23:22:14.285637 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:22:14.288629 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:22:14.314561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F67FAD870>]}
[0m23:22:14.315558 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:22:14.316555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F67FFC940>]}
[0m23:22:14.317553 [info ] [MainThread]: 
[0m23:22:14.318550 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:22:14.319547 [info ] [MainThread]: 
[0m23:22:14.320544 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:22:14.321542 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:22:14.443216 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:22:14.444213 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:22:14.444213 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:22:17.672575 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.228 seconds
[0m23:22:17.680553 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:22:17.690527 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:22:17.691524 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:22:17.691524 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:22:21.304855 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.613 seconds
[0m23:22:21.309842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F67FAF460>]}
[0m23:22:21.313831 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:22:21.314829 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:22:21.315826 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:22:21.316824 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:22:21.326797 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:22:21.327794 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:22:21.358711 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:22:21.361704 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:22:21.362701 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (





-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches           as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats       as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c  using (route)

),

-- 2. Apply Rules 1–3 with dynamic Rule 2 threshold
rules as (

  select
    *,
    
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + price ≥ dynamic 90.0th percentile */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= percentile_cont(0.9)
                            within group (order by usd_per_mi)
                            over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:22:21.363698 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:23:12.513832 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 51.151 seconds
[0m23:23:12.539762 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '885222d1-db4c-49bb-8edb-80b241e8937a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5B5CEB00>]}
[0m23:23:12.540760 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 51.22s]
[0m23:23:12.541757 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:23:12.542755 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:23:12.543752 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:23:12.543752 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:23:12.877857 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:23:12.877857 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:23:13.219943 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:23:13.220940 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:23:13.565020 [info ] [MainThread]: 
[0m23:23:13.566017 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 59.25 seconds (59.25s).
[0m23:23:13.567014 [debug] [MainThread]: Command end result
[0m23:23:13.599925 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:23:13.603915 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:23:13.611894 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:23:13.612891 [info ] [MainThread]: 
[0m23:23:13.614886 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:23:13.615884 [info ] [MainThread]: 
[0m23:23:13.616881 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:23:13.617878 [debug] [MainThread]: Command `dbt run` succeeded at 23:23:13.617878 after 63.17 seconds
[0m23:23:13.619874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5D6D77F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F684F36A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F5D6B2110>]}
[0m23:23:13.620870 [debug] [MainThread]: Flushing usage events
[0m23:23:13.987887 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:26:50.595293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3361D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D34D59CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D34D59EA0>]}


============================== 23:26:50.598286 | 0dc4ae27-42fa-4844-8cbd-12e0f276b9b6 ==============================
[0m23:26:50.598286 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:26:50.599283 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'send_anonymous_usage_stats': 'True'}
[0m23:26:51.549740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D31A97040>]}
[0m23:26:51.612571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D346022C0>]}
[0m23:26:51.614567 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:26:52.195014 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:26:52.370543 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:26:52.371541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D34602B90>]}
[0m23:26:54.260486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3E845A20>]}
[0m23:26:54.404102 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:26:54.407094 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:26:54.436017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3E4F1780>]}
[0m23:26:54.437014 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:26:54.438012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3E4F19C0>]}
[0m23:26:54.440006 [info ] [MainThread]: 
[0m23:26:54.441003 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:26:54.442001 [info ] [MainThread]: 
[0m23:26:54.442999 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:26:54.444993 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:26:54.555696 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:26:54.556694 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:26:54.556694 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:26:59.236172 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.679 seconds
[0m23:26:59.244151 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:26:59.254124 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:26:59.255122 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:26:59.255122 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:27:02.894383 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.639 seconds
[0m23:27:02.899370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3E4F1660>]}
[0m23:27:02.903360 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:27:02.904357 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:27:02.905355 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:27:02.906352 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:27:02.916325 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:27:02.917322 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:27:02.948239 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:27:02.951231 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:27:02.952229 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (





-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches           as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats       as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c  using (route)

),

-- 2. Apply Rules 1–3 with dynamic Rule 2 threshold
rules as (

  select
    *,
    
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + price ≥ dynamic 93.0th percentile */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= percentile_cont(0.93)
                            within group (order by usd_per_mi)
                            over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.75) */
    case
      when hhi >= 0.75
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:27:02.952229 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:28:00.677769 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 57.725 seconds
[0m23:28:00.708686 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0dc4ae27-42fa-4844-8cbd-12e0f276b9b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D315CF4F0>]}
[0m23:28:00.710680 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 57.80s]
[0m23:28:00.720654 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:28:00.723646 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:28:00.724643 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:28:00.726638 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:28:01.080690 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:28:01.081687 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:28:01.431750 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:28:01.432748 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:28:01.768849 [info ] [MainThread]: 
[0m23:28:01.769846 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 7.33 seconds (67.33s).
[0m23:28:01.770843 [debug] [MainThread]: Command end result
[0m23:28:01.804754 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:28:01.807744 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:28:01.815723 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:28:01.816722 [info ] [MainThread]: 
[0m23:28:01.817718 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:28:01.818715 [info ] [MainThread]: 
[0m23:28:01.818715 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:28:01.820710 [debug] [MainThread]: Command `dbt run` succeeded at 23:28:01.820710 after 71.30 seconds
[0m23:28:01.820710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3361D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3368F880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D3E4B2B00>]}
[0m23:28:01.821707 [debug] [MainThread]: Flushing usage events
[0m23:28:02.167781 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:28:34.681781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0AC1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0C359CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0C359EA0>]}


============================== 23:28:34.685770 | 26065f4a-da7a-4fe8-9f01-760e1cbd2857 ==============================
[0m23:28:34.685770 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:28:34.686767 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --select int_rules_r1_r2_r3', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:28:35.572397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C09097040>]}
[0m23:28:35.634232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0B9FDE10>]}
[0m23:28:35.635230 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:28:36.197724 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:28:36.375249 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:28:36.376247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0B9FD540>]}
[0m23:28:38.245245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C15D45A20>]}
[0m23:28:38.388862 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:28:38.390856 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:28:38.414792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C159F1780>]}
[0m23:28:38.415790 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:28:38.415790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C159F19C0>]}
[0m23:28:38.417784 [info ] [MainThread]: 
[0m23:28:38.418781 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:28:38.419779 [info ] [MainThread]: 
[0m23:28:38.419779 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:28:38.421774 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:28:38.529485 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:28:38.530482 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:28:38.530482 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:28:43.037423 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.506 seconds
[0m23:28:43.044404 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:28:43.055375 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:28:43.056372 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:28:43.056372 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:28:46.677682 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.621 seconds
[0m23:28:46.682669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C159F1660>]}
[0m23:28:46.687655 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:28:46.687655 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 .................. [RUN]
[0m23:28:46.688653 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_rules_r1_r2_r3'
[0m23:28:46.689651 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:28:46.699623 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:28:46.700621 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:28:46.732535 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:28:46.735527 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_rules_r1_r2_r3"
[0m23:28:46.736525 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_rules_r1_r2_r3: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_rules_r1_r2_r3"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_rules_r1_r2_r3
         as
        (





-- 1. Core booking row + route & carrier stats
with base as (

  select
    s.legid,
    s.route,
    s.flight_date,
    s.search_date,
    s.days_to_flight,
    s.fare_bucket,
    s.usd_per_mi,
    s.seats_flag,

    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi,

    c.carrier_count,
    c.hhi

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches           as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats       as rs using (route, fare_bucket)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c  using (route)

),

-- 2. Apply Rules 1–3 with dynamic Rule 2 threshold
rules as (

  select
    *,
    
    /* Rule 1: z-score ≥ 1.5 */
    case
      when ((usd_per_mi - p50_usd_per_mi)
             / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           ) >= 1.5
      then 1 else 0
    end as r1_price_outlier_flag,

    /* Rule 2: seat scarcity + price ≥ dynamic 90.0th percentile */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >= percentile_cont(0.9)
                            within group (order by usd_per_mi)
                            over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity_flag,

    /* Rule 3: monopoly premium (HHI ≥ 0.7) */
    case
      when hhi >= 0.7
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium_flag

  from base

)

-- 3. Final select with “any rule” flag
select
  *,
  case
    when r1_price_outlier_flag    = 1
      or r2_seat_scarcity_flag    = 1
      or r3_monopoly_premium_flag = 1
    then 1 else 0
  end as any_rule_flag

from rules
        );
[0m23:28:46.736525 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:29:40.829783 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 54.092 seconds
[0m23:29:40.852722 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '26065f4a-da7a-4fe8-9f01-760e1cbd2857', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C07CCF4F0>]}
[0m23:29:40.853719 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.int_rules_r1_r2_r3 ............. [[32mSUCCESS 1[0m in 54.16s]
[0m23:29:40.854716 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_rules_r1_r2_r3
[0m23:29:40.856711 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:29:40.856711 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:29:40.857708 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:29:41.200790 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:29:41.201788 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:29:41.549857 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_rules_r1_r2_r3' was left open.
[0m23:29:41.549857 [debug] [MainThread]: On model.fair_pricing_radar.int_rules_r1_r2_r3: Close
[0m23:29:42.059493 [info ] [MainThread]: 
[0m23:29:42.060490 [info ] [MainThread]: Finished running 1 table model in 0 hours 1 minutes and 3.64 seconds (63.64s).
[0m23:29:42.061488 [debug] [MainThread]: Command end result
[0m23:29:42.094400 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:29:42.097392 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:29:42.105369 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:29:42.106368 [info ] [MainThread]: 
[0m23:29:42.107366 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:29:42.108362 [info ] [MainThread]: 
[0m23:29:42.109359 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:29:42.110357 [debug] [MainThread]: Command `dbt run` succeeded at 23:29:42.110357 after 67.51 seconds
[0m23:29:42.111354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0AC1D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C0AC8F880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024C159AAA40>]}
[0m23:29:42.112351 [debug] [MainThread]: Flushing usage events
[0m23:29:42.459423 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:34:18.010109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0321D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA04959CC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA04959EA0>]}


============================== 23:34:18.014098 | 4c6aba06-cce3-4804-af9e-6c2ec041e011 ==============================
[0m23:34:18.014098 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:34:18.015096 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select mart_pricing_features', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:34:18.906710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA01397040>]}
[0m23:34:18.965552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA041FE2C0>]}
[0m23:34:18.966550 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:34:19.520069 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:34:19.696596 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m23:34:19.697595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA041FEB90>]}
[0m23:34:21.575569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0E1965C0>]}
[0m23:34:21.722176 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:34:21.726167 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:34:21.751099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0DCB2770>]}
[0m23:34:21.752097 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:34:21.753094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0DCB2410>]}
[0m23:34:21.755089 [info ] [MainThread]: 
[0m23:34:21.756086 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:34:21.757083 [info ] [MainThread]: 
[0m23:34:21.757083 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:34:21.759079 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:34:21.866789 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:34:21.866789 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:34:21.867787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:34:27.314213 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.447 seconds
[0m23:34:27.322192 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:34:27.332165 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:34:27.332165 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:34:27.333162 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:34:30.958462 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.626 seconds
[0m23:34:30.963449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0D85C130>]}
[0m23:34:30.968435 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:34:30.968435 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:34:30.969433 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:34:30.970430 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:34:30.981401 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:30.982398 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:34:31.018302 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:31.022291 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:31.023289 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (





-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
          to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS using your vars
flags as (
  select
    *,
    /* Rule 1: statistical outlier (z ≥ 1.5) */
    case
      when p50_usd_per_mi is not null
       and p95_usd_per_mi is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           >= 1.5
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-90.0% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >=
         percentile_cont(0.9)
           within group (order by usd_per_mi)
           over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and p95_usd_per_mi is not null
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    f.*,
    case
      when f.r1_price_outlier    = 1
        or f.r2_seat_scarcity    = 1
        or f.r3_monopoly_premium = 1
      then 1 else 0
    end as any_rule_flag
  from flags f
)

select * from final;
[0m23:34:31.024286 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:34:34.613681 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe98b-0305-0bba-0006-8fdb0018f146
[0m23:34:34.614679 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 139 at position 19 unexpected ';'.
[0m23:34:34.616674 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 139 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:34:34.619665 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c6aba06-cce3-4804-af9e-6c2ec041e011', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0DD110C0>]}
[0m23:34:34.620663 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.65s]
[0m23:34:34.621661 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:34:34.621661 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 139 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m23:34:34.623655 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:34:34.624652 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:34:34.624652 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:34:34.969729 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:34:34.970726 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:34:35.332757 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:34:35.333755 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:34:35.668858 [info ] [MainThread]: 
[0m23:34:35.669855 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.91 seconds (13.91s).
[0m23:34:35.670853 [debug] [MainThread]: Command end result
[0m23:34:35.702767 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:34:35.704762 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:34:35.713738 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:34:35.713738 [info ] [MainThread]: 
[0m23:34:35.714736 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:34:35.715733 [info ] [MainThread]: 
[0m23:34:35.716731 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  001003 (42000): SQL compilation error:
  syntax error line 139 at position 19 unexpected ';'.
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:34:35.716731 [info ] [MainThread]: 
[0m23:34:35.717728 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:34:35.719722 [debug] [MainThread]: Command `dbt run` failed at 23:34:35.718725 after 17.80 seconds
[0m23:34:35.719722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0321D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA0E1C8D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA032D44C0>]}
[0m23:34:35.720719 [debug] [MainThread]: Flushing usage events
[0m23:34:36.061806 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:34:43.872906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3A11D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3B85DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3B85E1D0>]}


============================== 23:34:43.876895 | 2e3eaa0a-bd80-4426-94b4-8642f34c2afc ==============================
[0m23:34:43.876895 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:34:43.877893 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select mart_pricing_features', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:34:44.760530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3B831CC0>]}
[0m23:34:44.819373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E4415F820>]}
[0m23:34:44.821368 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:34:45.384860 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:34:45.674086 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:34:45.674086 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:34:46.042101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44D98A60>]}
[0m23:34:46.184720 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:34:46.187713 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:34:46.210651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44D29C00>]}
[0m23:34:46.211648 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:34:46.212646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44D2ADA0>]}
[0m23:34:46.214640 [info ] [MainThread]: 
[0m23:34:46.214640 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:34:46.215637 [info ] [MainThread]: 
[0m23:34:46.216635 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:34:46.218630 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:34:46.326341 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:34:46.326341 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:34:46.327339 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:34:49.674382 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 3.347 seconds
[0m23:34:49.682361 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:34:49.692334 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:34:49.693331 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:34:49.693331 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:34:53.330599 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.637 seconds
[0m23:34:53.335586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44D2A680>]}
[0m23:34:53.339575 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:34:53.340572 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:34:53.341570 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:34:53.342567 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:34:53.353538 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:53.354535 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:34:53.386449 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:53.390439 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:34:53.391436 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (





-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination          as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                        as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)     as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                              as segment_count,
    split(s.segmentsairlinecode, '||')[0]      as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                             as staging_trip_dist,
    s.usd_per_mi                              as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2% pad)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon || ' ' || og.lat || ')'),
          to_geography('POINT(' || dg.lon || ' ' || dg.lat || ')')
        ) / 1609.344
      )
    )                                        as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)   as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull percentiles from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI between 0 and 1)
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))           as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS using your vars
flags as (
  select
    *,
    /* Rule 1: statistical outlier (z ≥ 1.5) */
    case
      when p50_usd_per_mi is not null
       and p95_usd_per_mi is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi) / 1.645, 0)
           >= 1.5
      then 1 else 0
    end as r1_price_outlier,

    /* Rule 2: seat scarcity + top-90.0% price */
    case
      when seats_flag in ('sold_out','scarce')
       and usd_per_mi >=
         percentile_cont(0.9)
           within group (order by usd_per_mi)
           over (partition by route, fare_bucket)
      then 1 else 0
    end as r2_seat_scarcity,

    /* Rule 3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and p95_usd_per_mi is not null
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    f.*,
    case
      when f.r1_price_outlier    = 1
        or f.r2_seat_scarcity    = 1
        or f.r3_monopoly_premium = 1
      then 1 else 0
    end as any_rule_flag
  from flags f
)

select * from final
        );
[0m23:34:53.392434 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:34:57.086549 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe98b-0305-0f94-0006-8fdb0018ba26
[0m23:34:57.087546 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 46 at position 35
invalid identifier 'OG.LON'
[0m23:34:57.089541 [debug] [Thread-1 (]: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 46 at position 35
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:34:57.091536 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e3eaa0a-bd80-4426-94b4-8642f34c2afc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E44D286D0>]}
[0m23:34:57.092533 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_features ...... [[31mERROR[0m in 3.75s]
[0m23:34:57.093530 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:34:57.094528 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_features' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 46 at position 35
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql.
[0m23:34:57.096522 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:34:57.097520 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:34:57.097520 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:34:57.436612 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:34:57.437610 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:34:57.794654 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:34:57.794654 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:34:58.136739 [info ] [MainThread]: 
[0m23:34:58.137737 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 11.92 seconds (11.92s).
[0m23:34:58.138734 [debug] [MainThread]: Command end result
[0m23:34:58.168653 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:34:58.171646 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:34:58.180622 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:34:58.180622 [info ] [MainThread]: 
[0m23:34:58.181619 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:34:58.182617 [info ] [MainThread]: 
[0m23:34:58.183614 [error] [MainThread]:   Database Error in model mart_pricing_features (models\marts\mart_pricing_features.sql)
  000904 (42000): SQL compilation error: error line 46 at position 35
  invalid identifier 'OG.LON'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_features.sql
[0m23:34:58.184611 [info ] [MainThread]: 
[0m23:34:58.185609 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m23:34:58.187603 [debug] [MainThread]: Command `dbt run` failed at 23:34:58.186606 after 14.39 seconds
[0m23:34:58.187603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3A11D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E3A1B2110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E458BA890>]}
[0m23:34:58.188601 [debug] [MainThread]: Flushing usage events
[0m23:34:58.562599 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:42:42.567025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A761D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A8D5DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A8D5E1D0>]}


============================== 23:42:42.570017 | 8e862265-8e63-4889-8dc4-055724f69285 ==============================
[0m23:42:42.570017 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:42:42.571014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select mart_pricing_features', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:42:43.456644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A83FF040>]}
[0m23:42:43.518479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A83FCE50>]}
[0m23:42:43.519476 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:42:44.073992 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:42:44.369203 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:42:44.370200 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_features.sql
[0m23:42:44.739213 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B22A4AC0>]}
[0m23:42:44.883825 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:42:44.886818 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:42:44.910754 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B222F7C0>]}
[0m23:42:44.911751 [info ] [MainThread]: Found 14 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:42:44.912749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B222F9A0>]}
[0m23:42:44.914743 [info ] [MainThread]: 
[0m23:42:44.915741 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:42:44.915741 [info ] [MainThread]: 
[0m23:42:44.916738 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:42:44.917736 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:42:45.026444 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:42:45.026444 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:42:45.027442 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:42:50.411036 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.384 seconds
[0m23:42:50.419015 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:42:50.429985 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:42:50.429985 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:42:50.430983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:42:54.103158 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.673 seconds
[0m23:42:54.108143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B222DA80>]}
[0m23:42:54.113130 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_features
[0m23:42:54.114128 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_features ............... [RUN]
[0m23:42:54.115125 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_features'
[0m23:42:54.116123 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_features
[0m23:42:54.130086 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:42:54.131083 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_features
[0m23:42:54.165989 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_features"
[0m23:42:54.170975 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_features"
[0m23:42:54.171973 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_features: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_features"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
         as
        (










-- 1 · BOOKINGS (clean staging)
with bookings as (
  select
    s.legid,
    s.origin,
    s.destination,
    s.origin || '-' || s.destination            as route,
    s.search_date,
    s.flight_date,
    s.days_to_flight,
    case
      when s.days_to_flight between  0 and  3 then '00-03'
      when s.days_to_flight between  4 and  7 then '04-07'
      when s.days_to_flight between  8 and 29 then '08-29'
      else                                      '30+'
    end                                          as dtf_bucket,
    s.total_fare,
    s.base_fare,
    s.total_fare / nullif(s.base_fare, 0)       as total_base_ratio,
    array_size(split(s.segmentsdepartureairportcode, '||'))
                                                as segment_count,
    split(s.segmentsairlinecode, '||')[0]        as carrier_code,
    s.seats_flag,
    s.fare_bucket,
    s.total_miles                               as staging_trip_dist,
    s.usd_per_mi                                as staging_usd_per_mi
  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches as s
),

-- 2 · LAST-RESORT DISTANCE (great-circle + 2%)
gc_dist as (
  select
    b.*,
    coalesce(
      b.staging_trip_dist,
      1.02 * (
        st_distance(
          to_geography('POINT(' || og.lon_deg || ' ' || og.lat_deg || ')'),
          to_geography('POINT(' || dg.lon_deg || ' ' || dg.lat_deg || ')')
        ) / 1609.344
      )
    )                                          as trip_dist
  from bookings b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as og
    on og.iata_code = b.origin
  left join FLIGHT_PRICES.WALRUS_PUBLIC.seed_airport_geo as dg
    on dg.iata_code = b.destination
),

-- 3 · RECALCULATE USD_PER_MI
priced as (
  select
    g.*,
    g.total_fare / nullif(g.trip_dist, 0)      as usd_per_mi
  from gc_dist g
),

-- 4 · BENCHMARKS (pull p50,p90,p95,p97 from stg_route_stats)
benchmarks as (
  select
    p.*,
    rs.p50_usd_per_mi,
    rs.p90_usd_per_mi,
    rs.p95_usd_per_mi,
    rs.p97_usd_per_mi
  from priced p
  left join FLIGHT_PRICES.WALRUS_PUBLIC.stg_route_stats as rs
    on rs.route       = p.route
   and rs.fare_bucket = p.fare_bucket
),

-- 5 · COMPETITION METRICS (clamp HHI to [0,1])
comp as (
  select
    b.*,
    c.carrier_count,
    least(1, greatest(0, c.hhi))              as hhi
  from benchmarks b
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_route_competition as c
    on c.route = b.route
),

-- 6 · RULE FLAGS (using your tuned thresholds)
flags as (
  select
    *,
    /* R1: statistical outlier (z ≥ 1.5) */
    case
      when p50_usd_per_mi is not null
       and p95_usd_per_mi is not null
       and (usd_per_mi - p50_usd_per_mi)
           / nullif((p95_usd_per_mi - p50_usd_per_mi)/1.645,0)
           >= 1.5
      then 1 else 0
    end as r1_price_outlier,

    /* R2: seat scarcity + top-90% price */
    case
      when seats_flag in ('sold_out','scarce')
       and p90_usd_per_mi is not null
       and usd_per_mi >= p90_usd_per_mi
      then 1 else 0
    end as r2_seat_scarcity,

    /* R3: monopoly premium (HHI ≥ 0.8) */
    case
      when hhi >= 0.8
       and p95_usd_per_mi is not null
       and usd_per_mi >= p95_usd_per_mi
      then 1 else 0
    end as r3_monopoly_premium

  from comp
),

-- 7 · FINAL SELECT (any-rule flag)
final as (
  select
    f.*,
    case
      when f.r1_price_outlier    = 1
        or f.r2_seat_scarcity    = 1
        or f.r3_monopoly_premium = 1
      then 1 else 0
    end                                             as any_rule_flag
  from flags f
)

select * from final
        );
[0m23:42:54.172971 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:44:50.850766 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 116.678 seconds
[0m23:44:50.873704 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e862265-8e63-4889-8dc4-055724f69285', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B222FC40>]}
[0m23:44:50.874702 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_features .......... [[32mSUCCESS 1[0m in 116.76s]
[0m23:44:50.875699 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_features
[0m23:44:50.877694 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:44:50.877694 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:44:50.878692 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:44:51.244712 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:44:51.245709 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:44:51.622700 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_features' was left open.
[0m23:44:51.623697 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_features: Close
[0m23:44:51.976753 [info ] [MainThread]: 
[0m23:44:51.977750 [info ] [MainThread]: Finished running 1 table model in 0 hours 2 minutes and 7.06 seconds (127.06s).
[0m23:44:51.978748 [debug] [MainThread]: Command end result
[0m23:44:52.010662 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:44:52.013655 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:44:52.022630 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:44:52.022630 [info ] [MainThread]: 
[0m23:44:52.024626 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:44:52.025623 [info ] [MainThread]: 
[0m23:44:52.025623 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:44:52.027617 [debug] [MainThread]: Command `dbt run` succeeded at 23:44:52.027617 after 129.54 seconds
[0m23:44:52.028615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A761D270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263A83FCE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263B1769990>]}
[0m23:44:52.029612 [debug] [MainThread]: Flushing usage events
[0m23:44:52.370698 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:50:35.165455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966A01D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966B75DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966B75E1A0>]}


============================== 23:50:35.169444 | 3df373ee-9a22-4b93-abd2-a3e0bf496616 ==============================
[0m23:50:35.169444 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:50:35.170442 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select int_flagged_extra_costs mart_extra_cost_summary --full-refresh', 'send_anonymous_usage_stats': 'True'}
[0m23:50:36.133863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966B72FC70>]}
[0m23:50:36.192706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019673D5F820>]}
[0m23:50:36.194701 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:50:36.755201 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:50:37.048416 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m23:50:37.048416 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\intermediate\int_flagged_extra_costs.sql
[0m23:50:37.049414 [debug] [MainThread]: Partial parsing: added file: fair_pricing_radar://models\marts\mart_extra_cost_summary.sql
[0m23:50:37.412442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001967496D750>]}
[0m23:50:37.555060 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:50:37.558053 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:50:37.580992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000196749649A0>]}
[0m23:50:37.581989 [info ] [MainThread]: Found 16 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:50:37.582987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019674967C70>]}
[0m23:50:37.584981 [info ] [MainThread]: 
[0m23:50:37.585978 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:50:37.585978 [info ] [MainThread]: 
[0m23:50:37.586976 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:50:37.591962 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:50:37.699674 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:50:37.700671 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:50:37.700671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:50:43.387455 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.687 seconds
[0m23:50:43.391444 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:50:43.401417 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:50:43.401417 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:50:43.402415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:50:47.108498 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.707 seconds
[0m23:50:47.113484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019666FCE560>]}
[0m23:50:47.118471 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:50:47.118471 [info ] [Thread-1 (]: 1 of 2 START sql table model WALRUS_PUBLIC.int_flagged_extra_costs ............. [RUN]
[0m23:50:47.119469 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_flagged_extra_costs'
[0m23:50:47.120466 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:50:47.128444 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:50:47.130439 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:50:47.161357 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:50:47.164348 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:50:47.165345 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_flagged_extra_costs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_flagged_extra_costs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_flagged_extra_costs
         as
        (

-- 1. Grab only the bookings we’ve flagged as suspicious
with flagged as (

  select
    legid,
    route,
    carrier_code               as marketing_carrier,
    dtf_bucket,
    flight_date,
    total_fare,
    r1_price_outlier    as is_r1,
    r2_seat_scarcity    as is_r2,
    r3_monopoly_premium as is_r3

  from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
  where any_rule_flag = 1

),

-- 2. Pull in the median benchmark
bench as (

  select
    route,
    marketing_carrier,
    dtf_bucket,
    flight_date,
    median_fare

  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices

),

-- 3. Compute overage per booking
extra as (

  select
    f.*,
    b.median_fare,
    case
      when f.total_fare > b.median_fare then
        f.total_fare - b.median_fare
      else 0
    end as extra_cost

  from flagged f
  left join bench b
    using (route, marketing_carrier, dtf_bucket, flight_date)

)

select * from extra
        );
[0m23:50:47.166343 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:50:50.828544 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe99b-0305-0bba-0006-8fdb0018f1da
[0m23:50:50.829541 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 29 at position 4
invalid identifier 'MARKETING_CARRIER'
[0m23:50:50.831536 [debug] [Thread-1 (]: Database Error in model int_flagged_extra_costs (models\intermediate\int_flagged_extra_costs.sql)
  000904 (42000): SQL compilation error: error line 29 at position 4
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_flagged_extra_costs.sql
[0m23:50:50.833530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3df373ee-9a22-4b93-abd2-a3e0bf496616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966A0E4580>]}
[0m23:50:50.834528 [error] [Thread-1 (]: 1 of 2 ERROR creating sql table model WALRUS_PUBLIC.int_flagged_extra_costs .... [[31mERROR[0m in 3.71s]
[0m23:50:50.835525 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:50:50.836523 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.int_flagged_extra_costs' to be skipped because of status 'error'.  Reason: Database Error in model int_flagged_extra_costs (models\intermediate\int_flagged_extra_costs.sql)
  000904 (42000): SQL compilation error: error line 29 at position 4
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_flagged_extra_costs.sql.
[0m23:50:50.837520 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:50:50.838517 [info ] [Thread-3 (]: 2 of 2 SKIP relation WALRUS_PUBLIC.mart_extra_cost_summary ..................... [[33mSKIP[0m]
[0m23:50:50.839515 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:50:50.840512 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:50:50.841509 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:50:50.841509 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:50:51.188580 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:50:51.189577 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:50:51.554601 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_flagged_extra_costs' was left open.
[0m23:50:51.554601 [debug] [MainThread]: On model.fair_pricing_radar.int_flagged_extra_costs: Close
[0m23:50:51.908653 [info ] [MainThread]: 
[0m23:50:51.909651 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 14.32 seconds (14.32s).
[0m23:50:51.910649 [debug] [MainThread]: Command end result
[0m23:50:51.942563 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:50:51.945555 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:50:51.952536 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:50:51.953534 [info ] [MainThread]: 
[0m23:50:51.954531 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:50:51.955529 [info ] [MainThread]: 
[0m23:50:51.956526 [error] [MainThread]:   Database Error in model int_flagged_extra_costs (models\intermediate\int_flagged_extra_costs.sql)
  000904 (42000): SQL compilation error: error line 29 at position 4
  invalid identifier 'MARKETING_CARRIER'
  compiled code at target\run\fair_pricing_radar\models\intermediate\int_flagged_extra_costs.sql
[0m23:50:51.956526 [info ] [MainThread]: 
[0m23:50:51.957523 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=1 TOTAL=2
[0m23:50:51.959518 [debug] [MainThread]: Command `dbt run` failed at 23:50:51.959518 after 16.87 seconds
[0m23:50:51.959518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001966A01D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000196747F75E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019675A1B670>]}
[0m23:50:51.960516 [debug] [MainThread]: Flushing usage events
[0m23:50:52.314567 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:55:14.729403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0321D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E04959CF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E04959ED0>]}


============================== 23:55:14.733392 | 0e21a25a-400b-41e7-abf5-a6450678e998 ==============================
[0m23:55:14.733392 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:55:14.734390 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select int_flagged_extra_costs mart_extra_cost_summary --full-refresh', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:55:15.670883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E04937C70>]}
[0m23:55:15.729726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0CF5F820>]}
[0m23:55:15.731721 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m23:55:16.286237 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:55:16.581447 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:55:16.582445 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\intermediate\int_flagged_extra_costs.sql
[0m23:55:16.941484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0DB75780>]}
[0m23:55:17.083104 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:55:17.086097 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:55:17.111030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0DB6AF80>]}
[0m23:55:17.111030 [info ] [MainThread]: Found 16 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m23:55:17.112027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0D8CD150>]}
[0m23:55:17.114022 [info ] [MainThread]: 
[0m23:55:17.115019 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:55:17.115019 [info ] [MainThread]: 
[0m23:55:17.116017 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m23:55:17.122001 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m23:55:17.245670 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m23:55:17.246667 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m23:55:17.246667 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:55:21.992967 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.746 seconds
[0m23:55:21.996956 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m23:55:22.007927 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m23:55:22.007927 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m23:55:22.008925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:55:25.723983 [debug] [ThreadPool]: SQL status: SUCCESS 14 in 3.715 seconds
[0m23:55:25.728970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E03FD7220>]}
[0m23:55:25.732960 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:55:25.733957 [info ] [Thread-1 (]: 1 of 2 START sql table model WALRUS_PUBLIC.int_flagged_extra_costs ............. [RUN]
[0m23:55:25.734954 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.int_flagged_extra_costs'
[0m23:55:25.735952 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:55:25.743930 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:55:25.744928 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:55:25.775845 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:55:25.777840 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.int_flagged_extra_costs"
[0m23:55:25.778837 [debug] [Thread-1 (]: On model.fair_pricing_radar.int_flagged_extra_costs: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.int_flagged_extra_costs"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.int_flagged_extra_costs
         as
        (

-- 1. Grab only the bookings we’ve flagged as suspicious
with flagged as (

  select
    legid,
    route,
    carrier_code            as marketing_carrier,
    dtf_bucket,
    flight_date,
    total_fare,
    r1_price_outlier        as is_r1,
    r2_seat_scarcity        as is_r2,
    r3_monopoly_premium     as is_r3

  from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
  where any_rule_flag = 1

),

-- 2. Pull in the median benchmark (use carrier_code → marketing_carrier)
bench as (

  select
    route,
    carrier_code            as marketing_carrier,
    dtf_bucket,
    flight_date,
    median_fare

  from FLIGHT_PRICES.WALRUS_PUBLIC.int_route_daily_prices

),

-- 3. Compute overage per booking
extra as (

  select
    f.*,
    b.median_fare,
    case
      when f.total_fare > b.median_fare then
        f.total_fare - b.median_fare
      else 0
    end as extra_cost

  from flagged f
  left join bench b
    using (route, marketing_carrier, dtf_bucket, flight_date)

)

select * from extra
        );
[0m23:55:25.778837 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m23:55:37.650072 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 11.871 seconds
[0m23:55:37.671016 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0DB764D0>]}
[0m23:55:37.672013 [info ] [Thread-1 (]: 1 of 2 OK created sql table model WALRUS_PUBLIC.int_flagged_extra_costs ........ [[32mSUCCESS 1[0m in 11.94s]
[0m23:55:37.674009 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.int_flagged_extra_costs
[0m23:55:37.674009 [debug] [Thread-3 (]: Began running node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:55:37.675005 [info ] [Thread-3 (]: 2 of 2 START sql table model WALRUS_PUBLIC.mart_extra_cost_summary ............. [RUN]
[0m23:55:37.676003 [debug] [Thread-3 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_extra_cost_summary'
[0m23:55:37.677000 [debug] [Thread-3 (]: Began compiling node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:55:37.679992 [debug] [Thread-3 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_extra_cost_summary"
[0m23:55:37.681987 [debug] [Thread-3 (]: Began executing node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:55:37.685976 [debug] [Thread-3 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_extra_cost_summary"
[0m23:55:37.687971 [debug] [Thread-3 (]: Using snowflake connection "model.fair_pricing_radar.mart_extra_cost_summary"
[0m23:55:37.688968 [debug] [Thread-3 (]: On model.fair_pricing_radar.mart_extra_cost_summary: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_extra_cost_summary"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_extra_cost_summary
         as
        (

select
  /* overall */
  count(*)                       as num_flagged_bookings,
  sum(extra_cost)                as total_extra_cost,
  sum(extra_cost) / nullif(count(*),0) as avg_extra_per_booking,

  /* by rule */
  sum(case when is_r1 = 1 then extra_cost else 0 end)
                                 as total_extra_r1,
  sum(case when is_r2 = 1 then extra_cost else 0 end)
                                 as total_extra_r2,
  sum(case when is_r3 = 1 then extra_cost else 0 end)
                                 as total_extra_r3

from FLIGHT_PRICES.WALRUS_PUBLIC.int_flagged_extra_costs
        );
[0m23:55:37.688968 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m23:55:42.202889 [debug] [Thread-3 (]: SQL status: SUCCESS 1 in 4.513 seconds
[0m23:55:42.204884 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e21a25a-400b-41e7-abf5-a6450678e998', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0EC18CA0>]}
[0m23:55:42.205882 [info ] [Thread-3 (]: 2 of 2 OK created sql table model WALRUS_PUBLIC.mart_extra_cost_summary ........ [[32mSUCCESS 1[0m in 4.53s]
[0m23:55:42.206879 [debug] [Thread-3 (]: Finished running node model.fair_pricing_radar.mart_extra_cost_summary
[0m23:55:42.207877 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:55:42.208874 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m23:55:42.208874 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m23:55:42.562926 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m23:55:42.563923 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m23:55:42.897032 [debug] [MainThread]: Connection 'model.fair_pricing_radar.int_flagged_extra_costs' was left open.
[0m23:55:42.898030 [debug] [MainThread]: On model.fair_pricing_radar.int_flagged_extra_costs: Close
[0m23:55:43.256072 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_extra_cost_summary' was left open.
[0m23:55:43.257069 [debug] [MainThread]: On model.fair_pricing_radar.mart_extra_cost_summary: Close
[0m23:55:43.592172 [info ] [MainThread]: 
[0m23:55:43.593171 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 26.48 seconds (26.48s).
[0m23:55:43.594168 [debug] [MainThread]: Command end result
[0m23:55:43.624087 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m23:55:43.627079 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m23:55:43.635058 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m23:55:43.636055 [info ] [MainThread]: 
[0m23:55:43.637053 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:55:43.637053 [info ] [MainThread]: 
[0m23:55:43.638051 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m23:55:43.640045 [debug] [MainThread]: Command `dbt run` succeeded at 23:55:43.640045 after 28.99 seconds
[0m23:55:43.641043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0321D2D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E032BF1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E0DB4A950>]}
[0m23:55:43.642039 [debug] [MainThread]: Flushing usage events
[0m23:55:43.986118 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:08:45.073101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62491D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62605DFF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62605E1D0>]}


============================== 00:08:45.076092 | 844f8d79-8c19-44d3-be35-00ce5ab29cb2 ==============================
[0m00:08:45.076092 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:08:45.077089 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select mart_pricing_alerts', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:08:45.959727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E626031CC0>]}
[0m00:08:46.018570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62E85F820>]}
[0m00:08:46.019568 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:08:46.582062 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:08:46.895224 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:08:46.896222 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_alerts.sql
[0m00:08:47.254263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62F36D750>]}
[0m00:08:47.394887 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:08:47.397880 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:08:47.421816 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62F36D870>]}
[0m00:08:47.422813 [info ] [MainThread]: Found 16 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m00:08:47.423811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62F2E2290>]}
[0m00:08:47.424808 [info ] [MainThread]: 
[0m00:08:47.425805 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:08:47.426802 [info ] [MainThread]: 
[0m00:08:47.427800 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:08:47.428797 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:08:47.535511 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:08:47.535511 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:08:47.536508 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:08:52.468312 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.931 seconds
[0m00:08:52.476291 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:08:52.486264 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:08:52.487262 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:08:52.487262 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:08:56.175392 [debug] [ThreadPool]: SQL status: SUCCESS 16 in 3.688 seconds
[0m00:08:56.180379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62F36FBB0>]}
[0m00:08:56.185366 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m00:08:56.186364 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_alerts ................. [RUN]
[0m00:08:56.187361 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_alerts'
[0m00:08:56.187361 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_alerts
[0m00:08:56.195339 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:08:56.196337 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_alerts
[0m00:08:56.228251 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:08:56.230246 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:08:56.231244 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_alerts: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_alerts"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_alerts
         as
        (-- models/marts/mart_pricing_alerts.sql


with alerts as (

  select
    legid,
    route,
    flight_date,
    carrier_code,
    -- if your mart already has carrier_name, use it; otherwise join to dim_carrier
    carrier_name,
    total_fare,
    trip_dist,

    r1_price_outlier      as flag_price_outlier,
    r2_seat_scarcity      as flag_seat_scarcity,
    r3_monopoly_premium   as flag_monopoly,

    array_construct_compact(
      case when r1_price_outlier    = 1 then 'price_outlier'    end,
      case when r2_seat_scarcity    = 1 then 'seat_scarcity'    end,
      case when r3_monopoly_premium = 1 then 'monopoly_premium' end
    ) as flag_list

  from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features
  where any_rule_flag = 1

)

select * from alerts
        );
[0m00:08:56.232241 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:08:59.952287 [debug] [Thread-1 (]: Snowflake adapter: Snowflake query id: 01bbe9ad-0305-0fb8-0006-8fdb0018c9ea
[0m00:08:59.952287 [debug] [Thread-1 (]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 14 at position 4
invalid identifier 'CARRIER_NAME'
[0m00:08:59.955279 [debug] [Thread-1 (]: Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 14 at position 4
  invalid identifier 'CARRIER_NAME'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql
[0m00:08:59.957273 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '844f8d79-8c19-44d3-be35-00ce5ab29cb2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62FDBA5F0>]}
[0m00:08:59.958271 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model WALRUS_PUBLIC.mart_pricing_alerts ........ [[31mERROR[0m in 3.77s]
[0m00:08:59.959268 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m00:08:59.960265 [debug] [Thread-7 (]: Marking all children of 'model.fair_pricing_radar.mart_pricing_alerts' to be skipped because of status 'error'.  Reason: Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 14 at position 4
  invalid identifier 'CARRIER_NAME'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql.
[0m00:08:59.962260 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:08:59.962260 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:08:59.963257 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:09:00.536722 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:09:00.536722 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:09:00.894765 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_alerts' was left open.
[0m00:09:00.894765 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_alerts: Close
[0m00:09:01.232860 [info ] [MainThread]: 
[0m00:09:01.233858 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.81 seconds (13.81s).
[0m00:09:01.234855 [debug] [MainThread]: Command end result
[0m00:09:01.265772 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:09:01.268765 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:09:01.276743 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:09:01.277740 [info ] [MainThread]: 
[0m00:09:01.278738 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m00:09:01.279735 [info ] [MainThread]: 
[0m00:09:01.279735 [error] [MainThread]:   Database Error in model mart_pricing_alerts (models\marts\mart_pricing_alerts.sql)
  000904 (42000): SQL compilation error: error line 14 at position 4
  invalid identifier 'CARRIER_NAME'
  compiled code at target\run\fair_pricing_radar\models\marts\mart_pricing_alerts.sql
[0m00:09:01.280733 [info ] [MainThread]: 
[0m00:09:01.281730 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m00:09:01.283724 [debug] [MainThread]: Command `dbt run` failed at 00:09:01.282727 after 16.29 seconds
[0m00:09:01.283724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E62491D2A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E6249B2110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E63011EA70>]}
[0m00:09:01.284722 [debug] [MainThread]: Flushing usage events
[0m00:09:01.632790 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:11:31.114809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8171D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC82E5DFC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC82E5E1A0>]}


============================== 00:11:31.118798 | bb3575e9-bde2-410b-8eab-7dc43ae9be78 ==============================
[0m00:11:31.118798 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:11:31.119796 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select mart_pricing_alerts', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:11:32.010412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DCFF997040>]}
[0m00:11:32.069255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC826FE2C0>]}
[0m00:11:32.071249 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:11:32.630752 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:11:32.951894 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:11:32.951894 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_pricing_alerts.sql
[0m00:11:33.351823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8C16D810>]}
[0m00:11:33.508404 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:11:33.510399 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:11:33.535332 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8C166E60>]}
[0m00:11:33.536329 [info ] [MainThread]: Found 16 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m00:11:33.537327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8C0053C0>]}
[0m00:11:33.539322 [info ] [MainThread]: 
[0m00:11:33.540319 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:11:33.540319 [info ] [MainThread]: 
[0m00:11:33.541317 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:11:33.543311 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:11:33.654015 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:11:33.655012 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:11:33.655012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:11:38.053243 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 4.398 seconds
[0m00:11:38.061222 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:11:38.072192 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:11:38.072192 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:11:38.073190 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:11:41.706467 [debug] [ThreadPool]: SQL status: SUCCESS 16 in 3.634 seconds
[0m00:11:41.711454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8C167DF0>]}
[0m00:11:41.716441 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_pricing_alerts
[0m00:11:41.716441 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_pricing_alerts ................. [RUN]
[0m00:11:41.717438 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_pricing_alerts'
[0m00:11:41.718436 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_pricing_alerts
[0m00:11:41.726415 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:11:41.727411 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_pricing_alerts
[0m00:11:41.759326 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:11:41.761321 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_pricing_alerts"
[0m00:11:41.762318 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_pricing_alerts: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_pricing_alerts"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_alerts
         as
        (

with alerts as (

  select
    m.legid,
    m.route,
    m.flight_date,
    m.carrier_code,
    d.carrier_name,                     -- now pulled from dim_carrier
    m.total_fare,
    m.trip_dist,

    m.r1_price_outlier    as flag_price_outlier,
    m.r2_seat_scarcity    as flag_seat_scarcity,
    m.r3_monopoly_premium as flag_monopoly,

    array_construct_compact(
      case when m.r1_price_outlier    = 1 then 'price_outlier'    end,
      case when m.r2_seat_scarcity    = 1 then 'seat_scarcity'    end,
      case when m.r3_monopoly_premium = 1 then 'monopoly_premium' end
    ) as flag_list

  from FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features as m
  left join FLIGHT_PRICES.WALRUS_PUBLIC.dim_carrier as d
    on m.carrier_code = d.carrier_code

  where m.r1_price_outlier    = 1
     or m.r2_seat_scarcity    = 1
     or m.r3_monopoly_premium = 1

)

select * from alerts
        );
[0m00:11:41.762318 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:11:55.166452 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 13.404 seconds
[0m00:11:55.190387 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb3575e9-bde2-410b-8eab-7dc43ae9be78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8CBB65F0>]}
[0m00:11:55.191385 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_pricing_alerts ............ [[32mSUCCESS 1[0m in 13.47s]
[0m00:11:55.192382 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_pricing_alerts
[0m00:11:55.194377 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:11:55.194377 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:11:55.195374 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:11:55.538457 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:11:55.539454 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:11:55.895501 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_pricing_alerts' was left open.
[0m00:11:55.896498 [debug] [MainThread]: On model.fair_pricing_radar.mart_pricing_alerts: Close
[0m00:11:56.253543 [info ] [MainThread]: 
[0m00:11:56.254540 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 22.71 seconds (22.71s).
[0m00:11:56.255539 [debug] [MainThread]: Command end result
[0m00:11:56.287453 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:11:56.290445 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:11:56.299421 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:11:56.300418 [info ] [MainThread]: 
[0m00:11:56.301415 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:11:56.301415 [info ] [MainThread]: 
[0m00:11:56.302413 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:11:56.304407 [debug] [MainThread]: Command `dbt run` succeeded at 00:11:56.304407 after 25.27 seconds
[0m00:11:56.304407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC8171D300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC826FE2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DC817D44C0>]}
[0m00:11:56.305405 [debug] [MainThread]: Flushing usage events
[0m00:11:56.647489 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m00:23:05.278379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CD21D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CE959C60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CE959E40>]}


============================== 00:23:05.282368 | fca25516-d473-4310-bac8-06f05824f021 ==============================
[0m00:23:05.282368 [info ] [MainThread]: Running with dbt=1.9.4
[0m00:23:05.283365 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\Mattia\\Business_Challenge\\fair_pricing_radar\\logs', 'profiles_dir': 'C:\\Users\\Mattia\\.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select mart_dashboard_kpis', 'send_anonymous_usage_stats': 'True'}
[0m00:23:06.220856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CE927E20>]}
[0m00:23:06.279699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D6F5F400>]}
[0m00:23:06.280697 [info ] [MainThread]: Registered adapter: snowflake=1.9.2
[0m00:23:06.837208 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m00:23:07.131420 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:23:07.132418 [debug] [MainThread]: Partial parsing: updated file: fair_pricing_radar://models\marts\mart_dashboard_kpis.sql
[0m00:23:07.493451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7B6D990>]}
[0m00:23:07.635073 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:23:07.637067 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:23:07.662998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7B6C220>]}
[0m00:23:07.663996 [info ] [MainThread]: Found 16 models, 1 analysis, 3 seeds, 19 data tests, 1 source, 475 macros
[0m00:23:07.664993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7B0EA10>]}
[0m00:23:07.665990 [info ] [MainThread]: 
[0m00:23:07.666988 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m00:23:07.667985 [info ] [MainThread]: 
[0m00:23:07.668982 [debug] [MainThread]: Acquiring new snowflake connection 'master'
[0m00:23:07.669980 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES'
[0m00:23:07.803622 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES"
[0m00:23:07.803622 [debug] [ThreadPool]: On list_FLIGHT_PRICES: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES"} */
show terse schemas in database FLIGHT_PRICES
    limit 10000
[0m00:23:07.804619 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:23:13.053574 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 5.249 seconds
[0m00:23:13.061552 [debug] [ThreadPool]: Acquiring new snowflake connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC'
[0m00:23:13.072523 [debug] [ThreadPool]: Using snowflake connection "list_FLIGHT_PRICES_WALRUS_PUBLIC"
[0m00:23:13.072523 [debug] [ThreadPool]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "connection_name": "list_FLIGHT_PRICES_WALRUS_PUBLIC"} */
show objects in FLIGHT_PRICES.WALRUS_PUBLIC limit 10000;
[0m00:23:13.073520 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:23:16.731732 [debug] [ThreadPool]: SQL status: SUCCESS 16 in 3.658 seconds
[0m00:23:16.736718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D7B6FF10>]}
[0m00:23:16.741705 [debug] [Thread-1 (]: Began running node model.fair_pricing_radar.mart_dashboard_kpis
[0m00:23:16.741705 [info ] [Thread-1 (]: 1 of 1 START sql table model WALRUS_PUBLIC.mart_dashboard_kpis ................. [RUN]
[0m00:23:16.742703 [debug] [Thread-1 (]: Acquiring new snowflake connection 'model.fair_pricing_radar.mart_dashboard_kpis'
[0m00:23:16.743700 [debug] [Thread-1 (]: Began compiling node model.fair_pricing_radar.mart_dashboard_kpis
[0m00:23:16.751678 [debug] [Thread-1 (]: Writing injected SQL for node "model.fair_pricing_radar.mart_dashboard_kpis"
[0m00:23:16.753674 [debug] [Thread-1 (]: Began executing node model.fair_pricing_radar.mart_dashboard_kpis
[0m00:23:16.784591 [debug] [Thread-1 (]: Writing runtime sql for node "model.fair_pricing_radar.mart_dashboard_kpis"
[0m00:23:16.787583 [debug] [Thread-1 (]: Using snowflake connection "model.fair_pricing_radar.mart_dashboard_kpis"
[0m00:23:16.788580 [debug] [Thread-1 (]: On model.fair_pricing_radar.mart_dashboard_kpis: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "fair_pricing_radar", "target_name": "dev", "node_id": "model.fair_pricing_radar.mart_dashboard_kpis"} */
create or replace transient table FLIGHT_PRICES.WALRUS_PUBLIC.mart_dashboard_kpis
         as
        (

-- 1) Base data: every booking, annotated with alert flags & extra cost
with base as (

  select
    s.legid,
    s.search_date,
    s.flight_date,
    s.route,
    s.fare_bucket,
    s.usd_per_mi,
    coalesce(f.any_rule_flag,         0) as any_alert,
    coalesce(f.r1_price_outlier,      0) as is_r1_outlier,
    coalesce(f.r2_seat_scarcity,      0) as is_r2_scarcity,
    coalesce(f.r3_monopoly_premium,   0) as is_r3_monopoly,
    coalesce(e.extra_cost,            0) as extra_cost

  from FLIGHT_PRICES.WALRUS_PUBLIC.stg_fare_searches         as s
  left join FLIGHT_PRICES.WALRUS_PUBLIC.mart_pricing_features as f using (legid)
  left join FLIGHT_PRICES.WALRUS_PUBLIC.int_flagged_extra_costs as e using (legid)

),

-- 2) Aggregate KPIs over that base set
kpis as (

  select
    count(*)                                   as total_bookings,
    sum(any_alert)                             as total_any_alerts,
    sum(is_r1_outlier)                         as total_R1_alerts,
    sum(is_r2_scarcity)                        as total_R2_alerts,
    sum(is_r3_monopoly)                        as total_R3_alerts,

    round(100.0 * sum(any_alert)/nullif(count(*),0),2)   as pct_any_alerts,
    round(100.0 * sum(is_r1_outlier)/nullif(count(*),0),2) as pct_R1_outliers,
    round(100.0 * sum(is_r2_scarcity)/nullif(count(*),0),2) as pct_R2_scarcity,
    round(100.0 * sum(is_r3_monopoly)/nullif(count(*),0),2) as pct_R3_monopoly,

    sum(extra_cost)                            as total_extra_cost_usd,
    round(sum(extra_cost)/nullif(sum(any_alert),0),2) as avg_extra_per_alert

  from base

)

select * from kpis
        );
[0m00:23:16.789577 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:23:56.508298 [debug] [Thread-1 (]: SQL status: SUCCESS 1 in 39.719 seconds
[0m00:23:56.529242 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fca25516-d473-4310-bac8-06f05824f021', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CB1CD660>]}
[0m00:23:56.530240 [info ] [Thread-1 (]: 1 of 1 OK created sql table model WALRUS_PUBLIC.mart_dashboard_kpis ............ [[32mSUCCESS 1[0m in 39.79s]
[0m00:23:56.531238 [debug] [Thread-1 (]: Finished running node model.fair_pricing_radar.mart_dashboard_kpis
[0m00:23:56.533233 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:23:56.533233 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES' was left open.
[0m00:23:56.534229 [debug] [MainThread]: On list_FLIGHT_PRICES: Close
[0m00:23:56.892271 [debug] [MainThread]: Connection 'list_FLIGHT_PRICES_WALRUS_PUBLIC' was left open.
[0m00:23:56.892271 [debug] [MainThread]: On list_FLIGHT_PRICES_WALRUS_PUBLIC: Close
[0m00:23:57.224382 [debug] [MainThread]: Connection 'model.fair_pricing_radar.mart_dashboard_kpis' was left open.
[0m00:23:57.225380 [debug] [MainThread]: On model.fair_pricing_radar.mart_dashboard_kpis: Close
[0m00:23:57.556494 [info ] [MainThread]: 
[0m00:23:57.557491 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 49.89 seconds (49.89s).
[0m00:23:57.558489 [debug] [MainThread]: Command end result
[0m00:23:57.590403 [debug] [MainThread]: Wrote artifact WritableManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\manifest.json
[0m00:23:57.592398 [debug] [MainThread]: Wrote artifact SemanticManifest to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\semantic_manifest.json
[0m00:23:57.601374 [debug] [MainThread]: Wrote artifact RunExecutionResult to C:\Users\Mattia\Business_Challenge\fair_pricing_radar\target\run_results.json
[0m00:23:57.602372 [info ] [MainThread]: 
[0m00:23:57.602372 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:23:57.603369 [info ] [MainThread]: 
[0m00:23:57.604367 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:23:57.606361 [debug] [MainThread]: Command `dbt run` succeeded at 00:23:57.606361 after 52.41 seconds
[0m00:23:57.606361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CD21D360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D72E0250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3CD2B0F70>]}
[0m00:23:57.607358 [debug] [MainThread]: Flushing usage events
[0m00:23:57.949442 [debug] [MainThread]: An error was encountered while trying to flush usage events
